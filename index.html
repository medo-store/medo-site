
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Medo Gaming Store</title>

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1230;
      --panel:#0E183B;
      --card:#0C1736;
      --text:#F6F7FF;
      --muted:#B9C1D9;
      --border:rgba(255,255,255,.10);
      --accent:#E11D48;
      --accent2:#38BDF8;
      --good:#22C55E;
      --warn:#F59E0B;

      --radius:14px;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Segoe UI", Tahoma, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 15% 8%, rgba(56,189,248,.16), transparent 60%),
        radial-gradient(900px 600px at 85% 0%, rgba(225,29,72,.14), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      min-height:100vh;
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:1200px;margin:0 auto;padding:10px 12px}

    /* Sticky header */
    .nav{
      position:sticky;top:0;z-index:60;
      background:rgba(7,10,18,.72);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .nav-inner{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.2px;white-space:nowrap}
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:0 0 0 4px rgba(56,189,248,.10);
    }

    .ramadanPill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(245,158,11,.35);
      background:rgba(245,158,11,.10);
      color:#fff;font-weight:900;font-size:12px;
      white-space:nowrap;
    }
    .lantern{
      width:14px;height:14px;display:inline-block;
      background:
        radial-gradient(circle at 50% 35%, rgba(255,255,255,.85), rgba(255,255,255,.12) 55%, transparent 60%),
        linear-gradient(180deg, rgba(245,158,11,.95), rgba(245,158,11,.45));
      border-radius:6px;
      box-shadow:0 0 14px rgba(245,158,11,.25);
      border:1px solid rgba(255,255,255,.15);
    }

    .searchWrap{flex:1;min-width:220px;display:flex;align-items:center;gap:8px}
    .search{
      flex:1;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
    }

    .iconBtn{
      display:inline-flex;align-items:center;justify-content:center;
      gap:8px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      user-select:none;
    }
    .iconBtn:hover{filter:brightness(1.08)}
    .rightBox{margin-inline-start:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pillCount{
      min-width:22px;height:22px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;
      background:rgba(56,189,248,.16);
      border:1px solid rgba(56,189,248,.35);
      font-weight:900;font-size:12px;padding:0 6px;
    }

    .userChip{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 10px;border-radius:999px;
      border:1px solid rgba(56,189,248,.35);
      background:rgba(56,189,248,.10);
      cursor:pointer;white-space:nowrap;
      font-weight:900;font-size:13px;
    }
    .avatarSmall{
      width:22px;height:22px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.07);
      display:inline-flex;align-items:center;justify-content:center;
      overflow:hidden;
      font-size:11px;
    }
    .avatarSmall img{width:100%;height:100%;object-fit:cover}

    /* Sections */
    .sectionTitle{
      margin:18px 0 8px;
      font-size:15px;
      font-weight:900;
      display:flex;align-items:center;gap:10px;
    }
    .sectionHint{color:var(--muted);font-weight:800;font-size:12px}
    .spacer{height:18px}

    /* Grid */
   
/* Grid ‚Äì FIXED */
.grid{
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 12px;
}

/* ŸÑÿßÿ®ÿ™Ÿàÿ® ŸàŸÉŸÖÿ®ŸäŸàÿ™ÿ± */
@media (max-width: 1200px){
  .grid{
    grid-template-columns: repeat(4, minmax(0, 1fr));
  }
}

/* ŸÖŸàÿ®ÿßŸäŸÑ */
@media (max-width: 768px){
  .grid{
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

/* ŸÖŸàÿ®ÿßŸäŸÑ ÿµÿ∫Ÿäÿ± */
@media (max-width: 420px){
  .grid{
    grid-template-columns: 1fr;
  }
}
    .card{
      background:rgba(12,23,54,.72);
      border:1px solid var(--border);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      display:flex;flex-direction:column;
      min-height:270px;
    }
    .thumb{
      height:96px;
      background:
        radial-gradient(180px 120px at 25% 30%, rgba(56,189,248,.22), transparent 65%),
        radial-gradient(180px 120px at 75% 0%, rgba(225,29,72,.18), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;letter-spacing:.7px;font-size:12px;
      position:relative;
      overflow:hidden;
    }
    .thumb img{
      width:100%;height:100%;object-fit:cover;opacity:.92;
      display:block;
    }

    .badge{
      position:absolute;top:8px;inset-inline-start:8px;
      padding:6px 8px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.25);
      font-size:11px;font-weight:900;
      display:inline-flex;gap:6px;align-items:center;
      backdrop-filter: blur(6px);
    }
    .badge.top{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.12)}
    .badge.offer{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.12)}

    .content{padding:10px 10px 12px;display:flex;flex-direction:column;gap:8px;flex:1}
    .name{margin:0;font-size:13px;font-weight:900}
    .meta{margin:0;font-size:12px;color:var(--muted);line-height:1.4}
    .priceRow{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .price{margin:0;font-size:12px;font-weight:900}

    .ratingRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-top:2px;
    }
    .starsView{
      display:inline-flex;gap:2px;align-items:center;
      font-size:12px;color:rgba(246,247,255,.92);font-weight:900;
    }
    .starsView .s{opacity:.35}
    .starsView .s.on{opacity:1}
    .starsMini{color:rgba(185,193,217,.9);font-weight:800;font-size:12px}

    /* Actions */
    .actions{display:flex;gap:8px;margin-top:auto;flex-wrap:wrap}
    .btn{
      flex:1;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 10px;
      font-weight:900;font-size:12px;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      min-width:120px;
    }
    .btn:hover{filter:brightness(1.08)}
    .btnRed{background:linear-gradient(135deg, rgba(225,29,72,1), rgba(225,29,72,.82));border-color:transparent}
    .btnBlue{background:rgba(56,189,248,.12);border-color:rgba(56,189,248,.35)}

    /* Overlay / drawer / modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.58);display:none;z-index:80}
    .overlay.show{display:block}

    /* Drawer */
    .drawer{
      position:fixed;top:0;bottom:0;
      width:min(360px, 92vw);
      background:rgba(14,24,59,.92);
      backdrop-filter: blur(10px);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      z-index:90;
      transition: right .22s ease, left .22s ease;
      display:flex;flex-direction:column;
    }
    /* RTL default: open from right */
    html[dir="rtl"] .drawer{ right:-420px; left:auto; }
    html[dir="rtl"] .drawer.show{ right:0; }
    /* LTR: open from left */
    html[dir="ltr"] .drawer{ left:-420px; right:auto; }
    html[dir="ltr"] .drawer.show{ left:0; }

    .drawerHeader{
      padding:12px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .drawerTitle{font-weight:900}
    .drawerBody{padding:12px;overflow:auto}
    .drawerSection{margin:10px 0 16px}
    .drawerLabel{font-weight:900;margin:0 0 8px}
    .drawerList{display:flex;flex-direction:column;gap:8px}
    .linkRow{
      padding:10px 10px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      cursor:pointer;
    }
    .linkRow:hover{filter:brightness(1.08)}
    .mini{font-size:12px;color:var(--muted);font-weight:800}

    .note{
      padding:10px 10px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-weight:800;font-size:12px;line-height:1.5;
    }
    .note.err{background:rgba(225,29,72,.18);border-color:rgba(225,29,72,.45);color:#fff}
    .note.ok{background:rgba(34,197,94,.14);border-color:rgba(34,197,94,.35);color:#fff}
    .note.warn{background:rgba(245,158,11,.14);border-color:rgba(245,158,11,.35);color:#fff}

    .modal{position:fixed;inset:0;display:none;z-index:95;align-items:center;justify-content:center;padding:14px}
    .modal.show{display:flex}
    .modalBox{
      width:min(760px, 96vw);
      background:rgba(14,24,59,.94);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHeader{
      padding:12px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .modalTitle{font-weight:900}
    .modalBody{padding:12px}
    .stack{display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .row .tight{flex:0 0 auto}

    .input{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
    }
    .select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
      font-weight:900;
    }

    /* Cart */
    .cartItem{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .cartLeft{display:flex;gap:10px;flex:1}
    .cartThumb{
      width:54px;height:54px;border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      overflow:hidden;
      flex:0 0 auto;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:11px;opacity:.95;
    }
    .cartThumb img{width:100%;height:100%;object-fit:cover}
    .cartName{font-weight:900;font-size:13px;margin:0 0 4px}
    .cartMeta{margin:0;color:var(--muted);font-size:12px;font-weight:800}
    .qtyRow{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .qtyBtn{
      width:34px;height:34px;border-radius:10px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
    }
    .qtyNum{min-width:34px;text-align:center;font-weight:900}
    .removeBtn{
      border:1px solid rgba(225,29,72,.35);
      background:rgba(225,29,72,.12);
      color:rgba(246,247,255,.95);
      font-weight:900;cursor:pointer;
      padding:8px 10px;border-radius:10px;
      white-space:nowrap;
    }
    .detailsBtn{
      border:1px solid rgba(56,189,248,.35);
      background:rgba(56,189,248,.10);
      color:rgba(246,247,255,.95);
      font-weight:900;cursor:pointer;
      padding:8px 10px;border-radius:10px;
      white-space:nowrap;
    }
    .totalBar{
      margin-top:10px;
      border:1px solid rgba(56,189,248,.35);
      background:rgba(56,189,248,.10);
      border-radius:14px;
      padding:10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      cursor:pointer;
      user-select:none;
    }

    /* Details Gallery */
    .galleryBig{
      width:100%;
      height:220px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;letter-spacing:.7px;
      position:relative;
    }
    .galleryBig img{width:100%;height:100%;object-fit:cover;display:block}
    .galleryRow{display:flex;gap:10px;flex-wrap:wrap}
    .gThumb{
      width:74px;height:54px;border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;font-weight:900;font-size:11px;color:rgba(246,247,255,.9);
    }
    .gThumb img{width:100%;height:100%;object-fit:cover;display:block}
    .gThumb.active{border-color:rgba(56,189,248,.55);background:rgba(56,189,248,.10)}

    /* Footer */
    .footer{
      margin-top:18px;border-top:1px solid var(--border);
      padding:14px 0 22px;
      color:var(--muted);
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }
    .social{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      font-weight:900;font-size:12px;
    }
    .social:hover{filter:brightness(1.08)}
  </style>
</head>

<body>
  <div class="nav">
    <div class="container nav-inner">
      <div class="brand">
        <span class="dot"></span>
        <span id="brandText">Medo Gaming Store</span>
        <span class="ramadanPill" id="ramadanPill"><span class="lantern"></span><span id="ramadanText">ÿ±ŸÖÿ∂ÿßŸÜ ŸÉÿ±ŸäŸÖ</span></span>
      </div>

      <div class="searchWrap">
        <input id="search" class="search" placeholder="üîç ÿßÿ®ÿ≠ÿ´..." />
        <button class="iconBtn" id="filterBtn" title="Filter">
          <span style="display:inline-block;line-height:0">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M4 6h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M7 12h13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M10 18h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M4 3h10" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".75"/>
            </svg>
          </span>
        </button>
      </div>

      <div class="rightBox">
        <button class="iconBtn" id="inboxBtn" title="Inbox">üîî <span class="pillCount" id="inboxCount">0</span></button>
        <button class="iconBtn" id="gemsBtn" title="Bonus">üíé <span class="pillCount" id="gemsCount">0</span></button>
        <button class="iconBtn" id="cartBtn" title="Cart">üõí <span class="pillCount" id="cartCount">0</span></button>

        <button class="iconBtn" id="authBtn" title="Account">üë§ <span id="authText">ÿ™ÿ≥ÿ¨ŸäŸÑ</span></button>

        <div class="userChip" id="userChip" style="display:none" title="User">
          <span class="avatarSmall" id="avatarSmall">U</span>
          <span id="userNameText">User</span>
        </div>

        <button class="iconBtn" id="menuBtn" title="Menu">‚ò∞</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="sectionTitle" id="titleTop">üî• Top <span class="sectionHint" id="hintTop">ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ∑ŸÑÿ®Ÿãÿß</span></div>
    <div id="gridTop" class="grid"></div>

    <div class="spacer"></div>

    <div class="sectionTitle" id="titleOffers">üéÅ Offers <span class="sectionHint" id="hintOffers">ÿπÿ±Ÿàÿ∂</span></div>
    <div id="gridOffers" class="grid"></div>

    <div class="spacer"></div>

    <div class="sectionTitle" id="titleGames">üéÆ Games</div>
    <div id="gridGames" class="grid"></div>

    <div class="spacer"></div>

    <div class="sectionTitle" id="titlePrograms">üíª Programs</div>
    <div id="gridPrograms" class="grid"></div>

    <div class="spacer"></div>

    <div class="sectionTitle" id="titleAccounts">üßæ Accounts</div>
    <div id="gridAccounts" class="grid"></div>

    <div class="footer" id="footer">
      <a class="social" href="https://wa.me/201006760663" target="_blank" rel="noreferrer" id="waLink">WhatsApp</a>
      <a class="social" href="https://www.instagram.com/medo__rami" target="_blank" rel="noreferrer" id="igLink">Instagram</a>
      <a class="social" href="https://www.facebook.com/share/1AScQqiSqq/" target="_blank" rel="noreferrer" id="fbLink">Facebook</a>
      <a class="social" href="mailto:medorami77@gmail.com" id="mailLink">Email</a>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <!-- MENU DRAWER -->
  <div class="drawer" id="menuDrawer" aria-hidden="true">
    <div class="drawerHeader">
      <div class="drawerTitle" id="menuTitle">Menu</div>
      <button class="iconBtn" id="menuClose">‚úï</button>
    </div>
    <div class="drawerBody">
      <div class="drawerSection" id="drawerUserBox" style="display:none">
        <div class="note ok" id="drawerUserNote"></div>
        <div class="row">
          <button class="btn" id="editProfileBtn">Edit profile</button>
          <button class="btn" id="changePassBtn">Change password</button>
        </div>
        <div class="row">
          <button class="btn btnRed" id="logoutBtn">Logout</button>
        </div>
      </div>

      <div class="drawerSection">
        <p class="drawerLabel" id="quickLabel">Quick</p>
        <div class="drawerList">
          <div class="linkRow" data-scroll="gridTop"><span id="mTop">Top</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" data-scroll="gridOffers"><span id="mOffers">Offers</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" data-scroll="gridGames"><span id="mGames">Games</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" data-scroll="gridPrograms"><span id="mPrograms">Programs</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" data-scroll="gridAccounts"><span id="mAccounts">Accounts</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" id="openContactRow"><span id="mContact">Contact</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" id="openReviewsRow"><span id="mReviews">Reviews</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" id="openInboxRow"><span id="mInbox">Inbox</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" id="openBonusRow"><span id="mBonus">Bonus</span><span class="mini">‚Üí</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- FILTER DRAWER -->
  <div class="drawer" id="filterDrawer" aria-hidden="true">
    <div class="drawerHeader">
      <div class="drawerTitle" id="filterTitle">Filter</div>
      <button class="iconBtn" id="filterClose">‚úï</button>
    </div>
    <div class="drawerBody">
      <div class="note" id="filterNote">ÿßÿÆÿ™ÿßÿ± ÿßŸÑŸÇÿ≥ŸÖ ŸàÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ŸàÿßŸÑÿ≥ÿπÿ± Ÿàÿ®ÿπÿØŸäŸÜ ÿ™ÿ∑ÿ®ŸäŸÇ.</div>

      <div class="drawerSection">
        <p class="drawerLabel" id="filterCatLbl">Category</p>
        <select class="select" id="filterCategory">
          <option value="all" id="catAll">All</option>
          <option value="games" id="catGames">Games</option>
          <option value="programs" id="catPrograms">Programs</option>
          <option value="accounts" id="catAccounts">Accounts</option>
        </select>
      </div>

      <div class="drawerSection">
        <p class="drawerLabel" id="filterSortLbl">Sort</p>
        <select class="select" id="filterSort">
          <option value="new" id="sNew">Newest</option>
          <option value="old" id="sOld">Oldest</option>
          <option value="low" id="sLow">Low ‚Üí High</option>
          <option value="high" id="sHigh">High ‚Üí Low</option>
        </select>
      </div>

      <div class="drawerSection">
        <p class="drawerLabel" id="filterPriceLbl">Price</p>
        <div class="row">
          <select class="select" id="priceMode">
            <option value="off" id="pOff">Off</option>
            <option value="eq" id="pEq">Equal</option>
            <option value="lte" id="pLte">‚â§</option>
            <option value="gte" id="pGte">‚â•</option>
          </select>
          <input class="input" id="priceValue" type="number" min="0" placeholder="ŸÖÿ´ŸÑÿßŸã 300" />
        </div>
      </div>

      <button class="btn btnRed" id="applyFilterBtn">Apply</button>
    </div>
  </div>

  <!-- CONTACT MODAL -->
  <div class="modal" id="contactModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="contactTitle">Contact</div>
        <button class="iconBtn" id="contactClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <a class="btn" href="https://wa.me/201006760663" target="_blank" id="contactWA">WhatsApp</a>
          <a class="btn" href="https://www.instagram.com/medo__rami" target="_blank" id="contactIG">Instagram</a>
          <a class="btn" href="https://www.facebook.com/share/1AScQqiSqq/" target="_blank" id="contactFB">Facebook</a>
          <a class="btn" href="mailto:medorami77@gmail.com" id="contactMail">Email</a>
        </div>
      </div>
    </div>
  </div>

  <!-- REVIEWS MODAL -->
  <div class="modal" id="reviewsModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="reviewsTitle">Reviews</div>
        <button class="iconBtn" id="reviewsClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="row">
            <input class="input" id="reviewText" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ£ŸäŸÉ..." />
            <button class="btn btnRed tight" id="addReviewBtn" style="flex:0 0 auto">Post</button>
          </div>
          <div class="stack" id="reviewsList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- INBOX MODAL -->
  <div class="modal" id="inboxModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="inboxTitle">Inbox</div>
        <button class="iconBtn" id="inboxClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack" id="inboxList"></div>
      </div>
    </div>
  </div>

  <!-- BONUS MODAL -->
  <div class="modal" id="bonusModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="bonusTitle">Bonus (Gems)</div>
        <button class="iconBtn" id="bonusClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="note ok" id="bonusNote"></div>
          <div class="note" id="bonusHint"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- AUTH MODAL (Login/Register Step by Step) -->
  <div class="modal" id="authModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="authTitle">Account</div>
        <button class="iconBtn" id="authClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="row" style="margin-bottom:10px">
          <button class="btn btnBlue" id="tabLogin">Login</button>
          <button class="btn btnRed" id="tabRegister">Create account</button>
        </div>

        <!-- LOGIN -->
        <div class="stack" id="loginBox">
          <input class="input" id="loginEmail" type="email" placeholder="Email" />
          <div class="row">
            <input class="input" id="loginPass" type="password" placeholder="Password" />
            <button class="iconBtn" id="loginEye" style="flex:0 0 auto" title="Show/Hide">üëÅ</button>
          </div>
          <button class="btn btnRed" id="doLogin">Login</button>
          <div class="note err" id="loginErr" style="display:none"></div>
        </div>

        <!-- REGISTER STEPS -->
        <div class="stack" id="registerBox" style="display:none">
          <!-- step 1 -->
          <div class="stack" data-step="1">
            <input class="input" id="firstName" placeholder="First name" />
            <input class="input" id="lastName" placeholder="Last name" />
            <button class="btn btnRed" id="rNext1">Next</button>
          </div>

          <!-- step 2 -->
          <div class="stack" data-step="2" style="display:none">
            <input class="input" id="regEmail" type="email" placeholder="Email" />
            <div class="row">
              <input class="input" id="regPass" type="password" placeholder="Password" />
              <button class="iconBtn" id="regEye" style="flex:0 0 auto" title="Show/Hide">üëÅ</button>
            </div>
            <div class="row">
              <button class="btn" id="rBack2">Back</button>
              <button class="btn btnRed" id="rNext2">Next</button>
            </div>
          </div>

          <!-- step 3 -->
          <div class="stack" data-step="3" style="display:none">
            <select class="select" id="regGender">
              <option value="">Gender</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
            <input class="input" id="regAge" type="number" min="1" placeholder="Age" />
            <div class="row">
              <button class="btn" id="rBack3">Back</button>
              <button class="btn btnRed" id="rNext3">Next</button>
            </div>
          </div>

          <!-- step 4 -->
          <div class="stack" data-step="4" style="display:none">
            <input class="input" id="regPhoto" type="file" accept="image/*" />
            <button class="btn btnRed" id="saveAccount">Save</button>
            <button class="btn" id="rBack4">Back</button>
            <div class="note err" id="regErr" style="display:none"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- EDIT PROFILE MODAL -->
  <div class="modal" id="profileModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="profileTitle">Edit profile</div>
        <button class="iconBtn" id="profileClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="row">
            <input class="input" id="editFirst" placeholder="First name" />
            <input class="input" id="editLast" placeholder="Last name" />
          </div>
          <div class="row">
            <select class="select" id="editGender">
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
            <input class="input" id="editAge" type="number" min="1" placeholder="Age" />
          </div>
          <input class="input" id="editPhoto" type="file" accept="image/*" />
          <button class="btn btnRed" id="saveProfile">Save</button>
          <div class="note ok" id="profileOk" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- CHANGE PASSWORD MODAL -->
  <div class="modal" id="passModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="passTitle">Change password</div>
        <button class="iconBtn" id="passClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="row">
            <input class="input" id="oldPass" type="password" placeholder="Old password" />
            <button class="iconBtn" id="oldEye" style="flex:0 0 auto">üëÅ</button>
          </div>
          <div class="row">
            <input class="input" id="newPass" type="password" placeholder="New password" />
            <button class="iconBtn" id="newEye" style="flex:0 0 auto">üëÅ</button>
          </div>
          <button class="btn btnRed" id="savePass">Save</button>
          <div class="note err" id="passErr" style="display:none"></div>
          <div class="note ok" id="passOk" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- PRODUCT DETAILS MODAL -->
  <div class="modal" id="detailsModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="detailsTitle">Details</div>
        <button class="iconBtn" id="detailsClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="galleryBig" id="galleryBig"></div>
          <div class="galleryRow" id="galleryRow"></div>

          <div class="row">
            <div class="note ok" style="margin:0" id="detailsPrice"></div>
            <div class="note" style="margin:0" id="detailsRating"></div>
          </div>

          <div class="note" id="detailsDesc"></div>

          <div class="row">
            <button class="btn btnBlue" id="detailsAddCart">Add to cart</button>
            <button class="btn btnRed" id="detailsBuyNow">Buy</button>
          </div>

          <div class="note warn" id="rateHint"></div>
          <div class="row" id="rateRow">
            <button class="iconBtn" data-rate="1">‚≠ê</button>
            <button class="iconBtn" data-rate="2">‚≠ê</button>
            <button class="iconBtn" data-rate="3">‚≠ê</button>
            <button class="iconBtn" data-rate="4">‚≠ê</button>
            <button class="iconBtn" data-rate="5">‚≠ê</button>
          </div>
          <div class="note ok" id="rateOk" style="display:none"></div>
          <div class="note err" id="rateErr" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- CART MODAL -->
  <div class="modal" id="cartModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="cartTitle">Cart</div>
        <button class="iconBtn" id="cartClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack" id="cartList"></div>
        <div class="totalBar" id="totalBar">
          <span id="totalLabel">Total</span>
          <strong id="totalValue">0</strong>
        </div>
      </div>
    </div>
  </div>

  <!-- CHECKOUT MODAL (summary -> confirm -> payment methods) -->
  <div class="modal" id="checkoutModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="checkoutTitle">Checkout</div>
        <button class="iconBtn" id="checkoutClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack" id="checkoutStep1">
          <div class="note ok" id="checkoutSummary"></div>

          <div class="row">
            <input class="input" id="couponInput" placeholder="Coupon code" />
            <button class="btn btnBlue tight" id="applyCouponBtn" style="flex:0 0 auto">Apply</button>
          </div>
          <div class="note" id="couponMsg"></div>

          <button class="btn btnRed" id="confirmCheckoutBtn">Confirm</button>
        </div>

        <div class="stack" id="checkoutStep2" style="display:none">
          <div class="note ok" id="payHint"></div>

          <div class="stack">
            <button class="btn" id="payVodafone">Vodafone Cash</button>
            <button class="btn" id="payEtisalat">Etisalat Cash</button>
            <button class="btn" id="payOrange">Orange Cash</button>
            <button class="btn" id="payWe">WE Pay</button>
            <button class="btn" id="payInsta">InstaPay</button>
            <button class="btn" id="payCard">Visa / Card</button>
            <button class="btn" id="payBill">Bill Pay</button>
            <button class="btn" id="payTelda">Telda</button>
          </div>

          <div class="row">
            <button class="btn btnBlue" id="backToSummary">Back</button>
            <button class="btn btnRed" id="markPaidBtn">I Paid</button>
          </div>

          <div class="note ok" id="paidOk" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===========================
   Helpers
=========================== */
const $ = (id)=>document.getElementById(id);
const show = (el)=>{ if(el) el.classList.add("show"); };
const hide = (el)=>{ if(el) el.classList.remove("show"); };
const fmtEGP = (n)=> `${Number(n||0).toFixed(0)} EGP`;

/* ===========================
   Language (Auto by device)
=========================== */
const deviceLang = (navigator.language || "en").toLowerCase().startsWith("ar") ? "ar" : "en";
document.documentElement.lang = deviceLang;
document.documentElement.dir  = deviceLang === "ar" ? "rtl" : "ltr";

const I18N = {
  ar:{
    brand:"Medo Gaming Store",
    ramadan:"ÿ±ŸÖÿ∂ÿßŸÜ ŸÉÿ±ŸäŸÖ",
    search:"üîç ÿßÿ®ÿ≠ÿ´...",
    top:"Top", topHint:"ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ∑ŸÑÿ®Ÿãÿß",
    offers:"Offers", offersHint:"ÿπÿ±Ÿàÿ∂",
    games:"Games",
    programs:"Programs",
    accounts:"Accounts",
    menu:"ÿßŸÑŸÇÿßÿ¶ŸÖÿ©",
    quick:"ÿ≥ÿ±Ÿäÿπ",
    contact:"ÿßŸÑÿ™ŸàÿßÿµŸÑ",
    reviews:"ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿßÿ™",
    inbox:"ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ",
    bonus:"ÿßŸÑÿ¨ŸàÿßŸáÿ±",
    filter:"ŸÅŸÑÿ™ÿ±ÿ©",
    filterNote:"ÿßÿÆÿ™ÿßÿ± ÿßŸÑŸÇÿ≥ŸÖ ŸàÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ŸàÿßŸÑÿ≥ÿπÿ± Ÿàÿ®ÿπÿØŸäŸÜ ÿ™ÿ∑ÿ®ŸäŸÇ.",
    category:"ÿßŸÑŸÇÿ≥ŸÖ",
    sort:"ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ®",
    price:"ÿßŸÑÿ≥ÿπÿ±",
    apply:"ÿ™ÿ∑ÿ®ŸäŸÇ",
    all:"ÿßŸÑŸÉŸÑ",
    newest:"ÿßŸÑÿ£ÿ≠ÿØÿ´",
    oldest:"ÿßŸÑÿ£ŸÇÿØŸÖ",
    lowHigh:"ŸÖŸÜ ÿßŸÑÿ£ÿ±ÿÆÿµ ŸÑŸÑÿ£ÿ∫ŸÑŸâ",
    highLow:"ŸÖŸÜ ÿßŸÑÿ£ÿ∫ŸÑŸâ ŸÑŸÑÿ£ÿ±ÿÆÿµ",
    off:"ÿ•ŸäŸÇÿßŸÅ",
    equal:"Ÿäÿ≥ÿßŸàŸä",
    total:"ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä",
    cart:"ÿßŸÑÿ≥ŸÑÿ©",
    details:"ÿ™ŸÅÿßÿµŸäŸÑ",
    addCart:"ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ≥ŸÑÿ©",
    buy:"ÿ¥ÿ±ÿßÿ°",
    login:"ÿ™ÿ≥ÿ¨ŸäŸÑ",
    account:"ÿßŸÑÿ≠ÿ≥ÿßÿ®",
    create:"ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®",
    first:"ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ£ŸàŸÑ",
    last:"ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ´ÿßŸÜŸä",
    email:"ÿßŸÑÿ®ÿ±ŸäÿØ",
    pass:"ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±",
    gender:"ÿßŸÑŸÜŸàÿπ",
    male:"ÿ∞ŸÉÿ±",
    female:"ÿ£ŸÜÿ´Ÿâ",
    age:"ÿßŸÑÿπŸÖÿ±",
    save:"ÿ≠ŸÅÿ∏",
    next:"ÿßŸÑÿ™ÿßŸÑŸä",
    back:"ÿ±ÿ¨Ÿàÿπ",
    logout:"ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨",
    editProfile:"ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®",
    changePass:"ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±",
    oldPass:"ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ÿßŸÑŸÇÿØŸäŸÖÿ©",
    newPass:"ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ©",
    post:"ŸÜÿ¥ÿ±",
    writeReview:"ÿßŸÉÿ™ÿ® ÿ±ÿ£ŸäŸÉ...",
    needLogin:"ŸÑÿßÿ≤ŸÖ ÿ™ÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ ÿßŸÑÿ£ŸàŸÑ",
    emailUsed:"ÿßŸÑÿ®ÿ±ŸäÿØ ÿØŸá ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÇÿ®ŸÑ ŸÉÿØŸá",
    wrongLogin:"ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿØÿÆŸàŸÑ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©",
    saved:"ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏",
    passChanged:"ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±",
    wrongOld:"ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ÿßŸÑŸÇÿØŸäŸÖÿ© ÿ∫ŸÑÿ∑",
    rateHint:"ŸÇŸäŸëŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨ (ŸÑÿßÿ≤ŸÖ ÿ≠ÿ≥ÿßÿ®):",
    rated:"ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ™ŸÇŸäŸäŸÖŸÉ ‚úÖ",
    coupon:"ŸÉŸàÿØ ÿßŸÑÿÆÿµŸÖ",
    couponApplied:"ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿÆÿµŸÖ ‚úÖ",
    couponBad:"ŸÉŸàÿØ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ ÿ£Ÿà ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÇÿ®ŸÑ ŸÉÿØŸá",
    checkout:"ÿßŸÑÿØŸÅÿπ",
    confirm:"ÿ™ÿ£ŸÉŸäÿØ",
    payMethods:"ÿ∑ÿ±ŸÇ ÿßŸÑÿØŸÅÿπ",
    paid:"ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ© ‚úÖ",
    bonusHint:"ÿßŸÑÿ¨ŸàÿßŸáÿ± ÿ®ÿ™ÿ≤ŸäÿØ ÿ®ÿπÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿπŸÖŸÑŸäÿ© ÿ¥ÿ±ÿßÿ°.",
    gemsCount:(n)=>`ÿ¨ŸàÿßŸáÿ±ŸÉ: ${n}`,
    cartEmpty:"ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ∂Ÿäÿ©",
    inboxEmpty:"ŸÖŸÅŸäÿ¥ ÿ±ÿ≥ÿßÿ¶ŸÑ",
    reviewSaved:"ÿ™ŸÖ ŸÜÿ¥ÿ± ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ© ‚úÖ"
  },
  en:{
    brand:"Medo Gaming Store",
    ramadan:"Ramadan Kareem",
    search:"üîç Search...",
    top:"Top", topHint:"Most requested",
    offers:"Offers", offersHint:"Deals",
    games:"Games",
    programs:"Programs",
    accounts:"Accounts",
    menu:"Menu",
    quick:"Quick",
    contact:"Contact",
    reviews:"Reviews",
    inbox:"Inbox",
    bonus:"Bonus",
    filter:"Filter",
    filterNote:"Pick category, sort, price then apply.",
    category:"Category",
    sort:"Sort",
    price:"Price",
    apply:"Apply",
    all:"All",
    newest:"Newest",
    oldest:"Oldest",
    lowHigh:"Low ‚Üí High",
    highLow:"High ‚Üí Low",
    off:"Off",
    equal:"Equal",
    total:"Total",
    cart:"Cart",
    details:"Details",
    addCart:"Add to cart",
    buy:"Buy",
    login:"Sign in",
    account:"Account",
    create:"Create account",
    first:"First name",
    last:"Last name",
    email:"Email",
    pass:"Password",
    gender:"Gender",
    male:"Male",
    female:"Female",
    age:"Age",
    save:"Save",
    next:"Next",
    back:"Back",
    logout:"Logout",
    editProfile:"Edit profile",
    changePass:"Change password",
    oldPass:"Old password",
    newPass:"New password",
    post:"Post",
    writeReview:"Write your review...",
    needLogin:"Please login first",
    emailUsed:"Email already exists",
    wrongLogin:"Wrong email or password",
    saved:"Saved",
    passChanged:"Password changed",
    wrongOld:"Old password is wrong",
    rateHint:"Rate this product (login required):",
    rated:"Your rating is saved ‚úÖ",
    coupon:"Coupon code",
    couponApplied:"Coupon applied ‚úÖ",
    couponBad:"Invalid or already used coupon",
    checkout:"Checkout",
    confirm:"Confirm",
    payMethods:"Payment methods",
    paid:"Order recorded ‚úÖ",
    bonusHint:"Gems increase after recording a purchase.",
    gemsCount:(n)=>`Your gems: ${n}`,
    cartEmpty:"Cart is empty",
    inboxEmpty:"No messages",
    reviewSaved:"Review posted ‚úÖ"
  }
};
const T = (k,...args)=>{
  const v = I18N[deviceLang][k];
  return (typeof v === "function") ? v(...args) : (v ?? k);
};

/* Apply language texts */
(function applyLang(){
  $("brandText").textContent = T("brand");
  $("ramadanText").textContent = T("ramadan");
  $("search").placeholder = T("search");

  $("titleTop").childNodes[0].textContent = "üî• " + T("top") + " ";
  $("hintTop").textContent = T("topHint");

  $("titleOffers").childNodes[0].textContent = "üéÅ " + T("offers") + " ";
  $("hintOffers").textContent = T("offersHint");

  $("titleGames").textContent = "üéÆ " + T("games");
  $("titlePrograms").textContent = "üíª " + T("programs");
  $("titleAccounts").textContent = "üßæ " + T("accounts");

  $("authText").textContent = T("login");

  $("menuTitle").textContent = T("menu");
  $("quickLabel").textContent = T("quick");
  $("mTop").textContent = T("top");
  $("mOffers").textContent = T("offers");
  $("mGames").textContent = T("games");
  $("mPrograms").textContent = T("programs");
  $("mAccounts").textContent = T("accounts");
  $("mContact").textContent = T("contact");
  $("mReviews").textContent = T("reviews");
  $("mInbox").textContent = T("inbox");
  $("mBonus").textContent = T("bonus");

  $("filterTitle").textContent = T("filter");
  $("filterNote").textContent = T("filterNote");
  $("filterCatLbl").textContent = T("category");
  $("filterSortLbl").textContent = T("sort");
  $("filterPriceLbl").textContent = T("price");
  $("applyFilterBtn").textContent = T("apply");
  $("catAll").textContent = T("all");
  $("catGames").textContent = T("games");
  $("catPrograms").textContent = T("programs");
  $("catAccounts").textContent = T("accounts");
  $("sNew").textContent = T("newest");
  $("sOld").textContent = T("oldest");
  $("sLow").textContent = T("lowHigh");
  $("sHigh").textContent = T("highLow");
  $("pOff").textContent = T("off");
  $("pEq").textContent = T("equal");

  $("contactTitle").textContent = T("contact");
  $("reviewsTitle").textContent = T("reviews");
  $("inboxTitle").textContent = T("inbox");
  $("bonusTitle").textContent = T("bonus");
  $("cartTitle").textContent = T("cart");
  $("checkoutTitle").textContent = T("checkout");
  $("detailsTitle").textContent = T("details");

  $("reviewText").placeholder = T("writeReview");
  $("addReviewBtn").textContent = T("post");

  $("tabLogin").textContent = T("login");
  $("tabRegister").textContent = T("create");

  $("loginEmail").placeholder = T("email");
  $("loginPass").placeholder = T("pass");
  $("doLogin").textContent = T("login");

  $("firstName").placeholder = T("first");
  $("lastName").placeholder = T("last");
  $("rNext1").textContent = T("next");

  $("regEmail").placeholder = T("email");
  $("regPass").placeholder = T("pass");
  $("rBack2").textContent = T("back");
  $("rNext2").textContent = T("next");

  $("regGender").options[0].textContent = T("gender");
  $("regGender").options[1].textContent = T("male");
  $("regGender").options[2].textContent = T("female");
  $("regAge").placeholder = T("age");
  $("rBack3").textContent = T("back");
  $("rNext3").textContent = T("next");

  $("saveAccount").textContent = T("save");
  $("rBack4").textContent = T("back");

  $("editProfileBtn").textContent = T("editProfile");
  $("changePassBtn").textContent = T("changePass");
  $("logoutBtn").textContent = T("logout");

  $("profileTitle").textContent = T("editProfile");
  $("editFirst").placeholder = T("first");
  $("editLast").placeholder = T("last");
  $("editGender").options[0].textContent = T("male");
  $("editGender").options[1].textContent = T("female");
  $("editAge").placeholder = T("age");
  $("saveProfile").textContent = T("save");

  $("passTitle").textContent = T("changePass");
  $("oldPass").placeholder = T("oldPass");
  $("newPass").placeholder = T("newPass");
  $("savePass").textContent = T("save");

  $("detailsAddCart").textContent = T("addCart");
  $("detailsBuyNow").textContent = T("buy");
  $("rateHint").textContent = T("rateHint");

  $("totalLabel").textContent = T("total");
  $("couponInput").placeholder = T("coupon");
  $("applyCouponBtn").textContent = T("apply");
  $("confirmCheckoutBtn").textContent = T("confirm");
  $("payHint").textContent = T("payMethods");
  $("backToSummary").textContent = T("back");
  $("markPaidBtn").textContent = (deviceLang==="ar" ? "ÿ™ŸÖ ÿßŸÑÿØŸÅÿπ" : "I Paid");

  $("bonusHint").textContent = T("bonusHint");
})();
$("ramadanPill").style.display = "inline-flex";

/* ===========================
   Local Storage keys
=========================== */
const LS_USERS   = "mg_users_v1";
const LS_SESSION = "mg_session_v1";
const LS_CART    = "mg_cart_v1";
const LS_REVIEWS = "mg_reviews_v1";
const LS_INBOX   = "mg_inbox_v1";
const LS_RATINGS = "mg_ratings_v1";
const LS_USED_COUPONS = "mg_used_coupons_v1";
const LS_ORDERS  = "mg_orders_v1";

/* ===========================
   Data helpers
=========================== */
function jget(key, fallback){
  try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
  catch{ return fallback; }
}
function jset(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

function loadUsers(){ return jget(LS_USERS, {}); }
function saveUsers(u){ jset(LS_USERS, u); }
function getSession(){ return jget(LS_SESSION, null); }
function setSession(s){ jset(LS_SESSION, s); }
function clearSession(){ localStorage.removeItem(LS_SESSION); }

function loadCart(){ return jget(LS_CART, []); }
function saveCart(c){ jset(LS_CART, c); }

function loadInbox(){ return jget(LS_INBOX, []); }
function saveInbox(x){ jset(LS_INBOX, x); }

function loadReviews(){ return jget(LS_REVIEWS, []); }
function saveReviews(x){ jset(LS_REVIEWS, x); }

function loadRatings(){ return jget(LS_RATINGS, {}); }
function saveRatings(r){ jset(LS_RATINGS, r); }

function loadUsedCoupons(){ return jget(LS_USED_COUPONS, {}); }
function saveUsedCoupons(x){ jset(LS_USED_COUPONS, x); }

function loadOrders(){ return jget(LS_ORDERS, []); }
function saveOrders(x){ jset(LS_ORDERS, x); }

/* ===========================
   Coupons (NOT visible)
   Your codes:
   MG1..MG10 => 10%
   MZ1..MZ10 => 20%
   MK1..MK10 => 30%
   MC1..MC10 => 40%
   MA1..MA10 => 50%
   MB1..MB10 => 60%
   ME1..ME10 => 70%
   MX1..MX10 => 80%
   MR1..MR10 => 90%
   MI1..MI10 => 100%
=========================== */
function couponPercent(code){
  const c = (code||"").trim().toUpperCase();
  const map = {
    MG:10, MZ:20, MK:30, MC:40, MA:50, MB:60, ME:70, MX:80, MR:90, MI:100
  };
  const prefix = c.slice(0,2);
  const num = Number(c.slice(2));
  if(!map[prefix]) return 0;
  if(!(num>=1 && num<=10)) return 0;
  return map[prefix];
}

/* ===========================
   Products (Edit here only)
   Put your images in /img/
=========================== */
const PRODUCTS = [
  // Top
  {id:"top_01", section:"top", category:"games", name:"Top Game 1", price:300, desc:"ŸàÿµŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸáŸÜÿß...", images:["img/sample1.jpg","img/sample2.jpg"], createdAt: Date.now()-100000},
  {id:"top_02", section:"top", category:"accounts", name:"Top Account 1", price:600, desc:"ŸàÿµŸÅ ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸáŸÜÿß...", images:["img/sample2.jpg"], createdAt: Date.now()-200000},

  // Offers
  {id:"off_01", section:"offers", category:"programs", name:"Offer Program 1", price:150, desc:"ŸàÿµŸÅ ÿßŸÑÿ®ÿ±ŸÜÿßŸÖÿ¨ ŸáŸÜÿß...", images:["img/sample3.jpg"], createdAt: Date.now()-300000},

  // Games
  {id:"g_01", section:"games", category:"games", name:"Game 1", price:200, desc:"ŸàÿµŸÅ ÿßŸÑŸÑÿπÿ®ÿ© ŸáŸÜÿß...", images:["img/sample1.jpg"], createdAt: Date.now()-400000},
  {id:"g_02", section:"games", category:"games", name:"Game 2", price:450, desc:"ŸàÿµŸÅ ÿßŸÑŸÑÿπÿ®ÿ© ŸáŸÜÿß...", images:["img/sample2.jpg"], createdAt: Date.now()-500000},

  // Programs
  {id:"p_01", section:"programs", category:"programs", name:"Program 1", price:120, desc:"ŸàÿµŸÅ ÿßŸÑÿ®ÿ±ŸÜÿßŸÖÿ¨ ŸáŸÜÿß...", images:["img/sample3.jpg"], createdAt: Date.now()-600000},

  // Accounts
  {id:"a_pubg_01", section:"accounts", category:"accounts", name:"PUBG Account", price:700, desc:"ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸáŸÜÿß (ÿ≥ŸÉŸäŸÜÿßÿ™/ŸÖÿ≥ÿ™ŸàŸâ/ÿßŸÑÿÆ)...", images:["img/sample2.jpg","img/sample1.jpg"], createdAt: Date.now()-700000},
  {id:"a_steam_01", section:"accounts", category:"accounts", name:"Steam Account", price:900, desc:"ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸáŸÜÿß...", images:["img/sample1.jpg"], createdAt: Date.now()-800000},
];

/* ===========================
   Overlay / Drawers / Modals
=========================== */
const overlay = $("overlay");
const menuDrawer = $("menuDrawer");
const filterDrawer = $("filterDrawer");

function openOverlay(){ show(overlay); }
function closeOverlay(){ hide(overlay); }
function closeAll(){
  closeOverlay();
  hide(menuDrawer);
  hide(filterDrawer);
}
overlay.addEventListener("click", closeAll);

$("menuBtn").addEventListener("click", ()=>{
  openOverlay();
  show(menuDrawer);
});
$("menuClose").addEventListener("click", closeAll);

$("filterBtn").addEventListener("click", ()=>{
  openOverlay();
  show(filterDrawer);
});
$("filterClose").addEventListener("click", closeAll);

document.querySelectorAll(".linkRow[data-scroll]").forEach(r=>{
  r.addEventListener("click", ()=>{
    closeAll();
    const id = r.getAttribute("data-scroll");
    const el = $(id);
    if(el) el.scrollIntoView({behavior:"smooth"});
  });
});

/* Modals helpers */
function openModal(id){ const m=$(id); if(m){ show(m); } }
function closeModal(id){ const m=$(id); if(m){ hide(m); } }

$("contactClose").onclick = ()=> closeModal("contactModal");
$("reviewsClose").onclick = ()=> closeModal("reviewsModal");
$("inboxClose").onclick = ()=> closeModal("inboxModal");
$("bonusClose").onclick = ()=> closeModal("bonusModal");
$("authClose").onclick = ()=> closeModal("authModal");
$("profileClose").onclick = ()=> closeModal("profileModal");
$("passClose").onclick = ()=> closeModal("passModal");
$("detailsClose").onclick = ()=> closeModal("detailsModal");
$("cartClose").onclick = ()=> closeModal("cartModal");
$("checkoutClose").onclick = ()=> closeModal("checkoutModal");

$("openContactRow").onclick = ()=>{ closeAll(); openModal("contactModal"); };
$("openReviewsRow").onclick = ()=>{ closeAll(); openModal("reviewsModal"); renderReviews(); };
$("openInboxRow").onclick = ()=>{ closeAll(); openModal("inboxModal"); renderInbox(); };
$("openBonusRow").onclick = ()=>{ closeAll(); openModal("bonusModal"); renderBonus(); };

/* ===========================
   Session + UI
=========================== */
function currentUser(){
  const s = getSession();
  if(!s || !s.email) return null;
  const users = loadUsers();
  return users[s.email] ? users[s.email] : null;
}
function requireLogin(){
  openModal("authModal");
  $("loginErr").style.display="block";
  $("loginErr").textContent = T("needLogin");
}

function refreshUserUI(){
  const u = currentUser();
  if(u){
    $("authBtn").style.display = "none";
    $("userChip").style.display = "inline-flex";
    $("userNameText").textContent = `${u.firstName} ${u.lastName}`;
    if(u.photo){
      $("avatarSmall").innerHTML = `<img src="${u.photo}" alt="avatar">`;
    }else{
      $("avatarSmall").textContent = (u.firstName?.[0] || "U").toUpperCase();
    }
    $("drawerUserBox").style.display = "block";
    $("drawerUserNote").textContent = `${u.firstName} ${u.lastName} ‚Ä¢ ${u.email}`;
    $("gemsCount").textContent = u.gems || 0;
  }else{
    $("authBtn").style.display = "inline-flex";
    $("userChip").style.display = "none";
    $("authText").textContent = T("login");
    $("drawerUserBox").style.display = "none";
    $("gemsCount").textContent = 0;
  }
}

/* user chip click opens menu */
$("userChip").onclick = ()=>{
  openOverlay();
  show(menuDrawer);
};

/* ===========================
   Auth (Login/Register)
=========================== */
function setAuthTab(tab){
  if(tab==="login"){
    $("loginBox").style.display="flex";
    $("loginBox").style.flexDirection="column";
    $("registerBox").style.display="none";
    $("tabLogin").classList.add("btnRed");
    $("tabLogin").classList.remove("btnBlue");
    $("tabRegister").classList.add("btnBlue");
    $("tabRegister").classList.remove("btnRed");
  }else{
    $("loginBox").style.display="none";
    $("registerBox").style.display="flex";
    $("registerBox").style.flexDirection="column";
    $("tabRegister").classList.add("btnRed");
    $("tabRegister").classList.remove("btnBlue");
    $("tabLogin").classList.add("btnBlue");
    $("tabLogin").classList.remove("btnRed");
    showRegisterStep(1);
  }
  $("loginErr").style.display="none";
  $("regErr").style.display="none";
}
$("tabLogin").onclick = ()=> setAuthTab("login");
$("tabRegister").onclick = ()=> setAuthTab("register");

$("authBtn").onclick = ()=>{ setAuthTab("login"); openModal("authModal"); };

function toggleEye(inputId){
  const i = $(inputId);
  if(!i) return;
  i.type = (i.type==="password") ? "text" : "password";
}
$("loginEye").onclick = ()=> toggleEye("loginPass");
$("regEye").onclick = ()=> toggleEye("regPass");

$("doLogin").onclick = ()=>{
  const email = ($("loginEmail").value||"").trim().toLowerCase();
  const pass = ($("loginPass").value||"");
  const users = loadUsers();
  if(!users[email] || users[email].password !== pass){
    $("loginErr").style.display="block";
    $("loginErr").textContent = T("wrongLogin");
    return;
  }
  setSession({email});
  closeModal("authModal");
  pushInbox(email, (deviceLang==="ar"?"ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ":"Logged in"));
  refreshUserUI();
};

function showRegisterStep(n){
  document.querySelectorAll("#registerBox [data-step]").forEach(el=>{
    el.style.display = (el.getAttribute("data-step")==String(n)) ? "flex" : "none";
    if(el.style.display==="flex") el.style.flexDirection="column";
  });
}
$("rNext1").onclick = ()=> showRegisterStep(2);
$("rBack2").onclick = ()=> showRegisterStep(1);
$("rNext2").onclick = ()=> showRegisterStep(3);
$("rBack3").onclick = ()=> showRegisterStep(2);
$("rNext3").onclick = ()=> showRegisterStep(4);
$("rBack4").onclick = ()=> showRegisterStep(3);

$("saveAccount").onclick = async ()=>{
  const firstName = ($("firstName").value||"").trim();
  const lastName  = ($("lastName").value||"").trim();
  const email     = ($("regEmail").value||"").trim().toLowerCase();
  const password  = ($("regPass").value||"");
  const gender    = ($("regGender").value||"");
  const age       = Number($("regAge").value||0);
  const photoFile = $("regPhoto").files?.[0] || null;

  if(!firstName || !lastName || !email || !password || !gender || !age){
    $("regErr").style.display="block";
    $("regErr").textContent = T("needLogin"); // ŸÜŸÅÿ≥ ŸÖÿπŸÜŸâ "ÿßŸÖŸÑÿ£ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™"
    $("regErr").textContent = (deviceLang==="ar" ? "ÿßŸÖŸÑÿ£ ŸÉŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©" : "Fill all required fields");
    return;
  }

  const users = loadUsers();
  if(users[email]){
    $("regErr").style.display="block";
    $("regErr").textContent = T("emailUsed");
    return;
  }

  let photoData = "";
  if(photoFile){
    photoData = await new Promise((resolve)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(String(r.result||""));
      r.readAsDataURL(photoFile);
    });
  }

  users[email] = {
    firstName,lastName,email,password,gender,age,
    photo: photoData,
    gems: 0,
    createdAt: Date.now()
  };
  saveUsers(users);

  setSession({email});
  closeModal("authModal");
  pushInbox(email, (deviceLang==="ar"?"ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ®":"Account created"));
  refreshUserUI();
};

/* Logout / profile / password */
$("logoutBtn").onclick = ()=>{
  const u = currentUser();
  if(u){ pushInbox(u.email, (deviceLang==="ar"?"ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨":"Logged out")); }
  clearSession();
  refreshUserUI();
};

$("editProfileBtn").onclick = ()=>{
  const u = currentUser();
  if(!u){ requireLogin(); return; }
  $("editFirst").value = u.firstName;
  $("editLast").value  = u.lastName;
  $("editGender").value= u.gender;
  $("editAge").value   = u.age;
  $("profileOk").style.display="none";
  closeAll();
  openModal("profileModal");
};

$("saveProfile").onclick = async ()=>{
  const u = currentUser();
  if(!u){ requireLogin(); return; }
  const users = loadUsers();
  const email = u.email;

  const firstName = ($("editFirst").value||"").trim();
  const lastName  = ($("editLast").value||"").trim();
  const gender    = ($("editGender").value||"");
  const age       = Number($("editAge").value||0);
  const photoFile = $("editPhoto").files?.[0] || null;

  if(!firstName || !lastName || !gender || !age) return;

  let photoData = users[email].photo || "";
  if(photoFile){
    photoData = await new Promise((resolve)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(String(r.result||""));
      r.readAsDataURL(photoFile);
    });
  }

  users[email] = {...users[email], firstName,lastName,gender,age,photo:photoData};
  saveUsers(users);
  $("profileOk").style.display="block";
  $("profileOk").textContent = T("saved");
  refreshUserUI();
};

$("changePassBtn").onclick = ()=>{
  const u = currentUser();
  if(!u){ requireLogin(); return; }
  $("passErr").style.display="none";
  $("passOk").style.display="none";
  $("oldPass").value="";
  $("newPass").value="";
  closeAll();
  openModal("passModal");
};
$("oldEye").onclick = ()=> toggleEye("oldPass");
$("newEye").onclick = ()=> toggleEye("newPass");

$("savePass").onclick = ()=>{
  const u = currentUser();
  if(!u){ requireLogin(); return; }
  const users = loadUsers();
  const email = u.email;

  const oldP = $("oldPass").value||"";
  const newP = $("newPass").value||"";
  if(users[email].password !== oldP){
    $("passErr").style.display="block";
    $("passErr").textContent = T("wrongOld");
    return;
  }
  if(!newP || newP.length < 4){
    $("passErr").style.display="block";
    $("passErr").textContent = (deviceLang==="ar"?"ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ŸÇÿµŸäÿ±ÿ©":"Password too short");
    return;
  }
  users[email].password = newP;
  saveUsers(users);
  $("passErr").style.display="none";
  $("passOk").style.display="block";
  $("passOk").textContent = T("passChanged");
  pushInbox(email, (deviceLang==="ar"?"ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±":"Password changed"));
};

/* ===========================
   Inbox / Reviews
=========================== */
function pushInbox(email, msg){
  const inbox = loadInbox();
  inbox.unshift({email, msg, at: Date.now()});
  saveInbox(inbox);
  updateInboxCount();
}
function updateInboxCount(){
  const u = currentUser();
  const inbox = loadInbox();
  const mine = u ? inbox.filter(x=>x.email===u.email) : [];
  $("inboxCount").textContent = mine.length;
}
function renderInbox(){
  const list = $("inboxList");
  list.innerHTML = "";
  const u = currentUser();
  const inbox = loadInbox();
  const mine = u ? inbox.filter(x=>x.email===u.email) : [];
  if(!u){
    list.innerHTML = `<div class="note warn">${T("needLogin")}</div>`;
    return;
  }
  if(mine.length===0){
    list.innerHTML = `<div class="note">${T("inboxEmpty")}</div>`;
    return;
  }
  mine.slice(0,30).forEach(it=>{
    const d = new Date(it.at);
    const row = document.createElement("div");
    row.className="note";
    row.textContent = `${it.msg} ‚Ä¢ ${d.toLocaleString()}`;
    list.appendChild(row);
  });
}

$("inboxBtn").onclick = ()=>{
  openModal("inboxModal");
  renderInbox();
};

$("addReviewBtn").onclick = ()=>{
  const text = ($("reviewText").value||"").trim();
  if(!text) return;
  const u = currentUser();
  const name = u ? `${u.firstName} ${u.lastName}` : (deviceLang==="ar"?"ÿ≤ÿßÿ¶ÿ±":"Guest");
  const reviews = loadReviews();
  reviews.unshift({name, text, at: Date.now()});
  saveReviews(reviews);
  $("reviewText").value="";
  renderReviews();
};
function renderReviews(){
  const list = $("reviewsList");
  list.innerHTML="";
  const reviews = loadReviews();
  if(reviews.length===0){
    list.innerHTML = `<div class="note">${deviceLang==="ar"?"ŸÖŸÅŸäÿ¥ ŸÖÿ±ÿßÿ¨ÿπÿßÿ™ ŸÑÿ≥Ÿá":"No reviews yet"}</div>`;
    return;
  }
  reviews.slice(0,25).forEach(r=>{
    const d = new Date(r.at);
    const row = document.createElement("div");
    row.className="note";
    row.innerHTML = `<strong>${r.name}</strong><div style="height:6px"></div>${r.text}<div style="height:6px"></div><span style="opacity:.8;font-size:12px">${d.toLocaleString()}</span>`;
    list.appendChild(row);
  });
}

/* ===========================
   Bonus / Gems
=========================== */
$("gemsBtn").onclick = ()=>{
  openModal("bonusModal");
  renderBonus();
};
function renderBonus(){
  const u = currentUser();
  if(!u){
    $("bonusNote").className="note warn";
    $("bonusNote").textContent = T("needLogin");
    $("bonusHint").textContent = "";
    return;
  }
  $("bonusNote").className="note ok";
  $("bonusNote").textContent = T("gemsCount")(u.gems||0);
  $("bonusHint").textContent = T("bonusHint");
}

/* ===========================
   Ratings (1-5 stars) - requires login
   Stored per product: {productId:{sum,count,byUser:{email:stars}}}
=========================== */
function getProductRating(pid){
  const ratings = loadRatings();
  const r = ratings[pid] || {sum:0,count:0,byUser:{}};
  const avg = r.count ? (r.sum/r.count) : 0;
  return {avg,count:r.count};
}
function setUserRating(pid, stars){
  const u = currentUser();
  if(!u) return {ok:false, msg:T("needLogin")};
  const ratings = loadRatings();
  ratings[pid] = ratings[pid] || {sum:0,count:0,byUser:{}};
  const r = ratings[pid];
  const prev = r.byUser[u.email];
  if(prev){
    // update
    r.sum = r.sum - prev + stars;
    r.byUser[u.email] = stars;
  }else{
    r.sum += stars;
    r.count += 1;
    r.byUser[u.email] = stars;
  }
  saveRatings(ratings);
  return {ok:true};
}
function starsHTML(avg){
  const full = Math.round(avg); // simple
  let html = "";
  for(let i=1;i<=5;i++){
    html += `<span class="s ${i<=full?"on":""}">‚≠ê</span>`;
  }
  return html;
}

/* ===========================
   Render products
=========================== */
let currentFilter = {category:"all", sort:"new", priceMode:"off", priceValue:0};
let currentDetails = null;

function renderAll(){
  renderSection("gridTop",   PRODUCTS.filter(p=>p.section==="top"));
  renderSection("gridOffers",PRODUCTS.filter(p=>p.section==="offers"));
  renderSection("gridGames", PRODUCTS.filter(p=>p.section==="games"));
  renderSection("gridPrograms",PRODUCTS.filter(p=>p.section==="programs"));
  renderSection("gridAccounts",PRODUCTS.filter(p=>p.section==="accounts"));
  updateCartCount();
  updateInboxCount();
  refreshUserUI();
}

function passSearch(p){
  const q = ($("search").value||"").trim().toLowerCase();
  if(!q) return true;
  return (p.name||"").toLowerCase().includes(q) || (p.desc||"").toLowerCase().includes(q);
}

function passFilter(p){
  // category filter
  if(currentFilter.category !== "all"){
    if(p.category !== currentFilter.category) return false;
  }
  // price filter
  const m = currentFilter.priceMode;
  const v = Number(currentFilter.priceValue||0);
  if(m==="eq" && p.price !== v) return false;
  if(m==="lte" && !(p.price <= v)) return false;
  if(m==="gte" && !(p.price >= v)) return false;
  return true;
}

function sortProducts(arr){
  const s = currentFilter.sort;
  const a = [...arr];
  if(s==="new") a.sort((x,y)=>(y.createdAt||0)-(x.createdAt||0));
  if(s==="old") a.sort((x,y)=>(x.createdAt||0)-(y.createdAt||0));
  if(s==="low") a.sort((x,y)=>(x.price||0)-(y.price||0));
  if(s==="high") a.sort((x,y)=>(y.price||0)-(x.price||0));
  return a;
}

function renderSection(gridId, items){
  const grid = $(gridId);
  grid.innerHTML = "";

  let list = items.filter(passSearch).filter(passFilter);
  list = sortProducts(list);

  list.forEach(p=>{
    const {avg,count} = getProductRating(p.id);
    const card = document.createElement("div");
    card.className="card";

    const thumb = document.createElement("div");
    thumb.className="thumb";
    const img0 = (p.images && p.images[0]) ? p.images[0] : "";
    if(img0){
      thumb.innerHTML = `<img src="${img0}" alt="">`;
    }else{
      thumb.textContent = "IMAGE";
    }

    // badges ONLY for top/offers section (correct)
    if(p.section==="top"){
      const b = document.createElement("div");
      b.className="badge top";
      b.textContent = T("top");
      thumb.appendChild(b);
    }
    if(p.section==="offers"){
      const b = document.createElement("div");
      b.className="badge offer";
      b.textContent = T("offers");
      thumb.appendChild(b);
    }

    const content = document.createElement("div");
    content.className="content";

    const name = document.createElement("p");
    name.className="name";
    name.textContent = p.name;

    const meta = document.createElement("p");
    meta.className="meta";
    meta.textContent = (p.desc||"").slice(0,80) + ((p.desc||"").length>80 ? "..." : "");

    const pr = document.createElement("div");
    pr.className="priceRow";
    pr.innerHTML = `<p class="price">${fmtEGP(p.price)}</p>`;

    const rr = document.createElement("div");
    rr.className="ratingRow";
    rr.innerHTML = `
      <div class="starsView">${starsHTML(avg)}</div>
      <div class="starsMini">${avg.toFixed(1)} (${count})</div>
    `;

    const actions = document.createElement("div");
    actions.className="actions";

    const detailsBtn = document.createElement("button");
    detailsBtn.className="btn btnBlue";
    detailsBtn.textContent = T("details");
    detailsBtn.onclick = ()=> openDetails(p.id);

    const addBtn = document.createElement("button");
    addBtn.className="btn";
    addBtn.textContent = T("addCart");
    addBtn.onclick = ()=> addToCart(p.id);

    const buyBtn = document.createElement("button");
    buyBtn.className="btn btnRed";
    buyBtn.textContent = T("buy");
    buyBtn.onclick = ()=> buyNow(p.id);

    actions.appendChild(detailsBtn);
    actions.appendChild(addBtn);
    actions.appendChild(buyBtn);

    content.appendChild(name);
    content.appendChild(rr);
    content.appendChild(meta);
    content.appendChild(pr);
    content.appendChild(actions);

    card.appendChild(thumb);
    card.appendChild(content);

    grid.appendChild(card);
  });
}

/* ===========================
   Details modal
=========================== */
function openDetails(pid){
  const p = PRODUCTS.find(x=>x.id===pid);
  if(!p) return;
  currentDetails = pid;

  // big image + thumbs
  const big = $("galleryBig");
  const row = $("galleryRow");
  row.innerHTML="";

  const imgs = (p.images && p.images.length) ? p.images : [];
  function setBig(src){
    if(src){
      big.innerHTML = `<img src="${src}" alt="">`;
    }else{
      big.textContent = "IMAGE";
    }
  }
  setBig(imgs[0]||"");

  imgs.forEach((src, idx)=>{
    const t = document.createElement("div");
    t.className = "gThumb" + (idx===0 ? " active" : "");
    t.innerHTML = `<img src="${src}" alt="">`;
    t.onclick = ()=>{
      document.querySelectorAll(".gThumb").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      setBig(src);
    };
    row.appendChild(t);
  });

  $("detailsPrice").textContent = fmtEGP(p.price);
  const r = getProductRating(pid);
  $("detailsRating").textContent = `${r.avg.toFixed(1)} (${r.count})`;
  $("detailsDesc").textContent = p.desc || "";

  $("rateOk").style.display="none";
  $("rateErr").style.display="none";

  openModal("detailsModal");
}

$("detailsAddCart").onclick = ()=>{ if(currentDetails) addToCart(currentDetails); };
$("detailsBuyNow").onclick = ()=>{ if(currentDetails) buyNow(currentDetails); };

document.querySelectorAll("#rateRow .iconBtn").forEach(btn=>{
  btn.onclick = ()=>{
    const pid = currentDetails;
    if(!pid) return;
    const stars = Number(btn.getAttribute("data-rate")||0);
    if(!currentUser()){
      $("rateErr").style.display="block";
      $("rateErr").textContent = T("needLogin");
      $("rateOk").style.display="none";
      return;
    }
    const res = setUserRating(pid, stars);
    if(res.ok){
      $("rateOk").style.display="block";
      $("rateOk").textContent = T("rated");
      $("rateErr").style.display="none";
      renderAll(); // update stars everywhere
      const r = getProductRating(pid);
      $("detailsRating").textContent = `${r.avg.toFixed(1)} (${r.count})`;
    }
  };
});

/* ===========================
   Cart
=========================== */
function updateCartCount(){
  const cart = loadCart();
  const count = cart.reduce((a,x)=>a+(x.qty||1),0);
  $("cartCount").textContent = count;
}

function addToCart(pid){
  const cart = loadCart();
  const i = cart.find(x=>x.id===pid);
  if(i) i.qty += 1;
  else cart.push({id:pid, qty:1});
  saveCart(cart);
  updateCartCount();
}

function cartTotal(){
  const cart = loadCart();
  let total = 0;
  cart.forEach(it=>{
    const p = PRODUCTS.find(x=>x.id===it.id);
    if(p) total += (p.price||0) * (it.qty||1);
  });
  return total;
}

function renderCart(){
  const list = $("cartList");
  list.innerHTML="";
  const cart = loadCart();
  if(cart.length===0){
    list.innerHTML = `<div class="note">${T("cartEmpty")}</div>`;
    $("totalValue").textContent = fmtEGP(0);
    return;
  }

  cart.forEach(it=>{
    const p = PRODUCTS.find(x=>x.id===it.id);
    if(!p) return;
    const img0 = p.images?.[0] || "";

    const item = document.createElement("div");
    item.className="cartItem";

    const left = document.createElement("div");
    left.className="cartLeft";

    const th = document.createElement("div");
    th.className="cartThumb";
    th.innerHTML = img0 ? `<img src="${img0}" alt="">` : "IMG";

    const info = document.createElement("div");
    info.style.flex="1";
    info.innerHTML = `
      <p class="cartName">${p.name}</p>
      <p class="cartMeta">${fmtEGP(p.price)} ‚Ä¢ ${deviceLang==="ar"?"ÿßŸÑŸÉŸÖŸäÿ©":"Qty"}: ${it.qty}</p>
      <div class="qtyRow">
        <button class="qtyBtn">-</button>
        <span class="qtyNum">${it.qty}</span>
        <button class="qtyBtn">+</button>
        <button class="detailsBtn">${T("details")}</button>
        <button class="removeBtn">${deviceLang==="ar"?"ÿ≠ÿ∞ŸÅ":"Remove"}</button>
      </div>
    `;

    const btnMinus = info.querySelectorAll(".qtyBtn")[0];
    const btnPlus  = info.querySelectorAll(".qtyBtn")[1];
    const btnDetails = info.querySelector(".detailsBtn");
    const btnRemove  = info.querySelector(".removeBtn");

    btnMinus.onclick = ()=>{
      const c = loadCart();
      const x = c.find(z=>z.id===it.id);
      if(!x) return;
      x.qty -= 1;
      if(x.qty<=0){
        const idx = c.findIndex(z=>z.id===it.id);
        c.splice(idx,1);
      }
      saveCart(c);
      renderCart();
      updateCartCount();
    };
    btnPlus.onclick = ()=>{
      const c = loadCart();
      const x = c.find(z=>z.id===it.id);
      if(x) x.qty += 1;
      saveCart(c);
      renderCart();
      updateCartCount();
    };
    btnRemove.onclick = ()=>{
      const c = loadCart().filter(z=>z.id!==it.id);
      saveCart(c);
      renderCart();
      updateCartCount();
    };
    btnDetails.onclick = ()=> openDetails(it.id);

    left.appendChild(th);
    left.appendChild(info);

    item.appendChild(left);
    list.appendChild(item);
  });

  $("totalValue").textContent = fmtEGP(cartTotal());
}

$("cartBtn").onclick = ()=>{
  openModal("cartModal");
  renderCart();
};

$("totalBar").onclick = ()=>{
  // checkout from cart
  startCheckoutFromCart();
};

/* ===========================
   Checkout / Payment
=========================== */
let checkoutItems = []; // [{id,qty}]
let appliedCoupon = {code:"", percent:0, discount:0};

function startCheckoutFromCart(){
  const cart = loadCart();
  if(cart.length===0){
    openModal("cartModal");
    renderCart();
    return;
  }
  checkoutItems = cart.map(x=>({id:x.id, qty:x.qty||1}));
  openCheckout();
}
function buyNow(pid){
  // buy single product
  checkoutItems = [{id:pid, qty:1}];
  openCheckout();
}

function openCheckout(){
  const u = currentUser();
  if(!u){ requireLogin(); return; }

  appliedCoupon = {code:"", percent:0, discount:0};
  $("couponInput").value="";
  $("couponMsg").textContent="";
  $("checkoutStep1").style.display="flex";
  $("checkoutStep1").style.flexDirection="column";
  $("checkoutStep2").style.display="none";
  $("paidOk").style.display="none";

  updateCheckoutSummary();
  openModal("checkoutModal");
}

function itemsSubtotal(){
  let sub = 0;
  checkoutItems.forEach(it=>{
    const p = PRODUCTS.find(x=>x.id===it.id);
    if(p) sub += (p.price||0)*(it.qty||1);
  });
  return sub;
}

function updateCheckoutSummary(){
  const sub = itemsSubtotal();
  const disc = appliedCoupon.discount || 0;
  const total = Math.max(0, sub - disc);

  const lines = checkoutItems.map(it=>{
    const p = PRODUCTS.find(x=>x.id===it.id);
    if(!p) return "";
    return `‚Ä¢ ${p.name} √ó ${it.qty} = ${fmtEGP((p.price||0)*(it.qty||1))}`;
  }).join("\n");

  $("checkoutSummary").textContent =
    (deviceLang==="ar"
      ? `ŸÖŸÑÿÆÿµ ÿßŸÑÿ∑ŸÑÿ®:\n${lines}\n\nÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: ${fmtEGP(sub)}\nÿßŸÑÿÆÿµŸÖ: ${fmtEGP(disc)}\nÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿ®ÿπÿØ ÿßŸÑÿÆÿµŸÖ: ${fmtEGP(total)}`
      : `Order summary:\n${lines}\n\nSubtotal: ${fmtEGP(sub)}\nDiscount: ${fmtEGP(disc)}\nTotal: ${fmtEGP(total)}`
    );

  $("payHint").textContent = (deviceLang==="ar"
    ? `ÿ∑ÿ±ŸÇ ÿßŸÑÿØŸÅÿπ ‚Äî ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®: ${fmtEGP(total)}`
    : `Payment methods ‚Äî Amount: ${fmtEGP(total)}`
  );
}

$("applyCouponBtn").onclick = ()=>{
  const u = currentUser();
  if(!u){ requireLogin(); return; }

  const code = ($("couponInput").value||"").trim().toUpperCase();
  const pct = couponPercent(code);

  // used coupons are global (one-time) OR per user? You asked: once used, no one can use again
  const used = loadUsedCoupons();
  if(!pct || used[code]){
    $("couponMsg").textContent = T("couponBad");
    $("couponMsg").className="note err";
    appliedCoupon = {code:"", percent:0, discount:0};
    updateCheckoutSummary();
    return;
  }

  const sub = itemsSubtotal();
  const discount = Math.round(sub * (pct/100));

  appliedCoupon = {code, percent:pct, discount};
  $("couponMsg").textContent = `${T("couponApplied")} (${pct}%)`;
  $("couponMsg").className="note ok";
  updateCheckoutSummary();
};

$("confirmCheckoutBtn").onclick = ()=>{
  $("checkoutStep1").style.display="none";
  $("checkoutStep2").style.display="flex";
  $("checkoutStep2").style.flexDirection="column";
};

/* Payment buttons (open external / placeholder) */
function openPayLink(name){
  // You can change links later safely
  // For cash: open WhatsApp with message
  const u = currentUser();
  const total = Math.max(0, itemsSubtotal() - (appliedCoupon.discount||0));
  const msg = encodeURIComponent(
    (deviceLang==="ar"
      ? `ÿπÿßŸäÿ≤ ÿ£ÿØŸÅÿπ (${name}) ‚Äî ÿßŸÑŸÖÿ®ŸÑÿ∫: ${total} ÿ¨ŸÜŸäŸá ‚Äî ÿ≠ÿ≥ÿßÿ®Ÿä: ${u.email}`
      : `Payment (${name}) ‚Äî Amount: ${total} EGP ‚Äî My account: ${u.email}`
    )
  );
  window.open(`https://wa.me/201006760663?text=${msg}`, "_blank");
}
$("payVodafone").onclick = ()=> openPayLink("Vodafone Cash");
$("payEtisalat").onclick = ()=> openPayLink("Etisalat Cash");
$("payOrange").onclick = ()=> openPayLink("Orange Cash");
$("payWe").onclick = ()=> openPayLink("WE Pay");
$("payInsta").onclick = ()=> openPayLink("InstaPay");
$("payCard").onclick = ()=> openPayLink("Visa/Card");
$("payBill").onclick = ()=> openPayLink("Bill Pay");
$("payTelda").onclick = ()=> openPayLink("Telda");

$("backToSummary").onclick = ()=>{
  $("checkoutStep2").style.display="none";
  $("checkoutStep1").style.display="flex";
  $("checkoutStep1").style.flexDirection="column";
};

$("markPaidBtn").onclick = ()=>{
  const u = currentUser();
  if(!u){ requireLogin(); return; }

  // mark coupon as used (one-time globally)
  if(appliedCoupon.code){
    const used = loadUsedCoupons();
    used[appliedCoupon.code] = {at:Date.now(), by:u.email};
    saveUsedCoupons(used);
  }

  // record operation (private)
  const sub = itemsSubtotal();
  const disc = appliedCoupon.discount || 0;
  const total = Math.max(0, sub - disc);

  const orders = loadOrders();
  orders.unshift({
    id: "ord_" + Math.random().toString(16).slice(2) + "_" + Date.now(),
    email: u.email,
    items: checkoutItems,
    subtotal: sub,
    discount: disc,
    total: total,
    coupon: appliedCoupon.code || "",
    at: Date.now()
  });
  saveOrders(orders);

  // reward gems (balanced)
  // every 100 EGP => 1 gem (you can change later)
  const users = loadUsers();
  const gained = Math.max(1, Math.floor(total/100));
  users[u.email].gems = (users[u.email].gems||0) + gained;
  saveUsers(users);

  pushInbox(u.email, deviceLang==="ar"
    ? `ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ¥ÿ±ÿßÿ° ÿ®ŸÇŸäŸÖÿ© ${total} ÿ¨ŸÜŸäŸá (+${gained} ÿ¨ŸàŸáÿ±ÿ©)`
    : `Purchase recorded: ${total} EGP (+${gained} gem)`
  );

  // if checkout from cart -> clear cart
  const cartIds = loadCart().map(x=>x.id);
  const checkoutIds = checkoutItems.map(x=>x.id);
  // if they match by set (simple) we clear, else leave
  const same = cartIds.length && cartIds.every(id=>checkoutIds.includes(id));
  if(same){
    saveCart([]);
    updateCartCount();
    if($("cartModal").classList.contains("show")){
      renderCart();
    }
  }

  $("paidOk").style.display="block";
  $("paidOk").textContent = T("paid");

  refreshUserUI();
  renderAll();
};

/* ===========================
   Filter apply
=========================== */
$("applyFilterBtn").onclick = ()=>{
  currentFilter.category = $("filterCategory").value;
  currentFilter.sort = $("filterSort").value;
  currentFilter.priceMode = $("priceMode").value;
  currentFilter.priceValue = Number($("priceValue").value||0);
  closeAll();
  renderAll();
};

/* Search */
$("search").addEventListener("input", ()=> renderAll());

/* ===========================
   Init
=========================== */
window.addEventListener("load", ()=>{
  // start clean UI
  hide(menuDrawer);
  hide(filterDrawer);
  hide(overlay);

  // counts
  updateCartCount();
  updateInboxCount();
  refreshUserUI();

  // Bonus note
  $("bonusHint").textContent = T("bonusHint");

  // render
  renderAll();
});

/* ===========================
   Buttons open modals
=========================== */
$("reviewsClose").onclick = ()=> closeModal("reviewsModal");
$("reviewsModal").addEventListener("click", (e)=>{ if(e.target=== $("reviewsModal")) closeModal("reviewsModal"); });
$("contactModal").addEventListener("click", (e)=>{ if(e.target=== $("contactModal")) closeModal("contactModal"); });
$("inboxModal").addEventListener("click", (e)=>{ if(e.target=== $("inboxModal")) closeModal("inboxModal"); });
$("bonusModal").addEventListener("click", (e)=>{ if(e.target=== $("bonusModal")) closeModal("bonusModal"); });
$("authModal").addEventListener("click", (e)=>{ if(e.target=== $("authModal")) closeModal("authModal"); });
$("profileModal").addEventListener("click", (e)=>{ if(e.target=== $("profileModal")) closeModal("profileModal"); });
$("passModal").addEventListener("click", (e)=>{ if(e.target=== $("passModal")) closeModal("passModal"); });
$("detailsModal").addEventListener("click", (e)=>{ if(e.target=== $("detailsModal")) closeModal("detailsModal"); });
$("cartModal").addEventListener("click", (e)=>{ if(e.target=== $("cartModal")) closeModal("cartModal"); });
$("checkoutModal").addEventListener("click", (e)=>{ if(e.target=== $("checkoutModal")) closeModal("checkoutModal"); });

</script>
</body>
</html>
