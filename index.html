
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Medo Gaming Store</title>

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1230;
      --panel:#0E183B;
      --card:#0C1736;
      --text:#F6F7FF;
      --muted:#B9C1D9;
      --border:rgba(255,255,255,.10);
      --accent:#E11D48;
      --accent2:#38BDF8;
      --good:#22C55E;
      --warn:#F59E0B;

      --radius:14px;
      --radius2:12px;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Segoe UI", Tahoma, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 15% 8%, rgba(56,189,248,.16), transparent 60%),
        radial-gradient(900px 600px at 85% 0%, rgba(225,29,72,.14), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:1200px;margin:0 auto;padding:10px 12px}

    /* Header */
    .nav{
      position:sticky;top:0;z-index:50;
      background:rgba(7,10,18,.72);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .nav-inner{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight:900;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:0 0 0 4px rgba(56,189,248,.10);
    }
    .searchWrap{flex:1;min-width:220px;display:flex;align-items:center;gap:8px}
    .search{
      flex:1;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
    }
    .iconBtn{
      display:inline-flex;align-items:center;justify-content:center;
      gap:8px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .iconBtn:hover{filter:brightness(1.08)}
    .rightBox{margin-inline-start:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pillCount{
      min-width:22px;height:22px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;
      background:rgba(56,189,248,.16);
      border:1px solid rgba(56,189,248,.35);
      font-weight:900;font-size:12px;padding:0 6px;
    }
    .pillRed{
      background:rgba(225,29,72,.16);
      border-color:rgba(225,29,72,.35);
    }
    .userChip{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 10px;border-radius:999px;
      border:1px solid rgba(56,189,248,.35);
      background:rgba(56,189,248,.10);
      cursor:pointer;
      white-space:nowrap;
      font-weight:900;font-size:13px;
    }
    .avatarMini{
      width:24px;height:24px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      overflow:hidden;
      display:inline-flex;align-items:center;justify-content:center;
      font-weight:900;font-size:12px;
    }
    .avatarMini img{width:100%;height:100%;object-fit:cover;display:block}

    /* Titles */
    .sectionTitle{
      margin:18px 0 8px;
      font-size:15px;font-weight:900;
      display:flex;align-items:center;gap:10px;
    }
    .sectionHint{color:var(--muted);font-weight:800;font-size:12px}
    .spacer{height:14px}

    /* Grid */
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media (max-width:1050px){ .grid{grid-template-columns:repeat(3,1fr);} }
    @media (max-width:760px){ .grid{grid-template-columns:repeat(2,1fr);} }
    @media (max-width:460px){ .grid{grid-template-columns:1fr;} }

    .card{
      background:rgba(12,23,54,.72);
      border:1px solid var(--border);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      display:flex;flex-direction:column;
      min-height:240px;
    }
    .thumb{
      height:112px;
      border-bottom:1px solid var(--border);
      position:relative;
      overflow:hidden;
      background:rgba(255,255,255,.03);
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block;filter:saturate(1.05)}
    .tag{
      position:absolute;top:10px;inset-inline-start:10px;
      padding:6px 10px;border-radius:999px;
      font-size:11px;font-weight:900;
      border:1px solid var(--border);
      background:rgba(0,0,0,.25);
      color:rgba(246,247,255,.92);
      backdrop-filter: blur(6px);
    }
    .content{
      padding:10px 10px 12px;
      display:flex;flex-direction:column;gap:8px;flex:1;
    }
    .name{margin:0;font-size:13px;font-weight:900}
    .meta{margin:0;font-size:12px;color:var(--muted);line-height:1.45}
    .priceRow{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .price{margin:0;font-size:12px;font-weight:900}
    .badge{
      padding:5px 9px;border-radius:999px;
      border:1px solid rgba(56,189,248,.35);
      background:rgba(56,189,248,.10);
      font-size:11px;font-weight:900;
      white-space:nowrap;
    }
    .badgeOffer{
      border-color:rgba(225,29,72,.35);
      background:rgba(225,29,72,.10);
    }
    .actions{display:flex;gap:8px;margin-top:auto;flex-wrap:wrap}
    .btn{
      flex:1;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 10px;
      font-weight:900;font-size:12px;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      min-width:110px;
    }
    .btn:hover{filter:brightness(1.08)}
    .btnRed{
      background:linear-gradient(135deg, rgba(225,29,72,1), rgba(225,29,72,.82));
      border-color: transparent;
    }
    .btnCyan{
      background:rgba(56,189,248,.12);
      border-color:rgba(56,189,248,.35);
    }

    /* Overlay / Drawer / Modal */
    .overlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.58);
      display:none;z-index:80;
    }
    .overlay.show{display:block}

    .drawer{
      position:fixed;top:0;bottom:0;
      width:min(360px, 92vw);
      background:rgba(14,24,59,.92);
      backdrop-filter: blur(10px);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      z-index:90;
      transition: transform .22s ease;
      display:flex;flex-direction:column;
    }
    .drawerHeader{
      padding:12px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .drawerTitle{font-weight:900}
    .drawerBody{padding:12px; overflow:auto}
    .drawerSection{margin:10px 0 16px}
    .drawerLabel{font-weight:900;margin:0 0 8px}
    .drawerList{display:flex;flex-direction:column;gap:8px}
    .linkRow{
      padding:10px 10px;border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      cursor:pointer;
    }
    .linkRow:hover{filter:brightness(1.08)}
    .mini{font-size:12px;color:var(--muted);font-weight:800}

    .modal{
      position:fixed;inset:0;
      display:none;z-index:95;
      align-items:center;justify-content:center;
      padding:14px;
    }
    .modal.show{display:flex}
    .modalBox{
      width:min(560px, 96vw);
      background:rgba(14,24,59,.94);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHeader{
      padding:12px 12px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .modalTitle{font-weight:900}
    .modalBody{padding:12px}
    .stack{display:flex;flex-direction:column;gap:10px}

    .input, .select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
      font-weight:900;
    }
    .note{
      padding:10px 10px;border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-weight:800;font-size:12px;line-height:1.5;
    }
    .err{color:#fff;background:rgba(225,29,72,.18);border-color:rgba(225,29,72,.45)}
    .ok{color:#fff;background:rgba(34,197,94,.14);border-color:rgba(34,197,94,.35)}
    .warn{color:#fff;background:rgba(245,158,11,.14);border-color:rgba(245,158,11,.35)}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .tight{flex:0 0 auto}

    /* Cart items */
    .cartItem{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .cartLeft{display:flex;gap:10px;flex:1}
    .cartThumb{
      width:62px;height:62px;border-radius:12px;
      overflow:hidden;border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      flex:0 0 auto;
    }
    .cartThumb img{width:100%;height:100%;object-fit:cover;display:block}
    .cartName{font-weight:900;font-size:13px;margin:0 0 4px}
    .cartMeta{margin:0;color:var(--muted);font-size:12px;font-weight:800}
    .qtyRow{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .qtyBtn{
      width:34px;height:34px;border-radius:10px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      color:var(--text);
      font-weight:900;cursor:pointer;
    }
    .qtyNum{min-width:34px;text-align:center;font-weight:900}
    .smallBtn{
      border:none;
      color:rgba(246,247,255,.95);
      font-weight:900;
      cursor:pointer;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      white-space:nowrap;
      font-size:12px;
    }
    .removeBtn{
      border-color:rgba(225,29,72,.35);
      background:rgba(225,29,72,.12);
    }
    .totalBar{
      margin-top:10px;
      border:1px solid rgba(56,189,248,.35);
      background:rgba(56,189,248,.10);
      border-radius:14px;
      padding:10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      cursor:pointer;
      user-select:none;
    }
    .totalBar strong{font-size:13px}
    .totalBar span{font-size:12px;color:rgba(246,247,255,.90);font-weight:900}

    /* Details gallery */
    .galleryMain{
      width:100%;
      height:220px;
      border-radius:14px;
      border:1px solid var(--border);
      overflow:hidden;
      background:rgba(255,255,255,.03);
    }
    .galleryMain img{width:100%;height:100%;object-fit:cover;display:block}
    .thumbRow{display:flex;gap:8px;flex-wrap:wrap}
    .gThumb{
      width:68px;height:48px;border-radius:12px;
      border:1px solid var(--border);
      overflow:hidden;background:rgba(255,255,255,.03);
      cursor:pointer;
    }
    .gThumb img{width:100%;height:100%;object-fit:cover;display:block}
    .gThumb.active{outline:2px solid rgba(56,189,248,.55)}
    .lightboxBox{
      width:min(920px, 96vw);
      background:rgba(14,24,59,.94);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .lightImgWrap{
      position:relative;
      background:#000;
      height:min(70vh, 620px);
    }
    .lightImgWrap img{width:100%;height:100%;object-fit:contain;display:block}
    .navArrow{
      position:absolute;top:50%;
      transform:translateY(-50%);
      width:44px;height:44px;border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.08);
      color:#fff;font-weight:900;cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      user-select:none;
    }
    .navArrow:hover{filter:brightness(1.1)}
    .navPrev{inset-inline-start:12px}
    .navNext{inset-inline-end:12px}

    /* Payment mini modal */
    .miniModalBox{
      width:min(420px, 94vw);
      background:rgba(14,24,59,.96);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .payList{display:flex;flex-direction:column;gap:10px}
    .payBtn{
      width:100%;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:12px 12px;
      font-weight:900;
      cursor:pointer;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .payBtn:hover{filter:brightness(1.08)}
    .payLeft{display:flex;align-items:center;gap:10px}
    .payIcon{
      width:34px;height:34px;border-radius:12px;
      display:inline-flex;align-items:center;justify-content:center;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      font-weight:900;
      font-size:12px;
    }

    /* Footer */
    .footer{
      margin-top:18px;
      border-top:1px solid var(--border);
      padding:14px 0 22px;
      color:var(--muted);
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }
    .social{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      font-weight:900;font-size:12px;
    }
    .social:hover{filter:brightness(1.08)}

    /* Tabs */
    .tabs{display:flex;gap:8px}
    .tab{
      flex:1;
      padding:10px 10px;border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      font-weight:900;cursor:pointer;
      text-align:center;
      user-select:none;
    }
    .tab.active{
      border-color:rgba(56,189,248,.45);
      background:rgba(56,189,248,.10);
    }

    /* Reviews */
    textarea.input{min-height:110px;resize:vertical}
  </style>
</head>

<body>
  <div class="nav">
    <div class="container nav-inner">
      <div class="brand">
        <span class="dot"></span>
        <span id="brandText">Medo Gaming Store</span>
      </div>

      <div class="searchWrap">
        <input id="search" class="search" />
        <!-- Filter icon (3 lines + top line) -->
        <button class="iconBtn" id="filterBtn" title="Filter">
          <span style="display:inline-block;line-height:0">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M4 6h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M7 12h13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M10 18h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M4 3h10" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".75"/>
            </svg>
          </span>
        </button>
      </div>

      <div class="rightBox">
        <button class="iconBtn" id="gemsBtn" title="Bonus">
          üíé <span class="pillCount" id="gemsCount">0</span>
        </button>

        <button class="iconBtn" id="notifBtn" title="Notifications">
          üîî <span class="pillCount pillRed" id="notifCount">0</span>
        </button>

        <button class="iconBtn" id="cartBtn" title="Cart">
          üõí <span class="pillCount" id="cartCount">0</span>
        </button>

        <button class="iconBtn" id="authBtn" title="Login">
          üë§ <span id="authText">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</span>
        </button>

        <div class="userChip" id="userChip" style="display:none" title="Account">
          <span class="avatarMini" id="avatarMini">
            <span id="avatarLetter">M</span>
          </span>
          <span id="userNameText">User</span>
        </div>

        <!-- Menu -->
        <button class="iconBtn" id="menuBtn" title="Menu">‚ò∞</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="sectionTitle" id="topTitle">üî• Top <span class="sectionHint" id="topHint">ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ∑ŸÑÿ®Ÿãÿß</span></div>
    <div id="gridTop" class="grid"></div>

    <div class="spacer"></div>

    <div class="sectionTitle" id="offersTitle">üéÅ Offers <span class="sectionHint" id="offersHint">ÿπÿ±Ÿàÿ∂</span></div>
    <div id="gridOffers" class="grid"></div>

    <div class="spacer" style="height:18px"></div>

    <div class="sectionTitle" id="gamesTitle">üéÆ ÿßŸÑÿ£ŸÑÿπÿßÿ®</div>
    <div id="gridGames" class="grid"></div>

    <div class="spacer"></div>

    <div class="sectionTitle" id="programsTitle">üíª ÿßŸÑÿ®ÿ±ÿßŸÖÿ¨</div>
    <div id="gridPrograms" class="grid"></div>

    <div class="spacer"></div>

    <div class="sectionTitle" id="accountsTitle">üßæ ÿßŸÑÿ£ŸÉŸàŸÜÿ™ÿßÿ™</div>
    <div id="gridAccounts" class="grid"></div>

    <div class="footer" id="contactSection">
      <a class="social" href="https://wa.me/201006760663" target="_blank" rel="noreferrer">WhatsApp</a>
      <a class="social" href="https://www.instagram.com/medo__rami" target="_blank" rel="noreferrer">Instagram</a>
      <a class="social" href="https://www.facebook.com/share/1AScQqiSqq/" target="_blank" rel="noreferrer">Facebook</a>
      <a class="social" href="mailto:medorami77@gmail.com">Email</a>
      <span style="margin-inline-start:auto;font-weight:900;font-size:12px;color:rgba(185,193,217,.9)">
        ¬© <span id="year"></span> Medo Gaming
      </span>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <!-- MENU DRAWER -->
  <div class="drawer" id="menuDrawer" aria-hidden="true">
    <div class="drawerHeader">
      <div class="drawerTitle" id="menuTitle">Menu</div>
      <button class="iconBtn" id="menuClose">‚úï</button>
    </div>
    <div class="drawerBody">
      <div class="drawerSection" id="drawerUserBox" style="display:none">
        <div class="note ok" id="drawerUserNote"></div>
        <div class="row">
          <button class="btn" id="accountBtn">Account</button>
          <button class="btn" id="logoutBtn">Logout</button>
        </div>
      </div>

      <div class="drawerSection">
        <p class="drawerLabel" id="drawerQuick">Quick</p>
        <div class="drawerList">
          <div class="linkRow" id="goTop"><span id="goTopText">Top</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" id="goOffers"><span id="goOffersText">Offers</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" id="goGames"><span id="goGamesText">Games</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" id="goPrograms"><span id="goProgramsText">Programs</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" id="goAccounts"><span id="goAccountsText">Accounts</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" id="goReviews"><span id="goReviewsText">Reviews</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" id="goContact"><span id="goContactText">Contact</span><span class="mini">‚Üí</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- FILTER DRAWER -->
  <div class="drawer" id="filterDrawer" aria-hidden="true">
    <div class="drawerHeader">
      <div class="drawerTitle" id="filterTitle">Filter</div>
      <button class="iconBtn" id="filterClose">‚úï</button>
    </div>
    <div class="drawerBody">
      <div class="drawerSection">
        <p class="drawerLabel" id="filterCategoryLabel">Category</p>
        <select class="select" id="filterCategory"></select>
      </div>

      <div class="drawerSection">
        <p class="drawerLabel" id="filterSortLabel">Sort</p>
        <select class="select" id="filterSort"></select>
      </div>

      <div class="drawerSection">
        <p class="drawerLabel" id="filterPriceLabel">Price</p>
        <div class="row">
          <select class="select" id="priceMode"></select>
          <input class="input" id="priceValue" type="number" min="0" />
        </div>
      </div>

      <button class="btn btnRed" id="applyFilterBtn">Apply</button>
      <div class="note" style="margin-top:10px" id="filterNote"></div>
    </div>
  </div>

  <!-- AUTH MODAL -->
  <div class="modal" id="authModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="authModalTitle">Account</div>
        <button class="iconBtn" id="authClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="tabs">
          <div class="tab active" id="tabLogin">Login</div>
          <div class="tab" id="tabSignup">Sign up</div>
        </div>

        <div class="stack" id="loginForm" style="margin-top:10px">
          <div class="note" id="loginNote"></div>
          <input class="input" id="loginEmail" type="email" />
          <input class="input" id="loginPass" type="password" />
          <button class="btn btnRed" id="loginBtn">Login</button>
          <div class="note err" id="loginErr" style="display:none"></div>
        </div>

        <div class="stack" id="signupForm" style="margin-top:10px;display:none">
          <div class="note" id="signupNote"></div>
          <input class="input" id="signupEmail" type="email" />
          <input class="input" id="signupPass" type="password" />
          <input class="input" id="signupName" type="text" />
          <input class="input" id="signupAge" type="number" min="1" max="120" />
          <div class="note">
            <div style="font-weight:900;margin-bottom:6px" id="avatarLabel">Profile photo (optional)</div>
            <input class="input" id="signupAvatar" type="file" accept="image/*" />
          </div>
          <button class="btn btnRed" id="signupBtn">Create account</button>
          <div class="note err" id="signupErr" style="display:none"></div>
          <div class="note ok" id="signupOk" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ACCOUNT SETTINGS MODAL -->
  <div class="modal" id="accountModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="accountTitle">Account</div>
        <button class="iconBtn" id="accountClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="note" id="accountInfo"></div>

          <div class="note">
            <div style="font-weight:900;margin-bottom:6px" id="editNameLabel">Edit name</div>
            <input class="input" id="editName" type="text" />
            <button class="btn btnCyan" id="saveNameBtn">Save</button>
          </div>

          <div class="note">
            <div style="font-weight:900;margin-bottom:6px" id="editAvatarLabel">Edit photo</div>
            <input class="input" id="editAvatar" type="file" accept="image/*" />
            <button class="btn btnCyan" id="saveAvatarBtn">Save</button>
          </div>

          <div class="note">
            <div style="font-weight:900;margin-bottom:6px" id="changePassLabel">Change password</div>
            <input class="input" id="oldPass" type="password" />
            <input class="input" id="newPass" type="password" />
            <button class="btn btnRed" id="changePassBtn">Change</button>
            <div class="note err" id="changePassErr" style="display:none"></div>
            <div class="note ok" id="changePassOk" style="display:none"></div>
          </div>

          <button class="btn" id="accountLogoutBtn">Logout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- NOTIFICATIONS MODAL -->
  <div class="modal" id="notifModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="notifTitle">Notifications</div>
        <button class="iconBtn" id="notifClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div id="notifList"></div>
          <button class="btn" id="notifClearBtn">Clear</button>
        </div>
      </div>
    </div>
  </div>

  <!-- GEMS / BONUS MODAL -->
  <div class="modal" id="gemsModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="gemsTitle">Bonus</div>
        <button class="iconBtn" id="gemsClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="note" id="gemsInfo"></div>

          <div class="note">
            <div style="font-weight:900;margin-bottom:8px" id="redeemLabel">Redeem gems ‚Üí discount card</div>
            <div class="row">
              <input class="input" id="redeemInput" type="number" min="1" />
              <button class="btn btnRed tight" id="redeemBtn" style="flex:0 0 auto">Redeem</button>
            </div>
            <div class="note warn" id="redeemHint" style="margin-top:10px"></div>
            <div class="note err" id="redeemErr" style="display:none;margin-top:10px"></div>
            <div class="note ok" id="redeemOk" style="display:none;margin-top:10px"></div>
          </div>

          <div class="note">
            <div style="font-weight:900;margin-bottom:8px" id="cardsLabel">Your discount cards</div>
            <div id="cardsList"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CART MODAL -->
  <div class="modal" id="cartModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="cartTitle">Cart</div>
        <button class="iconBtn" id="cartClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div id="cartItems"></div>
          <div class="totalBar" id="totalBar">
            <strong id="totalLabel">Total</strong>
            <span id="totalValue">EGP 0</span>
          </div>
          <button class="btn btnRed" id="cartCheckoutBtn">Checkout</button>
          <div class="note" id="cartNote"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- CHECKOUT SUMMARY MODAL (STEP 1) -->
  <div class="modal" id="checkoutModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="checkoutTitle">Checkout</div>
        <button class="iconBtn" id="checkoutClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div id="checkoutItems"></div>
          <div class="note" id="checkoutTotals"></div>

          <div class="note" id="couponNote"></div>
          <div class="row">
            <input class="input" id="couponInput" />
            <button class="btn tight" id="applyCouponBtn" style="flex:0 0 auto">Apply</button>
          </div>

          <div class="note" id="cardPickNote"></div>
          <select class="select" id="cardPicker"></select>

          <div class="row">
            <button class="btn" id="backToCartBtn">Back</button>
            <button class="btn btnRed" id="confirmCheckoutBtn">Confirm</button>
          </div>

          <div class="note warn" id="checkoutHint"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- PAYMENT MODAL (STEP 2) -->
  <div class="modal" id="payModal" aria-hidden="true">
    <div class="miniModalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="payTitle">Payment</div>
        <button class="iconBtn" id="payClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="note" id="paySummary"></div>
          <div class="payList" id="payList"></div>
          <div class="note" id="payHelp"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- DETAILS MODAL -->
  <div class="modal" id="detailsModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="detailsTitle">Details</div>
        <button class="iconBtn" id="detailsClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="galleryMain"><img id="detailsMainImg" alt=""></div>
          <div class="thumbRow" id="detailsThumbs"></div>

          <div class="note" id="detailsText"></div>

          <div class="row">
            <button class="btn" id="detailsAddBtn">üõí Add</button>
            <button class="btn btnRed" id="detailsBuyBtn">‚ö° Buy</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- LIGHTBOX -->
  <div class="modal" id="lightbox" aria-hidden="true">
    <div class="lightboxBox">
      <div class="modalHeader">
        <div class="modalTitle" id="lightTitle">Photo</div>
        <button class="iconBtn" id="lightClose">‚úï</button>
      </div>
      <div class="lightImgWrap">
        <img id="lightImg" alt="">
        <div class="navArrow navPrev" id="lightPrev">‚Äπ</div>
        <div class="navArrow navNext" id="lightNext">‚Ä∫</div>
      </div>
    </div>
  </div>

  <!-- CONTACT MODAL -->
  <div class="modal" id="contactModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="contactTitle">Contact</div>
        <button class="iconBtn" id="contactClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <a class="payBtn" href="https://wa.me/201006760663" target="_blank" rel="noreferrer">
            <span class="payLeft"><span class="payIcon">WA</span><span>WhatsApp</span></span><span class="mini">‚Üí</span>
          </a>
          <a class="payBtn" href="https://www.instagram.com/medo__rami" target="_blank" rel="noreferrer">
            <span class="payLeft"><span class="payIcon">IG</span><span>Instagram</span></span><span class="mini">‚Üí</span>
          </a>
          <a class="payBtn" href="https://www.facebook.com/share/1AScQqiSqq/" target="_blank" rel="noreferrer">
            <span class="payLeft"><span class="payIcon">FB</span><span>Facebook</span></span><span class="mini">‚Üí</span>
          </a>
          <a class="payBtn" href="mailto:medorami77@gmail.com">
            <span class="payLeft"><span class="payIcon">@</span><span>Email</span></span><span class="mini">‚Üí</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- REVIEWS MODAL -->
  <div class="modal" id="reviewsModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="reviewsTitle">Reviews</div>
        <button class="iconBtn" id="reviewsClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="note" id="reviewsHint"></div>

          <div class="note">
            <div class="row">
              <select class="select" id="reviewStars"></select>
              <button class="btn btnRed tight" id="submitReviewBtn" style="flex:0 0 auto">Send</button>
            </div>
            <textarea class="input" id="reviewText"></textarea>
            <div class="note err" id="reviewErr" style="display:none;margin-top:10px"></div>
            <div class="note ok" id="reviewOk" style="display:none;margin-top:10px"></div>
          </div>

          <div class="note">
            <div style="font-weight:900;margin-bottom:8px" id="reviewsListLabel">All reviews</div>
            <div id="reviewsList"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Language (auto by device)
========================= */
const isArabic = (() => (navigator.language || "").toLowerCase().startsWith("ar"))();
document.documentElement.lang = isArabic ? "ar" : "en";
document.documentElement.dir = isArabic ? "rtl" : "ltr";

const T = {
  ar:{
    search:"üîç ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÑÿπÿ®ÿ© / ÿ®ÿ±ŸÜÿßŸÖÿ¨ / ÿ£ŸÉŸàŸÜÿ™",
    menu:"ÿßŸÑŸÇÿßÿ¶ŸÖÿ©",
    filter:"ÿßŸÑŸÅŸÑÿ™ÿ±ÿ©",
    category:"ÿßŸÑŸÇÿ≥ŸÖ",
    sort:"ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ®",
    price:"ŸÅŸÑÿ™ÿ± ÿßŸÑÿ≥ÿπÿ±",
    apply:"ÿ™ÿ∑ÿ®ŸäŸÇ",
    filterHelp:"ÿßÿÆÿ™ÿßÿ± ŸÇÿ≥ŸÖ + ÿ™ÿ±ÿ™Ÿäÿ® + ÿ≥ÿπÿ± Ÿàÿßÿ∂ÿ∫ÿ∑ ÿ™ÿ∑ÿ®ŸäŸÇ.",
    all:"ÿßŸÑŸÉŸÑ",
    games:"ÿßŸÑÿ£ŸÑÿπÿßÿ®",
    programs:"ÿßŸÑÿ®ÿ±ÿßŸÖÿ¨",
    accounts:"ÿßŸÑÿ£ŸÉŸàŸÜÿ™ÿßÿ™",
    top:"ÿ™Ÿàÿ®",
    offers:"ÿ£ŸàŸÅÿ±ÿ≤",
    topHint:"ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ∑ŸÑÿ®Ÿãÿß",
    offersHint:"ÿπÿ±Ÿàÿ∂",
    quick:"ÿßÿÆÿ™ÿµÿßÿ±ÿßÿ™",
    contact:"ÿßŸÑÿ™ŸàÿßÿµŸÑ",
    reviews:"ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿßÿ™",
    cart:"ÿßŸÑÿ≥ŸÑÿ©",
    total:"ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä",
    checkout:"ÿ¥ÿ±ÿßÿ°",
    back:"ÿ±ÿ¨Ÿàÿπ",
    confirm:"ÿ™ÿ£ŸÉŸäÿØ",
    details:"ÿ™ŸÅÿßÿµŸäŸÑ",
    addCart:"ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ≥ŸÑÿ©",
    buy:"ÿ¥ÿ±ÿßÿ°",
    newest:"ÿßŸÑÿ£ÿ≠ÿØÿ´",
    oldest:"ÿßŸÑÿ£ŸÇÿØŸÖ",
    low:"ÿßŸÑÿ£ÿ±ÿÆÿµ ‚Üí ÿßŸÑÿ£ÿ∫ŸÑŸâ",
    high:"ÿßŸÑÿ£ÿ∫ŸÑŸâ ‚Üí ÿßŸÑÿ£ÿ±ÿÆÿµ",
    priceOff:"ÿ•ŸäŸÇÿßŸÅ",
    priceEq:"ÿ®ÿßŸÑÿ∏ÿ®ÿ∑",
    priceLte:"ÿ£ŸÇŸÑ ÿ£Ÿà Ÿäÿ≥ÿßŸàŸä",
    priceGte:"ÿ£ŸÉÿ®ÿ± ÿ£Ÿà Ÿäÿ≥ÿßŸàŸä",
    emptyCart:"ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ∂Ÿäÿ©.",
    cartHint:"ÿ™ŸÇÿØÿ± ÿ™ÿ¥ÿ™ÿ±Ÿä ŸÖŸÜ ÿßŸÑÿ≥ŸÑÿ© ÿ£Ÿà ŸÖŸÜ ŸÖŸÜÿ™ÿ¨ Ÿàÿßÿ≠ÿØ.",
    mustLogin:"ŸÑÿßÿ≤ŸÖ ÿ™ÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ ÿßŸÑÿ£ŸàŸÑ.",
    auth:"ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",
    login:"ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ",
    signup:"ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ",
    email:"ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä",
    pass:"ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±",
    name:"ÿßŸÑÿßÿ≥ŸÖ",
    age:"ÿßŸÑÿπŸÖÿ±",
    create:"ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®",
    exists:"Ÿáÿ∞ÿß ÿßŸÑÿ®ÿ±ŸäÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÜ ŸÇÿ®ŸÑ ‚Äî ÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ.",
    notFound:"Ÿáÿ∞ÿß ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ‚Äî ÿßÿπŸÖŸÑ ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ.",
    wrong:"ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿØÿÆŸàŸÑ ÿ∫ŸÑÿ∑.",
    fillAll:"ÿßŸÖŸÑÿ£ ŸÉŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™.",
    account:"ÿßŸÑÿ≠ÿ≥ÿßÿ®",
    logout:"ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨",
    editName:"ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿßÿ≥ŸÖ",
    editPhoto:"ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿµŸàÿ±ÿ©",
    save:"ÿ≠ŸÅÿ∏",
    changePass:"ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±",
    oldPass:"ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ÿßŸÑŸÇÿØŸäŸÖÿ©",
    newPass:"ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ©",
    passChanged:"ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ‚úÖ",
    passFail:"ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ÿßŸÑŸÇÿØŸäŸÖÿ© ÿ∫ŸÑÿ∑.",
    notifications:"ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ",
    clear:"ŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸÑ",
    bonus:"ÿßŸÑÿ¨ŸàÿßŸáÿ±",
    gemsInfo:(n)=>`ÿπŸÜÿØŸÉ ${n} üíé ÿ¨ŸàÿßŸáÿ±`,
    redeem:"ÿ™ÿ®ÿØŸäŸÑ",
    redeemHint:"ŸÖÿ´ÿßŸÑ: 10 ÿ¨ŸàÿßŸáÿ± = ŸÉÿßÿ±ÿ™ ÿÆÿµŸÖ 10% (ÿ™ŸÇÿØÿ± ÿ™ÿ®ÿØŸëŸÑ ÿ£ŸÉÿ™ÿ± ÿ≠ÿ≥ÿ® ÿßŸÑŸÑŸä ŸÖÿπÿßŸÉ)",
    redeemTooMuch:"ÿßŸÑÿ±ŸÇŸÖ ÿ£ŸÉÿ®ÿ± ŸÖŸÜ ÿßŸÑŸÑŸä ŸÖÿπÿßŸÉ.",
    redeemOk:(code,pct)=>`ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÉÿßÿ±ÿ™ ÿÆÿµŸÖ: ${code} = ${pct}% ‚úÖ`,
    cards:"ŸÉÿ±Ÿàÿ™ ÿßŸÑÿÆÿµŸÖ",
    noCards:"ŸÖŸÅŸäÿ¥ ŸÉÿ±Ÿàÿ™ ÿÆÿµŸÖ.",
    pickCard:"ÿßÿÆÿ™ÿßÿ± ŸÉÿßÿ±ÿ™ ÿÆÿµŸÖ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)",
    none:"ÿ®ÿØŸàŸÜ",
    couponHint:"ŸÉŸàÿØ ÿÆÿµŸÖ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)",
    invalidCoupon:"ŸÉŸàÿØ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠",
    applied:"ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿÆÿµŸÖ ‚úÖ",
    stepHint:"ÿ®ÿπÿØ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ Ÿáÿ™ÿ∏Ÿáÿ± ÿ∑ÿ±ŸÇ ÿßŸÑÿØŸÅÿπ ŸÅŸä ŸÜÿßŸÅÿ∞ÿ© ÿµÿ∫Ÿäÿ±ÿ©.",
    payment:"ÿ∑ÿ±ŸÇ ÿßŸÑÿØŸÅÿπ",
    afterPay:"ÿ®ÿπÿØ ÿßŸÑÿØŸÅÿπ ÿßÿ®ÿπÿ™ ÿ•ÿ´ÿ®ÿßÿ™ ÿπŸÑŸâ Ÿàÿßÿ™ÿ≥ÿßÿ®.",
    orderDone:(g)=>`ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ¥ÿ±ÿßÿ¶ŸÉ! ÿßÿ™ÿ∂ÿßŸÅŸÑŸÉ ${g} üíé ÿ¨ŸàÿßŸáÿ±`,
    reviewHint:"ÿßŸÉÿ™ÿ® ÿ±ÿ£ŸäŸÉ ÿπÿ¥ÿßŸÜ ŸÜÿ∑ŸàŸëÿ± ÿßŸÑŸÖŸàŸÇÿπ.",
    reviewText:"ÿßŸÉÿ™ÿ® ÿ™ÿπŸÑŸäŸÇŸÉ ŸáŸÜÿß...",
    reviewNeedLogin:"ŸÑÿßÿ≤ŸÖ ÿ™ÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ ÿπÿ¥ÿßŸÜ ÿ™ŸÉÿ™ÿ® ŸÖÿ±ÿßÿ¨ÿπÿ©.",
    reviewSent:"ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ© ‚úÖ",
    stars:"ÿßŸÑÿ™ŸÇŸäŸäŸÖ",
    detailsTitle:"ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨",
    copied:"ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ ‚úÖ"
  },
  en:{
    search:"üîç Search games / programs / accounts",
    menu:"Menu",
    filter:"Filter",
    category:"Category",
    sort:"Sort",
    price:"Price filter",
    apply:"Apply",
    filterHelp:"Pick category + sort + price then Apply.",
    all:"All",
    games:"Games",
    programs:"Programs",
    accounts:"Accounts",
    top:"Top",
    offers:"Offers",
    topHint:"Most ordered",
    offersHint:"Deals",
    quick:"Quick",
    contact:"Contact",
    reviews:"Reviews",
    cart:"Cart",
    total:"Total",
    checkout:"Checkout",
    back:"Back",
    confirm:"Confirm",
    details:"Details",
    addCart:"Add to cart",
    buy:"Buy",
    newest:"Newest",
    oldest:"Oldest",
    low:"Lowest ‚Üí Highest",
    high:"Highest ‚Üí Lowest",
    priceOff:"Off",
    priceEq:"Equal",
    priceLte:"‚â§",
    priceGte:"‚â•",
    emptyCart:"Your cart is empty.",
    cartHint:"Buy from cart or from a single product.",
    mustLogin:"Please login first.",
    auth:"Login",
    login:"Login",
    signup:"Sign up",
    email:"Email",
    pass:"Password",
    name:"Name",
    age:"Age",
    create:"Create account",
    exists:"Email already used ‚Äî login instead.",
    notFound:"Account not found ‚Äî sign up instead.",
    wrong:"Wrong credentials.",
    fillAll:"Fill all fields.",
    account:"Account",
    logout:"Logout",
    editName:"Edit name",
    editPhoto:"Edit photo",
    save:"Save",
    changePass:"Change password",
    oldPass:"Old password",
    newPass:"New password",
    passChanged:"Password changed ‚úÖ",
    passFail:"Old password is wrong.",
    notifications:"Notifications",
    clear:"Clear",
    bonus:"Gems",
    gemsInfo:(n)=>`You have ${n} üíé gems`,
    redeem:"Redeem",
    redeemHint:"Example: 10 gems = 10% discount card (redeem more as you want)",
    redeemTooMuch:"Number is greater than your balance.",
    redeemOk:(code,pct)=>`New discount card: ${code} = ${pct}% ‚úÖ`,
    cards:"Discount cards",
    noCards:"No discount cards.",
    pickCard:"Pick a discount card (optional)",
    none:"None",
    couponHint:"Coupon (optional)",
    invalidCoupon:"Invalid coupon",
    applied:"Discount applied ‚úÖ",
    stepHint:"After confirm, payment methods show in a small popup.",
    payment:"Payment",
    afterPay:"After paying, send proof on WhatsApp.",
    orderDone:(g)=>`Thanks! You earned ${g} üíé gems`,
    reviewHint:"Leave a review to improve the site.",
    reviewText:"Write your review here...",
    reviewNeedLogin:"Please login to review.",
    reviewSent:"Review sent ‚úÖ",
    stars:"Stars",
    detailsTitle:"Product details",
    copied:"Copied ‚úÖ"
  }
};
const L = isArabic ? T.ar : T.en;

/* =========================
   Storage keys
========================= */
const LS_USERS = "medo_users_v1";        // { email: {email, pass, name, age, avatar} }
const LS_SESSION = "medo_session_v1";    // { email }
const LS_CART = "medo_cart_v1";          // { emailOrGuest: [{id, qty}] }
const LS_GEMS = "medo_gems_v1";          // { email: number }
const LS_CARDS = "medo_cards_v1";        // { email: [{code,pct,used,created}] }
const LS_NOTIFS = "medo_notifs_v1";      // { email: [{text,ts,read}] }
const LS_REVIEWS = "medo_reviews_v1";    // [{email,name,stars,text,ts}]

/* =========================
   Helpers
========================= */
const $ = (id)=>document.getElementById(id);
const money = (n)=>`EGP ${n}`;
const now = ()=>Date.now();
function safeJSONGet(key, fallback){
  try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }catch{ return fallback; }
}
function safeJSONSet(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

function uid(len=8){
  const chars="ABCDEFGHJKMNPQRSTUVWXYZ23456789";
  let s=""; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)];
  return s;
}

function placeholderSVG(text){
  const t = String(text).slice(0,18);
  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="900" height="520">
    <defs>
      <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
        <stop stop-color="rgba(56,189,248,.35)" offset="0"/>
        <stop stop-color="rgba(225,29,72,.30)" offset="1"/>
      </linearGradient>
    </defs>
    <rect width="100%" height="100%" fill="url(#g)"/>
    <rect x="40" y="40" width="820" height="440" rx="28" fill="rgba(0,0,0,.25)" stroke="rgba(255,255,255,.22)"/>
    <text x="450" y="270" font-size="54" font-family="Segoe UI, Arial" fill="rgba(255,255,255,.92)" text-anchor="middle" font-weight="700">${t}</text>
    <text x="450" y="330" font-size="22" font-family="Segoe UI, Arial" fill="rgba(255,255,255,.75)" text-anchor="middle">Medo Gaming Store</text>
  </svg>`;
  return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg.trim());
}

/* =========================
   Product data (EDIT HERE)
   - image: main image
   - images: gallery (details)
========================= */
const products = [
  { id:1, type:"games", name:"Game #1", desc: isArabic ? "ŸàÿµŸÅ ŸÖÿÆÿ™ÿµÿ±" : "Short description", price:250, top:true,
    image: placeholderSVG("Game #1"), images:[placeholderSVG("Game #1 - 1"), placeholderSVG("Game #1 - 2"), placeholderSVG("Game #1 - 3")] },
  { id:2, type:"games", name:"Game #2", desc: isArabic ? "ŸàÿµŸÅ ŸÖÿÆÿ™ÿµÿ±" : "Short description", price:180, offer:true,
    image: placeholderSVG("Game #2"), images:[placeholderSVG("Game #2 - 1"), placeholderSVG("Game #2 - 2")] },
  { id:3, type:"games", name:"Game #3", desc: isArabic ? "ŸàÿµŸÅ ŸÖÿÆÿ™ÿµÿ±" : "Short description", price:300,
    image: placeholderSVG("Game #3"), images:[placeholderSVG("Game #3 - 1")] },
  { id:4, type:"games", name:"Game #4", desc: isArabic ? "ŸàÿµŸÅ ŸÖÿÆÿ™ÿµÿ±" : "Short description", price:120, offer:true,
    image: placeholderSVG("Game #4"), images:[placeholderSVG("Game #4 - 1"), placeholderSVG("Game #4 - 2")] },

  { id:11, type:"programs", name:"Program #1", desc: isArabic ? "ŸàÿµŸÅ ŸÖÿÆÿ™ÿµÿ±" : "Short description", price:150, top:true,
    image: placeholderSVG("Program #1"), images:[placeholderSVG("Program #1 - 1"), placeholderSVG("Program #1 - 2")] },
  { id:12, type:"programs", name:"Program #2", desc: isArabic ? "ŸàÿµŸÅ ŸÖÿÆÿ™ÿµÿ±" : "Short description", price:90,
    image: placeholderSVG("Program #2"), images:[placeholderSVG("Program #2 - 1")] },
  { id:13, type:"programs", name:"Program #3", desc: isArabic ? "ŸàÿµŸÅ ŸÖÿÆÿ™ÿµÿ±" : "Short description", price:220, offer:true,
    image: placeholderSVG("Program #3"), images:[placeholderSVG("Program #3 - 1"), placeholderSVG("Program #3 - 2"), placeholderSVG("Program #3 - 3")] },
  { id:14, type:"programs", name:"Program #4", desc: isArabic ? "ŸàÿµŸÅ ŸÖÿÆÿ™ÿµÿ±" : "Short description", price:60,
    image: placeholderSVG("Program #4"), images:[placeholderSVG("Program #4 - 1")] },

  { id:21, type:"accounts", name:"Account #1", desc: isArabic ? "ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÉŸàŸÜÿ™ (ÿßŸÉÿ™ÿ® ÿßŸÑŸÑŸä ÿ™ÿ≠ÿ®Ÿá)" : "Account details", price:700, top:true,
    image: placeholderSVG("Account #1"), images:[placeholderSVG("Account #1 - Car"), placeholderSVG("Account #1 - Skins"), placeholderSVG("Account #1 - Weapons")] },
  { id:22, type:"accounts", name:"Account #2", desc: isArabic ? "ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÉŸàŸÜÿ™ (ÿßŸÉÿ™ÿ® ÿßŸÑŸÑŸä ÿ™ÿ≠ÿ®Ÿá)" : "Account details", price:350, offer:true,
    image: placeholderSVG("Account #2"), images:[placeholderSVG("Account #2 - 1"), placeholderSVG("Account #2 - 2")] },
  { id:23, type:"accounts", name:"Account #3", desc: isArabic ? "ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÉŸàŸÜÿ™ (ÿßŸÉÿ™ÿ® ÿßŸÑŸÑŸä ÿ™ÿ≠ÿ®Ÿá)" : "Account details", price:200,
    image: placeholderSVG("Account #3"), images:[placeholderSVG("Account #3 - 1")] },
  { id:24, type:"accounts", name:"Account #4", desc: isArabic ? "ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÉŸàŸÜÿ™ (ÿßŸÉÿ™ÿ® ÿßŸÑŸÑŸä ÿ™ÿ≠ÿ®Ÿá)" : "Account details", price:450,
    image: placeholderSVG("Account #4"), images:[placeholderSVG("Account #4 - 1"), placeholderSVG("Account #4 - 2")] },
];

/* =========================
   UI text binding
========================= */
function applyLanguage(){
  $("brandText").textContent = "Medo Gaming Store";
  $("search").placeholder = L.search;
  $("menuTitle").textContent = L.menu;
  $("filterTitle").textContent = L.filter;

  $("topTitle").childNodes[0].textContent = `üî• ${L.top} `;
  $("topHint").textContent = L.topHint;

  $("offersTitle").childNodes[0].textContent = `üéÅ ${L.offers} `;
  $("offersHint").textContent = L.offersHint;

  $("gamesTitle").textContent = `üéÆ ${L.games}`;
  $("programsTitle").textContent = `üíª ${L.programs}`;
  $("accountsTitle").textContent = `üßæ ${L.accounts}`;

  $("drawerQuick").textContent = L.quick;
  $("goTopText").textContent = L.top;
  $("goOffersText").textContent = L.offers;
  $("goGamesText").textContent = L.games;
  $("goProgramsText").textContent = L.programs;
  $("goAccountsText").textContent = L.accounts;
  $("goReviewsText").textContent = L.reviews;
  $("goContactText").textContent = L.contact;

  $("filterCategoryLabel").textContent = L.category;
  $("filterSortLabel").textContent = L.sort;
  $("filterPriceLabel").textContent = L.price;
  $("applyFilterBtn").textContent = L.apply;
  $("filterNote").textContent = L.filterHelp;

  $("authText").textContent = L.auth;
  $("authModalTitle").textContent = L.account;
  $("tabLogin").textContent = L.login;
  $("tabSignup").textContent = L.signup;

  $("loginNote").textContent = isArabic
    ? "ŸÑŸà ÿ≠ÿ≥ÿßÿ®ŸÉ ŸÖŸàÿ¨ŸàÿØ ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ."
    : "If you already have an account, use Login.";
  $("loginEmail").placeholder = L.email;
  $("loginPass").placeholder = L.pass;
  $("loginBtn").textContent = L.login;

  $("signupNote").textContent = isArabic
    ? "ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ (ÿπŸÑŸâ ŸÜŸÅÿ≥ ÿßŸÑÿ¨Ÿáÿßÿ≤)."
    : "Create a new account (this device).";
  $("signupEmail").placeholder = L.email;
  $("signupPass").placeholder = L.pass;
  $("signupName").placeholder = L.name;
  $("signupAge").placeholder = L.age;
  $("avatarLabel").textContent = isArabic ? "ÿµŸàÿ±ÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ® (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)" : "Profile photo (optional)";
  $("signupBtn").textContent = L.create;

  $("accountTitle").textContent = L.account;
  $("editNameLabel").textContent = L.editName;
  $("saveNameBtn").textContent = L.save;
  $("editAvatarLabel").textContent = L.editPhoto;
  $("saveAvatarBtn").textContent = L.save;
  $("changePassLabel").textContent = L.changePass;
  $("oldPass").placeholder = L.oldPass;
  $("newPass").placeholder = L.newPass;
  $("changePassBtn").textContent = L.changePass;
  $("accountLogoutBtn").textContent = L.logout;

  $("notifTitle").textContent = L.notifications;
  $("notifClearBtn").textContent = L.clear;

  $("gemsTitle").textContent = L.bonus;
  $("redeemLabel").textContent = isArabic ? "ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿ¨ŸàÿßŸáÿ± ‚Üí ŸÉÿßÿ±ÿ™ ÿÆÿµŸÖ" : "Redeem gems ‚Üí discount card";
  $("redeemBtn").textContent = L.redeem;
  $("redeemInput").placeholder = isArabic ? "ÿπÿØÿØ ÿßŸÑÿ¨ŸàÿßŸáÿ±" : "Gems amount";
  $("redeemHint").textContent = L.redeemHint;
  $("cardsLabel").textContent = L.cards;

  $("cartTitle").textContent = L.cart;
  $("totalLabel").textContent = L.total;
  $("cartCheckoutBtn").textContent = L.checkout;
  $("cartNote").textContent = L.cartHint;

  $("checkoutTitle").textContent = L.checkout;
  $("couponNote").textContent = L.couponHint;
  $("couponInput").placeholder = isArabic ? "ŸÖÿ´ÿßŸÑ: MG1 (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)" : "Example: MG1 (optional)";
  $("applyCouponBtn").textContent = L.apply;
  $("cardPickNote").textContent = L.pickCard;
  $("backToCartBtn").textContent = L.back;
  $("confirmCheckoutBtn").textContent = L.confirm;
  $("checkoutHint").textContent = L.stepHint;

  $("payTitle").textContent = L.payment;

  $("detailsTitle").textContent = L.detailsTitle;

  $("contactTitle").textContent = L.contact;

  $("reviewsTitle").textContent = L.reviews;
  $("reviewsHint").textContent = L.reviewHint;
  $("reviewText").placeholder = L.reviewText;
  $("submitReviewBtn").textContent = isArabic ? "ÿ•ÿ±ÿ≥ÿßŸÑ" : "Send";
  $("reviewsListLabel").textContent = isArabic ? "ŸÉŸÑ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿßÿ™" : "All reviews";

  // Stars
  const stars = $("reviewStars");
  stars.innerHTML = "";
  for(let i=5;i>=1;i--){
    const o = document.createElement("option");
    o.value = String(i);
    o.textContent = isArabic ? `${i} ŸÜÿ¨ŸàŸÖ` : `${i} stars`;
    stars.appendChild(o);
  }

  // Drawer positions: menu on right for Arabic, left for English
  const menuDrawer = $("menuDrawer");
  const filterDrawer = $("filterDrawer");
  if(isArabic){
    menuDrawer.style.insetInlineEnd="0"; menuDrawer.style.insetInlineStart="auto";
    menuDrawer.dataset.closed="translateX(110%)";
    menuDrawer.style.transform="translateX(110%)";

    filterDrawer.style.insetInlineStart="0"; filterDrawer.style.insetInlineEnd="auto";
    filterDrawer.dataset.closed="translateX(-110%)";
    filterDrawer.style.transform="translateX(-110%)";
  }else{
    menuDrawer.style.insetInlineStart="0"; menuDrawer.style.insetInlineEnd="auto";
    menuDrawer.dataset.closed="translateX(-110%)";
    menuDrawer.style.transform="translateX(-110%)";

    filterDrawer.style.insetInlineEnd="0"; filterDrawer.style.insetInlineStart="auto";
    filterDrawer.dataset.closed="translateX(110%)";
    filterDrawer.style.transform="translateX(110%)";
  }

  // Filter selects
  $("filterCategory").innerHTML = `
    <option value="all">${L.all}</option>
    <option value="games">${L.games}</option>
    <option value="programs">${L.programs}</option>
    <option value="accounts">${L.accounts}</option>
  `;
  $("filterSort").innerHTML = `
    <option value="new">${L.newest}</option>
    <option value="old">${L.oldest}</option>
    <option value="low">${L.low}</option>
    <option value="high">${L.high}</option>
  `;
  $("priceMode").innerHTML = `
    <option value="off">${L.priceOff}</option>
    <option value="eq">${L.priceEq}</option>
    <option value="lte">${L.priceLte}</option>
    <option value="gte">${L.priceGte}</option>
  `;
}
applyLanguage();

/* =========================
   Drawers/Modals controls
========================= */
const overlay = $("overlay");
function openOverlay(){ overlay.classList.add("show"); }
function closeOverlay(){ overlay.classList.remove("show"); }

function closeAll(){
  closeOverlay();
  // drawers
  const md = $("menuDrawer"), fd = $("filterDrawer");
  md.classList.remove("show"); fd.classList.remove("show");
  md.style.transform = md.dataset.closed || "translateX(110%)";
  fd.style.transform = fd.dataset.closed || "translateX(110%)";
  // modals
  ["authModal","accountModal","notifModal","gemsModal","cartModal","checkoutModal","payModal","detailsModal","lightbox","contactModal","reviewsModal"]
    .forEach(id=>$(id).classList.remove("show"));
}
overlay.addEventListener("click", closeAll);

function openDrawer(el){
  openOverlay();
  el.classList.add("show");
  el.style.transform = "translateX(0)";
}
function openModal(el){
  openOverlay();
  el.classList.add("show");
}

/* =========================
   Auth system (local users)
========================= */
function getUsers(){ return safeJSONGet(LS_USERS, {}); }
function setUsers(u){ safeJSONSet(LS_USERS, u); }

function getSession(){ return safeJSONGet(LS_SESSION, null); }
function setSession(s){ safeJSONSet(LS_SESSION, s); }
function clearSession(){ localStorage.removeItem(LS_SESSION); }

function currentEmail(){
  const s = getSession();
  return s?.email || null;
}
function isLoggedIn(){ return !!currentEmail(); }
function getCurrentUser(){
  const email = currentEmail();
  if(!email) return null;
  const users = getUsers();
  return users[email] || null;
}

/* Per-user cart/gems/cards/notifs helpers */
function userKey(){
  return currentEmail() ? `u:${currentEmail()}` : "guest";
}
function getAllCarts(){ return safeJSONGet(LS_CART, {}); }
function setAllCarts(x){ safeJSONSet(LS_CART, x); }
function loadCart(){
  const all = getAllCarts();
  return all[userKey()] || [];
}
function saveCart(items){
  const all = getAllCarts();
  all[userKey()] = items;
  setAllCarts(all);
}

function getGemsAll(){ return safeJSONGet(LS_GEMS, {}); }
function setGemsAll(x){ safeJSONSet(LS_GEMS, x); }
function getGems(){
  const email = currentEmail();
  if(!email) return 0;
  const g = getGemsAll();
  return Number(g[email] || 0);
}
function setGems(n){
  const email = currentEmail();
  if(!email) return;
  const g = getGemsAll();
  g[email] = Math.max(0, Math.floor(Number(n)||0));
  setGemsAll(g);
  refreshGemsUI();
}
function addGems(delta){
  setGems(getGems() + (Number(delta)||0));
}

function getCardsAll(){ return safeJSONGet(LS_CARDS, {}); }
function setCardsAll(x){ safeJSONSet(LS_CARDS, x); }
function getCards(){
  const email = currentEmail();
  if(!email) return [];
  const all = getCardsAll();
  return all[email] || [];
}
function setCards(list){
  const email = currentEmail();
  if(!email) return;
  const all = getCardsAll();
  all[email] = list;
  setCardsAll(all);
}

function getNotifsAll(){ return safeJSONGet(LS_NOTIFS, {}); }
function setNotifsAll(x){ safeJSONSet(LS_NOTIFS, x); }
function getNotifs(){
  const email = currentEmail();
  if(!email) return [];
  const all = getNotifsAll();
  return all[email] || [];
}
function setNotifs(list){
  const email = currentEmail();
  if(!email) return;
  const all = getNotifsAll();
  all[email] = list;
  setNotifsAll(all);
  refreshNotifUI();
}
function pushNotif(text){
  const email = currentEmail();
  if(!email) return;
  const list = getNotifs();
  list.unshift({ text, ts: now(), read:false });
  setNotifs(list);
}

/* =========================
   Coupon codes (MG..MI)
========================= */
function buildCoupons(){
  const map = {};
  const groups = [
    ["MG",10],["MZ",20],["MK",30],["MC",40],["MA",50],
    ["MB",60],["ME",70],["MX",80],["MR",90],["MI",100]
  ];
  for(const [prefix, pct] of groups){
    for(let i=1;i<=10;i++) map[`${prefix}${i}`] = pct;
  }
  return map;
}
const COUPONS = buildCoupons();

/* =========================
   Bonus ‚Üí Card tiers (balanced)
   - You can change tiers here
========================= */
const REDEEM_TIERS = [
  { gems:10, pct:10 },
  { gems:20, pct:15 },
  { gems:30, pct:20 },
  { gems:50, pct:30 },
  { gems:80, pct:40 },
  { gems:120, pct:50 }
];
function pctForRedeem(g){
  // choose best pct not exceeding g (simple)
  let best = 0;
  for(const t of REDEEM_TIERS){
    if(g >= t.gems) best = t.pct;
  }
  return best || 0;
}

/* =========================
   Render products
========================= */
function typeLabel(t){
  if(t==="games") return L.games;
  if(t==="programs") return L.programs;
  return L.accounts;
}

function cardHTML(p){
  // IMPORTANT: remove any extra word above Buy (as requested)
  const tag = typeLabel(p.type);
  const badge = p.offer ? `<span class="badge badgeOffer">${L.offers}</span>` : (p.top ? `<span class="badge">${L.top}</span>` : `<span class="badge">${tag}</span>`);
  return `
    <div class="card">
      <div class="thumb">
        <img src="${p.image}" alt="">
        <span class="tag">${tag}</span>
      </div>
      <div class="content">
        <p class="name">${p.name}</p>
        <p class="meta">${p.desc || ""}</p>
        <div class="priceRow">
          <p class="price">${money(p.price)}</p>
          ${badge}
        </div>
        <div class="actions">
          <button class="btn btnCyan" data-details="${p.id}">‚ÑπÔ∏è ${L.details}</button>
          <button class="btn" data-add="${p.id}">üõí ${L.addCart}</button>
          <button class="btn btnRed" data-buy="${p.id}">‚ö° ${L.buy}</button>
        </div>
      </div>
    </div>
  `;
}

const gridTop = $("gridTop");
const gridOffers = $("gridOffers");
const gridGames = $("gridGames");
const gridPrograms = $("gridPrograms");
const gridAccounts = $("gridAccounts");

function applyFilters(list){
  const q = ($("search").value || "").toLowerCase().trim();
  const cat = $("filterCategory").value;
  const sort = $("filterSort").value;
  const pm = $("priceMode").value;
  const pv = Number($("priceValue").value);

  let out = [...list];

  if(q){
    out = out.filter(p => (p.name + " " + (p.desc||"")).toLowerCase().includes(q));
  }
  if(cat !== "all"){
    out = out.filter(p => p.type === cat);
  }
  if(pm !== "off" && !Number.isNaN(pv)){
    if(pm === "eq") out = out.filter(p => p.price === pv);
    if(pm === "lte") out = out.filter(p => p.price <= pv);
    if(pm === "gte") out = out.filter(p => p.price >= pv);
  }
  if(sort === "new") out.sort((a,b)=> b.id - a.id);
  if(sort === "old") out.sort((a,b)=> a.id - b.id);
  if(sort === "low") out.sort((a,b)=> a.price - b.price);
  if(sort === "high") out.sort((a,b)=> b.price - a.price);

  return out;
}

function bindCardButtons(){
  document.querySelectorAll("[data-add]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      addToCart(Number(btn.dataset.add));
    });
  });
  document.querySelectorAll("[data-buy]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      buyNow(Number(btn.dataset.buy));
    });
  });
  document.querySelectorAll("[data-details]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      openDetails(Number(btn.dataset.details));
    });
  });
}

function renderAll(){
  const filtered = applyFilters(products);
  const tops = filtered.filter(p=>p.top);
  const offers = filtered.filter(p=>p.offer);

  gridTop.innerHTML = tops.length ? tops.map(cardHTML).join("") : `<div class="note">${isArabic ? "ŸÖŸÅŸäÿ¥ ÿπŸÜÿßÿµÿ± ÿ™Ÿàÿ® ÿ≠ÿßŸÑŸäÿßŸã." : "No Top items."}</div>`;
  gridOffers.innerHTML = offers.length ? offers.map(cardHTML).join("") : `<div class="note">${isArabic ? "ŸÖŸÅŸäÿ¥ ÿπÿ±Ÿàÿ∂ ÿ≠ÿßŸÑŸäÿßŸã." : "No offers."}</div>`;

  gridGames.innerHTML = filtered.filter(p=>p.type==="games").map(cardHTML).join("");
  gridPrograms.innerHTML = filtered.filter(p=>p.type==="programs").map(cardHTML).join("");
  gridAccounts.innerHTML = filtered.filter(p=>p.type==="accounts").map(cardHTML).join("");

  bindCardButtons();
}
renderAll();

/* =========================
   Menu navigation
========================= */
function scrollToEl(el){
  closeAll();
  window.scrollTo({ top: el.getBoundingClientRect().top + window.scrollY - 80, behavior:"smooth" });
}
$("goTop").onclick = ()=>scrollToEl($("gridTop"));
$("goOffers").onclick = ()=>scrollToEl($("gridOffers"));
$("goGames").onclick = ()=>scrollToEl($("gridGames"));
$("goPrograms").onclick = ()=>scrollToEl($("gridPrograms"));
$("goAccounts").onclick = ()=>scrollToEl($("gridAccounts"));

$("goContact").onclick = ()=>{
  closeAll();
  openModal($("contactModal"));
};
$("goReviews").onclick = ()=>{
  closeAll();
  openModal($("reviewsModal"));
  renderReviews();
};

/* =========================
   Drawer buttons
========================= */
$("menuBtn").onclick = ()=>{
  refreshAuthUI();
  openDrawer($("menuDrawer"));
};
$("menuClose").onclick = closeAll;

$("filterBtn").onclick = ()=>openDrawer($("filterDrawer"));
$("filterClose").onclick = closeAll;

$("applyFilterBtn").onclick = ()=>{
  closeAll();
  renderAll();
};

$("search").addEventListener("input", ()=>renderAll());

/* =========================
   Auth modal tabs
========================= */
function showTab(tab){
  $("tabLogin").classList.toggle("active", tab==="login");
  $("tabSignup").classList.toggle("active", tab==="signup");
  $("loginForm").style.display = (tab==="login") ? "block" : "none";
  $("signupForm").style.display = (tab==="signup") ? "block" : "none";
  $("loginErr").style.display="none";
  $("signupErr").style.display="none";
  $("signupOk").style.display="none";
}
$("tabLogin").onclick = ()=>showTab("login");
$("tabSignup").onclick = ()=>showTab("signup");

$("authBtn").onclick = ()=>{
  openModal($("authModal"));
  showTab("login");
};
$("authClose").onclick = closeAll;

/* Signup image to base64 */
function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=>resolve(String(r.result||""));
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

/* Signup */
$("signupBtn").onclick = async ()=>{
  const email = ($("signupEmail").value||"").trim().toLowerCase();
  const pass = ($("signupPass").value||"").trim();
  const name = ($("signupName").value||"").trim();
  const age = Number(($("signupAge").value||"").trim());

  $("signupErr").style.display="none";
  $("signupOk").style.display="none";

  if(!email || !pass || !name || !age){
    $("signupErr").textContent = L.fillAll;
    $("signupErr").style.display="block";
    return;
  }

  const users = getUsers();
  if(users[email]){
    $("signupErr").textContent = L.exists;
    $("signupErr").style.display="block";
    return;
  }

  let avatar = "";
  const f = $("signupAvatar").files?.[0];
  if(f){
    try{ avatar = await fileToDataURL(f); }catch{}
  }

  users[email] = { email, pass, name, age, avatar };
  setUsers(users);

  // auto login
  setSession({ email });
  initUserDefaultsIfNeeded(email);
  pushNotif(isArabic ? "ÿ£ŸáŸÑÿßŸã ÿ®ŸäŸÉ! ÿ≠ÿ≥ÿßÿ®ŸÉ ÿßÿ™ÿπŸÖŸÑ ÿ®ŸÜÿ¨ÿßÿ≠ ‚úÖ" : "Welcome! Account created ‚úÖ");
  $("signupOk").textContent = isArabic ? "ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ® ‚úÖ" : "Account created ‚úÖ";
  $("signupOk").style.display="block";

  refreshAuthUI();
  closeAll();
};

/* Login */
$("loginBtn").onclick = ()=>{
  const email = ($("loginEmail").value||"").trim().toLowerCase();
  const pass = ($("loginPass").value||"").trim();

  $("loginErr").style.display="none";

  const users = getUsers();
  if(!users[email]){
    $("loginErr").textContent = L.notFound;
    $("loginErr").style.display="block";
    return;
  }
  if(users[email].pass !== pass){
    $("loginErr").textContent = L.wrong;
    $("loginErr").style.display="block";
    return;
  }

  setSession({ email });
  initUserDefaultsIfNeeded(email);
  pushNotif(isArabic ? "ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ‚úÖ" : "Logged in ‚úÖ");
  refreshAuthUI();
  closeAll();
};

/* Init per-user default stores */
function initUserDefaultsIfNeeded(email){
  // gems default
  const g = getGemsAll();
  if(g[email] == null){ g[email] = 0; setGemsAll(g); }
  // cards default
  const c = getCardsAll();
  if(!c[email]){ c[email] = []; setCardsAll(c); }
  // notifs default
  const n = getNotifsAll();
  if(!n[email]){ n[email] = []; setNotifsAll(n); }
  // cart per user key is handled dynamically
}

/* Auth UI */
function refreshAuthUI(){
  const u = getCurrentUser();
  if(!u){
    $("authBtn").style.display="inline-flex";
    $("userChip").style.display="none";
    $("drawerUserBox").style.display="none";
    refreshCartCount();
    refreshGemsUI();
    refreshNotifUI();
    return;
  }

  $("authBtn").style.display="none";
  $("userChip").style.display="inline-flex";
  $("userNameText").textContent = u.name;

  // avatar mini
  if(u.avatar){
    $("avatarMini").innerHTML = `<img src="${u.avatar}" alt="">`;
  }else{
    $("avatarMini").innerHTML = `<span id="avatarLetter">${(u.name||"M").trim().slice(0,1).toUpperCase()}</span>`;
  }

  $("drawerUserBox").style.display="block";
  $("drawerUserNote").textContent = isArabic
    ? `ŸÖÿ≥ÿ¨ŸÑ ÿ®ÿßÿ≥ŸÖ: ${u.name} ‚Ä¢ ${u.email}`
    : `Logged as: ${u.name} ‚Ä¢ ${u.email}`;

  $("logoutBtn").textContent = L.logout;
  $("accountBtn").textContent = L.account;

  $("logoutBtn").onclick = doLogout;
  $("accountLogoutBtn").onclick = doLogout;
  $("accountBtn").onclick = ()=>{
    closeAll();
    openAccountModal();
  };

  // user chip click
  $("userChip").onclick = ()=>{
    openAccountModal();
  };

  refreshCartCount();
  refreshGemsUI();
  refreshNotifUI();
}
function doLogout(){
  clearSession();
  refreshAuthUI();
  closeAll();
}
refreshAuthUI();

/* Account modal */
$("accountClose").onclick = closeAll;
function openAccountModal(){
  const u = getCurrentUser();
  if(!u) return openModal($("authModal"));
  $("accountInfo").textContent = isArabic
    ? `ÿßŸÑÿ®ÿ±ŸäÿØ: ${u.email}\nÿßŸÑÿπŸÖÿ±: ${u.age}`
    : `Email: ${u.email}\nAge: ${u.age}`;
  $("editName").value = u.name || "";
  $("oldPass").value = "";
  $("newPass").value = "";
  $("changePassErr").style.display="none";
  $("changePassOk").style.display="none";
  openModal($("accountModal"));
}
$("saveNameBtn").onclick = ()=>{
  const u = getCurrentUser(); if(!u) return;
  const users = getUsers();
  const name = ($("editName").value||"").trim();
  if(!name) return;
  users[u.email].name = name;
  setUsers(users);
  pushNotif(isArabic ? "ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿßÿ≥ŸÖ ‚úÖ" : "Name updated ‚úÖ");
  refreshAuthUI();
  $("accountInfo").textContent = isArabic
    ? `ÿßŸÑÿ®ÿ±ŸäÿØ: ${u.email}\nÿßŸÑÿπŸÖÿ±: ${users[u.email].age}`
    : `Email: ${u.email}\nAge: ${users[u.email].age}`;
};
$("saveAvatarBtn").onclick = async ()=>{
  const u = getCurrentUser(); if(!u) return;
  const f = $("editAvatar").files?.[0];
  if(!f) return;
  const data = await fileToDataURL(f);
  const users = getUsers();
  users[u.email].avatar = data;
  setUsers(users);
  pushNotif(isArabic ? "ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ© ‚úÖ" : "Photo updated ‚úÖ");
  refreshAuthUI();
};
$("changePassBtn").onclick = ()=>{
  const u = getCurrentUser(); if(!u) return;
  const oldP = ($("oldPass").value||"").trim();
  const newP = ($("newPass").value||"").trim();
  $("changePassErr").style.display="none";
  $("changePassOk").style.display="none";
  const users = getUsers();
  if(users[u.email].pass !== oldP){
    $("changePassErr").textContent = L.passFail;
    $("changePassErr").style.display="block";
    return;
  }
  if(!newP){
    $("changePassErr").textContent = L.fillAll;
    $("changePassErr").style.display="block";
    return;
  }
  users[u.email].pass = newP;
  setUsers(users);
  $("changePassOk").textContent = L.passChanged;
  $("changePassOk").style.display="block";
  pushNotif(isArabic ? "ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ‚úÖ" : "Password changed ‚úÖ");
};

/* =========================
   Cart
========================= */
let cart = loadCart(); // [{id, qty}]

function cartIndex(id){ return cart.findIndex(x=>x.id===id); }
function addToCart(id){
  const i = cartIndex(id);
  if(i>=0) cart[i].qty += 1;
  else cart.push({id, qty:1});
  saveCart(cart);
  refreshCartCount();
  pushLightNotif(isArabic ? "ÿßÿ™ÿ∂ÿßŸÅ ŸÑŸÑÿ≥ŸÑÿ© ‚úÖ" : "Added to cart ‚úÖ");
}
function setQty(id, qty){
  const i = cartIndex(id);
  if(i<0) return;
  cart[i].qty = Math.max(1, qty);
  saveCart(cart);
  refreshCartCount();
  renderCart();
}
function removeFromCart(id){
  cart = cart.filter(x=>x.id!==id);
  saveCart(cart);
  refreshCartCount();
  renderCart();
}

function cartItemsDetailed(){
  const map = new Map(products.map(p=>[p.id,p]));
  return cart.map(ci=>({ ...ci, p: map.get(ci.id) })).filter(x=>x.p);
}
function cartSubtotal(items){
  return items.reduce((s,x)=> s + (x.p.price * x.qty), 0);
}
function refreshCartCount(){
  cart = loadCart();
  const c = cart.reduce((s,x)=>s+x.qty,0);
  $("cartCount").textContent = String(c);
}
refreshCartCount();

$("cartBtn").onclick = ()=>{
  renderCart();
  openModal($("cartModal"));
};
$("cartClose").onclick = closeAll;

function renderCart(){
  const items = cartItemsDetailed();
  if(!items.length){
    $("cartItems").innerHTML = `<div class="note">${L.emptyCart}</div>`;
    $("totalValue").textContent = money(0);
    return;
  }
  $("cartItems").innerHTML = items.map(({id,qty,p})=>`
    <div class="cartItem">
      <div class="cartLeft">
        <div class="cartThumb"><img src="${p.image}" alt=""></div>
        <div style="flex:1">
          <p class="cartName">${p.name}</p>
          <p class="cartMeta">${typeLabel(p.type)} ‚Ä¢ ${money(p.price)}</p>
          <div class="qtyRow">
            <button class="qtyBtn" data-dec="${id}">‚àí</button>
            <div class="qtyNum">${qty}</div>
            <button class="qtyBtn" data-inc="${id}">+</button>
            <button class="smallBtn" data-details="${id}">‚ÑπÔ∏è ${L.details}</button>
            <button class="smallBtn removeBtn" data-rem="${id}">${isArabic ? "ÿ≠ÿ∞ŸÅ" : "Remove"}</button>
          </div>
        </div>
      </div>
      <div style="text-align:end;white-space:nowrap;font-weight:900">${money(p.price*qty)}</div>
    </div>
  `).join("");

  const subtotal = cartSubtotal(items);
  $("totalValue").textContent = money(subtotal);

  $("cartItems").querySelectorAll("[data-inc]").forEach(b=>b.onclick=()=>{
    const id=Number(b.dataset.inc);
    const i=cartIndex(id); if(i>=0) setQty(id, cart[i].qty+1);
  });
  $("cartItems").querySelectorAll("[data-dec]").forEach(b=>b.onclick=()=>{
    const id=Number(b.dataset.dec);
    const i=cartIndex(id); if(i>=0) setQty(id, cart[i].qty-1);
  });
  $("cartItems").querySelectorAll("[data-rem]").forEach(b=>b.onclick=()=>{
    const id=Number(b.dataset.rem); removeFromCart(id);
  });
  $("cartItems").querySelectorAll("[data-details]").forEach(b=>b.onclick=()=>{
    openDetails(Number(b.dataset.details));
  });
}

$("totalBar").onclick = ()=>$("cartCheckoutBtn").click();
$("cartCheckoutBtn").onclick = ()=>{
  if(!cartItemsDetailed().length){ renderCart(); return; }
  startCheckout({ mode:"cart" });
};

/* =========================
   Details modal (gallery)
========================= */
let detailsProduct = null;
let detailsIndex = 0;

$("detailsClose").onclick = closeAll;

function openDetails(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  detailsProduct = p;
  detailsIndex = 0;
  renderDetails();
  openModal($("detailsModal"));
}

function renderDetails(){
  const p = detailsProduct;
  if(!p) return;

  $("detailsTitle").textContent = L.detailsTitle;
  const imgs = (p.images && p.images.length) ? p.images : [p.image];

  $("detailsMainImg").src = imgs[detailsIndex] || p.image;

  $("detailsThumbs").innerHTML = imgs.map((src,idx)=>`
    <div class="gThumb ${idx===detailsIndex?'active':''}" data-idx="${idx}">
      <img src="${src}" alt="">
    </div>
  `).join("");

  $("detailsThumbs").querySelectorAll(".gThumb").forEach(t=>{
    t.onclick = ()=>{
      detailsIndex = Number(t.dataset.idx);
      renderDetails();
    };
  });

  const longDesc = p.longDesc || p.desc || "";
  $("detailsText").textContent =
    `${p.name}\n\n${longDesc}\n\n${isArabic ? "ÿßŸÑÿ≥ÿπÿ±:" : "Price:"} ${money(p.price)}`;

  $("detailsAddBtn").textContent = `üõí ${L.addCart}`;
  $("detailsBuyBtn").textContent = `‚ö° ${L.buy}`;

  $("detailsAddBtn").onclick = ()=> addToCart(p.id);
  $("detailsBuyBtn").onclick = ()=> buyNow(p.id);

  // click main image => lightbox
  $("detailsMainImg").onclick = ()=> openLightbox(imgs, detailsIndex, p.name);
}

/* =========================
   Lightbox (zoom + nav)
========================= */
let lightImgs = [];
let lightIdx = 0;

$("lightClose").onclick = closeAll;
$("lightPrev").onclick = ()=>{ if(!lightImgs.length) return; lightIdx = (lightIdx-1+lightImgs.length)%lightImgs.length; renderLight(); };
$("lightNext").onclick = ()=>{ if(!lightImgs.length) return; lightIdx = (lightIdx+1)%lightImgs.length; renderLight(); };

function openLightbox(imgs, idx, title){
  lightImgs = imgs || [];
  lightIdx = idx || 0;
  $("lightTitle").textContent = title || "Photo";
  renderLight();
  openModal($("lightbox"));
}
function renderLight(){
  $("lightImg").src = lightImgs[lightIdx] || "";
}

/* =========================
   Checkout (2 steps)
========================= */
let checkoutState = { mode:"cart" };
let couponPct = 0;
let couponCode = "";
let cardApplied = null; // {code,pct}
let checkoutConfirmedItems = []; // frozen items after confirm

$("checkoutClose").onclick = closeAll;
$("backToCartBtn").onclick = ()=>{
  closeAll();
  openModal($("cartModal"));
};
$("confirmCheckoutBtn").onclick = ()=>{
  // Step 2 open payment popup
  checkoutConfirmedItems = checkoutItemsFromState(checkoutState);
  // add bonus NOW (simulate successful order confirmation)
  const totals = computeTotals(checkoutConfirmedItems);
  const gemsEarned = earnGemsFromTotal(totals.total);
  if(isLoggedIn()){
    addGems(gemsEarned);
    pushNotif(L.orderDone(gemsEarned));
  }
  closeAll();
  openPaymentModal(totals);
};

$("payClose").onclick = closeAll;

function buyNow(id){
  if(!isLoggedIn()){
    pushLightNotif(L.mustLogin);
    openModal($("authModal"));
    showTab("login");
    return;
  }
  startCheckout({ mode:"single", singleId:id });
}

function startCheckout(state){
  if(!isLoggedIn()){
    pushLightNotif(L.mustLogin);
    openModal($("authModal"));
    showTab("login");
    return;
  }
  checkoutState = state;
  couponPct = 0; couponCode = "";
  cardApplied = null;
  $("couponInput").value = "";
  renderCheckout();
  closeAll();
  openModal($("checkoutModal"));
}

function checkoutItemsFromState(state){
  if(state.mode==="single"){
    const p = products.find(x=>x.id===state.singleId);
    if(!p) return [];
    return [{ id:p.id, qty:1, p }];
  }
  return cartItemsDetailed();
}

function computeTotals(items){
  const subtotal = cartSubtotal(items);
  const discountValue = Math.round(subtotal * (couponPct/100));
  const total = Math.max(0, subtotal - discountValue);
  return { subtotal, discountValue, total, pct: couponPct, code: couponCode };
}

function earnGemsFromTotal(total){
  // balanced: 1 gem per 100 EGP, minimum 1 if total>0
  if(total <= 0) return 0;
  return Math.max(1, Math.floor(total / 100));
}

function renderCheckout(){
  const items = checkoutItemsFromState(checkoutState);
  $("checkoutItems").innerHTML = items.map(x=>`
    <div class="cartItem">
      <div class="cartLeft">
        <div class="cartThumb"><img src="${x.p.image}" alt=""></div>
        <div style="flex:1">
          <p class="cartName">${x.p.name}</p>
          <p class="cartMeta">${typeLabel(x.p.type)} ‚Ä¢ ${money(x.p.price)} √ó ${x.qty}</p>
        </div>
      </div>
      <div style="text-align:end;white-space:nowrap;font-weight:900">${money(x.p.price*x.qty)}</div>
    </div>
  `).join("");

  // build card picker
  const cards = getCards().filter(c=>!c.used);
  const picker = $("cardPicker");
  picker.innerHTML = `<option value="">${L.none}</option>` + cards.map(c=>`<option value="${c.code}">${c.code} ‚Äî ${c.pct}%</option>`).join("");
  picker.value = cardApplied?.code || "";
  picker.onchange = ()=>{
    const code = picker.value;
    const found = cards.find(c=>c.code===code);
    if(!code || !found){
      cardApplied = null;
      // restore couponCode? keep coupon typed
      couponPct = couponCode ? (COUPONS[couponCode]||0) : 0;
      renderCheckout();
      return;
    }
    cardApplied = { code: found.code, pct: found.pct };
    couponCode = found.code;
    couponPct = found.pct;
    renderCheckout();
  };

  const totals = computeTotals(items);
  $("checkoutTotals").textContent = isArabic
    ? `ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™: ${money(totals.subtotal)} ‚Ä¢ ÿßŸÑÿÆÿµŸÖ: ${totals.pct}% (${money(totals.discountValue)}) ‚Ä¢ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: ${money(totals.total)}`
    : `Items: ${money(totals.subtotal)} ‚Ä¢ Discount: ${totals.pct}% (${money(totals.discountValue)}) ‚Ä¢ Total: ${money(totals.total)}`;

  $("checkoutHint").textContent = L.stepHint;
}

$("applyCouponBtn").onclick = ()=>{
  const code = ($("couponInput").value||"").trim().toUpperCase();
  // If user picked a card, applying manual coupon will clear card
  cardApplied = null;
  if(!code){
    couponPct = 0; couponCode = "";
    pushLightNotif(isArabic ? "ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿÆÿµŸÖ" : "Discount cleared");
    renderCheckout();
    return;
  }
  const pct = COUPONS[code] || 0;
  if(!pct){
    pushLightNotif(`${L.invalidCoupon}: ${code}`);
    return;
  }
  couponCode = code;
  couponPct = pct;
  pushLightNotif(L.applied);
  renderCheckout();
};

function openPaymentModal(totals){
  // small modal
  $("paySummary").textContent = isArabic
    ? `ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÜŸáÿßÿ¶Ÿä: ${money(totals.total)} ‚Ä¢ ÿßŸÑÿÆÿµŸÖ: ${totals.pct}%`
    : `Final total: ${money(totals.total)} ‚Ä¢ Discount: ${totals.pct}%`;

  const SELLER_PHONE = "201006760663";
  const user = getCurrentUser();
  const orderLines = checkoutConfirmedItems.map(i=>`${i.p.name} x${i.qty} = ${money(i.p.price*i.qty)}`).join("\n");
  const msg = encodeURIComponent(
    isArabic
      ? `ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸäŸÉŸÖÿå ÿπÿßŸäÿ≤ ÿ£ÿπŸÖŸÑ ÿ∑ŸÑÿ®.\n\n${orderLines}\n\nÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: ${money(totals.total)}\nÿßŸÑÿÆÿµŸÖ: ${totals.pct}%\nŸÉŸàÿØ/ŸÉÿßÿ±ÿ™: ${couponCode || "‚Äî"}\nÿßŸÑÿ≠ÿ≥ÿßÿ®: ${user?.email || "‚Äî"}\n\n(ÿßÿ®ÿπÿ™ ÿ•ÿ´ÿ®ÿßÿ™ ÿßŸÑÿØŸÅÿπ ŸáŸÜÿß)`
      : `Hi, I want to place an order.\n\n${orderLines}\n\nTotal: ${money(totals.total)}\nDiscount: ${totals.pct}%\nCode/Card: ${couponCode || "‚Äî"}\nAccount: ${user?.email || "‚Äî"}\n\n(Send payment proof here)`
  );
  const waLink = `https://wa.me/${SELLER_PHONE}?text=${msg}`;

  const items = [
    { key:"vodafone", title:"Vodafone Cash", icon:"VC", href:waLink },
    { key:"orange", title:"Orange Cash", icon:"OC", href:waLink },
    { key:"etisalat", title:"Etisalat Cash", icon:"EC", href:waLink },
    { key:"we", title:"WE Pay", icon:"WE", href:waLink },
    { key:"instapay", title:"InstaPay", icon:"IP", href:"https://www.instapay.eg/" },
    { key:"visa", title:"Visa / Card", icon:"V", href:"https://www.visa.com/" },
  ];

  $("payList").innerHTML = items.map(x=>`
    <button class="payBtn" data-pay="${x.key}">
      <span class="payLeft"><span class="payIcon">${x.icon}</span><span>${x.title}</span></span>
      <span class="mini">‚Üí</span>
    </button>
  `).join("");

  $("payList").querySelectorAll("[data-pay]").forEach(b=>{
    b.onclick = ()=>{
      const k=b.dataset.pay;
      const it=items.find(x=>x.key===k);
      if(it) window.open(it.href, "_blank");
      // Mark card as used only when user opens a payment method (simulate usage)
      if(cardApplied?.code){
        consumeCard(cardApplied.code);
        cardApplied = null;
      }
      // clear cart only if checkout was from cart
      if(checkoutState.mode==="cart"){
        cart = [];
        saveCart(cart);
        refreshCartCount();
      }
      pushNotif(isArabic ? "ÿ™ŸÖ ŸÅÿ™ÿ≠ ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ. ÿßÿ®ÿπÿ™ ÿ•ÿ´ÿ®ÿßÿ™ ÿßŸÑÿØŸÅÿπ." : "Payment method opened. Send proof.");
      $("payHelp").textContent = L.afterPay;
    };
  });

  $("payHelp").innerHTML = `
    <div class="row" style="align-items:center">
      <button class="smallBtn tight" id="copyPhoneBtn" style="flex:0 0 auto">${isArabic ? "ŸÜÿ≥ÿÆ ÿßŸÑÿ±ŸÇŸÖ" : "Copy number"}</button>
      <div class="note" style="margin:0;flex:1">${isArabic ? "ÿ±ŸÇŸÖ ÿßŸÑÿØŸÅÿπ/ÿßŸÑÿ™ŸàÿßÿµŸÑ:" : "Payment/Contact:"} <strong>${SELLER_PHONE}</strong></div>
    </div>
  `;
  $("copyPhoneBtn").onclick = async ()=>{
    try{ await navigator.clipboard.writeText(SELLER_PHONE); alert(L.copied); }
    catch{ prompt(isArabic ? "ÿßŸÜÿ≥ÿÆ ÿßŸÑÿ±ŸÇŸÖ:" : "Copy number:", SELLER_PHONE); }
  };

  openModal($("payModal"));
}

/* Consume card */
function consumeCard(code){
  const cards = getCards();
  const idx = cards.findIndex(c=>c.code===code);
  if(idx>=0){
    cards[idx].used = true;
    setCards(cards);
    pushNotif(isArabic ? `ÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÉÿßÿ±ÿ™ ÿßŸÑÿÆÿµŸÖ: ${code}` : `Discount card used: ${code}`);
  }
}

/* =========================
   Gems UI + redeem
========================= */
function refreshGemsUI(){
  $("gemsCount").textContent = String(getGems());
}
$("gemsBtn").onclick = ()=>{
  if(!isLoggedIn()){
    pushLightNotif(L.mustLogin);
    openModal($("authModal"));
    showTab("login");
    return;
  }
  renderGemsModal();
  openModal($("gemsModal"));
};
$("gemsClose").onclick = closeAll;

function renderGemsModal(){
  const g = getGems();
  $("gemsInfo").textContent = L.gemsInfo(g);
  $("redeemErr").style.display="none";
  $("redeemOk").style.display="none";
  $("redeemInput").value = "";

  renderCardsList();
}
function renderCardsList(){
  const cards = getCards().slice().sort((a,b)=>b.created-a.created);
  if(!cards.length){
    $("cardsList").innerHTML = `<div class="note">${L.noCards}</div>`;
    return;
  }
  $("cardsList").innerHTML = cards.map(c=>`
    <div class="note ${c.used?'err':'ok'}" style="display:flex;justify-content:space-between;gap:10px;align-items:center">
      <div style="font-weight:900">${c.code} ‚Äî ${c.pct}%</div>
      <div style="font-size:12px">${c.used ? (isArabic?'ŸÖŸèÿ≥ÿ™ÿÆÿØŸÖ':'Used') : (isArabic?'ÿ¨ÿßŸáÿ≤':'Ready')}</div>
    </div>
  `).join("");
}

$("redeemBtn").onclick = ()=>{
  const want = Math.floor(Number($("redeemInput").value||0));
  $("redeemErr").style.display="none";
  $("redeemOk").style.display="none";

  if(!want || want<=0){
    $("redeemErr").textContent = L.fillAll;
    $("redeemErr").style.display="block";
    return;
  }
  const have = getGems();
  if(want > have){
    $("redeemErr").textContent = L.redeemTooMuch;
    $("redeemErr").style.display="block";
    return;
  }

  const pct = pctForRedeem(want);
  if(!pct){
    $("redeemErr").textContent = isArabic ? "ÿßÿ®ÿØÿ£ ŸÖŸÜ 10 ÿ¨ŸàÿßŸáÿ± ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ." : "Minimum 10 gems.";
    $("redeemErr").style.display="block";
    return;
  }

  // Create card
  const code = `GEM-${uid(6)}`;
  const cards = getCards();
  cards.unshift({ code, pct, used:false, created: now() });
  setCards(cards);

  // Deduct gems
  setGems(have - want);

  $("redeemOk").textContent = L.redeemOk(code, pct);
  $("redeemOk").style.display="block";
  pushNotif(isArabic ? `ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÉÿßÿ±ÿ™ ÿÆÿµŸÖ ŸÖŸÜ ÿßŸÑÿ¨ŸàÿßŸáÿ±: ${code}` : `Created discount card: ${code}`);
  renderGemsModal();
};

/* =========================
   Notifications
========================= */
function refreshNotifUI(){
  const u = getCurrentUser();
  if(!u){
    $("notifCount").textContent = "0";
    return;
  }
  const list = getNotifs();
  const unread = list.filter(x=>!x.read).length;
  $("notifCount").textContent = String(unread);
}
$("notifBtn").onclick = ()=>{
  if(!isLoggedIn()){
    pushLightNotif(L.mustLogin);
    openModal($("authModal"));
    showTab("login");
    return;
  }
  renderNotifs();
  openModal($("notifModal"));
};
$("notifClose").onclick = closeAll;
$("notifClearBtn").onclick = ()=>{
  setNotifs([]);
  renderNotifs();
};

function renderNotifs(){
  const list = getNotifs();
  if(!list.length){
    $("notifList").innerHTML = `<div class="note">${isArabic ? "ŸÖŸÅŸäÿ¥ ÿ±ÿ≥ÿßÿ¶ŸÑ." : "No notifications."}</div>`;
    return;
  }
  // mark as read
  list.forEach(x=>x.read=true);
  setNotifs(list);

  $("notifList").innerHTML = list.map(n=>`
    <div class="note">
      <div style="font-weight:900;margin-bottom:6px">${new Date(n.ts).toLocaleString()}</div>
      <div>${n.text}</div>
    </div>
  `).join("");
}

/* small toast-like feedback using notifications count only (no external libs) */
let toastTimer=null;
function pushLightNotif(text){
  // re-use notif modal hint style via alert-ish but nicer:
  // We'll use pushNotif only if logged in; otherwise quick alert
  if(isLoggedIn()){
    // do not spam list; just a soft alert:
    // keep in-app alert:
    try{ console.log(text); }catch{}
  }else{
    // for guest, use alert
    // but keep it short
  }
}

/* =========================
   Reviews
========================= */
$("reviewsClose").onclick = closeAll;
$("submitReviewBtn").onclick = ()=>{
  $("reviewErr").style.display="none";
  $("reviewOk").style.display="none";

  if(!isLoggedIn()){
    $("reviewErr").textContent = L.reviewNeedLogin;
    $("reviewErr").style.display="block";
    return;
  }
  const text = ($("reviewText").value||"").trim();
  const stars = Number($("reviewStars").value||5);
  if(!text){
    $("reviewErr").textContent = L.fillAll;
    $("reviewErr").style.display="block";
    return;
  }
  const u = getCurrentUser();
  const all = safeJSONGet(LS_REVIEWS, []);
  all.unshift({ email:u.email, name:u.name, stars, text, ts: now() });
  safeJSONSet(LS_REVIEWS, all);

  $("reviewText").value = "";
  $("reviewOk").textContent = L.reviewSent;
  $("reviewOk").style.display="block";
  pushNotif(isArabic ? "ÿ¥ŸÉÿ±ÿßŸã! ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ŸÖÿ±ÿßÿ¨ÿπÿ™ŸÉ ‚úÖ" : "Thanks! Review sent ‚úÖ");
  renderReviews();
};

function renderReviews(){
  const all = safeJSONGet(LS_REVIEWS, []);
  if(!all.length){
    $("reviewsList").innerHTML = `<div class="note">${isArabic ? "ŸÖŸÅŸäÿ¥ ŸÖÿ±ÿßÿ¨ÿπÿßÿ™ ŸÑÿ≥Ÿá." : "No reviews yet."}</div>`;
    return;
  }
  $("reviewsList").innerHTML = all.map(r=>`
    <div class="note">
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
        <div style="font-weight:900">${r.name}</div>
        <div style="font-weight:900;color:rgba(246,247,255,.9)">${"‚≠ê".repeat(Math.max(1,Math.min(5,r.stars)))}</div>
      </div>
      <div style="margin-top:8px;color:rgba(185,193,217,.95)">${r.text}</div>
      <div class="mini" style="margin-top:8px">${new Date(r.ts).toLocaleString()}</div>
    </div>
  `).join("");
}

/* =========================
   Contact modal
========================= */
$("contactClose").onclick = closeAll;

/* =========================
   Buttons: cart/checkout details already
========================= */

/* =========================
   Filter defaults
========================= */
$("filterCategory").value="all";
$("filterSort").value="new";
$("priceMode").value="off";
$("priceValue").placeholder = isArabic ? "ŸÖÿ´ŸÑÿßŸã 300" : "e.g. 300";

/* =========================
   Pay modal close by clicking outside too
========================= */
$("payModal").addEventListener("click", (e)=>{
  if(e.target === $("payModal")) closeAll();
});

/* =========================
   Close modals by clicking outside
========================= */
[
  "authModal","accountModal","notifModal","gemsModal","cartModal","checkoutModal","detailsModal","lightbox","contactModal","reviewsModal"
].forEach(id=>{
  $(id).addEventListener("click", (e)=>{
    if(e.target === $(id)) closeAll();
  });
});

/* =========================
   Year
========================= */
$("year").textContent = new Date().getFullYear();

/* =========================
   Final: close buttons
========================= */
$("notifClose").onclick = closeAll;
$("gemsClose").onclick = closeAll;
$("cartClose").onclick = closeAll;
$("checkoutClose").onclick = closeAll;
$("detailsClose").onclick = closeAll;
$("lightClose").onclick = closeAll;

/* =========================
   Keep counts fresh after load
========================= */
refreshCartCount();
refreshGemsUI();
refreshNotifUI();

/* =========================
   IMPORTANT: ensure drawers close transform
========================= */
(function(){
  const md=$("menuDrawer"), fd=$("filterDrawer");
  md.dataset.closed = md.dataset.closed || (isArabic ? "translateX(110%)" : "translateX(-110%)");
  fd.dataset.closed = fd.dataset.closed || (isArabic ? "translateX(-110%)" : "translateX(110%)");
})();

/* Open gems/notifs only after auth; already handled */

/* End */
</script>
</body>
</html>
