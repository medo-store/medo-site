<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Medo Gaming Store</title>

  <style>
    :root{
      --bg0:#060814;
      --bg1:#0A1030;
      --panel:#0C173A;
      --card:rgba(12,23,54,.78);
      --text:#F6F7FF;
      --muted:#B9C1D9;
      --border:rgba(255,255,255,.10);

      --accent:#E11D48;
      --accent2:#38BDF8;
      --good:#22C55E;
      --warn:#F59E0B;

      --radius:14px;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 15% 8%, rgba(56,189,248,.16), transparent 60%),
        radial-gradient(900px 600px at 85% 0%, rgba(225,29,72,.14), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      min-height:100vh;
      overflow-x:hidden;
    }

    /* subtle side decor (no external images) */
    body:before, body:after{
      content:"";
      position:fixed;
      top:140px;
      width:320px;height:520px;
      pointer-events:none;
      opacity:.20;
      filter: blur(.2px);
      z-index:0;
      background:
        radial-gradient(120px 120px at 35% 25%, rgba(56,189,248,.35), transparent 60%),
        radial-gradient(150px 150px at 70% 35%, rgba(225,29,72,.28), transparent 62%),
        radial-gradient(110px 110px at 40% 70%, rgba(245,158,11,.22), transparent 62%),
        radial-gradient(160px 160px at 70% 78%, rgba(34,197,94,.20), transparent 62%);
      border-radius:26px;
      border:1px solid rgba(255,255,255,.06);
    }
    body:before{left:-220px}
    body:after{right:-220px}

    a{color:inherit;text-decoration:none}
    .container{max-width:1200px;margin:0 auto;padding:10px 12px; position:relative; z-index:1;}

    /* Header */
    .nav{
      position:sticky; top:0; z-index:60;
      background:rgba(6,8,20,.72);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .nav-inner{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.2px;white-space:nowrap}
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:0 0 0 4px rgba(56,189,248,.10);
    }

    .searchWrap{flex:1;min-width:220px;display:flex;align-items:center;gap:8px}
    .search{
      flex:1;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
    }

    .iconBtn{
      display:inline-flex;align-items:center;justify-content:center;
      gap:8px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      user-select:none;
    }
    .iconBtn:hover{filter:brightness(1.08)}
    .rightBox{margin-inline-start:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    .pillCount{
      min-width:22px;height:22px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;
      background:rgba(56,189,248,.16);
      border:1px solid rgba(56,189,248,.35);
      font-weight:900;font-size:12px;padding:0 6px;
    }

    .userChip{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 10px;border-radius:999px;
      border:1px solid rgba(56,189,248,.35);
      background:rgba(56,189,248,.10);
      cursor:pointer;white-space:nowrap;
      font-weight:900;font-size:13px;
    }
    .avatarSmall{
      width:22px;height:22px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.07);
      display:inline-flex;align-items:center;justify-content:center;
      overflow:hidden;
      font-size:11px;
      flex:0 0 auto;
    }
    .avatarSmall img{width:100%;height:100%;object-fit:cover}

    /* Filter button - looks like app */
    .filterIcon{
      width:18px;height:18px;display:inline-block;line-height:0;
    }
    .filterIcon svg{display:block}

    /* Sections */
    .sectionTitle{
      margin:18px 0 8px;
      font-size:15px;
      font-weight:900;
      display:flex;align-items:center;gap:10px;
    }
    .sectionHint{color:var(--muted);font-weight:800;font-size:12px}
    .spacer{height:18px}

    /* Grid: desktop = 4, tablet = 3, mobile = 2, small = 1 */
    .grid{
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:16px; /* requested: more space */
    }
    @media (max-width:1050px){ .grid{grid-template-columns:repeat(3, minmax(0,1fr));} }
    @media (max-width:760px){ .grid{grid-template-columns:repeat(2, minmax(0,1fr));} }
    @media (max-width:460px){ .grid{grid-template-columns:1fr;} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      display:flex;flex-direction:column;
      min-height:246px;
    }
    .thumb{
      height:110px;
      background:
        radial-gradient(180px 120px at 25% 30%, rgba(56,189,248,.22), transparent 65%),
        radial-gradient(180px 120px at 75% 0%, rgba(225,29,72,.18), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;letter-spacing:.7px;font-size:12px;
      position:relative;
      cursor:pointer;
    }
    .badge{
      position:absolute;top:8px;inset-inline-start:8px;
      padding:6px 8px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.25);
      font-size:11px;font-weight:900;
      display:inline-flex;gap:6px;align-items:center;
    }
    .badge.top{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.12)}
    .badge.offer{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.12)}

    .content{padding:12px 12px 12px;display:flex;flex-direction:column;gap:8px;flex:1}
    .name{margin:0;font-size:13px;font-weight:900}
    .meta{margin:0;font-size:12px;color:var(--muted);line-height:1.4}
    .stars{display:flex;gap:2px;align-items:center;font-size:14px;letter-spacing:1px; opacity:.95}
    .stars button{
      background:transparent;border:none;color:rgba(246,247,255,.88);
      cursor:pointer;padding:0;line-height:1;
      font-size:16px;
    }
    .stars .mutedStar{opacity:.45}
    .ratingInfo{font-size:11px;color:var(--muted);font-weight:800}

    .priceRow{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .price{margin:0;font-size:12px;font-weight:900}

    .actions{display:flex;gap:8px;margin-top:auto;flex-wrap:wrap}
    .btn{
      flex:1;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 10px;
      font-weight:900;font-size:12px;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      min-width:120px;
    }
    .btn:hover{filter:brightness(1.08)}
    .btnRed{background:linear-gradient(135deg, rgba(225,29,72,1), rgba(225,29,72,.82));border-color:transparent}
    .btnBlue{background:rgba(56,189,248,.12);border-color:rgba(56,189,248,.35)}
    .btnWarn{background:rgba(245,158,11,.14);border-color:rgba(245,158,11,.35)}

    /* Overlay / Drawer / Modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.58);display:none;z-index:80}
    .overlay.show{display:block}

    .drawer{
      position:fixed;top:0;bottom:0;
      width:min(360px, 92vw);
      background:rgba(12,23,58,.92);
      backdrop-filter: blur(10px);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      z-index:90;
      transition: transform .22s ease;
      display:flex;flex-direction:column;
      transform: translateX(110%); /* hidden by default */
    }
    html[dir="rtl"] .drawer{ right:0; transform: translateX(110%); }
    html[dir="ltr"] .drawer{ left:auto; right:0; transform: translateX(110%); }
    .drawer.show{ transform: translateX(0); }

    .drawerHeader{
      padding:12px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .drawerTitle{font-weight:900}
    .drawerBody{padding:12px;overflow:auto}
    .drawerSection{margin:10px 0 16px}
    .drawerLabel{font-weight:900;margin:0 0 8px}
    .drawerList{display:flex;flex-direction:column;gap:8px}
    .linkRow{
      padding:10px 10px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      cursor:pointer;
    }
    .linkRow:hover{filter:brightness(1.08)}
    .mini{font-size:12px;color:var(--muted);font-weight:800}

    .note{
      padding:10px 10px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-weight:800;font-size:12px;line-height:1.5;
    }
    .note.err{background:rgba(225,29,72,.18);border-color:rgba(225,29,72,.45);color:#fff}
    .note.ok{background:rgba(34,197,94,.14);border-color:rgba(34,197,94,.35);color:#fff}
    .note.warn{background:rgba(245,158,11,.14);border-color:rgba(245,158,11,.35);color:#fff}

    .modal{position:fixed;inset:0;display:none;z-index:95;align-items:center;justify-content:center;padding:14px}
    .modal.show{display:flex}
    .modalBox{
      width:min(820px, 96vw);
      max-height:min(86vh, 760px);
      overflow:auto;
      background:rgba(12,23,58,.94);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow-x:hidden;
    }
    .modalHeader{
      position:sticky;top:0;
      background:rgba(12,23,58,.94);
      padding:12px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      z-index:2;
    }
    .modalTitle{font-weight:900}
    .modalBody{padding:12px}

    .stack{display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .row .tight{flex:0 0 auto}

    .input{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
    }
    .select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
      font-weight:900;
    }

    /* Cart */
    .cartItem{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .cartLeft{display:flex;gap:10px;flex:1}
    .cartThumb{
      width:54px;height:54px;border-radius:14px;
      border:1px solid var(--border);
      background:
        radial-gradient(40px 30px at 20% 20%, rgba(56,189,248,.25), transparent 65%),
        radial-gradient(40px 30px at 80% 0%, rgba(225,29,72,.18), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      overflow:hidden;
      flex:0 0 auto;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:11px;opacity:.9;
      cursor:pointer;
    }
    .cartName{font-weight:900;font-size:13px;margin:0 0 4px}
    .cartMeta{margin:0;color:var(--muted);font-size:12px;font-weight:800}
    .qtyRow{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .qtyBtn{
      width:34px;height:34px;border-radius:10px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
    }
    .qtyNum{min-width:34px;text-align:center;font-weight:900}
    .removeBtn{
      border:1px solid rgba(225,29,72,.35);
      background:rgba(225,29,72,.12);
      color:rgba(246,247,255,.95);
      font-weight:900;cursor:pointer;
      padding:8px 10px;border-radius:10px;
      white-space:nowrap;
    }
    .totalBar{
      margin-top:10px;
      border:1px solid rgba(56,189,248,.35);
      background:rgba(56,189,248,.10);
      border-radius:14px;
      padding:10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      user-select:none;
    }

    /* Gallery */
    .galleryBig{
      width:100%;
      height:240px;
      border-radius:14px;
      border:1px solid var(--border);
      background:
        radial-gradient(280px 160px at 25% 30%, rgba(56,189,248,.22), transparent 65%),
        radial-gradient(280px 160px at 75% 0%, rgba(225,29,72,.18), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      display:flex;align-items:center;justify-content:center;
      font-weight:900;letter-spacing:.7px;
      overflow:hidden;
      position:relative;
    }
    .galleryBig img{
      width:100%;height:100%;object-fit:cover;
      opacity:.95;
    }
    .galleryRow{display:flex;gap:10px;flex-wrap:wrap}
    .gThumb{
      width:78px;height:56px;border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;font-weight:900;font-size:11px;color:rgba(246,247,255,.9);
      overflow:hidden;
    }
    .gThumb img{width:100%;height:100%;object-fit:cover}
    .gThumb.active{border-color:rgba(56,189,248,.55);background:rgba(56,189,248,.10)}

    /* Footer */
    .footer{
      margin-top:18px;border-top:1px solid var(--border);
      padding:14px 0 22px;
      color:var(--muted);
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }
    .social{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      font-weight:900;font-size:12px;
    }
    .social:hover{filter:brightness(1.08)}
    .mutedRight{margin-inline-start:auto;font-weight:900;font-size:12px;color:rgba(185,193,217,.9)}
  </style>
</head>

<body>
  <div class="nav">
    <div class="container nav-inner">
      <div class="brand">
        <span class="dot"></span>
        <span id="brandText">Medo Gaming Store</span>
      </div>

      <div class="searchWrap">
        <input id="search" class="search" placeholder="üîç Search..." />
        <button class="iconBtn" id="filterBtn" title="Filter">
          <span class="filterIcon" aria-hidden="true">
            <!-- nicer filter icon -->
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M4 6h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M7 12h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M10 18h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <circle cx="7" cy="12" r="2" fill="currentColor" opacity=".25"/>
              <circle cx="10" cy="18" r="2" fill="currentColor" opacity=".18"/>
              <circle cx="12" cy="6" r="2" fill="currentColor" opacity=".18"/>
            </svg>
          </span>
        </button>
      </div>

      <div class="rightBox">
        <button class="iconBtn" id="inboxBtn" title="Inbox">üîî <span class="pillCount" id="inboxCount">0</span></button>
        <button class="iconBtn" id="gemsBtn" title="Bonus">üíé <span class="pillCount" id="gemsCount">0</span></button>
        <button class="iconBtn" id="cartBtn" title="Cart">üõí <span class="pillCount" id="cartCount">0</span></button>

        <button class="iconBtn" id="authBtn" title="Account">üë§ <span id="authText">Sign in</span></button>

        <div class="userChip" id="userChip" style="display:none" title="User">
          <span class="avatarSmall" id="avatarSmall">U</span>
          <span id="userNameText">User</span>
        </div>

        <button class="iconBtn" id="menuBtn" title="Menu">‚ò∞</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="sectionTitle" id="titleTop">üî• Top <span class="sectionHint" id="hintTop">Most wanted</span></div>
    <div id="gridTop" class="grid"></div>

    <div class="spacer"></div>

    <div class="sectionTitle" id="titleOffers">üéÅ Offers <span class="sectionHint" id="hintOffers">Deals</span></div>
    <div id="gridOffers" class="grid"></div>

    <div class="spacer"></div>

    <div class="sectionTitle" id="titleGames">üéÆ Games</div>
    <div id="gridGames" class="grid"></div>

    <div class="spacer"></div>

    <div class="sectionTitle" id="titlePrograms">üíª Programs</div>
    <div id="gridPrograms" class="grid"></div>

    <div class="spacer"></div>

    <div class="sectionTitle" id="titleAccounts">üßæ Accounts</div>
    <div id="gridAccounts" class="grid"></div>

    <div class="spacer"></div>

    <div class="sectionTitle" id="titleCharging">‚ö° Charging</div>
    <div id="gridCharging" class="grid"></div>

    <div class="footer">
      <a class="social" href="https://wa.me/201006760663" target="_blank" rel="noreferrer">WhatsApp</a>
      <a class="social" href="https://www.instagram.com/medo__rami" target="_blank" rel="noreferrer">Instagram</a>
      <a class="social" href="https://www.facebook.com/share/1AScQqiSqq/" target="_blank" rel="noreferrer">Facebook</a>
      <a class="social" href="mailto:medorami77@gmail.com">Email</a>
      <span class="mutedRight">¬© <span id="year"></span> Medo Gaming</span>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <!-- MENU DRAWER -->
  <div class="drawer" id="menuDrawer" aria-hidden="true">
    <div class="drawerHeader">
      <div class="drawerTitle" id="menuTitle">Menu</div>
      <button class="iconBtn" id="menuClose">‚úï</button>
    </div>
    <div class="drawerBody">
      <div class="drawerSection" id="drawerUserBox" style="display:none">
        <div class="note ok" id="drawerUserNote"></div>
        <div class="row">
          <button class="btn" id="editProfileBtn">Edit profile</button>
          <button class="btn" id="logoutBtn">Logout</button>
        </div>
      </div>

      <div class="drawerSection">
        <p class="drawerLabel" id="quickLabel">Quick</p>
        <div class="drawerList">
          <div class="linkRow" data-scroll="gridTop"><span id="mTop">Top</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" data-scroll="gridOffers"><span id="mOffers">Offers</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" data-scroll="gridGames"><span id="mGames">Games</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" data-scroll="gridPrograms"><span id="mPrograms">Programs</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" data-scroll="gridAccounts"><span id="mAccounts">Accounts</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" data-scroll="gridCharging"><span id="mCharging">Charging</span><span class="mini">‚Üí</span></div>

          <div class="linkRow" id="openContactRow"><span id="mContact">Contact</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" id="openReviewsRow"><span id="mReviews">Reviews</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" id="openGiftRow"><span id="mGift">Send Gift</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" id="openInboxRow"><span id="mInbox">Inbox</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" id="openBonusRow"><span id="mBonus">Bonus (Gems)</span><span class="mini">‚Üí</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- FILTER DRAWER -->
  <div class="drawer" id="filterDrawer" aria-hidden="true">
    <div class="drawerHeader">
      <div class="drawerTitle" id="filterTitle">Filter</div>
      <button class="iconBtn" id="filterClose">‚úï</button>
    </div>
    <div class="drawerBody">
      <div class="note" id="filterNote">Choose category, sort and price then apply.</div>

      <div class="drawerSection">
        <p class="drawerLabel" id="filterCatLabel">Category</p>
        <select class="select" id="filterCategory">
          <option value="all">All</option>
          <option value="games">Games</option>
          <option value="programs">Programs</option>
          <option value="accounts">Accounts</option>
          <option value="charging">Charging</option>
          <option value="offers">Offers</option>
          <option value="top">Top</option>
        </select>
      </div>

      <div class="drawerSection">
        <p class="drawerLabel" id="filterSortLabel">Sort</p>
        <select class="select" id="filterSort">
          <option value="new">Newest</option>
          <option value="old">Oldest</option>
          <option value="low">Low ‚Üí High</option>
          <option value="high">High ‚Üí Low</option>
        </select>
      </div>

      <div class="drawerSection">
        <p class="drawerLabel" id="filterPriceLabel">Price</p>
        <div class="row">
          <select class="select" id="priceMode">
            <option value="off">Off</option>
            <option value="eq">Equal</option>
            <option value="lte">‚â§</option>
            <option value="gte">‚â•</option>
          </select>
          <input class="input" id="priceValue" type="number" min="0" placeholder="e.g. 300" />
        </div>
      </div>

      <div class="row">
        <button class="btn btnRed" id="applyFilterBtn">Apply</button>
        <button class="btn" id="clearFilterBtn">Clear</button>
      </div>
    </div>
  </div>

  <!-- PRODUCT DETAILS MODAL -->
  <div class="modal" id="detailsModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="detailsTitle">Product</div>
        <button class="iconBtn" id="detailsClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="galleryBig" id="galleryBig"></div>
          <div class="galleryRow" id="galleryRow"></div>

          <div class="row">
            <div>
              <div style="font-weight:900" id="detailsName">Name</div>
              <div class="note" id="detailsDesc"></div>
            </div>
            <div class="note ok" style="text-align:center">
              <div id="detailsPrice" style="font-weight:900"></div>
              <div id="detailsStock" style="font-size:12px"></div>
            </div>
          </div>

          <div class="row">
            <button class="btn btnBlue" id="detailsAddCartBtn">üõí Add to Cart</button>
            <button class="btn btnRed" id="detailsBuyBtn">Buy</button>
          </div>

          <div class="note" id="detailsMsg" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- IMAGE ZOOM MODAL -->
  <div class="modal" id="zoomModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="zoomTitle">Image</div>
        <button class="iconBtn" id="zoomClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="galleryBig" id="zoomBig"></div>
      </div>
    </div>
  </div>

  <!-- CART MODAL -->
  <div class="modal" id="cartModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="cartTitle">Cart</div>
        <button class="iconBtn" id="cartClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack" id="cartList"></div>
        <div class="totalBar">
          <div style="font-weight:900" id="cartTotalLabel">Total</div>
          <div style="font-weight:900" id="cartTotal">0</div>
        </div>
        <div class="row">
          <button class="btn btnRed" id="cartCheckoutBtn">Checkout</button>
          <button class="btn" id="cartClearBtn">Clear</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CHECKOUT MODAL (coupon then confirm, then payment methods) -->
  <div class="modal" id="checkoutModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="checkoutTitle">Checkout</div>
        <button class="iconBtn" id="checkoutClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="note" id="checkoutSummary"></div>

          <div class="row">
            <input class="input" id="couponInput" placeholder="Discount code" />
            <button class="btn btnBlue tight" id="applyCouponBtn" style="flex:0 0 auto">Apply</button>
          </div>

          <div class="note" id="couponMsg" style="display:none"></div>

          <div class="row">
            <button class="btn btnRed" id="confirmCheckoutBtn">Confirm</button>
          </div>

          <div id="paymentBlock" style="display:none">
            <div class="note ok" id="paymentTitle">Payment Methods</div>
            <div class="stack">
              <button class="btn" data-pay="vodafone">Vodafone Cash</button>
              <button class="btn" data-pay="etisalat">Etisalat Cash</button>
              <button class="btn" data-pay="orange">Orange Cash</button>
              <button class="btn" data-pay="we">WE Pay</button>
              <button class="btn" data-pay="instapay">InstaPay</button>
              <button class="btn" data-pay="card">Visa / Card</button>
              <button class="btn" data-pay="bill">Bill Pay</button>
              <button class="btn" data-pay="telda">Telda</button>
            </div>
            <div class="note warn" id="payNote" style="margin-top:10px">After paying, you can contact the store to complete the order.</div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- INBOX MODAL -->
  <div class="modal" id="inboxModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="inboxTitle">Inbox</div>
        <button class="iconBtn" id="inboxClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack" id="inboxList"></div>
        <div class="row">
          <button class="btn" id="clearInboxBtn">Clear</button>
        </div>
      </div>
    </div>
  </div>

  <!-- GEMS MODAL -->
  <div class="modal" id="gemsModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="gemsTitle">Bonus (Gems)</div>
        <button class="iconBtn" id="gemsClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="note ok" id="gemsInfo">Your gems: 0</div>

          <div class="note" id="redeemHint">Redeem gems to get a real discount code.</div>

          <div class="row">
            <select class="select" id="redeemSelect">
              <option value="10">10% (10 gems)</option>
              <option value="20">20% (20 gems)</option>
              <option value="30">30% (30 gems)</option>
              <option value="40">40% (40 gems)</option>
              <option value="50">50% (50 gems)</option>
            </select>
            <button class="btn btnRed tight" id="redeemBtn" style="flex:0 0 auto">Redeem</button>
          </div>

          <div class="note" id="redeemMsg" style="display:none"></div>

          <div class="note" id="walletTitle" style="font-weight:900">Your codes</div>
          <div class="stack" id="walletList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTACT MODAL -->
  <div class="modal" id="contactModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="contactTitle">Contact</div>
        <button class="iconBtn" id="contactClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <a class="btn" href="https://wa.me/201006760663" target="_blank">WhatsApp</a>
          <a class="btn" href="https://www.instagram.com/medo__rami" target="_blank">Instagram</a>
          <a class="btn" href="https://www.facebook.com/share/1AScQqiSqq/" target="_blank">Facebook</a>
          <a class="btn" href="mailto:medorami77@gmail.com">Email</a>
        </div>
      </div>
    </div>
  </div>

  <!-- REVIEWS MODAL -->
  <div class="modal" id="reviewsModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="reviewsTitle">Reviews</div>
        <button class="iconBtn" id="reviewsClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="row">
            <input class="input" id="reviewText" placeholder="Write your review..." />
            <button class="btn btnRed tight" id="addReviewBtn" style="flex:0 0 auto">Post</button>
          </div>
          <div class="stack" id="reviewsList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- GIFT MODAL -->
  <div class="modal" id="giftModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="giftTitle">Send Gift</div>
        <button class="iconBtn" id="giftClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="note" id="giftHint">Receiver must have an account.</div>
          <input class="input" id="giftToEmail" type="email" placeholder="Receiver email" />
          <div class="row">
            <select class="select" id="giftType">
              <option value="gems">Gems</option>
              <option value="product">Product ID</option>
            </select>
            <input class="input" id="giftAmount" type="text" placeholder="Amount / Product ID" />
          </div>
          <button class="btn btnRed" id="sendGiftBtn">Send</button>
          <div class="note err" id="giftErr" style="display:none"></div>
          <div class="note ok" id="giftOk" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- AUTH MODAL (Stepper) -->
  <div class="modal" id="authModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="authTitle">Account</div>
        <button class="iconBtn" id="authClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="row">
            <button class="btn btnBlue" id="tabLogin">Login</button>
            <button class="btn" id="tabRegister">Create account</button>
          </div>

          <!-- LOGIN -->
          <div id="loginBox" class="stack">
            <input class="input" id="loginEmail" type="email" placeholder="Email" />
            <div class="row">
              <input class="input" id="loginPass" type="password" placeholder="Password" />
              <button class="btn tight" id="toggleLoginPass" style="flex:0 0 auto; min-width:auto">üëÅ</button>
            </div>
            <button class="btn btnRed" id="loginBtn">Login</button>
            <div class="note err" id="loginErr" style="display:none"></div>
          </div>

          <!-- REGISTER (Steps) -->
          <div id="registerBox" class="stack" style="display:none">
            <div class="note" id="regStepTitle">Step 1/4</div>

            <div id="regStep1" class="stack">
              <div class="row">
                <input class="input" id="firstName" placeholder="First name" />
                <input class="input" id="lastName" placeholder="Last name" />
              </div>
              <button class="btn btnRed" id="regNext1">Next</button>
            </div>

            <div id="regStep2" class="stack" style="display:none">
              <input class="input" id="regEmail" type="email" placeholder="Email" />
              <div class="row">
                <input class="input" id="regPass" type="password" placeholder="Password" />
                <button class="btn tight" id="toggleRegPass" style="flex:0 0 auto; min-width:auto">üëÅ</button>
              </div>
              <button class="btn btnRed" id="regNext2">Next</button>
              <button class="btn" id="regBack2">Back</button>
              <div class="note err" id="regErr2" style="display:none"></div>
            </div>

            <div id="regStep3" class="stack" style="display:none">
              <div class="row">
                <select class="select" id="regGender">
                  <option value="">Gender</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                </select>
                <input class="input" id="regAge" type="number" min="1" max="120" placeholder="Age" />
              </div>
              <button class="btn btnRed" id="regNext3">Next</button>
              <button class="btn" id="regBack3">Back</button>
              <div class="note err" id="regErr3" style="display:none"></div>
            </div>

            <div id="regStep4" class="stack" style="display:none">
              <div class="note" id="avatarHint">Upload avatar (optional)</div>
              <input class="input" id="regAvatar" type="file" accept="image/*" />
              <button class="btn btnRed" id="createAccountBtn">Create</button>
              <button class="btn" id="regBack4">Back</button>
              <div class="note err" id="regErr4" style="display:none"></div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- PROFILE MODAL -->
  <div class="modal" id="profileModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="profileTitle">Profile</div>
        <button class="iconBtn" id="profileClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="row">
            <input class="input" id="profileName" placeholder="Display name" />
            <button class="btn btnBlue tight" id="saveProfileName" style="flex:0 0 auto">Save</button>
          </div>

          <div class="row">
            <input class="input" id="newPass" type="password" placeholder="New password" />
            <button class="btn tight" id="toggleNewPass" style="flex:0 0 auto; min-width:auto">üëÅ</button>
          </div>
          <button class="btn btnRed" id="saveNewPass">Change password</button>

          <div class="note" id="profileMsg" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       Helpers
    ========================== */
    const $ = (id)=>document.getElementById(id);
    const nowYear = new Date().getFullYear();
    $("year").textContent = nowYear;

    function safeJsonParse(v, fallback){
      try{ return JSON.parse(v); }catch{ return fallback; }
    }

    function uid(len=6){
      const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let out="";
      for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }

    /* =========================
       i18n (auto by device language)
    ========================== */
    const isArabic = (navigator.language || "").toLowerCase().startsWith("ar");
    document.documentElement.lang = isArabic ? "ar" : "en";
    document.documentElement.dir  = isArabic ? "rtl" : "ltr";

    const T = {
      en:{
        search:"üîç Search...",
        top:"Top", topHint:"Most wanted",
        offers:"Offers", offersHint:"Deals",
        games:"Games",
        programs:"Programs",
        accounts:"Accounts",
        charging:"Charging",
        menu:"Menu",
        quick:"Quick",
        contact:"Contact",
        reviews:"Reviews",
        gift:"Send Gift",
        inbox:"Inbox",
        bonus:"Bonus (Gems)",
        filter:"Filter",
        filterNote:"Choose category, sort and price then apply.",
        cat:"Category", sort:"Sort", price:"Price",
        apply:"Apply", clear:"Clear",
        signin:"Sign in",
        cart:"Cart",
        total:"Total",
        checkout:"Checkout",
        confirm:"Confirm",
        payment:"Payment Methods",
        coupon:"Discount code",
        addCart:"üõí Add to Cart",
        buy:"Buy",
        details:"Product",
        stock:"Available",
        soldout:"Sold out",
        login:"Login",
        create:"Create account",
        step:"Step",
        next:"Next",
        back:"Back",
        first:"First name",
        last:"Last name",
        email:"Email",
        pass:"Password",
        gender:"Gender",
        age:"Age",
        male:"Male",
        female:"Female",
        upload:"Upload avatar (optional)",
        profile:"Profile",
        displayName:"Display name",
        save:"Save",
        newPass:"New password",
        changePass:"Change password",
        posted:"Posted",
        writeReview:"Write your review...",
        receiver:"Receiver email",
        amount:"Amount / Product ID",
        sent:"Sent",
        mustLogin:"Please login first."
      },
      ar:{
        search:"üîç ÿßÿ®ÿ≠ÿ´...",
        top:"ÿ™Ÿàÿ®", topHint:"ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ∑ŸÑÿ®Ÿãÿß",
        offers:"ÿπÿ±Ÿàÿ∂", offersHint:"ÿÆÿµŸàŸÖÿßÿ™",
        games:"ÿßŸÑÿ£ŸÑÿπÿßÿ®",
        programs:"ÿßŸÑÿ®ÿ±ÿßŸÖÿ¨",
        accounts:"ÿßŸÑÿ£ŸÉŸàŸÜÿ™ÿßÿ™",
        charging:"ÿßŸÑÿ¥ÿ≠ŸÜ",
        menu:"ÿßŸÑŸÇÿßÿ¶ŸÖÿ©",
        quick:"ÿßÿÆÿ™ÿµÿßÿ±ÿßÿ™",
        contact:"ÿßŸÑÿ™ŸàÿßÿµŸÑ",
        reviews:"ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿßÿ™",
        gift:"ÿ•ÿ±ÿ≥ÿßŸÑ ŸáÿØŸäÿ©",
        inbox:"ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ",
        bonus:"ÿßŸÑÿ¨ŸàÿßŸáÿ±",
        filter:"ŸÅŸÑÿ™ÿ±ÿ©",
        filterNote:"ÿßÿÆÿ™ÿßÿ± ÿßŸÑŸÇÿ≥ŸÖ ŸàÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ŸàÿßŸÑÿ≥ÿπÿ± Ÿàÿ®ÿπÿØŸäŸÜ ÿ™ÿ∑ÿ®ŸäŸÇ.",
        cat:"ÿßŸÑŸÇÿ≥ŸÖ", sort:"ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ®", price:"ÿßŸÑÿ≥ÿπÿ±",
        apply:"ÿ™ÿ∑ÿ®ŸäŸÇ", clear:"ŸÖÿ≥ÿ≠",
        signin:"ÿ™ÿ≥ÿ¨ŸäŸÑ",
        cart:"ÿßŸÑÿ≥ŸÑÿ©",
        total:"ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä",
        checkout:"ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ¥ÿ±ÿßÿ°",
        confirm:"ÿ™ÿ£ŸÉŸäÿØ",
        payment:"ÿ∑ÿ±ŸÇ ÿßŸÑÿØŸÅÿπ",
        coupon:"ŸÉŸàÿØ ÿßŸÑÿÆÿµŸÖ",
        addCart:"üõí ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ≥ŸÑÿ©",
        buy:"ÿ¥ÿ±ÿßÿ°",
        details:"ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨",
        stock:"ŸÖÿ™ÿßÿ≠",
        soldout:"ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠",
        login:"ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ",
        create:"ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®",
        step:"ÿÆÿ∑Ÿàÿ©",
        next:"ÿßŸÑÿ™ÿßŸÑŸä",
        back:"ÿ±ÿ¨Ÿàÿπ",
        first:"ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ£ŸàŸÑ",
        last:"ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ´ÿßŸÜŸä",
        email:"ÿßŸÑÿ®ÿ±ŸäÿØ",
        pass:"ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±",
        gender:"ÿßŸÑŸÜŸàÿπ",
        age:"ÿßŸÑÿπŸÖÿ±",
        male:"ÿ∞ŸÉÿ±",
        female:"ÿ£ŸÜÿ´Ÿâ",
        upload:"ÿ±ŸÅÿπ ÿµŸàÿ±ÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)",
        profile:"ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä",
        displayName:"ÿßÿ≥ŸÖ ÿßŸÑÿπÿ±ÿ∂",
        save:"ÿ≠ŸÅÿ∏",
        newPass:"ŸÉŸÑŸÖÿ© ÿ≥ÿ± ÿ¨ÿØŸäÿØÿ©",
        changePass:"ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±",
        posted:"ÿ™ŸÖ ÿßŸÑŸÜÿ¥ÿ±",
        writeReview:"ÿßŸÉÿ™ÿ® ÿ±ÿ£ŸäŸÉ...",
        receiver:"ÿ®ÿ±ŸäÿØ ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖ",
        amount:"ÿßŸÑŸÉŸÖŸäÿ© / ÿ±ŸÇŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨",
        sent:"ÿ™ŸÖ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ",
        mustLogin:"ŸÑÿßÿ≤ŸÖ ÿ™ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸàŸÑ."
      }
    }[isArabic ? "ar" : "en"];

    // apply texts
    $("search").placeholder = T.search;
    $("titleTop").childNodes[1].textContent = " " + T.top + " ";
    $("hintTop").textContent = T.topHint;
    $("titleOffers").childNodes[1].textContent = " " + T.offers + " ";
    $("hintOffers").textContent = T.offersHint;
    $("titleGames").textContent = "üéÆ " + T.games;
    $("titlePrograms").textContent = "üíª " + T.programs;
    $("titleAccounts").textContent = "üßæ " + T.accounts;
    $("titleCharging").textContent = "‚ö° " + T.charging;

    $("menuTitle").textContent = T.menu;
    $("quickLabel").textContent = T.quick;

    $("mTop").textContent = T.top;
    $("mOffers").textContent = T.offers;
    $("mGames").textContent = T.games;
    $("mPrograms").textContent = T.programs;
    $("mAccounts").textContent = T.accounts;
    $("mCharging").textContent = T.charging;

    $("mContact").textContent = T.contact;
    $("mReviews").textContent = T.reviews;
    $("mGift").textContent = T.gift;
    $("mInbox").textContent = T.inbox;
    $("mBonus").textContent = T.bonus;

    $("filterTitle").textContent = T.filter;
    $("filterNote").textContent = T.filterNote;
    $("filterCatLabel").textContent = T.cat;
    $("filterSortLabel").textContent = T.sort;
    $("filterPriceLabel").textContent = T.price;
    $("applyFilterBtn").textContent = T.apply;
    $("clearFilterBtn").textContent = T.clear;

    $("authText").textContent = T.signin;
    $("cartTitle").textContent = T.cart;
    $("cartTotalLabel").textContent = T.total;
    $("cartCheckoutBtn").textContent = T.checkout;

    $("checkoutTitle").textContent = T.checkout;
    $("couponInput").placeholder = T.coupon;
    $("confirmCheckoutBtn").textContent = T.confirm;
    $("paymentTitle").textContent = T.payment;

    $("inboxTitle").textContent = T.inbox;
    $("gemsTitle").textContent = T.bonus;
    $("redeemHint").textContent = isArabic ? "ÿ®ÿØŸëŸÑ ÿßŸÑÿ¨ŸàÿßŸáÿ± ŸÑŸÉŸàÿØ ÿÆÿµŸÖ ÿ≠ŸÇŸäŸÇŸä." : "Redeem gems to get a real discount code.";
    $("contactTitle").textContent = T.contact;
    $("reviewsTitle").textContent = T.reviews;
    $("reviewText").placeholder = T.writeReview;
    $("giftTitle").textContent = T.gift;
    $("giftToEmail").placeholder = T.receiver;
    $("giftAmount").placeholder = T.amount;

    $("authTitle").textContent = T.signin;
    $("tabLogin").textContent = T.login;
    $("tabRegister").textContent = T.create;
    $("loginBtn").textContent = T.login;
    $("loginEmail").placeholder = T.email;
    $("loginPass").placeholder = T.pass;

    $("regStepTitle").textContent = `${T.step} 1/4`;
    $("firstName").placeholder = T.first;
    $("lastName").placeholder = T.last;
    $("regEmail").placeholder = T.email;
    $("regPass").placeholder = T.pass;
    $("regGender").options[0].textContent = T.gender;
    $("regGender").options[1].textContent = T.male;
    $("regGender").options[2].textContent = T.female;
    $("regAge").placeholder = T.age;
    $("avatarHint").textContent = T.upload;

    $("regNext1").textContent = T.next;
    $("regNext2").textContent = T.next;
    $("regNext3").textContent = T.next;
    $("createAccountBtn").textContent = T.create;
    $("regBack2").textContent = T.back;
    $("regBack3").textContent = T.back;
    $("regBack4").textContent = T.back;

    $("profileTitle").textContent = T.profile;
    $("profileName").placeholder = T.displayName;
    $("saveProfileName").textContent = T.save;
    $("newPass").placeholder = T.newPass;
    $("saveNewPass").textContent = T.changePass;

    /* =========================
       Storage Keys
    ========================== */
    const K = {
      accounts: "mg_accounts_v1",        // email -> account
      session:  "mg_session_v1",         // current email
      cart:     "mg_cart_v1",            // cart array
      inbox:    "mg_inbox_v1",           // per email inbox
      gems:     "mg_gems_v1",            // per email gems
      usedCoupons: "mg_used_coupons_v1", // coupon usage map
      wallet:   "mg_wallet_v1",          // per email generated coupons
      reviews:  "mg_reviews_v1",         // reviews array
      ratings:  "mg_ratings_v1",         // productId -> {sum,count,userMap}
      filter:   "mg_filter_v1"           // current filter
    };

    function getAccounts(){ return safeJsonParse(localStorage.getItem(K.accounts), {}); }
    function setAccounts(v){ localStorage.setItem(K.accounts, JSON.stringify(v)); }
    function getSession(){ return localStorage.getItem(K.session) || ""; }
    function setSession(email){ localStorage.setItem(K.session, email || ""); }

    function getCart(){ return safeJsonParse(localStorage.getItem(K.cart), []); }
    function setCart(v){ localStorage.setItem(K.cart, JSON.stringify(v)); }

    function getInbox(){ return safeJsonParse(localStorage.getItem(K.inbox), {}); }
    function setInbox(v){ localStorage.setItem(K.inbox, JSON.stringify(v)); }

    function getGems(){ return safeJsonParse(localStorage.getItem(K.gems), {}); }
    function setGems(v){ localStorage.setItem(K.gems, JSON.stringify(v)); }

    function getWallet(){ return safeJsonParse(localStorage.getItem(K.wallet), {}); }
    function setWallet(v){ localStorage.setItem(K.wallet, JSON.stringify(v)); }

    function getUsedCoupons(){ return safeJsonParse(localStorage.getItem(K.usedCoupons), {}); }
    function setUsedCoupons(v){ localStorage.setItem(K.usedCoupons, JSON.stringify(v)); }

    function getReviews(){ return safeJsonParse(localStorage.getItem(K.reviews), []); }
    function setReviews(v){ localStorage.setItem(K.reviews, JSON.stringify(v)); }

    function getRatings(){ return safeJsonParse(localStorage.getItem(K.ratings), {}); }
    function setRatings(v){ localStorage.setItem(K.ratings, JSON.stringify(v)); }

    function getFilter(){ return safeJsonParse(localStorage.getItem(K.filter), {q:"",cat:"all",sort:"new",mode:"off",price:0}); }
    function setFilter(v){ localStorage.setItem(K.filter, JSON.stringify(v)); }

    /* =========================
       UI Overlay/Drawers/Modals
    ========================== */
    const overlay = $("overlay");
    const menuDrawer = $("menuDrawer");
    const filterDrawer = $("filterDrawer");

    function openOverlay(){ overlay.classList.add("show"); }
    function closeOverlay(){ overlay.classList.remove("show"); }
    function closeDrawers(){
      menuDrawer.classList.remove("show");
      filterDrawer.classList.remove("show");
      menuDrawer.setAttribute("aria-hidden","true");
      filterDrawer.setAttribute("aria-hidden","true");
    }
    function closeAllPopups(){
      closeDrawers();
      closeOverlay();
      hideModal("contactModal");
      hideModal("reviewsModal");
      hideModal("giftModal");
      hideModal("inboxModal");
      hideModal("gemsModal");
      hideModal("detailsModal");
      hideModal("cartModal");
      hideModal("checkoutModal");
      hideModal("authModal");
      hideModal("profileModal");
      hideModal("zoomModal");
    }

    function showDrawer(drawer){
      openOverlay();
      drawer.classList.add("show");
      drawer.setAttribute("aria-hidden","false");
    }
    function hideDrawer(drawer){
      drawer.classList.remove("show");
      drawer.setAttribute("aria-hidden","true");
      closeOverlay();
    }

    function showModal(id){
      openOverlay();
      $(id).classList.add("show");
    }
    function hideModal(id){
      $(id).classList.remove("show");
    }

    overlay.addEventListener("click", ()=> closeAllPopups());

    $("menuBtn").addEventListener("click", ()=>{
      showDrawer(menuDrawer);
    });
    $("menuClose").addEventListener("click", ()=> hideDrawer(menuDrawer));

    $("filterBtn").addEventListener("click", ()=>{
      showDrawer(filterDrawer);
    });
    $("filterClose").addEventListener("click", ()=> hideDrawer(filterDrawer));

    // drawer links
    document.querySelectorAll(".linkRow[data-scroll]").forEach(el=>{
      el.addEventListener("click", ()=>{
        const target = el.getAttribute("data-scroll");
        hideDrawer(menuDrawer);
        const node = $(target);
        if(node) node.scrollIntoView({behavior:"smooth", block:"start"});
      });
    });

    $("openContactRow").addEventListener("click", ()=>{ hideDrawer(menuDrawer); showModal("contactModal"); });
    $("openReviewsRow").addEventListener("click", ()=>{ hideDrawer(menuDrawer); showModal("reviewsModal"); renderReviews(); });
    $("openGiftRow").addEventListener("click", ()=>{ hideDrawer(menuDrawer); showModal("giftModal"); });
    $("openInboxRow").addEventListener("click", ()=>{ hideDrawer(menuDrawer); showModal("inboxModal"); renderInbox(); });
    $("openBonusRow").addEventListener("click", ()=>{ hideDrawer(menuDrawer); showModal("gemsModal"); renderGems(); });

    // modal close buttons
    $("contactClose").onclick = ()=>{ hideModal("contactModal"); closeOverlay(); };
    $("reviewsClose").onclick = ()=>{ hideModal("reviewsModal"); closeOverlay(); };
    $("giftClose").onclick = ()=>{ hideModal("giftModal"); closeOverlay(); };
    $("inboxClose").onclick = ()=>{ hideModal("inboxModal"); closeOverlay(); };
    $("gemsClose").onclick = ()=>{ hideModal("gemsModal"); closeOverlay(); };
    $("detailsClose").onclick = ()=>{ hideModal("detailsModal"); closeOverlay(); };
    $("zoomClose").onclick = ()=>{ hideModal("zoomModal"); closeOverlay(); };
    $("cartClose").onclick = ()=>{ hideModal("cartModal"); closeOverlay(); };
    $("checkoutClose").onclick = ()=>{ hideModal("checkoutModal"); closeOverlay(); };
    $("authClose").onclick = ()=>{ hideModal("authModal"); closeOverlay(); };
    $("profileClose").onclick = ()=>{ hideModal("profileModal"); closeOverlay(); };

    // header buttons
    $("cartBtn").onclick = ()=>{ showModal("cartModal"); renderCart(); };
    $("inboxBtn").onclick = ()=>{ showModal("inboxModal"); renderInbox(); };
    $("gemsBtn").onclick = ()=>{ showModal("gemsModal"); renderGems(); };

    /* =========================
       Products data (4 per section)
       - Clicking image opens details (no Details button)
       - Add to cart button exists on card
       - Buy exists only inside details/checkout and does NOT auto-add to cart
    ========================== */
    const products = [
      // TOP (4)
      {id:"TOP-1", section:"top", category:"accounts", name:"PUBG Account (Premium)", desc:"High level + skins. Add your real info in gallery images.", price:550, stock:7, badge:"top",
        images: demoImages("PUBG", 5)},
      {id:"TOP-2", section:"top", category:"games", name:"Action Game Key", desc:"Instant delivery after confirmation.", price:250, stock:12, badge:"top",
        images: demoImages("ACTION", 5)},
      {id:"TOP-3", section:"top", category:"programs", name:"Video Editing Pack", desc:"Tools bundle for editing.", price:180, stock:20, badge:"top",
        images: demoImages("EDIT", 5)},
      {id:"TOP-4", section:"top", category:"charging", name:"Robux (Top up)", desc:"Robux charging service.", price:120, stock:30, badge:"top",
        images: demoImages("ROBUX", 5)},

      // OFFERS (4)
      {id:"OFF-1", section:"offers", category:"games", name:"Game Bundle (Offer)", desc:"Limited-time offer bundle.", price:199, stock:9, badge:"offer",
        images: demoImages("BUNDLE", 5)},
      {id:"OFF-2", section:"offers", category:"accounts", name:"Steam Account (Offer)", desc:"Ready-to-use account.", price:299, stock:5, badge:"offer",
        images: demoImages("STEAM", 5)},
      {id:"OFF-3", section:"offers", category:"programs", name:"Designer Pack (Offer)", desc:"Creative tools pack.", price:149, stock:15, badge:"offer",
        images: demoImages("DESIGN", 5)},
      {id:"OFF-4", section:"offers", category:"charging", name:"Free Fire Diamonds (Offer)", desc:"Diamonds top up.", price:99, stock:25, badge:"offer",
        images: demoImages("FF", 5)},

      // GAMES (4)
      {id:"G-1", section:"games", category:"games", name:"Story Game Key", desc:"Cinematic story experience.", price:220, stock:14, badge:"",
        images: demoImages("STORY", 5)},
      {id:"G-2", section:"games", category:"games", name:"Racing Game Key", desc:"Fast racing action.", price:210, stock:10, badge:"",
        images: demoImages("RACE", 5)},
      {id:"G-3", section:"games", category:"games", name:"Sports Game Key", desc:"Competitive matches.", price:230, stock:11, badge:"",
        images: demoImages("SPORT", 5)},
      {id:"G-4", section:"games", category:"games", name:"Indie Game Key", desc:"Fun indie title.", price:120, stock:22, badge:"",
        images: demoImages("INDIE", 5)},

      // PROGRAMS (4)
      {id:"P-1", section:"programs", category:"programs", name:"Editing Software", desc:"Smooth editing workflow.", price:170, stock:25, badge:"",
        images: demoImages("PROG", 5)},
      {id:"P-2", section:"programs", category:"programs", name:"Graphics Toolkit", desc:"Design assets & tools.", price:150, stock:18, badge:"",
        images: demoImages("GFX", 5)},
      {id:"P-3", section:"programs", category:"programs", name:"Utilities Pack", desc:"Helpful utilities pack.", price:90, stock:40, badge:"",
        images: demoImages("UTIL", 5)},
      {id:"P-4", section:"programs", category:"programs", name:"Office Pack", desc:"Documents & productivity.", price:110, stock:28, badge:"",
        images: demoImages("OFFICE", 5)},

      // ACCOUNTS (4)
      {id:"A-1", section:"accounts", category:"accounts", name:"Epic Account", desc:"Game library account.", price:260, stock:6, badge:"",
        images: demoImages("EPIC", 5)},
      {id:"A-2", section:"accounts", category:"accounts", name:"Steam Account", desc:"Account with games.", price:320, stock:4, badge:"",
        images: demoImages("STEAM", 5)},
      {id:"A-3", section:"accounts", category:"accounts", name:"Roblox Account", desc:"Ready account with items.", price:140, stock:8, badge:"",
        images: demoImages("RBLX", 5)},
      {id:"A-4", section:"accounts", category:"accounts", name:"Free Fire Account", desc:"Ranked account.", price:200, stock:7, badge:"",
        images: demoImages("FFACC", 5)},

      // CHARGING (4)
      {id:"C-1", section:"charging", category:"charging", name:"PUBG UC", desc:"UC top up service.", price:75, stock:50, badge:"",
        images: demoImages("UC", 5)},
      {id:"C-2", section:"charging", category:"charging", name:"Robux", desc:"Robux charging.", price:120, stock:50, badge:"",
        images: demoImages("ROBUX", 5)},
      {id:"C-3", section:"charging", category:"charging", name:"Free Fire Diamonds", desc:"Diamonds charging.", price:90, stock:50, badge:"",
        images: demoImages("FFD", 5)},
      {id:"C-4", section:"charging", category:"charging", name:"eFootball Coins", desc:"Coins charging.", price:80, stock:50, badge:"",
        images: demoImages("EFB", 5)}
    ];

    // demo images using inline svg data-uri (no external links)
    function demoImages(label, count){
      const out=[];
      for(let i=1;i<=count;i++){
        const svg = `
          <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="700">
            <defs>
              <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="#0ea5e9" stop-opacity="0.35"/>
                <stop offset="0.55" stop-color="#e11d48" stop-opacity="0.28"/>
                <stop offset="1" stop-color="#ffffff" stop-opacity="0.06"/>
              </linearGradient>
            </defs>
            <rect width="100%" height="100%" fill="#0b1230"/>
            <rect x="40" y="40" width="1120" height="620" rx="34" fill="url(#g)" stroke="rgba(255,255,255,0.12)"/>
            <text x="80" y="160" fill="rgba(246,247,255,0.95)" font-size="72" font-weight="800" font-family="Segoe UI, Arial">${label}</text>
            <text x="80" y="250" fill="rgba(185,193,217,0.95)" font-size="42" font-weight="700" font-family="Segoe UI, Arial">Image ${i}</text>
            <text x="80" y="330" fill="rgba(185,193,217,0.9)" font-size="30" font-weight="700" font-family="Segoe UI, Arial">Replace these with your real screenshots</text>
            <circle cx="1040" cy="200" r="62" fill="rgba(34,197,94,0.16)" stroke="rgba(34,197,94,0.35)" />
            <circle cx="1100" cy="300" r="56" fill="rgba(245,158,11,0.14)" stroke="rgba(245,158,11,0.35)" />
            <circle cx="1020" cy="420" r="70" fill="rgba(56,189,248,0.14)" stroke="rgba(56,189,248,0.35)" />
          </svg>
        `.trim();
        out.push("data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg));
      }
      return out;
    }

    /* =========================
       Ratings (5 stars per product)
       - requires login
    ========================== */
    function getCurrentUserEmail(){ return getSession(); }
    function requireLogin(){
      if(!getCurrentUserEmail()){
        showModal("authModal");
        $("loginErr").style.display="none";
        return false;
      }
      return true;
    }

    function productRatingInfo(pid){
      const ratings = getRatings();
      const r = ratings[pid] || {sum:0,count:0,byUser:{}};
      const avg = r.count ? (r.sum / r.count) : 0;
      return {avg, count:r.count, byUser:r.byUser};
    }

    function setRating(pid, stars){
      if(!requireLogin()) return;

      const email = getCurrentUserEmail();
      const ratings = getRatings();
      const r = ratings[pid] || {sum:0,count:0,byUser:{}};

      // if user rated before, remove old from sum
      const old = r.byUser[email];
      if(old){
        r.sum -= old;
        r.count -= 1;
      }
      r.byUser[email] = stars;
      r.sum += stars;
      r.count += 1;

      ratings[pid] = r;
      setRatings(ratings);

      renderAll(); // refresh stars
    }

    function renderStars(pid){
      const info = productRatingInfo(pid);
      const rounded = Math.round(info.avg || 0);
      let html = `<div class="stars" aria-label="rating">`;
      for(let i=1;i<=5;i++){
        const muted = i<=rounded ? "" : "mutedStar";
        html += `<button class="${muted}" title="${i}" onclick="setRating('${pid}',${i})">‚òÖ</button>`;
      }
      html += `</div><div class="ratingInfo">${info.count ? `${info.avg.toFixed(1)} (${info.count})` : (isArabic ? "0 ÿ™ŸÇŸäŸäŸÖ" : "No ratings")}</div>`;
      return html;
    }

    /* =========================
       Cart
       - MUST work: + / - / remove
       - Persist in localStorage
    ========================== */
    function cartCount(){
      const cart = getCart();
      return cart.reduce((a,it)=>a+it.qty,0);
    }

    function updateHeaderCounts(){
      $("cartCount").textContent = cartCount();

      const email = getCurrentUserEmail();
      const inbox = getInbox();
      const msgs = email ? (inbox[email] || []) : [];
      $("inboxCount").textContent = msgs.length;

      const gems = getGems();
      const g = email ? (gems[email] || 0) : 0;
      $("gemsCount").textContent = g;
    }

    function addToCart(pid){
      const p = products.find(x=>x.id===pid);
      if(!p || p.stock<=0) return;

      const cart = getCart();
      const found = cart.find(x=>x.id===pid);
      if(found){
        found.qty += 1;
      }else{
        cart.push({id:pid, qty:1});
      }
      setCart(cart);
      updateHeaderCounts();
      // notify
      pushInbox(getCurrentUserEmail(), `${isArabic ? "ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ ŸÑŸÑÿ≥ŸÑÿ©:" : "Added to cart:"} ${p.name}`);
    }

    function minusQty(pid){
      const cart = getCart();
      const item = cart.find(x=>x.id===pid);
      if(!item) return;
      item.qty -= 1;
      let next = cart.filter(x=>x.qty>0);
      setCart(next);
      renderCart();
      updateHeaderCounts();
    }

    function plusQty(pid){
      const cart = getCart();
      const item = cart.find(x=>x.id===pid);
      if(!item) return;
      item.qty += 1;
      setCart(cart);
      renderCart();
      updateHeaderCounts();
    }

    function removeFromCart(pid){
      const cart = getCart().filter(x=>x.id!==pid);
      setCart(cart);
      renderCart();
      updateHeaderCounts();
    }

    function clearCart(){
      setCart([]);
      renderCart();
      updateHeaderCounts();
    }

    function cartTotalRaw(){
      const cart = getCart();
      let sum = 0;
      for(const it of cart){
        const p = products.find(x=>x.id===it.id);
        if(p) sum += p.price * it.qty;
      }
      return sum;
    }

    function money(v){
      // simple EGP format
      return (isArabic ? `${v} ÿ¨ŸÜŸäŸá` : `${v} EGP`);
    }

    function renderCart(){
      const list = $("cartList");
      list.innerHTML = "";
      const cart = getCart();

      if(cart.length===0){
        list.innerHTML = `<div class="note">${isArabic ? "ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ∂Ÿäÿ©." : "Your cart is empty."}</div>`;
      }else{
        for(const it of cart){
          const p = products.find(x=>x.id===it.id);
          if(!p) continue;

          const node = document.createElement("div");
          node.className = "cartItem";
          node.innerHTML = `
            <div class="cartLeft">
              <div class="cartThumb" title="${isArabic ? "ÿßŸÅÿ™ÿ≠ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ" : "Open details"}"></div>
              <div style="flex:1">
                <div class="cartName">${p.name}</div>
                <div class="cartMeta">${money(p.price)} ‚Ä¢ ${isArabic ? "ŸÉŸÖŸäÿ©" : "Qty"}: <b>${it.qty}</b></div>
                <div class="qtyRow">
                  <button class="qtyBtn" title="-" aria-label="minus">‚àí</button>
                  <div class="qtyNum">${it.qty}</div>
                  <button class="qtyBtn" title="+" aria-label="plus">+</button>
                  <button class="removeBtn" title="remove">${isArabic ? "ÿ≠ÿ∞ŸÅ" : "Remove"}</button>
                </div>
              </div>
            </div>
          `;

          // handlers
          node.querySelector(".cartThumb").onclick = ()=> openDetails(p.id);
          const btns = node.querySelectorAll(".qtyBtn");
          btns[0].onclick = ()=> minusQty(p.id);
          btns[1].onclick = ()=> plusQty(p.id);
          node.querySelector(".removeBtn").onclick = ()=> removeFromCart(p.id);

          list.appendChild(node);
        }
      }

      $("cartTotal").textContent = money(cartTotalRaw());
    }

    $("cartClearBtn").onclick = ()=> clearCart();
    $("cartCheckoutBtn").onclick = ()=> openCheckoutFromCart();

    /* =========================
       Inbox
    ========================== */
    function pushInbox(email, text){
      if(!email) return; // keep quiet if not logged in
      const inbox = getInbox();
      inbox[email] = inbox[email] || [];
      inbox[email].unshift({text, at: Date.now()});
      setInbox(inbox);
      updateHeaderCounts();
    }

    function renderInbox(){
      const list = $("inboxList");
      list.innerHTML = "";
      const email = getCurrentUserEmail();
      if(!email){
        list.innerHTML = `<div class="note warn">${T.mustLogin}</div>`;
        updateHeaderCounts();
        return;
      }
      const inbox = getInbox();
      const msgs = inbox[email] || [];
      if(msgs.length===0){
        list.innerHTML = `<div class="note">${isArabic ? "ŸÖŸÅŸäÿ¥ ÿ±ÿ≥ÿßÿ¶ŸÑ." : "No messages."}</div>`;
      }else{
        for(const m of msgs.slice(0,50)){
          const dt = new Date(m.at);
          const time = dt.toLocaleString();
          const item = document.createElement("div");
          item.className = "note";
          item.innerHTML = `<div style="font-weight:900">${time}</div><div>${escapeHtml(m.text)}</div>`;
          list.appendChild(item);
        }
      }
      updateHeaderCounts();
    }

    $("clearInboxBtn").onclick = ()=>{
      const email = getCurrentUserEmail();
      if(!email) return;
      const inbox = getInbox();
      inbox[email] = [];
      setInbox(inbox);
      renderInbox();
      updateHeaderCounts();
    };

    /* =========================
       Coupons
       - preset codes MG1-10, MZ1-10, ... MI1-10
       - one-time use per code (device)
       - no codes shown publicly
    ========================== */
    const presetCoupons = (()=>{
      const map = {};
      const groups = [
        ["MG",10],["MZ",20],["MK",30],["MC",40],["MA",50],["MB",60],["ME",70],["MX",80],["MR",90],["MI",100]
      ];
      for(const [prefix,percent] of groups){
        for(let i=1;i<=10;i++){
          map[`${prefix}${i}`] = percent;
        }
      }
      return map;
    })();

    function getCouponPercent(code){
      if(!code) return 0;
      const c = code.trim().toUpperCase();
      // generated codes in wallet
      const wallet = getWallet();
      const email = getCurrentUserEmail();
      const userWallet = email ? (wallet[email] || []) : [];
      const found = userWallet.find(x=>x.code===c);
      if(found) return found.percent;

      return presetCoupons[c] || 0;
    }

    function couponIsUsed(code){
      const used = getUsedCoupons();
      return !!used[code.trim().toUpperCase()];
    }

    function markCouponUsed(code){
      const used = getUsedCoupons();
      used[code.trim().toUpperCase()] = true;
      setUsedCoupons(used);
    }

    /* =========================
       Gems
       - redeem to generate a REAL working code for the user
    ========================== */
    function getUserGems(email){
      const gems = getGems();
      return gems[email] || 0;
    }
    function setUserGems(email, amount){
      const gems = getGems();
      gems[email] = Math.max(0, amount|0);
      setGems(gems);
      updateHeaderCounts();
    }

    function addUserGems(email, amount){
      setUserGems(email, getUserGems(email) + (amount|0));
    }

    function addToWallet(email, code, percent){
      const wallet = getWallet();
      wallet[email] = wallet[email] || [];
      wallet[email].unshift({code, percent, at: Date.now()});
      setWallet(wallet);
    }

    function renderWallet(){
      const email = getCurrentUserEmail();
      const list = $("walletList");
      list.innerHTML = "";
      if(!email){
        list.innerHTML = `<div class="note warn">${T.mustLogin}</div>`;
        return;
      }
      const wallet = getWallet();
      const items = wallet[email] || [];
      if(items.length===0){
        list.innerHTML = `<div class="note">${isArabic ? "ŸÖŸÅŸäÿ¥ ÿ£ŸÉŸàÿßÿØ ÿπŸÜÿØŸÉ." : "No codes yet."}</div>`;
        return;
      }
      for(const it of items.slice(0,25)){
        const used = couponIsUsed(it.code);
        const row = document.createElement("div");
        row.className = used ? "note warn" : "note ok";
        row.innerHTML = `<div style="font-weight:900">${it.code} ‚Äî ${it.percent}%</div><div>${used ? (isArabic ? "ŸÖÿ≥ÿ™ÿÆÿØŸÖ" : "Used") : (isArabic ? "ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ" : "Ready")}</div>`;
        list.appendChild(row);
      }
    }

    function renderGems(){
      const email = getCurrentUserEmail();
      if(!email){
        $("gemsInfo").textContent = (isArabic ? "ŸÑÿßÿ≤ŸÖ ÿ™ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸàŸÑ." : "Please login first.");
        $("gemsInfo").className = "note warn";
        renderWallet();
        updateHeaderCounts();
        return;
      }
      $("gemsInfo").className = "note ok";
      $("gemsInfo").textContent = (isArabic ? `ÿ¨ŸàÿßŸáÿ±ŸÉ: ${getUserGems(email)}` : `Your gems: ${getUserGems(email)}`);
      $("redeemMsg").style.display = "none";
      renderWallet();
      updateHeaderCounts();
    }

    $("redeemBtn").onclick = ()=>{
      const email = getCurrentUserEmail();
      if(!requireLogin()) return;

      const percent = parseInt($("redeemSelect").value,10);
      const cost = percent; // 10% costs 10 gems etc
      const g = getUserGems(email);

      const msg = $("redeemMsg");
      if(g < cost){
        msg.className = "note err";
        msg.textContent = isArabic ? "ÿ¨ŸàÿßŸáÿ± ŸÖÿ¥ ŸÉŸÅÿßŸäÿ©." : "Not enough gems.";
        msg.style.display = "block";
        return;
      }

      // create a real code and store in wallet
      const code = `GEM${percent}-${uid(6)}`; // real usable code
      addToWallet(email, code, percent);
      setUserGems(email, g - cost);

      msg.className = "note ok";
      msg.textContent = isArabic ? `ÿßÿ™ÿπŸÖŸÑŸÉ ŸÉŸàÿØ: ${code} (ÿÆÿµŸÖ ${percent}%)` : `Your code: ${code} (${percent}% off)`;
      msg.style.display = "block";

      pushInbox(email, isArabic ? `ÿ™ŸÖ ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ¨ŸàÿßŸáÿ± ŸÑŸÉŸàÿØ ÿÆÿµŸÖ ${percent}%` : `Converted gems to ${percent}% discount code.`);
      renderGems();
    };

    /* =========================
       Checkout flow
       - From cart OR from single product (buy direct)
       - Buy does NOT add to cart
       - First: summary + coupon
       - Confirm -> show payment methods
    ========================== */
    let checkoutMode = {type:"cart", pid:null, discountCode:"", discountPercent:0, finalTotal:0};

    function openCheckoutFromCart(){
      const cart = getCart();
      if(cart.length===0){
        showModal("cartModal");
        renderCart();
        return;
      }
      checkoutMode = {type:"cart", pid:null, discountCode:"", discountPercent:0, finalTotal:0};
      $("couponInput").value = "";
      $("couponMsg").style.display = "none";
      $("paymentBlock").style.display = "none";
      updateCheckoutSummary();
      showModal("checkoutModal");
    }

    function openCheckoutForSingle(pid){
      // buy direct (no add to cart)
      checkoutMode = {type:"single", pid, discountCode:"", discountPercent:0, finalTotal:0};
      $("couponInput").value = "";
      $("couponMsg").style.display = "none";
      $("paymentBlock").style.display = "none";
      updateCheckoutSummary();
      showModal("checkoutModal");
    }

    function updateCheckoutSummary(){
      let total = 0;
      let lines = [];
      if(checkoutMode.type==="cart"){
        const cart = getCart();
        for(const it of cart){
          const p = products.find(x=>x.id===it.id);
          if(!p) continue;
          const line = `${p.name} √ó ${it.qty} = ${money(p.price*it.qty)}`;
          lines.push(line);
          total += p.price*it.qty;
        }
      }else{
        const p = products.find(x=>x.id===checkoutMode.pid);
        if(p){
          lines.push(`${p.name} = ${money(p.price)}`);
          total = p.price;
        }
      }

      const disc = checkoutMode.discountPercent || 0;
      const after = Math.max(0, Math.round(total * (100 - disc)/100));
      checkoutMode.finalTotal = after;

      const summary = `
        <div style="font-weight:900">${isArabic ? "ÿßŸÑŸÖÿ≠ÿ™ŸàŸäÿßÿ™:" : "Items:"}</div>
        <div style="margin-top:6px">${lines.map(x=>`‚Ä¢ ${escapeHtml(x)}`).join("<br/>")}</div>
        <div style="margin-top:10px; font-weight:900">${isArabic ? "ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:" : "Total:"} ${money(total)}</div>
        <div style="margin-top:6px; font-weight:900">${isArabic ? "ÿßŸÑÿÆÿµŸÖ:" : "Discount:"} ${disc}%</div>
        <div style="margin-top:6px; font-weight:900">${isArabic ? "ÿßŸÑŸÜŸáÿßÿ¶Ÿä:" : "Final:"} ${money(after)}</div>
      `;
      $("checkoutSummary").innerHTML = summary;
    }

    $("applyCouponBtn").onclick = ()=>{
      const code = $("couponInput").value.trim().toUpperCase();
      const msg = $("couponMsg");
      if(!code){
        msg.style.display="none";
        checkoutMode.discountCode="";
        checkoutMode.discountPercent=0;
        updateCheckoutSummary();
        return;
      }

      if(couponIsUsed(code)){
        msg.className="note err";
        msg.textContent = isArabic ? "ÿßŸÑŸÉŸàÿØ ÿØŸá ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÇÿ®ŸÑ ŸÉÿØŸá." : "This code is already used.";
        msg.style.display="block";
        return;
      }

      const percent = getCouponPercent(code);
      if(!percent){
        msg.className="note err";
        msg.textContent = isArabic ? "ŸÉŸàÿØ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠." : "Invalid code.";
        msg.style.display="block";
        return;
      }

      checkoutMode.discountCode = code;
      checkoutMode.discountPercent = percent;

      msg.className="note ok";
      msg.textContent = isArabic ? `ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿÆÿµŸÖ ${percent}%` : `Applied ${percent}% discount`;
      msg.style.display="block";
      updateCheckoutSummary();
    };

    $("confirmCheckoutBtn").onclick = ()=>{
      // confirm -> show payment methods
      $("paymentBlock").style.display = "block";
      // consume coupon upon confirm
      if(checkoutMode.discountCode){
        markCouponUsed(checkoutMode.discountCode);
      }
      // grant gems for purchase (simple rule)
      const email = getCurrentUserEmail();
      if(email){
        const gained = Math.max(1, Math.floor(checkoutMode.finalTotal / 100)); // 1 gem per 100 EGP
        addUserGems(email, gained);
        pushInbox(email, isArabic ? `ÿ™ŸÖ ÿ™ÿ£ŸÉŸäÿØ ÿ∑ŸÑÿ®ŸÉ. ÿ≠ÿµŸÑÿ™ ÿπŸÑŸâ ${gained} ÿ¨ŸàÿßŸáÿ±.` : `Order confirmed. You earned ${gained} gems.`);
      }
      updateHeaderCounts();
    };

    // payment click -> create order log message (private inbox)
    document.querySelectorAll("#paymentBlock [data-pay]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const method = btn.getAttribute("data-pay");
        const email = getCurrentUserEmail();
        if(email){
          pushInbox(email, (isArabic ? "ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ: " : "Payment method selected: ") + method.toUpperCase());
        }
        // do NOT auto add anything to cart
        if(checkoutMode.type==="single"){
          // nothing to clear
        }else{
          // keep cart as is until user clears (as requested: user can remove)
          // you can decide to clear after successful payment later manually
        }
        // close checkout after choose
        hideModal("checkoutModal"); closeOverlay();
      });
    });

    /* =========================
       Details Modal (open via image click)
       - 4-5 images gallery
       - Add to Cart
       - Buy (direct)
    ========================== */
    let activeDetailsPid = null;
    let activeImageIndex = 0;

    function openDetails(pid){
      const p = products.find(x=>x.id===pid);
      if(!p) return;

      activeDetailsPid = pid;
      activeImageIndex = 0;

      $("detailsTitle").textContent = T.details;
      $("detailsName").textContent = p.name;
      $("detailsDesc").textContent = p.desc;
      $("detailsPrice").textContent = money(p.price);
      $("detailsStock").textContent = p.stock>0 ? T.stock : T.soldout;

      // big image
      renderGallery(p);

      $("detailsAddCartBtn").textContent = T.addCart;
      $("detailsBuyBtn").textContent = T.buy;

      $("detailsMsg").style.display="none";

      $("detailsAddCartBtn").onclick = ()=>{
        addToCart(pid);
        const msg = $("detailsMsg");
        msg.className = "note ok";
        msg.textContent = isArabic ? "ÿßÿ™ÿ∂ÿßŸÅ ŸÑŸÑÿ≥ŸÑÿ© ‚úÖ" : "Added to cart ‚úÖ";
        msg.style.display="block";
        updateHeaderCounts();
      };

      $("detailsBuyBtn").onclick = ()=>{
        // buy direct: do not add to cart
        openCheckoutForSingle(pid);
      };

      showModal("detailsModal");
    }

    function renderGallery(p){
      const big = $("galleryBig");
      const row = $("galleryRow");
      big.innerHTML = "";
      row.innerHTML = "";

      const src = p.images[activeImageIndex] || p.images[0];
      big.innerHTML = `<img src="${src}" alt="image" />`;
      big.onclick = ()=> openZoom(src);

      p.images.slice(0,5).forEach((img, idx)=>{
        const t = document.createElement("div");
        t.className = "gThumb" + (idx===activeImageIndex ? " active" : "");
        t.innerHTML = `<img src="${img}" alt="thumb"/>`;
        t.onclick = ()=>{
          activeImageIndex = idx;
          renderGallery(p);
        };
        row.appendChild(t);
      });
    }

    function openZoom(src){
      $("zoomBig").innerHTML = `<img src="${src}" alt="zoom" />`;
      showModal("zoomModal");
    }

    /* =========================
       Rendering cards
       - IMPORTANT: no extra text above Buy
       - Add-to-cart is outside details (exists on card)
       - image click opens details
    ========================== */
    function cardTemplate(p){
      const badgeHtml = p.badge==="top"
        ? `<div class="badge top">üî• ${T.top}</div>`
        : p.badge==="offer"
          ? `<div class="badge offer">üéÅ ${T.offers}</div>`
          : "";

      return `
        <div class="card">
          <div class="thumb" data-open="${p.id}">
            ${badgeHtml}
            <span>${p.id}</span>
          </div>
          <div class="content">
            <p class="name">${escapeHtml(p.name)}</p>
            <p class="meta">${escapeHtml(p.desc)}</p>

            ${renderStars(p.id)}

            <div class="priceRow">
              <p class="price">${money(p.price)}</p>
              <span class="pillCount">${p.stock}</span>
            </div>

            <div class="actions">
              <button class="btn btnBlue" data-cart="${p.id}">üõí</button>
              <button class="btn btnRed" data-buy="${p.id}">${T.buy}</button>
            </div>
          </div>
        </div>
      `;
    }

    function renderSection(sectionId, list){
      const grid = $(sectionId);
      grid.innerHTML = list.map(cardTemplate).join("");

      // image open details
      grid.querySelectorAll("[data-open]").forEach(el=>{
        el.addEventListener("click", ()=>{
          const pid = el.getAttribute("data-open");
          openDetails(pid);
        });
      });

      // add to cart buttons
      grid.querySelectorAll("[data-cart]").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          e.stopPropagation();
          const pid = btn.getAttribute("data-cart");
          addToCart(pid);
          updateHeaderCounts();
        });
      });

      // buy buttons (direct, do not add cart)
      grid.querySelectorAll("[data-buy]").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          e.stopPropagation();
          const pid = btn.getAttribute("data-buy");
          openCheckoutForSingle(pid);
        });
      });
    }

    function applyFilters(list){
      const f = getFilter();
      const q = (f.q || "").toLowerCase().trim();

      let out = list.slice();

      // search
      if(q){
        out = out.filter(p=>{
          return (p.name||"").toLowerCase().includes(q) || (p.desc||"").toLowerCase().includes(q) || (p.id||"").toLowerCase().includes(q);
        });
      }

      // category filter (by section or category)
      if(f.cat && f.cat !== "all"){
        out = out.filter(p=>{
          if(f.cat==="top") return p.section==="top";
          if(f.cat==="offers") return p.section==="offers";
          return p.category===f.cat;
        });
      }

      // price filter
      const priceVal = Number(f.price||0);
      if(f.mode && f.mode!=="off" && priceVal>=0){
        if(f.mode==="eq") out = out.filter(p=>p.price===priceVal);
        if(f.mode==="lte") out = out.filter(p=>p.price<=priceVal);
        if(f.mode==="gte") out = out.filter(p=>p.price>=priceVal);
      }

      // sort
      if(f.sort==="low") out.sort((a,b)=>a.price-b.price);
      if(f.sort==="high") out.sort((a,b)=>b.price-a.price);
      if(f.sort==="old") out.sort((a,b)=>a.id.localeCompare(b.id));
      if(f.sort==="new") out.sort((a,b)=>b.id.localeCompare(a.id));

      return out;
    }

    function renderAll(){
      const filtered = applyFilters(products);

      // keep each section 4 visible normally, but with filters it may show less (that is expected)
      renderSection("gridTop", filtered.filter(p=>p.section==="top"));
      renderSection("gridOffers", filtered.filter(p=>p.section==="offers"));
      renderSection("gridGames", filtered.filter(p=>p.section==="games"));
      renderSection("gridPrograms", filtered.filter(p=>p.section==="programs"));
      renderSection("gridAccounts", filtered.filter(p=>p.section==="accounts"));
      renderSection("gridCharging", filtered.filter(p=>p.section==="charging"));

      updateHeaderCounts();
    }

    /* Search + filter controls */
    $("search").addEventListener("input", ()=>{
      const f = getFilter();
      f.q = $("search").value || "";
      setFilter(f);
      renderAll();
    });

    $("applyFilterBtn").onclick = ()=>{
      const f = getFilter();
      f.cat = $("filterCategory").value;
      f.sort = $("filterSort").value;
      f.mode = $("priceMode").value;
      f.price = Number($("priceValue").value || 0);
      setFilter(f);
      hideDrawer(filterDrawer);
      renderAll();
    };

    $("clearFilterBtn").onclick = ()=>{
      const f = {q:$("search").value || "", cat:"all", sort:"new", mode:"off", price:0};
      setFilter(f);
      $("filterCategory").value="all";
      $("filterSort").value="new";
      $("priceMode").value="off";
      $("priceValue").value="";
      hideDrawer(filterDrawer);
      renderAll();
    };

    /* =========================
       Reviews
    ========================== */
    function renderReviews(){
      const list = $("reviewsList");
      list.innerHTML = "";
      const items = getReviews();
      if(items.length===0){
        list.innerHTML = `<div class="note">${isArabic ? "ŸÖŸÅŸäÿ¥ ŸÖÿ±ÿßÿ¨ÿπÿßÿ™ ŸÑÿ≥Ÿá." : "No reviews yet."}</div>`;
        return;
      }
      for(const r of items.slice(0,50)){
        const item = document.createElement("div");
        item.className = "note";
        item.innerHTML = `<div style="font-weight:900">${escapeHtml(r.name||"User")}</div><div>${escapeHtml(r.text||"")}</div>`;
        list.appendChild(item);
      }
    }

    $("addReviewBtn").onclick = ()=>{
      const txt = $("reviewText").value.trim();
      if(!txt) return;
      const email = getCurrentUserEmail();
      const name = email ? getDisplayName(email) : "User";
      const items = getReviews();
      items.unshift({name, text: txt, at:Date.now()});
      setReviews(items);
      $("reviewText").value="";
      renderReviews();
    };

    /* =========================
       Gifts (requires account exists)
       - gems transfer OR product ID message
    ========================== */
    function getDisplayName(email){
      const accounts = getAccounts();
      const acc = accounts[email];
      return (acc && acc.displayName) ? acc.displayName : (acc ? `${acc.firstName||""} ${acc.lastName||""}`.trim() : "User");
    }

    $("sendGiftBtn").onclick = ()=>{
      const to = $("giftToEmail").value.trim().toLowerCase();
      const type = $("giftType").value;
      const amount = $("giftAmount").value.trim();

      $("giftErr").style.display="none";
      $("giftOk").style.display="none";

      if(!requireLogin()) return;

      const from = getCurrentUserEmail();
      const accounts = getAccounts();
      if(!accounts[to]){
        $("giftErr").textContent = isArabic ? "ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖ ŸÖÿ¥ ÿπÿßŸÖŸÑ ÿ≠ÿ≥ÿßÿ®." : "Receiver has no account.";
        $("giftErr").style.display="block";
        return;
      }

      if(type==="gems"){
        const n = parseInt(amount,10);
        if(!n || n<=0){
          $("giftErr").textContent = isArabic ? "ÿßŸÉÿ™ÿ® ÿ±ŸÇŸÖ ÿµÿ≠Ÿäÿ≠." : "Enter a valid number.";
          $("giftErr").style.display="block";
          return;
        }
        const g = getUserGems(from);
        if(g < n){
          $("giftErr").textContent = isArabic ? "ÿ¨ŸàÿßŸáÿ± ŸÖÿ¥ ŸÉŸÅÿßŸäÿ©." : "Not enough gems.";
          $("giftErr").style.display="block";
          return;
        }
        setUserGems(from, g-n);
        addUserGems(to, n);
        pushInbox(from, isArabic ? `ÿ£ÿ±ÿ≥ŸÑÿ™ ${n} ÿ¨ŸàÿßŸáÿ± ÿ•ŸÑŸâ ${to}` : `Sent ${n} gems to ${to}`);
        pushInbox(to, isArabic ? `ÿßÿ≥ÿ™ŸÑŸÖÿ™ ${n} ÿ¨ŸàÿßŸáÿ± ŸÖŸÜ ${getDisplayName(from)}` : `You received ${n} gems from ${getDisplayName(from)}`);
        $("giftOk").textContent = T.sent;
        $("giftOk").style.display="block";
        updateHeaderCounts();
        return;
      }

      // product
      const pid = amount.toUpperCase();
      const p = products.find(x=>x.id===pid);
      if(!p){
        $("giftErr").textContent = isArabic ? "ÿ±ŸÇŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠." : "Invalid product ID.";
        $("giftErr").style.display="block";
        return;
      }
      pushInbox(from, isArabic ? `ÿ£ÿ±ÿ≥ŸÑÿ™ ŸáÿØŸäÿ©: ${p.name} ÿ•ŸÑŸâ ${to}` : `Gift sent: ${p.name} to ${to}`);
      pushInbox(to, isArabic ? `ÿ¨ÿßŸÑŸÉ ŸáÿØŸäÿ©: ${p.name} ŸÖŸÜ ${getDisplayName(from)}` : `You received a gift: ${p.name} from ${getDisplayName(from)}`);
      $("giftOk").textContent = T.sent;
      $("giftOk").style.display="block";
      updateHeaderCounts();
    };

    /* =========================
       Auth: Login + Register + Profile
       - Email uniqueness
       - Basic profile data
       - Password show/hide eye
    ========================== */
    function setAuthUI(){
      const email = getCurrentUserEmail();
      if(!email){
        $("authBtn").style.display = "inline-flex";
        $("userChip").style.display = "none";
        $("drawerUserBox").style.display = "none";
        updateHeaderCounts();
        return;
      }

      $("authBtn").style.display = "none";
      $("userChip").style.display = "inline-flex";
      $("userNameText").textContent = getDisplayName(email) || "User";

      // avatar
      const accounts = getAccounts();
      const acc = accounts[email];
      const av = $("avatarSmall");
      av.innerHTML = "";
      if(acc && acc.avatar){
        const img = document.createElement("img");
        img.src = acc.avatar;
        av.appendChild(img);
      }else{
        av.textContent = (getDisplayName(email)||"U").slice(0,1).toUpperCase();
      }

      // drawer user box
      $("drawerUserBox").style.display = "block";
      $("drawerUserNote").textContent = (isArabic ? "ŸÖÿ≥ÿ¨ŸÑ ŸÉŸÄ: " : "Signed in as: ") + getDisplayName(email);
      updateHeaderCounts();
    }

    $("authBtn").onclick = ()=>{ showModal("authModal"); switchAuthTab("login"); };
    $("userChip").onclick = ()=>{ showModal("profileModal"); loadProfile(); };

    $("editProfileBtn").onclick = ()=>{ showModal("profileModal"); loadProfile(); };
    $("logoutBtn").onclick = ()=> logout();

    function logout(){
      setSession("");
      setAuthUI();
      updateHeaderCounts();
      hideDrawer(menuDrawer);
      closeOverlay();
    }

    function switchAuthTab(tab){
      if(tab==="login"){
        $("loginBox").style.display="flex";
        $("loginBox").className="stack";
        $("registerBox").style.display="none";
        $("tabLogin").className="btn btnBlue";
        $("tabRegister").className="btn";
      }else{
        $("loginBox").style.display="none";
        $("registerBox").style.display="flex";
        $("registerBox").className="stack";
        $("tabLogin").className="btn";
        $("tabRegister").className="btn btnBlue";
      }
    }

    $("tabLogin").onclick = ()=> switchAuthTab("login");
    $("tabRegister").onclick = ()=> switchAuthTab("register");

    $("toggleLoginPass").onclick = ()=>{
      $("loginPass").type = $("loginPass").type==="password" ? "text" : "password";
    };
    $("toggleRegPass").onclick = ()=>{
      $("regPass").type = $("regPass").type==="password" ? "text" : "password";
    };
    $("toggleNewPass").onclick = ()=>{
      $("newPass").type = $("newPass").type==="password" ? "text" : "password";
    };

    $("loginBtn").onclick = ()=>{
      const email = $("loginEmail").value.trim().toLowerCase();
      const pass = $("loginPass").value;
      const accounts = getAccounts();
      const err = $("loginErr");

      err.style.display="none";
      if(!email || !pass){
        err.textContent = isArabic ? "ÿßŸÖŸÑÿ£ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™." : "Fill the fields.";
        err.style.display="block";
        return;
      }
      const acc = accounts[email];
      if(!acc || acc.pass !== pass){
        err.textContent = isArabic ? "ÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©." : "Invalid credentials.";
        err.style.display="block";
        return;
      }
      setSession(email);
      setAuthUI();
      hideModal("authModal"); closeOverlay();
      pushInbox(email, isArabic ? "ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ." : "Logged in.");
    };

    // Register steps
    let regData = {first:"", last:"", email:"", pass:"", gender:"", age:"", avatar:""};

    function showRegStep(n){
      $("regStep1").style.display = (n===1) ? "flex" : "none";
      $("regStep2").style.display = (n===2) ? "flex" : "none";
      $("regStep3").style.display = (n===3) ? "flex" : "none";
      $("regStep4").style.display = (n===4) ? "flex" : "none";
      $("regStepTitle").textContent = `${T.step} ${n}/4`;
    }

    $("regNext1").onclick = ()=>{
      const f = $("firstName").value.trim();
      const l = $("lastName").value.trim();
      if(!f || !l) return;
      regData.first=f; regData.last=l;
      showRegStep(2);
    };

    $("regBack2").onclick = ()=> showRegStep(1);
    $("regBack3").onclick = ()=> showRegStep(2);
    $("regBack4").onclick = ()=> showRegStep(3);

    $("regNext2").onclick = ()=>{
      const email = $("regEmail").value.trim().toLowerCase();
      const pass = $("regPass").value;
      const err = $("regErr2");
      err.style.display="none";

      if(!email || !pass){
        err.textContent = isArabic ? "ÿßŸÖŸÑÿ£ ÿßŸÑÿ®ÿ±ŸäÿØ ŸàŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±." : "Enter email and password.";
        err.style.display="block";
        return;
      }
      const accounts = getAccounts();
      if(accounts[email]){
        err.textContent = isArabic ? "ÿßŸÑÿ®ÿ±ŸäÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÇÿ®ŸÑ ŸÉÿØŸá." : "Email already used.";
        err.style.display="block";
        return;
      }
      regData.email=email; regData.pass=pass;
      showRegStep(3);
    };

    $("regNext3").onclick = ()=>{
      const g = $("regGender").value;
      const a = parseInt($("regAge").value,10);
      const err = $("regErr3");
      err.style.display="none";

      if(!g || !a || a<=0){
        err.textContent = isArabic ? "ÿßÿÆÿ™ÿßÿ± ÿßŸÑŸÜŸàÿπ ŸàÿßŸÉÿ™ÿ® ÿπŸÖÿ± ÿµÿ≠Ÿäÿ≠." : "Choose gender and valid age.";
        err.style.display="block";
        return;
      }
      regData.gender=g; regData.age=a;
      showRegStep(4);
    };

    $("createAccountBtn").onclick = async ()=>{
      const err = $("regErr4");
      err.style.display="none";

      // avatar
      const file = $("regAvatar").files[0];
      if(file){
        const dataUrl = await fileToDataURL(file);
        regData.avatar = dataUrl;
      }

      const accounts = getAccounts();
      accounts[regData.email] = {
        firstName: regData.first,
        lastName: regData.last,
        email: regData.email,
        pass: regData.pass,
        gender: regData.gender,
        age: regData.age,
        avatar: regData.avatar || "",
        displayName: (regData.first + " " + regData.last).trim()
      };
      setAccounts(accounts);

      // init inbox + gems
      const inbox = getInbox();
      inbox[regData.email] = inbox[regData.email] || [];
      setInbox(inbox);
      const gems = getGems();
      if(gems[regData.email] == null) gems[regData.email] = 0;
      setGems(gems);

      setSession(regData.email);
      setAuthUI();
      hideModal("authModal"); closeOverlay();
      pushInbox(regData.email, isArabic ? "ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ®." : "Account created.");
      showRegStep(1);
    };

    function fileToDataURL(file){
      return new Promise((res, rej)=>{
        const fr = new FileReader();
        fr.onload = ()=>res(fr.result);
        fr.onerror = rej;
        fr.readAsDataURL(file);
      });
    }

    function loadProfile(){
      const email = getCurrentUserEmail();
      if(!email) return;
      const accounts = getAccounts();
      const acc = accounts[email];
      $("profileMsg").style.display="none";
      $("profileName").value = (acc && acc.displayName) ? acc.displayName : getDisplayName(email);
    }

    $("saveProfileName").onclick = ()=>{
      const email = getCurrentUserEmail();
      if(!email) return;
      const accounts = getAccounts();
      const acc = accounts[email];
      const name = $("profileName").value.trim();
      if(!name) return;
      acc.displayName = name;
      accounts[email] = acc;
      setAccounts(accounts);
      setAuthUI();

      const msg = $("profileMsg");
      msg.className="note ok";
      msg.textContent = isArabic ? "ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿßÿ≥ŸÖ." : "Name saved.";
      msg.style.display="block";
    };

    $("saveNewPass").onclick = ()=>{
      const email = getCurrentUserEmail();
      if(!email) return;
      const newPass = $("newPass").value;
      if(!newPass) return;

      const accounts = getAccounts();
      const acc = accounts[email];
      acc.pass = newPass;
      accounts[email] = acc;
      setAccounts(accounts);

      const msg = $("profileMsg");
      msg.className="note ok";
      msg.textContent = isArabic ? "ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±." : "Password updated.";
      msg.style.display="block";
    };

    /* =========================
       Buttons in header / auth
    ========================== */
    // clicking auth chip is profile already
    // auth modal default
    function initAuth(){
      showRegStep(1);
      switchAuthTab("login");
    }

    /* =========================
       Filter init values from storage
    ========================== */
    function initFilterUI(){
      const f = getFilter();
      $("search").value = f.q || "";
      $("filterCategory").value = f.cat || "all";
      $("filterSort").value = f.sort || "new";
      $("priceMode").value = f.mode || "off";
      $("priceValue").value = (f.price && f.mode!=="off") ? f.price : "";
    }

    /* =========================
       Security note: never store/show passwords publicly in UI
       (We keep passwords in local storage for demo-like behavior)
    ========================== */

    /* =========================
       Utilities
    ========================== */
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /* =========================
       Start
    ========================== */
    initAuth();
    initFilterUI();
    setAuthUI();
    renderAll();
    renderCart();
    updateHeaderCounts();

    // Initial seed: if user already logged, ensure counts
    window.addEventListener("storage", ()=>{
      // if multiple tabs
      setAuthUI();
      renderAll();
      renderCart();
      updateHeaderCounts();
    });
  </script>
</body>
</html>
