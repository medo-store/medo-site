
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Medo Gaming Store</title>

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1230;
      --panel: rgba(14,24,59,.92);
      --card: rgba(12,23,54,.72);
      --text:#F6F7FF;
      --muted:#B9C1D9;
      --border:rgba(255,255,255,.10);
      --accent:#E11D48;
      --accent2:#38BDF8;
      --good:#22C55E;
      --warn:#F59E0B;

      --radius:14px;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Segoe UI", Tahoma, Arial, sans-serif;
      color:var(--text);
      min-height:100vh;

      background:
        radial-gradient(900px 500px at 15% 8%, rgba(56,189,248,.16), transparent 60%),
        radial-gradient(900px 600px at 85% 0%, rgba(225,29,72,.14), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow-x:hidden;
    }
    a{color:inherit;text-decoration:none}
    button,input,select{font-family:inherit}
    .container{max-width:1220px;margin:0 auto;padding:10px 12px;position:relative}

    /* decorative icons on sides */
    .decor{
      position:fixed; inset:0; pointer-events:none; z-index:0; opacity:.10;
      filter: blur(.2px);
    }
    .decor::before, .decor::after{
      content:"";
      position:absolute; top:120px; bottom:0; width:280px;
      background-repeat:no-repeat; background-size: 180px auto;
      opacity:.85;
    }
    .decor::before{
      left:-40px;
      background-image:
        radial-gradient(circle at 60px 80px, rgba(56,189,248,.65), transparent 60%),
        radial-gradient(circle at 120px 200px, rgba(225,29,72,.6), transparent 60%),
        radial-gradient(circle at 80px 320px, rgba(245,158,11,.6), transparent 60%);
    }
    .decor::after{
      right:-40px;
      background-image:
        radial-gradient(circle at 160px 90px, rgba(225,29,72,.6), transparent 60%),
        radial-gradient(circle at 120px 230px, rgba(56,189,248,.65), transparent 60%),
        radial-gradient(circle at 160px 360px, rgba(34,197,94,.55), transparent 60%);
    }

    /* Sticky header */
    .nav{
      position:sticky;top:0;z-index:60;
      background:rgba(7,10,18,.74);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .nav-inner{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.2px;white-space:nowrap}
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:0 0 0 4px rgba(56,189,248,.10);
    }

    .searchWrap{flex:1;min-width:220px;display:flex;align-items:center;gap:8px}
    .search{
      flex:1;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
    }

    .iconBtn{
      display:inline-flex;align-items:center;justify-content:center;
      gap:8px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      user-select:none;
    }
    .iconBtn:hover{filter:brightness(1.08)}
    .rightBox{margin-inline-start:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pillCount{
      min-width:22px;height:22px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;
      background:rgba(56,189,248,.16);
      border:1px solid rgba(56,189,248,.35);
      font-weight:900;font-size:12px;padding:0 6px;
    }

    .userChip{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 10px;border-radius:999px;
      border:1px solid rgba(56,189,248,.35);
      background:rgba(56,189,248,.10);
      cursor:pointer;white-space:nowrap;
      font-weight:900;font-size:13px;
    }
    .avatarSmall{
      width:22px;height:22px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.07);
      display:inline-flex;align-items:center;justify-content:center;
      overflow:hidden;
      font-size:11px;
    }
    .avatarSmall img{width:100%;height:100%;object-fit:cover}

    /* Sections */
    .sectionTitle{
      margin:18px 0 8px;
      font-size:15px;
      font-weight:900;
      display:flex;align-items:center;gap:10px;
      position:relative;
      z-index:1;
    }
    .sectionHint{color:var(--muted);font-weight:800;font-size:12px}
    .spacer{height:18px}

    /* Grid: ALWAYS 4 on desktop */
    .grid{display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:14px;position:relative;z-index:1}
    @media (max-width:1050px){ .grid{grid-template-columns:repeat(3, minmax(0,1fr));} }
    @media (max-width:760px){ .grid{grid-template-columns:repeat(2, minmax(0,1fr));} }
    @media (max-width:460px){ .grid{grid-template-columns:1fr;} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      display:flex;flex-direction:column;
      min-height:250px;
    }
    .thumb{
      height:104px;
      background:
        radial-gradient(180px 120px at 25% 30%, rgba(56,189,248,.22), transparent 65%),
        radial-gradient(180px 120px at 75% 0%, rgba(225,29,72,.18), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;letter-spacing:.7px;font-size:12px;
      position:relative;
      cursor:pointer;
    }
    .badge{
      position:absolute;top:8px;inset-inline-start:8px;
      padding:6px 8px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.25);
      font-size:11px;font-weight:900;
      display:inline-flex;gap:6px;align-items:center;
    }
    .badge.top{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.12)}
    .badge.offer{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.12)}
    .content{padding:10px 10px 12px;display:flex;flex-direction:column;gap:8px;flex:1}
    .name{margin:0;font-size:13px;font-weight:900}
    .meta{margin:0;font-size:12px;color:var(--muted);line-height:1.4}
    .priceRow{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .price{margin:0;font-size:12px;font-weight:900}

    /* Rating */
    .ratingRow{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .stars{display:inline-flex;gap:3px;align-items:center}
    .starBtn{
      width:18px;height:18px;border-radius:6px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;
      font-size:12px; line-height:0;
      user-select:none;
    }
    .starBtn.filled{
      border-color:rgba(245,158,11,.55);
      background:rgba(245,158,11,.16);
    }
    .ratingMeta{font-size:11px;color:var(--muted);font-weight:800;white-space:nowrap}

    /* Actions */
    .actions{display:flex;gap:8px;margin-top:auto;flex-wrap:wrap}
    .btn{
      flex:1;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 10px;
      font-weight:900;font-size:12px;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      min-width:120px;
    }
    .btn:hover{filter:brightness(1.08)}
    .btnRed{background:linear-gradient(135deg, rgba(225,29,72,1), rgba(225,29,72,.82));border-color:transparent}
    .btnBlue{background:rgba(56,189,248,.12);border-color:rgba(56,189,248,.35)}

    /* Overlay / drawers / modals */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.58);display:none;z-index:80}
    .overlay.show{display:block}

    .drawer{
      position:fixed;top:0;bottom:0;
      width:min(360px, 92vw);
      background:var(--panel);
      backdrop-filter: blur(10px);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      z-index:90;
      transition: right .22s ease;
      display:flex;flex-direction:column;
      right:-420px; /* hidden */
    }
    .drawer.show{ right:0; }
    .drawerHeader{
      padding:12px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .drawerTitle{font-weight:900}
    .drawerBody{padding:12px;overflow:auto}
    .drawerSection{margin:10px 0 16px}
    .drawerLabel{font-weight:900;margin:0 0 8px}
    .drawerList{display:flex;flex-direction:column;gap:8px}
    .linkRow{
      padding:10px 10px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      cursor:pointer;
    }
    .linkRow:hover{filter:brightness(1.08)}
    .mini{font-size:12px;color:var(--muted);font-weight:800}

    .note{
      padding:10px 10px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-weight:800;font-size:12px;line-height:1.5;
    }
    .note.err{background:rgba(225,29,72,.18);border-color:rgba(225,29,72,.45);color:#fff}
    .note.ok{background:rgba(34,197,94,.14);border-color:rgba(34,197,94,.35);color:#fff}
    .note.warn{background:rgba(245,158,11,.14);border-color:rgba(245,158,11,.35);color:#fff}

    .modal{position:fixed;inset:0;display:none;z-index:95;align-items:center;justify-content:center;padding:14px}
    .modal.show{display:flex}
    .modalBox{
      width:min(760px, 96vw);
      background:rgba(14,24,59,.94);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHeader{
      padding:12px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .modalTitle{font-weight:900}
    .modalBody{padding:12px}
    .stack{display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .row .tight{flex:0 0 auto}

    .input{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
    }
    .select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
      font-weight:900;
    }

    /* password eye */
    .pwWrap{position:relative}
    .pwEye{
      position:absolute; top:50%; transform:translateY(-50%);
      inset-inline-end:10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      padding:6px 8px;
      cursor:pointer;
      font-weight:900;
      user-select:none;
    }

    /* Cart */
    .cartItem{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .cartLeft{display:flex;gap:10px;flex:1}
    .cartThumb{
      width:54px;height:54px;border-radius:14px;
      border:1px solid var(--border);
      background:
        radial-gradient(40px 30px at 20% 20%, rgba(56,189,248,.25), transparent 65%),
        radial-gradient(40px 30px at 80% 0%, rgba(225,29,72,.18), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      overflow:hidden;
      flex:0 0 auto;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:11px;opacity:.9;
    }
    .cartName{font-weight:900;font-size:13px;margin:0 0 4px}
    .cartMeta{margin:0;color:var(--muted);font-size:12px;font-weight:800}
    .qtyRow{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .qtyBtn{
      width:34px;height:34px;border-radius:10px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
    }
    .qtyNum{min-width:34px;text-align:center;font-weight:900}
    .removeBtn{
      border:1px solid rgba(225,29,72,.35);
      background:rgba(225,29,72,.12);
      color:rgba(246,247,255,.95);
      font-weight:900;cursor:pointer;
      padding:8px 10px;border-radius:10px;
      white-space:nowrap;
    }
    .detailsBtn{
      border:1px solid rgba(56,189,248,.35);
      background:rgba(56,189,248,.10);
      color:rgba(246,247,255,.95);
      font-weight:900;cursor:pointer;
      padding:8px 10px;border-radius:10px;
      white-space:nowrap;
    }
    .totalBar{
      margin-top:10px;
      border:1px solid rgba(56,189,248,.35);
      background:rgba(56,189,248,.10);
      border-radius:14px;
      padding:10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      cursor:pointer;
      user-select:none;
    }

    /* Details gallery */
    .galleryBig{
      width:100%;
      height:230px;
      border-radius:14px;
      border:1px solid var(--border);
      background:
        radial-gradient(280px 160px at 25% 30%, rgba(56,189,248,.22), transparent 65%),
        radial-gradient(280px 160px at 75% 0%, rgba(225,29,72,.18), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      display:flex;align-items:center;justify-content:center;
      font-weight:900;letter-spacing:.7px;
      overflow:hidden;
    }
    .galleryBig img{width:100%;height:100%;object-fit:cover}
    .galleryRow{display:flex;gap:10px;flex-wrap:wrap}
    .gThumb{
      width:78px;height:56px;border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;font-weight:900;font-size:11px;color:rgba(246,247,255,.9);
      overflow:hidden;
    }
    .gThumb img{width:100%;height:100%;object-fit:cover}
    .gThumb.active{border-color:rgba(56,189,248,.55);background:rgba(56,189,248,.10)}

    /* Footer */
    .footer{
      margin-top:18px;border-top:1px solid var(--border);
      padding:14px 0 22px;
      color:var(--muted);
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      position:relative;
      z-index:1;
    }
    .social{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      font-weight:900;font-size:12px;
    }
    .social:hover{filter:brightness(1.08)}
    .mutedRight{margin-inline-start:auto;font-weight:900;font-size:12px;color:rgba(185,193,217,.9)}
  </style>
</head>

<body>
  <div class="decor"></div>

  <div class="nav">
    <div class="container nav-inner">
      <div class="brand">
        <span class="dot"></span>
        <span id="brandText">Medo Gaming Store</span>
      </div>

      <div class="searchWrap">
        <input id="search" class="search" placeholder="üîç ÿßÿ®ÿ≠ÿ´..." />
        <!-- Filter icon (different style than menu) -->
        <button class="iconBtn" id="filterBtn" title="Filter">
          <span style="display:inline-block;line-height:0">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M4 6h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M7 12h13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M10 18h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <circle cx="6" cy="6" r="2" fill="currentColor" opacity=".35"/>
              <circle cx="9" cy="12" r="2" fill="currentColor" opacity=".35"/>
              <circle cx="12" cy="18" r="2" fill="currentColor" opacity=".35"/>
            </svg>
          </span>
        </button>
      </div>

      <div class="rightBox">
        <button class="iconBtn" id="inboxBtn" title="Inbox">üîî <span class="pillCount" id="inboxCount">0</span></button>
        <button class="iconBtn" id="gemsBtn" title="Bonus">üíé <span class="pillCount" id="gemsCount">0</span></button>
        <button class="iconBtn" id="cartBtn" title="Cart">üõí <span class="pillCount" id="cartCount">0</span></button>

        <button class="iconBtn" id="authBtn" title="Account">üë§ <span id="authText">ÿ™ÿ≥ÿ¨ŸäŸÑ</span></button>

        <div class="userChip" id="userChip" style="display:none" title="User">
          <span class="avatarSmall" id="avatarSmall">U</span>
          <span id="userNameText">User</span>
        </div>

        <button class="iconBtn" id="menuBtn" title="Menu">‚ò∞</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="sectionTitle" id="titleTop">üî• Top <span class="sectionHint" id="hintTop">ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ∑ŸÑÿ®Ÿãÿß</span></div>
    <div id="gridTop" class="grid"></div>

    <div class="spacer"></div>

    <div class="sectionTitle" id="titleOffers">üéÅ Offers <span class="sectionHint" id="hintOffers">ÿπÿ±Ÿàÿ∂</span></div>
    <div id="gridOffers" class="grid"></div>

    <div class="spacer"></div>

    <div class="sectionTitle" id="titleGames">üéÆ Games</div>
    <div id="gridGames" class="grid"></div>

    <div class="spacer"></div>

    <div class="sectionTitle" id="titlePrograms">üíª Programs</div>
    <div id="gridPrograms" class="grid"></div>

    <div class="spacer"></div>

    <div class="sectionTitle" id="titleAccounts">üßæ Accounts</div>
    <div id="gridAccounts" class="grid"></div>

    <div class="spacer"></div>

    <div class="sectionTitle" id="titleRecharge">‚ö° Recharge</div>
    <div id="gridRecharge" class="grid"></div>

    <div class="footer">
      <a class="social" href="https://wa.me/201006760663" target="_blank" rel="noreferrer" id="footerWa">WhatsApp</a>
      <a class="social" href="https://www.instagram.com/medo__rami" target="_blank" rel="noreferrer" id="footerIg">Instagram</a>
      <a class="social" href="https://www.facebook.com/share/1AScQqiSqq/" target="_blank" rel="noreferrer" id="footerFb">Facebook</a>
      <a class="social" href="mailto:medorami77@gmail.com" id="footerMail">Email</a>
      <span class="mutedRight">¬© <span id="year"></span> Medo Gaming</span>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <!-- MENU DRAWER -->
  <div class="drawer" id="menuDrawer" aria-hidden="true">
    <div class="drawerHeader">
      <div class="drawerTitle" id="menuTitle">Menu</div>
      <button class="iconBtn" id="menuClose">‚úï</button>
    </div>
    <div class="drawerBody">
      <div class="drawerSection" id="drawerUserBox" style="display:none">
        <div class="note ok" id="drawerUserNote"></div>
        <div class="row">
          <button class="btn" id="editProfileBtn">Edit profile</button>
          <button class="btn" id="logoutBtn">Logout</button>
        </div>
      </div>

      <div class="drawerSection">
        <p class="drawerLabel" id="quickLabel">Quick</p>
        <div class="drawerList">
          <div class="linkRow" data-scroll="gridTop"><span id="mTop">Top</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" data-scroll="gridOffers"><span id="mOffers">Offers</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" data-scroll="gridGames"><span id="mGames">Games</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" data-scroll="gridPrograms"><span id="mPrograms">Programs</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" data-scroll="gridAccounts"><span id="mAccounts">Accounts</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" data-scroll="gridRecharge"><span id="mRecharge">Recharge</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" id="openContactRow"><span id="mContact">Contact</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" id="openReviewsRow"><span id="mReviews">Reviews</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" id="openInboxRow"><span id="mInbox">Inbox</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" id="openBonusRow"><span id="mBonus">Bonus (Gems)</span><span class="mini">‚Üí</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- FILTER DRAWER -->
  <div class="drawer" id="filterDrawer" aria-hidden="true">
    <div class="drawerHeader">
      <div class="drawerTitle" id="filterTitle">Filter</div>
      <button class="iconBtn" id="filterClose">‚úï</button>
    </div>
    <div class="drawerBody">
      <div class="note" id="filterNote">ÿßÿÆÿ™ÿßÿ± ÿßŸÑŸÇÿ≥ŸÖ ŸàÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ŸàÿßŸÑÿ≥ÿπÿ± Ÿàÿ®ÿπÿØŸäŸÜ ÿ™ÿ∑ÿ®ŸäŸÇ.</div>

      <div class="drawerSection">
        <p class="drawerLabel" id="filterCatLabel">Category</p>
        <select class="select" id="filterCategory">
          <option value="all">All</option>
          <option value="top">Top</option>
          <option value="offers">Offers</option>
          <option value="games">Games</option>
          <option value="programs">Programs</option>
          <option value="accounts">Accounts</option>
          <option value="recharge">Recharge</option>
        </select>
      </div>

      <div class="drawerSection">
        <p class="drawerLabel" id="filterSortLabel">Sort</p>
        <select class="select" id="filterSort">
          <option value="new">Newest</option>
          <option value="old">Oldest</option>
          <option value="low">Low ‚Üí High</option>
          <option value="high">High ‚Üí Low</option>
        </select>
      </div>

      <div class="drawerSection">
        <p class="drawerLabel" id="filterPriceLabel">Price</p>
        <div class="row">
          <select class="select" id="priceMode">
            <option value="off">Off</option>
            <option value="eq">Equal</option>
            <option value="lte">‚â§</option>
            <option value="gte">‚â•</option>
          </select>
          <input class="input" id="priceValue" type="number" min="0" placeholder="ŸÖÿ´ŸÑÿßŸã 300" />
        </div>
      </div>

      <button class="btn btnRed" id="applyFilterBtn">Apply</button>
    </div>
  </div>

  <!-- CONTACT MODAL -->
  <div class="modal" id="contactModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="contactTitle">Contact</div>
        <button class="iconBtn" id="contactClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <a class="btn" href="https://wa.me/201006760663" target="_blank" id="contactWa">WhatsApp</a>
          <a class="btn" href="https://www.instagram.com/medo__rami" target="_blank" id="contactIg">Instagram</a>
          <a class="btn" href="https://www.facebook.com/share/1AScQqiSqq/" target="_blank" id="contactFb">Facebook</a>
          <a class="btn" href="mailto:medorami77@gmail.com" id="contactMail">Email</a>
        </div>
      </div>
    </div>
  </div>

  <!-- REVIEWS MODAL -->
  <div class="modal" id="reviewsModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="reviewsTitle">Reviews</div>
        <button class="iconBtn" id="reviewsClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="row">
            <input class="input" id="reviewText" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ£ŸäŸÉ..." />
            <button class="btn btnRed tight" id="addReviewBtn" style="flex:0 0 auto">Post</button>
          </div>
          <div class="stack" id="reviewsList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- INBOX MODAL -->
  <div class="modal" id="inboxModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="inboxTitle">Inbox</div>
        <button class="iconBtn" id="inboxClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack" id="inboxList"></div>
      </div>
    </div>
  </div>

  <!-- BONUS / GEMS MODAL -->
  <div class="modal" id="bonusModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="bonusTitle">Bonus (Gems)</div>
        <button class="iconBtn" id="bonusClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="note" id="bonusNote"></div>

          <div class="row">
            <select class="select" id="convertTier">
              <option value="10">10% (MG*)</option>
              <option value="20">20% (MZ*)</option>
              <option value="30">30% (MK*)</option>
              <option value="40">40% (MC*)</option>
              <option value="50">50% (MA*)</option>
              <option value="60">60% (MB*)</option>
              <option value="70">70% (ME*)</option>
              <option value="80">80% (MX*)</option>
              <option value="90">90% (MR*)</option>
              <option value="100">100% (MI*)</option>
            </select>
            <button class="btn btnRed tight" id="convertBtn" style="flex:0 0 auto">Convert</button>
          </div>

          <div class="note ok" id="convertOk" style="display:none"></div>
          <div class="note err" id="convertErr" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- AUTH MODAL (wizard) -->
  <div class="modal" id="authModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="authTitle">Account</div>
        <button class="iconBtn" id="authClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack" id="authHome">
          <button class="btn btnRed" id="openLoginBtn">Login</button>
          <button class="btn" id="openRegisterBtn">Create Account</button>
          <div class="note err" id="authErr" style="display:none"></div>
        </div>

        <div class="stack" id="loginBox" style="display:none">
          <div class="row">
            <input class="input" id="loginEmail" type="email" placeholder="Email" />
          </div>
          <div class="pwWrap">
            <input class="input" id="loginPass" type="password" placeholder="Password" />
            <span class="pwEye" data-eye="loginPass">üëÅ</span>
          </div>
          <button class="btn btnRed" id="doLoginBtn">Login</button>
          <button class="btn" id="backAuth1">Back</button>
          <div class="note err" id="loginErr" style="display:none"></div>
        </div>

        <div class="stack" id="regBox" style="display:none">
          <!-- step 1: names -->
          <div class="stack" id="regStep1">
            <div class="row">
              <input class="input" id="regFirst" placeholder="First name" />
              <input class="input" id="regLast" placeholder="Last name" />
            </div>
            <button class="btn btnRed" id="regNext1">Next</button>
            <button class="btn" id="backAuth2">Back</button>
            <div class="note err" id="regErr1" style="display:none"></div>
          </div>

          <!-- step 2: email + pass -->
          <div class="stack" id="regStep2" style="display:none">
            <input class="input" id="regEmail" type="email" placeholder="Email" />
            <div class="pwWrap">
              <input class="input" id="regPass" type="password" placeholder="Password" />
              <span class="pwEye" data-eye="regPass">üëÅ</span>
            </div>
            <button class="btn btnRed" id="regNext2">Next</button>
            <button class="btn" id="regBack2">Back</button>
            <div class="note err" id="regErr2" style="display:none"></div>
          </div>

          <!-- step 3: gender + age -->
          <div class="stack" id="regStep3" style="display:none">
            <select class="select" id="regGender">
              <option value="">Gender</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
            <input class="input" id="regAge" type="number" min="8" max="80" placeholder="Age" />
            <button class="btn btnRed" id="regNext3">Next</button>
            <button class="btn" id="regBack3">Back</button>
            <div class="note err" id="regErr3" style="display:none"></div>
          </div>

          <!-- step 4: avatar -->
          <div class="stack" id="regStep4" style="display:none">
            <div class="note" id="avatarNote">Upload profile picture (optional)</div>
            <input class="input" id="regAvatar" type="file" accept="image/*" />
            <button class="btn btnRed" id="regFinish">Save</button>
            <button class="btn" id="regBack4">Back</button>
            <div class="note err" id="regErr4" style="display:none"></div>
          </div>
        </div>

        <!-- profile modal inside -->
        <div class="stack" id="profileBox" style="display:none">
          <div class="note ok" id="profileHello"></div>

          <div class="row">
            <input class="input" id="profileName" placeholder="Display name" />
            <input class="input" id="profileAge" type="number" min="8" max="80" placeholder="Age" />
          </div>
          <div class="row">
            <select class="select" id="profileGender">
              <option value="">Gender</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
            <input class="input" id="profileAvatar" type="file" accept="image/*" />
          </div>

          <div class="pwWrap">
            <input class="input" id="profileNewPass" type="password" placeholder="New password" />
            <span class="pwEye" data-eye="profileNewPass">üëÅ</span>
          </div>

          <button class="btn btnRed" id="saveProfileBtn">Save</button>
          <button class="btn" id="closeProfileBtn">Close</button>
          <div class="note err" id="profileErr" style="display:none"></div>
          <div class="note ok" id="profileOk" style="display:none"></div>
        </div>

      </div>
    </div>
  </div>

  <!-- DETAILS MODAL -->
  <div class="modal" id="detailsModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="detailsTitle">Details</div>
        <button class="iconBtn" id="detailsClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="galleryBig" id="bigPreview"></div>
          <div class="galleryRow" id="thumbRow"></div>

          <div class="row">
            <div>
              <div style="font-weight:900" id="detailsName"></div>
              <div style="color:var(--muted);font-weight:800;font-size:12px" id="detailsDesc"></div>
            </div>
            <div class="note ok" style="text-align:center" id="detailsPrice"></div>
          </div>

          <div class="row">
            <button class="btn btnBlue" id="detailsAddCart">üõí Add to Cart</button>
            <button class="btn btnRed" id="detailsBuy">Buy</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CART MODAL -->
  <div class="modal" id="cartModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="cartTitle">Cart</div>
        <button class="iconBtn" id="cartClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack" id="cartList"></div>
        <div class="totalBar" id="cartTotalBar">
          <span id="cartTotalText">Total</span>
          <strong id="cartTotalValue">0</strong>
        </div>
        <button class="btn btnRed" id="cartCheckoutBtn">Checkout</button>
      </div>
    </div>
  </div>

  <!-- CHECKOUT MODAL (2 steps) -->
  <div class="modal" id="checkoutModal">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="checkoutTitle">Checkout</div>
        <button class="iconBtn" id="checkoutClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack" id="checkoutStep1">
          <div class="note" id="checkoutSummary"></div>

          <div class="row">
            <input class="input" id="couponInput" placeholder="Coupon code" />
            <button class="btn btnBlue tight" id="applyCouponBtn" style="flex:0 0 auto">Apply</button>
          </div>

          <div class="note ok" id="couponOk" style="display:none"></div>
          <div class="note err" id="couponErr" style="display:none"></div>

          <button class="btn btnRed" id="checkoutConfirmBtn">Confirm</button>
        </div>

        <div class="stack" id="checkoutStep2" style="display:none">
          <div class="note ok" id="payTitleNote"></div>

          <div class="stack">
            <button class="btn" id="payVodafone">Vodafone Cash</button>
            <button class="btn" id="payEtisalat">Etisalat Cash</button>
            <button class="btn" id="payOrange">Orange Cash</button>
            <button class="btn" id="payWe">WE Pay</button>
            <button class="btn" id="payInsta">InstaPay</button>
            <button class="btn" id="payVisa">Visa</button>
            <button class="btn" id="payBill">Bill Pay</button>
            <button class="btn" id="payTelda">Telda</button>
          </div>

          <div class="row">
            <button class="btn btnRed" id="finishPaymentBtn">I Paid</button>
            <button class="btn" id="backPaymentBtn">Back</button>
          </div>

          <div class="note err" id="payErr" style="display:none"></div>
        </div>

      </div>
    </div>
  </div>

  <script>
    /* ===================== helpers ===================== */
    const $ = (id)=>document.getElementById(id);
    const nowYear = new Date().getFullYear();
    $("year").textContent = nowYear;

    const isArabic = (navigator.language || "").toLowerCase().startsWith("ar");
    const LANG = isArabic ? "ar" : "en";
    document.documentElement.lang = LANG;
    document.documentElement.dir = isArabic ? "rtl" : "ltr";

    const t = {
      ar: {
        search:"üîç ÿßÿ®ÿ≠ÿ´...",
        top:"Top", offers:"Offers", games:"Games", programs:"Programs", accounts:"Accounts", recharge:"Recharge",
        most:"ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ∑ŸÑÿ®Ÿãÿß", deals:"ÿπÿ±Ÿàÿ∂",
        menu:"ÿßŸÑŸÇÿßÿ¶ŸÖÿ©", quick:"ÿ±Ÿàÿßÿ®ÿ∑ ÿ≥ÿ±Ÿäÿπÿ©", contact:"ÿßŸÑÿ™ŸàÿßÿµŸÑ", reviews:"ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿßÿ™", inbox:"ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ", bonus:"ÿßŸÑÿ¨ŸàÿßŸáÿ±",
        filter:"ŸÅŸÑÿ™ÿ±ÿ©", filterNote:"ÿßÿÆÿ™ÿßÿ± ÿßŸÑŸÇÿ≥ŸÖ ŸàÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ŸàÿßŸÑÿ≥ÿπÿ± Ÿàÿ®ÿπÿØŸäŸÜ ÿ™ÿ∑ÿ®ŸäŸÇ.",
        category:"ÿßŸÑŸÇÿ≥ŸÖ", sort:"ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ®", price:"ÿßŸÑÿ≥ÿπÿ±", apply:"ÿ™ÿ∑ÿ®ŸäŸÇ",
        all:"ÿßŸÑŸÉŸÑ", newest:"ÿßŸÑÿ£ÿ≠ÿØÿ´", oldest:"ÿßŸÑÿ£ŸÇÿØŸÖ", low:"ÿßŸÑÿ£ÿ±ÿÆÿµ ‚Üí ÿßŸÑÿ£ÿ∫ŸÑŸâ", high:"ÿßŸÑÿ£ÿ∫ŸÑŸâ ‚Üí ÿßŸÑÿ£ÿ±ÿÆÿµ",
        register:"ÿ™ÿ≥ÿ¨ŸäŸÑ", cart:"ÿßŸÑÿ≥ŸÑÿ©", details:"ÿ™ŸÅÿßÿµŸäŸÑ", addCart:"ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ≥ŸÑÿ©", buy:"ÿ¥ÿ±ÿßÿ°",
        ratingNeed:"ŸÑÿßÿ≤ŸÖ ÿ™ÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ ÿπŸÑÿ¥ÿßŸÜ ÿ™ŸÇŸäŸëŸÖ.",
        cartTitle:"ÿßŸÑÿ≥ŸÑÿ©", total:"ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä", checkout:"ÿ¥ÿ±ÿßÿ°",
        checkoutTitle:"ÿ¥ÿ±ÿßÿ°", confirm:"ÿ™ÿ£ŸÉŸäÿØ", paid:"ÿ™ŸÖ ÿßŸÑÿØŸÅÿπ", back:"ÿ±ÿ¨Ÿàÿπ",
        couponOk:"‚úÖ ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿÆÿµŸÖ.",
        couponBad:"‚ùå ÿßŸÑŸÉŸàÿØ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ ÿ£Ÿà ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÇÿ®ŸÑ ŸÉÿØŸá.",
        needLogin:"ŸÑÿßÿ≤ŸÖ ÿ™ÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ ÿßŸÑÿ£ŸàŸÑ.",
        inboxEmpty:"ŸÖŸÅŸäÿ¥ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿØŸÑŸàŸÇÿ™Ÿä.",
        bonusNote:(g)=>`üíé ÿ¨ŸàÿßŸáÿ±ŸÉ ÿßŸÑÿ≠ÿßŸÑŸäÿ©: ${g} ‚Äî ÿ™ŸÇÿØÿ± ÿ™ÿ≠ŸàŸÑŸáŸÖ ŸÑŸÉŸàÿ®ŸàŸÜ ÿÆÿµŸÖ.`,
        converted:(code)=>`‚úÖ ÿßÿ™ÿπŸÖŸÑ ŸÉŸàÿ®ŸàŸÜ: ${code}`,
        noCodes:"‚ùå ŸÖŸÅŸäÿ¥ ÿ£ŸÉŸàÿßÿØ ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑÿØÿ±ÿ¨ÿ© ÿØŸä ÿØŸÑŸàŸÇÿ™Ÿä.",
        authTitle:"ÿßŸÑÿ≠ÿ≥ÿßÿ®",
        login:"ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ",
        create:"ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®",
        first:"ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ£ŸàŸÑ",
        last:"ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ´ÿßŸÜŸä",
        email:"ÿßŸÑÿ®ÿ±ŸäÿØ",
        pass:"ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±",
        gender:"ÿßŸÑŸÜŸàÿπ",
        male:"ÿ∞ŸÉÿ±",
        female:"ÿ£ŸÜÿ´Ÿâ",
        age:"ÿßŸÑÿπŸÖÿ±",
        next:"ÿßŸÑÿ™ÿßŸÑŸä",
        save:"ÿ≠ŸÅÿ∏",
        editProfile:"ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®",
        logout:"ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨",
        saveOk:"‚úÖ ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏.",
        saveErr:"‚ùå ÿ±ÿßÿ¨ÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™.",
        payMethodsTitle:(amount)=>`ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÜŸáÿßÿ¶Ÿä: ${amount} ÿ¨ŸÜŸäŸá ‚Äî ÿßÿÆÿ™ÿßÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ`,
        payNeedConfirm:"‚ùå ÿßÿ∂ÿ∫ÿ∑ Confirm ÿßŸÑÿ£ŸàŸÑ.",
        detailsTitle:"ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨",
        rechargeNames:{
          robux:"Robux",
          freefire:"Free Fire Diamonds",
          pubguc:"PUBG UC",
          efootball:"eFootball Coins"
        }
      },
      en: {
        search:"üîç Search...",
        top:"Top", offers:"Offers", games:"Games", programs:"Programs", accounts:"Accounts", recharge:"Recharge",
        most:"Most wanted", deals:"Deals",
        menu:"Menu", quick:"Quick", contact:"Contact", reviews:"Reviews", inbox:"Inbox", bonus:"Gems",
        filter:"Filter", filterNote:"Choose category, sort, and price then apply.",
        category:"Category", sort:"Sort", price:"Price", apply:"Apply",
        all:"All", newest:"Newest", oldest:"Oldest", low:"Low ‚Üí High", high:"High ‚Üí Low",
        register:"Sign in", cart:"Cart", details:"Details", addCart:"Add to Cart", buy:"Buy",
        ratingNeed:"Please login to rate.",
        cartTitle:"Cart", total:"Total", checkout:"Checkout",
        checkoutTitle:"Checkout", confirm:"Confirm", paid:"I Paid", back:"Back",
        couponOk:"‚úÖ Discount applied.",
        couponBad:"‚ùå Invalid or already used coupon.",
        needLogin:"Please login first.",
        inboxEmpty:"No messages yet.",
        bonusNote:(g)=>`üíé Your gems: ${g} ‚Äî Convert to a discount coupon.`,
        converted:(code)=>`‚úÖ Coupon created: ${code}`,
        noCodes:"‚ùå No available codes for this tier.",
        authTitle:"Account",
        login:"Login",
        create:"Create Account",
        first:"First name",
        last:"Last name",
        email:"Email",
        pass:"Password",
        gender:"Gender",
        male:"Male",
        female:"Female",
        age:"Age",
        next:"Next",
        save:"Save",
        editProfile:"Edit profile",
        logout:"Logout",
        saveOk:"‚úÖ Saved.",
        saveErr:"‚ùå Check your data.",
        payMethodsTitle:(amount)=>`Final total: ${amount} EGP ‚Äî Choose payment method`,
        payNeedConfirm:"‚ùå Please confirm first.",
        detailsTitle:"Product Details",
        rechargeNames:{
          robux:"Robux",
          freefire:"Free Fire Diamonds",
          pubguc:"PUBG UC",
          efootball:"eFootball Coins"
        }
      }
    }[LANG];

    // apply language text
    $("search").placeholder = t.search;
    $("titleTop").firstChild.textContent = `üî• ${t.top} `;
    $("hintTop").textContent = t.most;
    $("titleOffers").firstChild.textContent = `üéÅ ${t.offers} `;
    $("hintOffers").textContent = t.deals;
    $("titleGames").textContent = `üéÆ ${t.games}`;
    $("titlePrograms").textContent = `üíª ${t.programs}`;
    $("titleAccounts").textContent = `üßæ ${t.accounts}`;
    $("titleRecharge").textContent = `‚ö° ${t.recharge}`;

    $("menuTitle").textContent = t.menu;
    $("quickLabel").textContent = t.quick;
    $("mTop").textContent = t.top;
    $("mOffers").textContent = t.offers;
    $("mGames").textContent = t.games;
    $("mPrograms").textContent = t.programs;
    $("mAccounts").textContent = t.accounts;
    $("mRecharge").textContent = t.recharge;
    $("mContact").textContent = t.contact;
    $("mReviews").textContent = t.reviews;
    $("mInbox").textContent = t.inbox;
    $("mBonus").textContent = t.bonus;

    $("filterTitle").textContent = t.filter;
    $("filterNote").textContent = t.filterNote;
    $("filterCatLabel").textContent = t.category;
    $("filterSortLabel").textContent = t.sort;
    $("filterPriceLabel").textContent = t.price;
    $("applyFilterBtn").textContent = t.apply;

    // filter options
    const cat = $("filterCategory");
    cat.options[0].textContent = t.all;
    cat.options[1].textContent = t.top;
    cat.options[2].textContent = t.offers;
    cat.options[3].textContent = t.games;
    cat.options[4].textContent = t.programs;
    cat.options[5].textContent = t.accounts;
    cat.options[6].textContent = t.recharge;

    const sort = $("filterSort");
    sort.options[0].textContent = t.newest;
    sort.options[1].textContent = t.oldest;
    sort.options[2].textContent = t.low;
    sort.options[3].textContent = t.high;

    $("contactTitle").textContent = t.contact;
    $("reviewsTitle").textContent = t.reviews;
    $("inboxTitle").textContent = t.inbox;
    $("bonusTitle").textContent = t.bonus;

    $("cartTitle").textContent = t.cartTitle;
    $("cartTotalText").textContent = t.total;
    $("cartCheckoutBtn").textContent = t.checkout;

    $("checkoutTitle").textContent = t.checkoutTitle;
    $("checkoutConfirmBtn").textContent = t.confirm;
    $("finishPaymentBtn").textContent = t.paid;
    $("backPaymentBtn").textContent = t.back;

    $("authTitle").textContent = t.authTitle;
    $("openLoginBtn").textContent = t.login;
    $("openRegisterBtn").textContent = t.create;
    $("doLoginBtn").textContent = t.login;
    $("openRegisterBtn").textContent = t.create;

    // Social labels (keep brand names)
    $("footerWa").textContent = "WhatsApp";
    $("footerIg").textContent = "Instagram";
    $("footerFb").textContent = "Facebook";
    $("footerMail").textContent = "Email";

    /* ===================== storage ===================== */
    const KEY = {
      users:"mgs_users_v1",
      session:"mgs_session_v1",
      cart:"mgs_cart_v1",
      ratings:"mgs_ratings_v1",
      reviews:"mgs_reviews_v1",
      inbox:"mgs_inbox_v1",
      gems:"mgs_gems_v1",
      usedCoupons:"mgs_usedCoupons_v1"
    };
    const load = (k, fallback)=> {
      try{ const v = JSON.parse(localStorage.getItem(k)); return (v ?? fallback); }
      catch{ return fallback; }
    };
    const save = (k, v)=> localStorage.setItem(k, JSON.stringify(v));

    /* ===================== coupons (hidden, not listed on UI) ===================== */
    // All codes you provided: MG, MZ, MK, MC, MA, MB, ME, MX, MR, MI from 1..10
    function buildCodes(prefix){
      const out=[];
      for(let i=1;i<=10;i++) out.push(`${prefix}${i}`);
      return out;
    }
    const COUPON_TIERS = {
      10: buildCodes("MG"),
      20: buildCodes("MZ"),
      30: buildCodes("MK"),
      40: buildCodes("MC"),
      50: buildCodes("MA"),
      60: buildCodes("MB"),
      70: buildCodes("ME"),
      80: buildCodes("MX"),
      90: buildCodes("MR"),
      100: buildCodes("MI"),
    };

    const getUsedCoupons = ()=> new Set(load(KEY.usedCoupons, []));
    const markCouponUsed = (code)=>{
      const s = getUsedCoupons(); s.add(code);
      save(KEY.usedCoupons, Array.from(s));
    };
    const isCouponUsed = (code)=> getUsedCoupons().has(code);

    const couponDiscount = (code)=>{
      const u = code.trim().toUpperCase();
      for(const [pct, arr] of Object.entries(COUPON_TIERS)){
        if(arr.includes(u) && !isCouponUsed(u)) return Number(pct);
      }
      return 0;
    };

    /* ===================== products ===================== */
    // IMPORTANT: 4 each section
    const PRODUCTS = [
      // Top (4)
      {id:"top1", section:"top", name:{ar:"Top Product 1",en:"Top Product 1"}, desc:{ar:"ŸàÿµŸÅ ŸÖÿÆÿ™ÿµÿ±",en:"Short description"}, price:350, badge:"top", imgs:[]},
      {id:"top2", section:"top", name:{ar:"Top Product 2",en:"Top Product 2"}, desc:{ar:"ŸàÿµŸÅ ŸÖÿÆÿ™ÿµÿ±",en:"Short description"}, price:420, badge:"top", imgs:[]},
      {id:"top3", section:"top", name:{ar:"Top Product 3",en:"Top Product 3"}, desc:{ar:"ŸàÿµŸÅ ŸÖÿÆÿ™ÿµÿ±",en:"Short description"}, price:280, badge:"top", imgs:[]},
      {id:"top4", section:"top", name:{ar:"Top Product 4",en:"Top Product 4"}, desc:{ar:"ŸàÿµŸÅ ŸÖÿÆÿ™ÿµÿ±",en:"Short description"}, price:510, badge:"top", imgs:[]},

      // Offers (4)
      {id:"off1", section:"offers", name:{ar:"Offer 1",en:"Offer 1"}, desc:{ar:"ÿπÿ±ÿ∂ ÿÆÿßÿµ",en:"Special offer"}, price:199, badge:"offer", imgs:[]},
      {id:"off2", section:"offers", name:{ar:"Offer 2",en:"Offer 2"}, desc:{ar:"ÿπÿ±ÿ∂ ÿÆÿßÿµ",en:"Special offer"}, price:249, badge:"offer", imgs:[]},
      {id:"off3", section:"offers", name:{ar:"Offer 3",en:"Offer 3"}, desc:{ar:"ÿπÿ±ÿ∂ ÿÆÿßÿµ",en:"Special offer"}, price:299, badge:"offer", imgs:[]},
      {id:"off4", section:"offers", name:{ar:"Offer 4",en:"Offer 4"}, desc:{ar:"ÿπÿ±ÿ∂ ÿÆÿßÿµ",en:"Special offer"}, price:179, badge:"offer", imgs:[]},

      // Games (4)
      {id:"g1", section:"games", name:{ar:"Game 1",en:"Game 1"}, desc:{ar:"ŸàÿµŸÅ ÿßŸÑŸÑÿπÿ®ÿ©",en:"Game description"}, price:600, badge:null, imgs:[]},
      {id:"g2", section:"games", name:{ar:"Game 2",en:"Game 2"}, desc:{ar:"ŸàÿµŸÅ ÿßŸÑŸÑÿπÿ®ÿ©",en:"Game description"}, price:750, badge:null, imgs:[]},
      {id:"g3", section:"games", name:{ar:"Game 3",en:"Game 3"}, desc:{ar:"ŸàÿµŸÅ ÿßŸÑŸÑÿπÿ®ÿ©",en:"Game description"}, price:500, badge:null, imgs:[]},
      {id:"g4", section:"games", name:{ar:"Game 4",en:"Game 4"}, desc:{ar:"ŸàÿµŸÅ ÿßŸÑŸÑÿπÿ®ÿ©",en:"Game description"}, price:820, badge:null, imgs:[]},

      // Programs (4)
      {id:"p1", section:"programs", name:{ar:"Program 1",en:"Program 1"}, desc:{ar:"ŸàÿµŸÅ ÿßŸÑÿ®ÿ±ŸÜÿßŸÖÿ¨",en:"Program description"}, price:300, badge:null, imgs:[]},
      {id:"p2", section:"programs", name:{ar:"Program 2",en:"Program 2"}, desc:{ar:"ŸàÿµŸÅ ÿßŸÑÿ®ÿ±ŸÜÿßŸÖÿ¨",en:"Program description"}, price:450, badge:null, imgs:[]},
      {id:"p3", section:"programs", name:{ar:"Program 3",en:"Program 3"}, desc:{ar:"ŸàÿµŸÅ ÿßŸÑÿ®ÿ±ŸÜÿßŸÖÿ¨",en:"Program description"}, price:280, badge:null, imgs:[]},
      {id:"p4", section:"programs", name:{ar:"Program 4",en:"Program 4"}, desc:{ar:"ŸàÿµŸÅ ÿßŸÑÿ®ÿ±ŸÜÿßŸÖÿ¨",en:"Program description"}, price:520, badge:null, imgs:[]},

      // Accounts (4) ‚Äî (ÿ®ÿØŸàŸÜ PlayStation/Epic/Steam ÿ≤Ÿä ŸÖÿß ŸÉŸÜÿ™ ÿ®ÿ™ŸÇŸàŸÑ ŸÇÿ®ŸÑ)
      {id:"a1", section:"accounts", name:{ar:"PUBG Account",en:"PUBG Account"}, desc:{ar:"ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÉÿßŸàŸÜÿ™ ŸÅŸä ÿßŸÑÿØŸäÿ™ŸäŸÑÿ≤",en:"Account details in details view"}, price:1200, badge:null, imgs:[]},
      {id:"a2", section:"accounts", name:{ar:"Free Fire Account",en:"Free Fire Account"}, desc:{ar:"ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÉÿßŸàŸÜÿ™ ŸÅŸä ÿßŸÑÿØŸäÿ™ŸäŸÑÿ≤",en:"Account details in details view"}, price:800, badge:null, imgs:[]},
      {id:"a3", section:"accounts", name:{ar:"Roblox Account",en:"Roblox Account"}, desc:{ar:"ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÉÿßŸàŸÜÿ™ ŸÅŸä ÿßŸÑÿØŸäÿ™ŸäŸÑÿ≤",en:"Account details in details view"}, price:650, badge:null, imgs:[]},
      {id:"a4", section:"accounts", name:{ar:"eFootball Account",en:"eFootball Account"}, desc:{ar:"ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÉÿßŸàŸÜÿ™ ŸÅŸä ÿßŸÑÿØŸäÿ™ŸäŸÑÿ≤",en:"Account details in details view"}, price:900, badge:null, imgs:[]},

      // Recharge (4)
      {id:"r1", section:"recharge", name:{ar:t.rechargeNames.robux,en:t.rechargeNames.robux}, desc:{ar:"ÿ¥ÿ≠ŸÜ ÿπŸÖŸÑÿ© ÿßŸÑŸÑÿπÿ®ÿ©",en:"Recharge currency"}, price:150, badge:null, imgs:[]},
      {id:"r2", section:"recharge", name:{ar:t.rechargeNames.freefire,en:t.rechargeNames.freefire}, desc:{ar:"ÿ¥ÿ≠ŸÜ ÿ¨ŸàÿßŸáÿ±",en:"Recharge diamonds"}, price:200, badge:null, imgs:[]},
      {id:"r3", section:"recharge", name:{ar:t.rechargeNames.pubguc,en:t.rechargeNames.pubguc}, desc:{ar:"ÿ¥ÿ≠ŸÜ UC",en:"Recharge UC"}, price:250, badge:null, imgs:[]},
      {id:"r4", section:"recharge", name:{ar:t.rechargeNames.efootball,en:t.rechargeNames.efootball}, desc:{ar:"ÿ¥ÿ≠ŸÜ ŸÉŸàŸäŸÜÿ≤",en:"Recharge coins"}, price:180, badge:null, imgs:[]},
    ];

    // default images placeholders (5)
    function defaultImgs(id){
      // no external links: create simple colored SVG data URIs
      const mk = (label, c1, c2)=>{
        const svg = encodeURIComponent(`
          <svg xmlns="http://www.w3.org/2000/svg" width="900" height="600">
            <defs>
              <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="${c1}"/>
                <stop offset="1" stop-color="${c2}"/>
              </linearGradient>
            </defs>
            <rect width="100%" height="100%" fill="url(#g)"/>
            <circle cx="150" cy="140" r="120" fill="rgba(255,255,255,.10)"/>
            <circle cx="760" cy="90" r="140" fill="rgba(255,255,255,.08)"/>
            <circle cx="640" cy="520" r="180" fill="rgba(255,255,255,.06)"/>
            <text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle"
              font-family="Segoe UI, Arial" font-size="54" font-weight="800" fill="rgba(255,255,255,.92)">${label}</text>
            <text x="50%" y="65%" dominant-baseline="middle" text-anchor="middle"
              font-family="Segoe UI, Arial" font-size="22" font-weight="700" fill="rgba(255,255,255,.75)">${id}</text>
          </svg>
        `);
        return `data:image/svg+xml;charset=utf-8,${svg}`;
      };

      return [
        mk("MAIN", "#0ea5e9", "#e11d48"),
        mk("VIEW 2", "#111827", "#0ea5e9"),
        mk("VIEW 3", "#e11d48", "#111827"),
        mk("VIEW 4", "#22c55e", "#0ea5e9"),
        mk("VIEW 5", "#f59e0b", "#111827"),
      ];
    }
    PRODUCTS.forEach(p => p.imgs = defaultImgs(p.id));

    /* ===================== session & users ===================== */
    let users = load(KEY.users, []); // {email, passHash, profile:{first,last,display,gender,age,avatarData}}
    let session = load(KEY.session, null); // {email}
    const hash = (s)=> btoa(unescape(encodeURIComponent(s))).slice(0, 64);

    const getUser = (email)=> users.find(u=>u.email.toLowerCase()===email.toLowerCase());
    const currentUser = ()=> session ? getUser(session.email) : null;

    function setSession(email){
      session = {email};
      save(KEY.session, session);
    }
    function clearSession(){
      session = null;
      save(KEY.session, null);
    }

    /* ===================== inbox + gems ===================== */
    function inboxAll(){
      return load(KEY.inbox, []); // {toEmail|null, text, ts, read}
    }
    function pushInbox(text, toEmail=null){
      const list = inboxAll();
      list.unshift({toEmail, text, ts: Date.now(), read:false});
      save(KEY.inbox, list);
      renderInboxCount();
    }
    function userInbox(){
      const u = currentUser();
      const list = inboxAll();
      if(!u) return [];
      return list.filter(m => m.toEmail === u.email);
    }
    function renderInboxCount(){
      const u = currentUser();
      if(!u){ $("inboxCount").textContent = "0"; return; }
      const unread = userInbox().filter(m=>!m.read).length;
      $("inboxCount").textContent = String(unread);
    }

    function gemsAll(){
      return load(KEY.gems, {}); // {email: number}
    }
    function getGems(email){
      const g = gemsAll();
      return Number(g[email] || 0);
    }
    function setGems(email, val){
      const g = gemsAll();
      g[email] = Math.max(0, Math.floor(val));
      save(KEY.gems, g);
    }
    function addGems(email, delta){
      setGems(email, getGems(email) + delta);
    }
    function renderGems(){
      const u = currentUser();
      $("gemsCount").textContent = u ? String(getGems(u.email)) : "0";
      $("bonusNote").textContent = t.bonusNote(u ? getGems(u.email) : 0);
    }

    /* ===================== ratings ===================== */
    // ratings: {productId: {sum, count, byUser:{email:stars}}}
    let ratings = load(KEY.ratings, {});
    function getRating(pid){
      const r = ratings[pid] || {sum:0,count:0,byUser:{}};
      return r;
    }
    function setRating(pid, r){
      ratings[pid] = r;
      save(KEY.ratings, ratings);
    }
    function avgRating(pid){
      const r = getRating(pid);
      return r.count ? (r.sum / r.count) : 0;
    }

    /* ===================== cart ===================== */
    // cart: {productId: qty}
    let cart = load(KEY.cart, {});
    function cartCount(){
      return Object.values(cart).reduce((a,b)=>a+Number(b||0),0);
    }
    function setCart(){
      save(KEY.cart, cart);
      $("cartCount").textContent = String(cartCount());
    }
    function addToCart(pid, qty=1){
      cart[pid] = (cart[pid] || 0) + qty;
      if(cart[pid] <= 0) delete cart[pid];
      setCart();
    }
    function removeFromCart(pid){
      delete cart[pid];
      setCart();
    }
    function cartTotal(){
      let total=0;
      for(const [pid,qty] of Object.entries(cart)){
        const p = PRODUCTS.find(x=>x.id===pid);
        if(p) total += p.price * qty;
      }
      return total;
    }

    /* ===================== UI open/close ===================== */
    const overlay = $("overlay");
    const menuDrawer = $("menuDrawer");
    const filterDrawer = $("filterDrawer");

    function openOverlay(){ overlay.classList.add("show"); }
    function closeOverlay(){ overlay.classList.remove("show"); }

    function closeAll(){
      closeOverlay();
      menuDrawer.classList.remove("show");
      filterDrawer.classList.remove("show");
      hideModal("contactModal");
      hideModal("reviewsModal");
      hideModal("inboxModal");
      hideModal("bonusModal");
      hideModal("authModal");
      hideModal("detailsModal");
      hideModal("cartModal");
      hideModal("checkoutModal");
      menuDrawer.setAttribute("aria-hidden","true");
      filterDrawer.setAttribute("aria-hidden","true");
    }
    function showDrawer(el){
      openOverlay();
      el.classList.add("show");
      el.setAttribute("aria-hidden","false");
    }
    function hideDrawer(el){
      el.classList.remove("show");
      el.setAttribute("aria-hidden","true");
      closeOverlay();
    }

    function showModal(id){
      openOverlay();
      $(id).classList.add("show");
    }
    function hideModal(id){
      $(id).classList.remove("show");
    }

    overlay.addEventListener("click", closeAll);

    /* ===================== render products ===================== */
    function makeCard(p){
      const card = document.createElement("div");
      card.className = "card";

      const thumb = document.createElement("div");
      thumb.className = "thumb";
      thumb.textContent = (p.section==="accounts") ? "ACCOUNT" : (p.section==="programs") ? "APP" : (p.section==="recharge") ? "RECHARGE" : "GAME";

      if(p.badge==="top"){
        const b = document.createElement("div");
        b.className = "badge top";
        b.textContent = t.top;
        thumb.appendChild(b);
      } else if(p.badge==="offer"){
        const b = document.createElement("div");
        b.className = "badge offer";
        b.textContent = t.offers;
        thumb.appendChild(b);
      }

      // Open details on thumb click
      thumb.addEventListener("click", ()=> openDetails(p.id));

      const content = document.createElement("div");
      content.className = "content";

      const name = document.createElement("p");
      name.className = "name";
      name.textContent = p.name[LANG] || p.name.en;

      const meta = document.createElement("p");
      meta.className = "meta";
      meta.textContent = p.desc[LANG] || p.desc.en;

      const priceRow = document.createElement("div");
      priceRow.className = "priceRow";
      const price = document.createElement("p");
      price.className = "price";
      price.textContent = `${p.price} EGP`;
      priceRow.appendChild(price);

      // rating UI
      const ratingRow = document.createElement("div");
      ratingRow.className = "ratingRow";
      const stars = document.createElement("div");
      stars.className = "stars";
      const metaR = document.createElement("div");
      metaR.className = "ratingMeta";

      const r = getRating(p.id);
      const av = avgRating(p.id);
      metaR.textContent = r.count ? `${av.toFixed(1)} (${r.count})` : `0.0 (0)`;

      // clickable rating (needs login)
      for(let i=1;i<=5;i++){
        const s = document.createElement("div");
        s.className = "starBtn" + (i <= Math.round(av) ? " filled" : "");
        s.textContent = "‚òÖ";
        s.title = "Rate";
        s.addEventListener("click", (e)=>{
          e.stopPropagation();
          const u = currentUser();
          if(!u){
            toast(t.ratingNeed, "err");
            return;
          }
          const rr = getRating(p.id);
          const prev = rr.byUser[u.email] || 0;
          rr.byUser[u.email] = i;

          // update sum/count properly
          if(prev === 0){ rr.count += 1; rr.sum += i; }
          else { rr.sum += (i - prev); }

          setRating(p.id, rr);
          renderAll(); // refresh rating UI
          pushInbox(`${u.profile.display || (u.profile.first+" "+u.profile.last)} rated "${p.name.en}" ${i}‚òÖ`, u.email);
        });
        stars.appendChild(s);
      }
      ratingRow.appendChild(stars);
      ratingRow.appendChild(metaR);

      const actions = document.createElement("div");
      actions.className = "actions";

      const detailsBtn = document.createElement("button");
      detailsBtn.className = "btn btnBlue";
      detailsBtn.textContent = t.details;
      detailsBtn.addEventListener("click", (e)=>{ e.stopPropagation(); openDetails(p.id); });

      const addBtn = document.createElement("button");
      addBtn.className = "btn";
      addBtn.textContent = `üõí ${t.addCart}`;
      addBtn.addEventListener("click", (e)=>{
        e.stopPropagation();
        addToCart(p.id, 1);
        toast(`${t.addCart}: ${p.name[LANG]}`, "ok");
      });

      const buyBtn = document.createElement("button");
      buyBtn.className = "btn btnRed";
      buyBtn.textContent = t.buy;
      buyBtn.addEventListener("click", (e)=>{
        e.stopPropagation();
        openCheckoutSingle(p.id);
      });

      actions.appendChild(detailsBtn);
      actions.appendChild(addBtn);
      actions.appendChild(buyBtn);

      content.appendChild(name);
      content.appendChild(meta);
      content.appendChild(priceRow);
      content.appendChild(ratingRow);
      content.appendChild(actions);

      card.appendChild(thumb);
      card.appendChild(content);
      return card;
    }

    function renderSection(section, gridId){
      const grid = $(gridId);
      grid.innerHTML = "";
      const list = filteredProducts().filter(p => p.section===section);
      list.forEach(p => grid.appendChild(makeCard(p)));
    }

    /* ===================== filter & search ===================== */
    let filterState = {cat:"all", sort:"new", priceMode:"off", priceValue:0};

    function filteredProducts(){
      let list = [...PRODUCTS];

      // search
      const q = ($("search").value || "").trim().toLowerCase();
      if(q){
        list = list.filter(p=>{
          const n = (p.name[LANG] || p.name.en || "").toLowerCase();
          const d = (p.desc[LANG] || p.desc.en || "").toLowerCase();
          return n.includes(q) || d.includes(q);
        });
      }

      // category filter
      if(filterState.cat !== "all"){
        list = list.filter(p => p.section === filterState.cat);
      }

      // price filter
      const pv = Number(filterState.priceValue || 0);
      if(filterState.priceMode !== "off" && pv >= 0){
        if(filterState.priceMode === "eq") list = list.filter(p => p.price === pv);
        if(filterState.priceMode === "lte") list = list.filter(p => p.price <= pv);
        if(filterState.priceMode === "gte") list = list.filter(p => p.price >= pv);
      }

      // sort
      if(filterState.sort === "low") list.sort((a,b)=>a.price-b.price);
      if(filterState.sort === "high") list.sort((a,b)=>b.price-a.price);
      if(filterState.sort === "new") list.sort((a,b)=> PRODUCTS.indexOf(a) - PRODUCTS.indexOf(b)); // default order
      if(filterState.sort === "old") list.sort((a,b)=> PRODUCTS.indexOf(b) - PRODUCTS.indexOf(a));

      return list;
    }

    $("applyFilterBtn").addEventListener("click", ()=>{
      filterState.cat = $("filterCategory").value;
      filterState.sort = $("filterSort").value;
      filterState.priceMode = $("priceMode").value;
      filterState.priceValue = $("priceValue").value;
      hideDrawer(filterDrawer);
      renderAll();
    });

    $("search").addEventListener("input", ()=> renderAll());

    /* ===================== details modal ===================== */
    let activeProductId = null;

    function openDetails(pid){
      activeProductId = pid;
      const p = PRODUCTS.find(x=>x.id===pid);
      if(!p) return;

      $("detailsTitle").textContent = t.detailsTitle;
      $("detailsName").textContent = p.name[LANG] || p.name.en;
      $("detailsDesc").textContent = p.desc[LANG] || p.desc.en;
      $("detailsPrice").textContent = `${p.price} EGP`;

      // gallery
      const big = $("bigPreview");
      const row = $("thumbRow");
      row.innerHTML = "";
      let currentImg = p.imgs[0];

      const setBig = (src)=>{
        big.innerHTML = "";
        const img = document.createElement("img");
        img.src = src;
        img.alt = "preview";
        big.appendChild(img);
      };
      setBig(currentImg);

      p.imgs.slice(0,5).forEach((src, idx)=>{
        const th = document.createElement("div");
        th.className = "gThumb" + (idx===0 ? " active":"");
        const im = document.createElement("img");
        im.src = src;
        im.alt = "thumb";
        th.appendChild(im);
        th.addEventListener("click", ()=>{
          currentImg = src;
          setBig(src);
          [...row.children].forEach(x=>x.classList.remove("active"));
          th.classList.add("active");
        });
        row.appendChild(th);
      });

      // actions
      $("detailsAddCart").onclick = ()=> {
        addToCart(pid, 1);
        toast(`${t.addCart}: ${p.name[LANG]}`, "ok");
      };
      $("detailsBuy").onclick = ()=> openCheckoutSingle(pid);

      showModal("detailsModal");
    }
    $("detailsClose").addEventListener("click", ()=>{ hideModal("detailsModal"); closeOverlay(); });

    /* ===================== cart modal ===================== */
    function renderCart(){
      const list = $("cartList");
      list.innerHTML = "";
      const entries = Object.entries(cart);

      if(entries.length === 0){
        const n = document.createElement("div");
        n.className = "note";
        n.textContent = (LANG==="ar") ? "ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ∂Ÿäÿ©." : "Cart is empty.";
        list.appendChild(n);
      }

      for(const [pid,qty] of entries){
        const p = PRODUCTS.find(x=>x.id===pid);
        if(!p) continue;

        const item = document.createElement("div");
        item.className = "cartItem";

        const left = document.createElement("div");
        left.className = "cartLeft";

        const th = document.createElement("div");
        th.className = "cartThumb";
        th.textContent = "IMG";

        const mid = document.createElement("div");
        const nm = document.createElement("div");
        nm.className = "cartName";
        nm.textContent = p.name[LANG] || p.name.en;

        const mt = document.createElement("div");
        mt.className = "cartMeta";
        mt.textContent = `${p.price} EGP`;

        const qtyRow = document.createElement("div");
        qtyRow.className = "qtyRow";

        const minus = document.createElement("button");
        minus.className = "qtyBtn";
        minus.textContent = "‚àí";
        minus.onclick = ()=>{
          addToCart(pid, -1);
          renderCart();
        };

        const qn = document.createElement("div");
        qn.className = "qtyNum";
        qn.textContent = String(qty);

        const plus = document.createElement("button");
        plus.className = "qtyBtn";
        plus.textContent = "+";
        plus.onclick = ()=>{
          addToCart(pid, 1);
          renderCart();
        };

        const det = document.createElement("button");
        det.className = "detailsBtn";
        det.textContent = t.details;
        det.onclick = ()=> openDetails(pid);

        const rm = document.createElement("button");
        rm.className = "removeBtn";
        rm.textContent = "Remove";
        rm.onclick = ()=>{
          removeFromCart(pid);
          renderCart();
        };

        qtyRow.appendChild(minus);
        qtyRow.appendChild(qn);
        qtyRow.appendChild(plus);
        qtyRow.appendChild(det);
        qtyRow.appendChild(rm);

        mid.appendChild(nm);
        mid.appendChild(mt);
        mid.appendChild(qtyRow);

        left.appendChild(th);
        left.appendChild(mid);

        item.appendChild(left);
        list.appendChild(item);
      }

      $("cartTotalValue").textContent = `${cartTotal()} EGP`;
      $("cartCount").textContent = String(cartCount());
    }

    $("cartBtn").addEventListener("click", ()=>{
      renderCart();
      showModal("cartModal");
    });
    $("cartClose").addEventListener("click", ()=>{ hideModal("cartModal"); closeOverlay(); });

    /* ===================== checkout ===================== */
    let checkoutMode = {type:"cart", singlePid:null};
    let appliedCoupon = null; // {code, pct}

    function openCheckoutSingle(pid){
      const u = currentUser();
      if(!u){
        toast(t.needLogin, "err");
        openAuth();
        return;
      }
      checkoutMode = {type:"single", singlePid:pid};
      appliedCoupon = null;
      startCheckout();
    }

    $("cartCheckoutBtn").addEventListener("click", ()=>{
      const u = currentUser();
      if(!u){
        toast(t.needLogin, "err");
        openAuth();
        return;
      }
      if(Object.keys(cart).length === 0){
        toast((LANG==="ar")?"ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ∂Ÿäÿ©.":"Cart is empty.", "err");
        return;
      }
      checkoutMode = {type:"cart", singlePid:null};
      appliedCoupon = null;
      startCheckout();
    });

    function startCheckout(){
      $("couponInput").value = "";
      $("couponOk").style.display="none";
      $("couponErr").style.display="none";
      $("checkoutStep1").style.display="flex";
      $("checkoutStep2").style.display="none";
      $("payErr").style.display="none";

      const {itemsText, total} = checkoutSummary();
      $("checkoutSummary").textContent = itemsText + `\n${(LANG==="ar")?"ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:":"Total:"} ${total} EGP`;

      showModal("checkoutModal");
    }

    function checkoutSummary(){
      let total=0;
      let lines=[];
      if(checkoutMode.type==="single"){
        const p = PRODUCTS.find(x=>x.id===checkoutMode.singlePid);
        total = p ? p.price : 0;
        lines.push(`‚Ä¢ ${p ? (p.name[LANG]||p.name.en) : ""} ‚Äî ${total} EGP`);
      } else {
        for(const [pid,qty] of Object.entries(cart)){
          const p = PRODUCTS.find(x=>x.id===pid);
          if(!p) continue;
          const lineTotal = p.price * qty;
          total += lineTotal;
          lines.push(`‚Ä¢ ${p.name[LANG]||p.name.en} x${qty} ‚Äî ${lineTotal} EGP`);
        }
      }
      const itemsText = lines.join("\n");
      return {itemsText, total};
    }

    function finalTotal(){
      const {total} = checkoutSummary();
      if(!appliedCoupon) return total;
      const pct = appliedCoupon.pct;
      return Math.max(0, Math.round(total * (1 - pct/100)));
    }

    $("applyCouponBtn").addEventListener("click", ()=>{
      const code = ($("couponInput").value||"").trim().toUpperCase();
      if(!code){
        $("couponErr").textContent = (LANG==="ar")?"ÿßŸÉÿ™ÿ® ŸÉŸàÿØ ÿßŸÑÿ£ŸàŸÑ.":"Enter a code.";
        $("couponErr").style.display="block";
        $("couponOk").style.display="none";
        return;
      }
      const pct = couponDiscount(code);
      if(pct>0){
        appliedCoupon = {code, pct};
        $("couponOk").textContent = `${t.couponOk} (-${pct}%)`;
        $("couponOk").style.display="block";
        $("couponErr").style.display="none";
      } else {
        appliedCoupon = null;
        $("couponErr").textContent = t.couponBad;
        $("couponErr").style.display="block";
        $("couponOk").style.display="none";
      }
    });

    $("checkoutConfirmBtn").addEventListener("click", ()=>{
      // lock coupon as used on confirm (one-time)
      if(appliedCoupon){
        markCouponUsed(appliedCoupon.code);
      }

      const amount = finalTotal();
      $("payTitleNote").textContent = t.payMethodsTitle(amount);

      $("checkoutStep1").style.display="none";
      $("checkoutStep2").style.display="flex";
    });

    $("backPaymentBtn").addEventListener("click", ()=>{
      $("checkoutStep2").style.display="none";
      $("checkoutStep1").style.display="flex";
    });

    function fakeOpenPay(method){
      const u = currentUser();
      if(!u){
        $("payErr").textContent = t.needLogin;
        $("payErr").style.display="block";
        return;
      }
      // just show toast
      toast(method, "ok");
    }
    $("payVodafone").onclick = ()=> fakeOpenPay("Vodafone Cash");
    $("payEtisalat").onclick = ()=> fakeOpenPay("Etisalat Cash");
    $("payOrange").onclick = ()=> fakeOpenPay("Orange Cash");
    $("payWe").onclick = ()=> fakeOpenPay("WE Pay");
    $("payInsta").onclick = ()=> fakeOpenPay("InstaPay");
    $("payVisa").onclick = ()=> fakeOpenPay("Visa");
    $("payBill").onclick = ()=> fakeOpenPay("Bill Pay");
    $("payTelda").onclick = ()=> fakeOpenPay("Telda");

    $("finishPaymentBtn").addEventListener("click", ()=>{
      const u = currentUser();
      if(!u){
        $("payErr").textContent = t.needLogin;
        $("payErr").style.display="block";
        return;
      }

      const amount = finalTotal();

      // award gems (balanced): 1 gem per 100 EGP, min 1
      const earned = Math.max(1, Math.floor(amount / 100));
      addGems(u.email, earned);
      renderGems();

      // inbox message
      pushInbox((LANG==="ar")
        ? `‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿπŸÖŸÑŸäÿ© ÿ¥ÿ±ÿßÿ° ÿ®ŸÇŸäŸÖÿ© ${amount} ÿ¨ŸÜŸäŸá. ÿ≠ÿµŸÑÿ™ ÿπŸÑŸâ üíé ${earned} ÿ¨ŸàÿßŸáÿ±.`
        : `‚úÖ Purchase recorded: ${amount} EGP. You earned üíé ${earned} gems.`,
        u.email
      );

      // clear cart only if checkout from cart
      if(checkoutMode.type==="cart"){
        cart = {};
        setCart();
      }

      // close checkout + cart
      hideModal("checkoutModal");
      hideModal("cartModal");
      closeOverlay();
      renderCart();
      renderInboxCount();
      toast((LANG==="ar")?"ÿ™ŸÖ!":"Done!", "ok");
    });

    $("checkoutClose").addEventListener("click", ()=>{ hideModal("checkoutModal"); closeOverlay(); });

    /* ===================== reviews ===================== */
    function reviewsAll(){ return load(KEY.reviews, []); } // {text, ts, name}
    function renderReviews(){
      const list = $("reviewsList");
      list.innerHTML = "";
      const rev = reviewsAll();
      if(rev.length===0){
        const n = document.createElement("div");
        n.className="note";
        n.textContent = (LANG==="ar")?"ŸÖŸÅŸäÿ¥ ŸÖÿ±ÿßÿ¨ÿπÿßÿ™ ŸÑÿ≥Ÿá.":"No reviews yet.";
        list.appendChild(n);
        return;
      }
      rev.slice(0,30).forEach(r=>{
        const div = document.createElement("div");
        div.className="note";
        const dt = new Date(r.ts).toLocaleString();
        div.textContent = `${r.name}: ${r.text} ‚Äî ${dt}`;
        list.appendChild(div);
      });
    }
    $("addReviewBtn").addEventListener("click", ()=>{
      const u = currentUser();
      if(!u){ toast(t.needLogin, "err"); openAuth(); return; }
      const txt = ($("reviewText").value||"").trim();
      if(!txt) return;
      const rev = reviewsAll();
      rev.unshift({text:txt, ts:Date.now(), name: u.profile.display || (u.profile.first+" "+u.profile.last)});
      save(KEY.reviews, rev);
      $("reviewText").value="";
      renderReviews();
      toast((LANG==="ar")?"ÿßÿ™ŸÜÿ¥ÿ±":"Posted", "ok");
    });

    /* ===================== inbox modal ===================== */
    function renderInbox(){
      const u = currentUser();
      const box = $("inboxList");
      box.innerHTML = "";
      if(!u){
        const n = document.createElement("div");
        n.className="note err";
        n.textContent = t.needLogin;
        box.appendChild(n);
        return;
      }
      const msgs = userInbox();
      if(msgs.length===0){
        const n = document.createElement("div");
        n.className="note";
        n.textContent = t.inboxEmpty;
        box.appendChild(n);
        return;
      }
      msgs.forEach(m=>{
        const div = document.createElement("div");
        div.className="note";
        const dt = new Date(m.ts).toLocaleString();
        div.textContent = `${m.text}\n${dt}`;
        box.appendChild(div);
        m.read = true;
      });
      // mark read back to storage
      const all = inboxAll();
      all.forEach(x=>{
        if(x.toEmail===u.email) x.read = true;
      });
      save(KEY.inbox, all);
      renderInboxCount();
    }

    /* ===================== gems convert to REAL coupon ===================== */
    // Gems cost per tier (balanced)
    const GEMS_COST = {10:5,20:8,30:12,40:16,50:20,60:26,70:32,80:40,90:55,100:80};

    function allocateCoupon(pct){
      const arr = COUPON_TIERS[pct] || [];
      for(const code of arr){
        if(!isCouponUsed(code)) return code; // available
      }
      return null;
    }

    $("convertBtn").addEventListener("click", ()=>{
      const u = currentUser();
      if(!u){ toast(t.needLogin, "err"); openAuth(); return; }

      $("convertOk").style.display="none";
      $("convertErr").style.display="none";

      const pct = Number($("convertTier").value);
      const cost = GEMS_COST[pct] || 999999;
      const have = getGems(u.email);

      if(have < cost){
        $("convertErr").textContent = (LANG==="ar")
          ? `‚ùå ÿ¨ŸàÿßŸáÿ±ŸÉ ŸÖÿ¥ ŸÉŸÅÿßŸäÿ©. ÿßŸÑŸÖÿ∑ŸÑŸàÿ®: ${cost}`
          : `‚ùå Not enough gems. Required: ${cost}`;
        $("convertErr").style.display="block";
        return;
      }

      const code = allocateCoupon(pct);
      if(!code){
        $("convertErr").textContent = t.noCodes;
        $("convertErr").style.display="block";
        return;
      }

      // mark as used? NO ‚Äî we give it to user, and it should be usable ONCE when applied at checkout.
      // To prevent "re-issuing" the same code to another convert, we reserve it by marking it used on issue,
      // BUT that would block usage. So we reserve by storing it to user's wallet.
      // We'll store issued coupons under inbox as message and store a wallet list.
      const walletKey = "mgs_wallet_v1";
      const walletAll = load(walletKey, {});
      const list = walletAll[u.email] || [];
      // prevent duplicates in same wallet
      if(!list.includes(code)) list.push(code);
      walletAll[u.email] = list;
      save(walletKey, walletAll);

      // deduct gems
      setGems(u.email, have - cost);
      renderGems();

      // message
      pushInbox((LANG==="ar")
        ? `üíé ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ! ŸÉŸàÿ®ŸàŸÜ ÿÆÿµŸÖ ${pct}%: ${code} (ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ©)`
        : `üíé Converted! ${pct}% coupon: ${code} (one-time)`,
        u.email
      );

      $("convertOk").textContent = t.converted(code);
      $("convertOk").style.display="block";
      toast("‚úÖ", "ok");
    });

    /* ===================== auth ===================== */
    function openAuth(){
      showModal("authModal");
      showAuthHome();
    }
    function showAuthHome(){
      $("authHome").style.display="flex";
      $("loginBox").style.display="none";
      $("regBox").style.display="none";
      $("profileBox").style.display="none";
      $("authErr").style.display="none";
    }

    function showLogin(){
      $("authHome").style.display="none";
      $("loginBox").style.display="flex";
      $("regBox").style.display="none";
      $("profileBox").style.display="none";
      $("loginErr").style.display="none";
    }

    function showRegister(){
      $("authHome").style.display="none";
      $("loginBox").style.display="none";
      $("regBox").style.display="flex";
      $("profileBox").style.display="none";
      // step1 visible
      $("regStep1").style.display="flex";
      $("regStep2").style.display="none";
      $("regStep3").style.display="none";
      $("regStep4").style.display="none";
      $("regErr1").style.display="none";
      $("regErr2").style.display="none";
      $("regErr3").style.display="none";
      $("regErr4").style.display="none";
    }

    function showProfile(){
      const u = currentUser();
      if(!u) return;
      $("authHome").style.display="none";
      $("loginBox").style.display="none";
      $("regBox").style.display="none";
      $("profileBox").style.display="flex";
      $("profileErr").style.display="none";
      $("profileOk").style.display="none";

      $("profileHello").textContent = (LANG==="ar")
        ? `ÿ£ŸáŸÑÿßŸã ${u.profile.display || (u.profile.first+" "+u.profile.last)}`
        : `Hello ${u.profile.display || (u.profile.first+" "+u.profile.last)}`;

      $("profileName").value = u.profile.display || (u.profile.first+" "+u.profile.last);
      $("profileAge").value = u.profile.age || "";
      $("profileGender").value = u.profile.gender || "";
      $("profileNewPass").value = "";
      $("profileAvatar").value = "";
    }

    $("authBtn").addEventListener("click", ()=>{
      const u = currentUser();
      if(u){
        showDrawer(menuDrawer); // open menu for logged user quickly
      } else {
        openAuth();
      }
    });
    $("authClose").addEventListener("click", ()=>{ hideModal("authModal"); closeOverlay(); });

    $("openLoginBtn").addEventListener("click", showLogin);
    $("openRegisterBtn").addEventListener("click", showRegister);
    $("backAuth1").addEventListener("click", showAuthHome);
    $("backAuth2").addEventListener("click", showAuthHome);

    // eye toggles
    document.querySelectorAll(".pwEye").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-eye");
        const inp = $(id);
        inp.type = (inp.type === "password") ? "text" : "password";
      });
    });

    $("doLoginBtn").addEventListener("click", ()=>{
      const email = ($("loginEmail").value||"").trim();
      const pass = ($("loginPass").value||"");
      const u = getUser(email);
      if(!u || u.passHash !== hash(pass)){
        $("loginErr").textContent = (LANG==="ar") ? "ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿØÿÆŸàŸÑ ÿ∫ŸÑÿ∑." : "Invalid login.";
        $("loginErr").style.display="block";
        return;
      }
      setSession(u.email);
      hideModal("authModal");
      closeOverlay();
      syncAuthUI();
      pushInbox((LANG==="ar")?"‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ.":"‚úÖ Logged in.", u.email);
    });

    // Register steps
    $("regNext1").addEventListener("click", ()=>{
      const first = ($("regFirst").value||"").trim();
      const last = ($("regLast").value||"").trim();
      if(!first || !last){
        $("regErr1").textContent = (LANG==="ar")?"ÿßŸÉÿ™ÿ® ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ£ŸàŸÑ ŸàÿßŸÑÿ´ÿßŸÜŸä.":"Enter first & last name.";
        $("regErr1").style.display="block";
        return;
      }
      $("regErr1").style.display="none";
      $("regStep1").style.display="none";
      $("regStep2").style.display="flex";
    });
    $("regBack2").addEventListener("click", ()=>{
      $("regStep2").style.display="none";
      $("regStep1").style.display="flex";
    });

    $("regNext2").addEventListener("click", ()=>{
      const email = ($("regEmail").value||"").trim().toLowerCase();
      const pass = ($("regPass").value||"");
      if(!email || !email.includes("@") || pass.length < 6){
        $("regErr2").textContent = (LANG==="ar")?"ÿßŸÉÿ™ÿ® ÿ®ÿ±ŸäÿØ ÿµÿ≠Ÿäÿ≠ Ÿàÿ®ÿßÿ≥Ÿàÿ±ÿØ 6 ÿ≠ÿ±ŸàŸÅ+":"Enter valid email and 6+ password.";
        $("regErr2").style.display="block";
        return;
      }
      if(getUser(email)){
        $("regErr2").textContent = (LANG==="ar")?"ÿßŸÑÿ®ÿ±ŸäÿØ ÿØŸá ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÇÿ®ŸÑ ŸÉÿØŸá.":"Email already exists.";
        $("regErr2").style.display="block";
        return;
      }
      $("regErr2").style.display="none";
      $("regStep2").style.display="none";
      $("regStep3").style.display="flex";
    });
    $("regBack3").addEventListener("click", ()=>{
      $("regStep3").style.display="none";
      $("regStep2").style.display="flex";
    });

    $("regNext3").addEventListener("click", ()=>{
      const gender = $("regGender").value;
      const age = Number($("regAge").value||0);
      if(!gender || age < 8 || age > 80){
        $("regErr3").textContent = (LANG==="ar")?"ÿßÿÆÿ™ÿßÿ± ÿßŸÑŸÜŸàÿπ ŸàÿßŸÉÿ™ÿ® ÿ≥ŸÜ ÿµÿ≠Ÿäÿ≠.":"Choose gender and valid age.";
        $("regErr3").style.display="block";
        return;
      }
      $("regErr3").style.display="none";
      $("regStep3").style.display="none";
      $("regStep4").style.display="flex";
    });
    $("regBack4").addEventListener("click", ()=>{
      $("regStep4").style.display="none";
      $("regStep3").style.display="flex";
    });

    function fileToDataURL(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(String(r.result));
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    $("regFinish").addEventListener("click", async ()=>{
      try{
        const first = ($("regFirst").value||"").trim();
        const last = ($("regLast").value||"").trim();
        const email = ($("regEmail").value||"").trim().toLowerCase();
        const pass = ($("regPass").value||"");
        const gender = $("regGender").value;
        const age = Number($("regAge").value||0);

        if(!first || !last || !email || !pass || !gender || age<8) throw new Error("bad");

        let avatarData = null;
        const f = $("regAvatar").files[0];
        if(f){
          avatarData = await fileToDataURL(f);
        }

        const display = `${first} ${last}`;
        const newUser = {
          email,
          passHash: hash(pass),
          profile: {first,last,display,gender,age,avatarData}
        };
        users.push(newUser);
        save(KEY.users, users);
        setSession(email);

        // init gems
        if(getGems(email) === 0) setGems(email, 0);

        hideModal("authModal");
        closeOverlay();
        syncAuthUI();
        pushInbox((LANG==="ar")?"üéâ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ®ŸÜÿ¨ÿßÿ≠.":"üéâ Account created.", email);

      } catch {
        $("regErr4").textContent = t.saveErr;
        $("regErr4").style.display="block";
      }
    });

    // profile save
    $("saveProfileBtn").addEventListener("click", async ()=>{
      const u = currentUser();
      if(!u) return;
      $("profileErr").style.display="none";
      $("profileOk").style.display="none";

      const display = ($("profileName").value||"").trim();
      const age = Number($("profileAge").value||0);
      const gender = $("profileGender").value;

      if(!display || !gender || age<8 || age>80){
        $("profileErr").textContent = t.saveErr;
        $("profileErr").style.display="block";
        return;
      }

      // avatar
      const f = $("profileAvatar").files[0];
      if(f){
        u.profile.avatarData = await fileToDataURL(f);
      }

      // password change (optional)
      const np = ($("profileNewPass").value||"");
      if(np && np.length < 6){
        $("profileErr").textContent = (LANG==="ar")?"ÿßŸÑÿ®ÿßÿ≥Ÿàÿ±ÿØ ŸÑÿßÿ≤ŸÖ 6 ÿ≠ÿ±ŸàŸÅ+":"Password must be 6+";
        $("profileErr").style.display="block";
        return;
      }
      if(np){
        u.passHash = hash(np);
      }

      u.profile.display = display;
      u.profile.age = age;
      u.profile.gender = gender;

      save(KEY.users, users);
      syncAuthUI();
      $("profileOk").textContent = t.saveOk;
      $("profileOk").style.display="block";
    });

    $("closeProfileBtn").addEventListener("click", ()=>{
      hideModal("authModal");
      closeOverlay();
    });

    /* ===================== menu actions ===================== */
    $("menuBtn").addEventListener("click", ()=> showDrawer(menuDrawer));
    $("menuClose").addEventListener("click", ()=> hideDrawer(menuDrawer));

    $("filterBtn").addEventListener("click", ()=> showDrawer(filterDrawer));
    $("filterClose").addEventListener("click", ()=> hideDrawer(filterDrawer));

    document.querySelectorAll(".linkRow[data-scroll]").forEach(row=>{
      row.addEventListener("click", ()=>{
        const id = row.getAttribute("data-scroll");
        hideDrawer(menuDrawer);
        const el = $(id);
        if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
      });
    });

    $("openContactRow").addEventListener("click", ()=>{
      hideDrawer(menuDrawer);
      showModal("contactModal");
    });
    $("contactClose").addEventListener("click", ()=>{ hideModal("contactModal"); closeOverlay(); });

    $("openReviewsRow").addEventListener("click", ()=>{
      hideDrawer(menuDrawer);
      renderReviews();
      showModal("reviewsModal");
    });
    $("reviewsClose").addEventListener("click", ()=>{ hideModal("reviewsModal"); closeOverlay(); });

    $("openInboxRow").addEventListener("click", ()=>{
      hideDrawer(menuDrawer);
      renderInbox();
      showModal("inboxModal");
    });
    $("inboxClose").addEventListener("click", ()=>{ hideModal("inboxModal"); closeOverlay(); });

    $("openBonusRow").addEventListener("click", ()=>{
      hideDrawer(menuDrawer);
      const u = currentUser();
      if(!u){ toast(t.needLogin, "err"); openAuth(); return; }
      renderGems();
      $("convertOk").style.display="none";
      $("convertErr").style.display="none";
      showModal("bonusModal");
    });
    $("bonusClose").addEventListener("click", ()=>{ hideModal("bonusModal"); closeOverlay(); });

    $("inboxBtn").addEventListener("click", ()=>{
      const u = currentUser();
      if(!u){ toast(t.needLogin, "err"); openAuth(); return; }
      renderInbox();
      showModal("inboxModal");
    });
    $("gemsBtn").addEventListener("click", ()=>{
      const u = currentUser();
      if(!u){ toast(t.needLogin, "err"); openAuth(); return; }
      renderGems();
      $("convertOk").style.display="none";
      $("convertErr").style.display="none";
      showModal("bonusModal");
    });

    // profile in menu
    $("editProfileBtn").addEventListener("click", ()=>{
      hideDrawer(menuDrawer);
      showModal("authModal");
      showProfile();
    });
    $("logoutBtn").addEventListener("click", ()=>{
      const u = currentUser();
      if(u) pushInbox((LANG==="ar")?"üëã ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨.":"üëã Logged out.", u.email);
      clearSession();
      syncAuthUI();
      hideDrawer(menuDrawer);
    });

    /* ===================== toast ===================== */
    let toastTimer=null;
    function toast(msg, type="ok"){
      let el = document.getElementById("toastBox");
      if(!el){
        el = document.createElement("div");
        el.id = "toastBox";
        el.style.position="fixed";
        el.style.bottom="16px";
        el.style.left="16px";
        el.style.right="16px";
        el.style.zIndex="120";
        el.style.display="flex";
        el.style.justifyContent="center";
        el.style.pointerEvents="none";
        document.body.appendChild(el);
      }
      el.innerHTML = "";
      const b = document.createElement("div");
      b.style.pointerEvents="auto";
      b.style.maxWidth="760px";
      b.style.width="100%";
      b.style.borderRadius="14px";
      b.style.border="1px solid rgba(255,255,255,.12)";
      b.style.padding="12px 12px";
      b.style.fontWeight="900";
      b.style.boxShadow="0 10px 30px rgba(0,0,0,.35)";
      b.style.background = type==="err" ? "rgba(225,29,72,.22)" : "rgba(34,197,94,.18)";
      b.style.backdropFilter="blur(10px)";
      b.textContent = msg;
      el.appendChild(b);
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>{ el.innerHTML=""; }, 1800);
    }

    /* ===================== sync auth UI ===================== */
    function syncAuthUI(){
      const u = currentUser();
      if(!u){
        $("authText").textContent = t.register;
        $("authBtn").style.display="inline-flex";
        $("userChip").style.display="none";
        $("drawerUserBox").style.display="none";
        $("inboxCount").textContent = "0";
        $("gemsCount").textContent = "0";
        return;
      }
      $("authBtn").style.display="none";
      $("userChip").style.display="inline-flex";
      $("userNameText").textContent = u.profile.display || (u.profile.first+" "+u.profile.last);
      $("drawerUserBox").style.display="block";
      $("drawerUserNote").textContent = (LANG==="ar")
        ? `üë§ ${u.profile.display || (u.profile.first+" "+u.profile.last)}`
        : `üë§ ${u.profile.display || (u.profile.first+" "+u.profile.last)}`;

      // avatar
      const av = $("avatarSmall");
      av.innerHTML="";
      if(u.profile.avatarData){
        const img = document.createElement("img");
        img.src = u.profile.avatarData;
        av.appendChild(img);
      } else {
        av.textContent = (u.profile.display || "U").slice(0,1).toUpperCase();
      }

      renderInboxCount();
      renderGems();
    }

    /* ===================== main render ===================== */
    function renderAll(){
      renderSection("top", "gridTop");
      renderSection("offers", "gridOffers");
      renderSection("games", "gridGames");
      renderSection("programs", "gridPrograms");
      renderSection("accounts", "gridAccounts");
      renderSection("recharge", "gridRecharge");
      setCart();
      syncAuthUI();
    }

    /* init */
    setCart();
    syncAuthUI();
    renderAll();

  </script>
</body>
</html>
