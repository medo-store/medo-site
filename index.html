
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Medo Gaming Store</title>

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1230;
      --panel:#0E183B;
      --card:#0C1736;
      --text:#F6F7FF;
      --muted:#B9C1D9;
      --border:rgba(255,255,255,.10);
      --accent:#E11D48;
      --accent2:#38BDF8;
      --good:#22C55E;

      --radius:14px;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Segoe UI", Tahoma, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 15% 8%, rgba(56,189,248,.16), transparent 60%),
        radial-gradient(900px 600px at 85% 0%, rgba(225,29,72,.14), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      min-height:100vh;
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:1200px;margin:0 auto;padding:10px 12px}

    /* Sticky header */
    .nav{
      position:sticky;top:0;z-index:60;
      background:rgba(7,10,18,.72);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .nav-inner{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.2px;white-space:nowrap}
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:0 0 0 4px rgba(56,189,248,.10);
    }

    .searchWrap{flex:1;min-width:220px;display:flex;align-items:center;gap:8px}
    .search{
      flex:1;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
    }

    .iconBtn{
      display:inline-flex;align-items:center;justify-content:center;
      gap:8px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      user-select:none;
    }
    .iconBtn:hover{filter:brightness(1.08)}
    .rightBox{margin-inline-start:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pillCount{
      min-width:22px;height:22px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;
      background:rgba(56,189,248,.16);
      border:1px solid rgba(56,189,248,.35);
      font-weight:900;font-size:12px;padding:0 6px;
    }

    .userChip{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 10px;border-radius:999px;
      border:1px solid rgba(56,189,248,.35);
      background:rgba(56,189,248,.10);
      cursor:pointer;white-space:nowrap;
      font-weight:900;font-size:13px;
    }
    .avatarSmall{
      width:22px;height:22px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.07);
      display:inline-flex;align-items:center;justify-content:center;
      overflow:hidden;
      font-size:11px;
    }
    .avatarSmall img{width:100%;height:100%;object-fit:cover}

    /* Sections */
    .sectionTitle{
      margin:18px 0 8px;
      font-size:15px;
      font-weight:900;
      display:flex;align-items:center;gap:10px;
    }
    .sectionHint{color:var(--muted);font-weight:800;font-size:12px}
    .spacer{height:18px}

    /* Grid */
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media (max-width:1050px){ .grid{grid-template-columns:repeat(3,1fr);} }
    @media (max-width:760px){ .grid{grid-template-columns:repeat(2,1fr);} }
    @media (max-width:460px){ .grid{grid-template-columns:1fr;} }

    .card{
      background:rgba(12,23,54,.72);
      border:1px solid var(--border);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      display:flex;flex-direction:column;
      min-height:230px;
    }
    .thumb{
      height:96px;
      background:
        radial-gradient(180px 120px at 25% 30%, rgba(56,189,248,.22), transparent 65%),
        radial-gradient(180px 120px at 75% 0%, rgba(225,29,72,.18), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;letter-spacing:.7px;font-size:12px;
      position:relative;
    }
    .content{padding:10px 10px 12px;display:flex;flex-direction:column;gap:8px;flex:1}
    .name{margin:0;font-size:13px;font-weight:900}
    .meta{margin:0;font-size:12px;color:var(--muted);line-height:1.4}
    .priceRow{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .price{margin:0;font-size:12px;font-weight:900}

    /* Actions */
    .actions{display:flex;gap:8px;margin-top:auto;flex-wrap:wrap}
    .btn{
      flex:1;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 10px;
      font-weight:900;font-size:12px;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      min-width:120px;
    }
    .btn:hover{filter:brightness(1.08)}
    .btnRed{background:linear-gradient(135deg, rgba(225,29,72,1), rgba(225,29,72,.82));border-color:transparent}

    /* Overlay / drawer / modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.58);display:none;z-index:80}
    .overlay.show{display:block}

    .drawer{
      position:fixed;top:0;bottom:0;
      width:min(360px, 92vw);
      background:rgba(14,24,59,.92);
      backdrop-filter: blur(10px);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      z-index:90;
      transition: transform .22s ease;
      display:flex;flex-direction:column;
      transform: translateX(120%);
    }
    /* ‚úÖ IMPORTANT FIX: this makes drawers actually appear */
    .drawer.show{ transform: translateX(0) !important; }

    .drawerHeader{
      padding:12px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .drawerTitle{font-weight:900}
    .drawerBody{padding:12px;overflow:auto}
    .drawerSection{margin:10px 0 16px}
    .drawerLabel{font-weight:900;margin:0 0 8px}
    .drawerList{display:flex;flex-direction:column;gap:8px}
    .linkRow{
      padding:10px 10px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      cursor:pointer;
    }
    .linkRow:hover{filter:brightness(1.08)}
    .mini{font-size:12px;color:var(--muted);font-weight:800}

    .note{
      padding:10px 10px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-weight:800;font-size:12px;line-height:1.5;
    }
    .note.err{background:rgba(225,29,72,.18);border-color:rgba(225,29,72,.45);color:#fff}
    .note.ok{background:rgba(34,197,94,.14);border-color:rgba(34,197,94,.35);color:#fff}

    .modal{position:fixed;inset:0;display:none;z-index:95;align-items:center;justify-content:center;padding:14px}
    .modal.show{display:flex}
    .modalBox{
      width:min(640px, 96vw);
      background:rgba(14,24,59,.94);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHeader{
      padding:12px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .modalTitle{font-weight:900}
    .modalBody{padding:12px}
    .stack{display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .row .tight{flex:0 0 auto}

    .input{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
    }
    .select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
      font-weight:900;
    }

    /* Cart */
    .cartItem{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .cartLeft{display:flex;gap:10px;flex:1}
    .cartThumb{
      width:54px;height:54px;border-radius:14px;
      border:1px solid var(--border);
      background:
        radial-gradient(40px 30px at 20% 20%, rgba(56,189,248,.25), transparent 65%),
        radial-gradient(40px 30px at 80% 0%, rgba(225,29,72,.18), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      overflow:hidden;
      flex:0 0 auto;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:11px;opacity:.9;
    }
    .cartName{font-weight:900;font-size:13px;margin:0 0 4px}
    .cartMeta{margin:0;color:var(--muted);font-size:12px;font-weight:800}
    .qtyRow{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .qtyBtn{
      width:34px;height:34px;border-radius:10px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
    }
    .qtyNum{min-width:34px;text-align:center;font-weight:900}
    .removeBtn{
      border:1px solid rgba(225,29,72,.35);
      background:rgba(225,29,72,.12);
      color:rgba(246,247,255,.95);
      font-weight:900;cursor:pointer;
      padding:8px 10px;border-radius:10px;
      white-space:nowrap;
    }
    .detailsBtn{
      border:1px solid rgba(56,189,248,.35);
      background:rgba(56,189,248,.10);
      color:rgba(246,247,255,.95);
      font-weight:900;cursor:pointer;
      padding:8px 10px;border-radius:10px;
      white-space:nowrap;
    }
    .totalBar{
      margin-top:10px;
      border:1px solid rgba(56,189,248,.35);
      background:rgba(56,189,248,.10);
      border-radius:14px;
      padding:10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      cursor:pointer;
      user-select:none;
    }

    /* Checkout steps */
    .stepPills{display:flex;gap:8px;flex-wrap:wrap}
    .pill{
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      font-weight:900;font-size:12px;color:rgba(246,247,255,.95);
    }
    .pill.active{border-color:rgba(56,189,248,.45);background:rgba(56,189,248,.12)}
    .payModalBox{width:min(520px, 94vw)}
    .payList{display:flex;flex-direction:column;gap:10px}
    .payBtn{
      width:100%;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:12px 12px;
      font-weight:900;
      cursor:pointer;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .payBtn:hover{filter:brightness(1.08)}
    .payLeft{display:flex;align-items:center;gap:10px}
    .payIcon{
      width:34px;height:34px;border-radius:12px;
      display:inline-flex;align-items:center;justify-content:center;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      font-weight:900;
      font-size:12px;
    }

    /* Details gallery */
    .detailsHero{
      height:180px;border-radius:16px;border:1px solid var(--border);
      background:
        radial-gradient(280px 160px at 25% 30%, rgba(56,189,248,.22), transparent 65%),
        radial-gradient(280px 160px at 75% 0%, rgba(225,29,72,.18), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      display:flex;align-items:center;justify-content:center;
      font-weight:900;letter-spacing:1px;
      text-align:center;padding:12px;
    }
    .gallery{display:flex;gap:10px;flex-wrap:wrap}
    .gThumb{
      width:78px;height:58px;border-radius:14px;border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      overflow:hidden;cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:11px;color:rgba(246,247,255,.85);
    }
    .gThumb:hover{filter:brightness(1.08)}

    /* Footer */
    .footer{
      margin-top:18px;border-top:1px solid var(--border);
      padding:14px 0 22px;
      color:var(--muted);
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }
    .social{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      font-weight:900;font-size:12px;
    }
    .social:hover{filter:brightness(1.08)}
    .mutedRight{margin-inline-start:auto;font-weight:900;font-size:12px;color:rgba(185,193,217,.9)}
  </style>
</head>

<body>
  <div class="nav">
    <div class="container nav-inner">
      <div class="brand">
        <span class="dot"></span>
        <span id="brandText">Medo Gaming Store</span>
      </div>

      <div class="searchWrap">
        <input id="search" class="search" />
        <!-- Filter icon -->
        <button class="iconBtn" id="filterBtn" title="Filter">
          <span style="display:inline-block;line-height:0">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M4 6h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M7 12h13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M10 18h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M4 3h10" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".75"/>
            </svg>
          </span>
        </button>
      </div>

      <div class="rightBox">
        <button class="iconBtn" id="inboxBtn" title="Inbox">
          üîî <span class="pillCount" id="inboxCount">0</span>
        </button>

        <button class="iconBtn" id="gemsBtn" title="Bonus">
          üíé <span class="pillCount" id="gemsCount">0</span>
        </button>

        <button class="iconBtn" id="cartBtn" title="Cart">
          üõí <span class="pillCount" id="cartCount">0</span>
        </button>

        <button class="iconBtn" id="authBtn" title="Account">
          üë§ <span id="authText">ÿ™ÿ≥ÿ¨ŸäŸÑ</span>
        </button>

        <div class="userChip" id="userChip" style="display:none" title="User">
          <span class="avatarSmall" id="avatarSmall">U</span>
          <span id="userNameText">User</span>
        </div>

        <button class="iconBtn" id="menuBtn" title="Menu">‚ò∞</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="sectionTitle" id="topTitle">üî• Top <span class="sectionHint" id="topHint"></span></div>
    <div id="gridTop" class="grid"></div>

    <div class="spacer"></div>

    <div class="sectionTitle" id="offersTitle">üéÅ Offers <span class="sectionHint" id="offersHint"></span></div>
    <div id="gridOffers" class="grid"></div>

    <div class="spacer"></div>

    <div class="sectionTitle" id="gamesTitle">üéÆ Games</div>
    <div id="gridGames" class="grid"></div>

    <div class="spacer"></div>

    <div class="sectionTitle" id="programsTitle">üíª Programs</div>
    <div id="gridPrograms" class="grid"></div>

    <div class="spacer"></div>

    <div class="sectionTitle" id="accountsTitle">üßæ Accounts</div>
    <div id="gridAccounts" class="grid"></div>

    <div class="footer" id="footer">
      <a class="social" href="https://wa.me/201006760663" target="_blank" rel="noreferrer">WhatsApp</a>
      <a class="social" href="https://www.instagram.com/medo__rami" target="_blank" rel="noreferrer">Instagram</a>
      <a class="social" href="https://www.facebook.com/share/1AScQqiSqq/" target="_blank" rel="noreferrer">Facebook</a>
      <a class="social" href="mailto:medorami77@gmail.com">Email</a>
      <span class="mutedRight">¬© <span id="year"></span> Medo Gaming</span>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <!-- MENU DRAWER -->
  <div class="drawer" id="menuDrawer" aria-hidden="true">
    <div class="drawerHeader">
      <div class="drawerTitle" id="menuTitle">Menu</div>
      <button class="iconBtn" id="menuClose">‚úï</button>
    </div>
    <div class="drawerBody">
      <div class="drawerSection" id="drawerUserBox" style="display:none">
        <div class="note ok" id="drawerUserNote"></div>
        <div class="row">
          <button class="btn" id="editProfileBtn">Edit profile</button>
          <button class="btn" id="logoutBtn">Logout</button>
        </div>
      </div>

      <div class="drawerSection">
        <p class="drawerLabel" id="drawerQuick">Quick</p>
        <div class="drawerList">
          <div class="linkRow" data-scroll="gridTop"><span id="goTopText">Top</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" data-scroll="gridOffers"><span id="goOffersText">Offers</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" data-scroll="gridGames"><span id="goGamesText">Games</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" data-scroll="gridPrograms"><span id="goProgramsText">Programs</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" data-scroll="gridAccounts"><span id="goAccountsText">Accounts</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" id="openContactRow"><span id="contactText">Contact</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" id="openReviewsRow"><span id="reviewsText">Reviews</span><span class="mini">‚Üí</span></div>
          <div class="linkRow" id="openGiftRow"><span id="giftText">Send Gift</span><span class="mini">‚Üí</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- FILTER DRAWER -->
  <div class="drawer" id="filterDrawer" aria-hidden="true">
    <div class="drawerHeader">
      <div class="drawerTitle" id="filterTitle">Filter</div>
      <button class="iconBtn" id="filterClose">‚úï</button>
    </div>
    <div class="drawerBody">
      <div class="drawerSection">
        <p class="drawerLabel" id="filterCategoryLabel">Category</p>
        <select class="select" id="filterCategory">
          <option value="all">All</option>
          <option value="games">Games</option>
          <option value="programs">Programs</option>
          <option value="accounts">Accounts</option>
        </select>
      </div>

      <div class="drawerSection">
        <p class="drawerLabel" id="filterSortLabel">Sort</p>
        <select class="select" id="filterSort">
          <option value="new">Newest</option>
          <option value="old">Oldest</option>
          <option value="low">Low ‚Üí High</option>
          <option value="high">High ‚Üí Low</option>
        </select>
      </div>

      <div class="drawerSection">
        <p class="drawerLabel" id="filterPriceLabel">Price</p>
        <div class="row">
          <select class="select" id="priceMode">
            <option value="off">Off</option>
            <option value="eq">Equal</option>
            <option value="lte">‚â§</option>
            <option value="gte">‚â•</option>
          </select>
          <input class="input" id="priceValue" type="number" min="0" placeholder="ŸÖÿ´ŸÑÿßŸã 300" />
        </div>
      </div>

      <button class="btn btnRed" id="applyFilterBtn">Apply</button>
      <div class="note" style="margin-top:10px" id="filterNote"></div>
    </div>
  </div>

  <!-- AUTH MODAL -->
  <div class="modal" id="authModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="authModalTitle">Account</div>
        <button class="iconBtn" id="authClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="note" id="authHelp"></div>
          <div class="row">
            <button class="btn btnRed" id="goLoginBtn">Login</button>
            <button class="btn" id="goSignupBtn">Create account</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div class="modal" id="loginModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="loginTitle">Login</div>
        <button class="iconBtn" id="loginClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <input class="input" id="loginEmail" type="email" placeholder="Email" />
          <input class="input" id="loginPass" type="password" placeholder="Password" />
          <button class="btn btnRed" id="loginSubmit">Continue</button>
          <div class="note err" id="loginErr" style="display:none"></div>
          <div class="note" id="loginHint"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- SIGNUP MODAL -->
  <div class="modal" id="signupModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="signupTitle">Create account</div>
        <button class="iconBtn" id="signupClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <input class="input" id="signupName" placeholder="Full name" />
          <div class="row">
            <input class="input" id="signupAge" type="number" min="1" max="120" placeholder="Age" />
            <input class="input" id="signupEmail" type="email" placeholder="Email" />
          </div>
          <input class="input" id="signupPass" type="password" placeholder="Password" />
          <div class="note" id="avatarHint"></div>
          <input class="input" id="signupAvatar" type="file" accept="image/*" />
          <button class="btn btnRed" id="signupSubmit">Create</button>
          <div class="note err" id="signupErr" style="display:none"></div>
          <div class="note" id="signupHint"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- PROFILE MODAL -->
  <div class="modal" id="profileModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="profileTitle">Profile</div>
        <button class="iconBtn" id="profileClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="note" id="profileNote"></div>
          <input class="input" id="profileName" placeholder="Name" />
          <input class="input" id="profileNewPass" type="password" placeholder="New password (optional)" />
          <div class="note" id="profileAvatarNote"></div>
          <input class="input" id="profileAvatar" type="file" accept="image/*" />
          <button class="btn btnRed" id="profileSave">Save</button>
          <div class="note ok" id="profileOk" style="display:none"></div>
          <div class="note err" id="profileErr" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- INBOX MODAL -->
  <div class="modal" id="inboxModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="inboxTitle">Inbox</div>
        <button class="iconBtn" id="inboxClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack" id="inboxList"></div>
      </div>
    </div>
  </div>

  <!-- BONUS MODAL -->
  <div class="modal" id="gemsModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="gemsTitle">Bonus</div>
        <button class="iconBtn" id="gemsClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="note" id="gemsInfo"></div>
          <div class="row">
            <input class="input" id="redeemBonusInput" type="number" min="1" placeholder="Bonus amount" />
            <button class="btn btnRed tight" id="redeemBonusBtn" style="flex:0 0 auto">Redeem</button>
          </div>
          <div class="note" id="redeemHelp"></div>
          <div class="note" id="couponListTitle"></div>
          <div class="stack" id="couponList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTACT MODAL -->
  <div class="modal" id="contactModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="contactTitle">Contact</div>
        <button class="iconBtn" id="contactClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <a class="payBtn" href="https://wa.me/201006760663" target="_blank" rel="noreferrer">
            <span class="payLeft"><span class="payIcon">WA</span><span>WhatsApp</span></span><span class="mini">‚Üí</span>
          </a>
          <a class="payBtn" href="https://www.instagram.com/medo__rami" target="_blank" rel="noreferrer">
            <span class="payLeft"><span class="payIcon">IG</span><span>Instagram</span></span><span class="mini">‚Üí</span>
          </a>
          <a class="payBtn" href="https://www.facebook.com/share/1AScQqiSqq/" target="_blank" rel="noreferrer">
            <span class="payLeft"><span class="payIcon">FB</span><span>Facebook</span></span><span class="mini">‚Üí</span>
          </a>
          <a class="payBtn" href="mailto:medorami77@gmail.com">
            <span class="payLeft"><span class="payIcon">@</span><span>Email</span></span><span class="mini">‚Üí</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- REVIEWS MODAL -->
  <div class="modal" id="reviewsModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="reviewsTitle">Reviews</div>
        <button class="iconBtn" id="reviewsClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="note" id="reviewsInfo"></div>
          <div class="row">
            <input class="input" id="reviewText" placeholder="Write your review..." />
            <button class="btn btnRed tight" id="addReviewBtn" style="flex:0 0 auto">Post</button>
          </div>
          <div class="stack" id="reviewsList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- GIFT MODAL -->
  <div class="modal" id="giftModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="giftTitle">Send Gift</div>
        <button class="iconBtn" id="giftClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="note" id="giftInfo"></div>
          <input class="input" id="giftToEmail" type="email" placeholder="Receiver email" />

          <div class="row">
            <select class="select" id="giftType">
              <option value="bonus">Bonus</option>
              <option value="product">Product (message)</option>
            </select>
            <input class="input" id="giftAmount" type="number" min="1" placeholder="Amount (bonus) or Product ID" />
          </div>

          <button class="btn btnRed" id="sendGiftBtn">Send</button>
          <div class="note err" id="giftErr" style="display:none"></div>
          <div class="note ok" id="giftOk" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- CART MODAL -->
  <div class="modal" id="cartModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="cartTitle">Cart</div>
        <button class="iconBtn" id="cartClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div id="cartItems"></div>
          <div class="totalBar" id="totalBar">
            <strong id="totalLabel">Total</strong>
            <span id="totalValue">EGP 0</span>
          </div>
          <button class="btn btnRed" id="cartCheckoutBtn">Checkout</button>
          <div class="note" id="cartNote"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- CHECKOUT -->
  <div class="modal" id="checkoutModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="checkoutTitle">Checkout</div>
        <button class="iconBtn" id="checkoutClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="stepPills">
            <span class="pill active" id="pill1">1) Summary</span>
            <span class="pill" id="pill2">2) Payment</span>
          </div>

          <div id="checkoutItems"></div>
          <div class="note" id="checkoutTotals"></div>

          <div class="note" id="couponNote"></div>
          <div class="row">
            <input class="input" id="couponInput" placeholder="Coupon code" />
            <button class="btn tight" id="applyCouponBtn" style="flex:0 0 auto">Apply</button>
          </div>

          <div class="note" id="bonusCouponNote"></div>
          <select class="select" id="myCouponsSelect"></select>

          <button class="btn btnRed" id="confirmCheckoutBtn">Confirm</button>
          <button class="btn" id="backToCartBtn">Back</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PAYMENT -->
  <div class="modal" id="paymentModal" aria-hidden="true">
    <div class="modalBox payModalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="paymentTitle">Payment</div>
        <button class="iconBtn" id="paymentClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="note" id="paymentInfo"></div>
          <div class="payList" id="payList"></div>
          <div class="note" id="payHelp"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- DETAILS -->
  <div class="modal" id="detailsModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <div class="modalTitle" id="detailsTitle">Details</div>
        <button class="iconBtn" id="detailsClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="detailsHero" id="detailsHero">PRODUCT</div>
          <div class="row">
            <button class="btn" id="detailsAddCartBtn">üõí Add to cart</button>
            <button class="btn btnRed" id="detailsBuyBtn">‚ö° Buy</button>
          </div>
          <div class="note" id="detailsDesc"></div>
          <div class="note" id="detailsGalleryTitle"></div>
          <div class="gallery" id="detailsGallery"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Language auto
========================= */
const isArabic = (() => (navigator.language || "").toLowerCase().startsWith("ar"))();
document.documentElement.lang = isArabic ? "ar" : "en";
document.documentElement.dir  = isArabic ? "rtl" : "ltr";

const T = {
  ar: {
    search:"üîç ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÑÿπÿ®ÿ© / ÿ®ÿ±ŸÜÿßŸÖÿ¨ / ÿ£ŸÉŸàŸÜÿ™",
    top:"ÿ™Ÿàÿ®", offers:"ÿ£ŸàŸÅÿ±ÿ≤", games:"ÿßŸÑÿ£ŸÑÿπÿßÿ®", programs:"ÿßŸÑÿ®ÿ±ÿßŸÖÿ¨", accounts:"ÿßŸÑÿ£ŸÉŸàŸÜÿ™ÿßÿ™",
    topHint:"ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ∑ŸÑÿ®Ÿãÿß", offersHint:"ÿπÿ±Ÿàÿ∂",
    menu:"ÿßŸÑŸÇÿßÿ¶ŸÖÿ©", filter:"ÿßŸÑŸÅŸÑÿ™ÿ±ÿ©", quick:"ÿßÿÆÿ™ÿµÿßÿ±ÿßÿ™",
    contact:"ÿßŸÑÿ™ŸàÿßÿµŸÑ", reviews:"ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿßÿ™", gift:"ÿ•ÿ±ÿ≥ÿßŸÑ ŸáÿØŸäÿ©",
    cart:"ÿßŸÑÿ≥ŸÑÿ©", total:"ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä", checkout:"ÿ¥ÿ±ÿßÿ°", back:"ÿ±ÿ¨Ÿàÿπ",
    details:"ÿ™ŸÅÿßÿµŸäŸÑ",
    auth:"ÿ™ÿ≥ÿ¨ŸäŸÑ",
    account:"ÿßŸÑÿ≠ÿ≥ÿßÿ®",
    login:"ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ", signup:"ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®",
    needLogin:"ŸÑÿßÿ≤ŸÖ ÿ™ÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ ÿßŸÑÿ£ŸàŸÑ ÿπŸÑÿ¥ÿßŸÜ ÿ™ÿ¥ÿ™ÿ±Ÿä.",
    cartHint:"ÿ™ŸÇÿØÿ± ÿ™ÿ∂ŸäŸÅ ŸÑŸÑÿ≥ŸÑÿ© ŸÖŸÜ ÿ£Ÿä ŸÖŸÜÿ™ÿ¨. ÿßŸÑÿ¥ÿ±ÿßÿ° Ÿäÿ∑ŸÑÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ.",
    emptyCart:"ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ∂Ÿäÿ©.",
    invalid:"ÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©.",
    exists:"‚ùå ÿßŸÑÿ•ŸäŸÖŸäŸÑ ÿØŸá ŸÖÿ≥ÿ¨ŸÑ ŸÇÿ®ŸÑ ŸÉÿØŸá. ÿßÿØÿÆŸÑ Login.",
    notFound:"‚ùå ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿØŸá ŸÖÿ¥ ŸÖŸàÿ¨ŸàÿØ. ÿßÿπŸÖŸÑ ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ.",
    profile:"ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®",
    save:"ÿ≠ŸÅÿ∏",
    logout:"ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨",
    bonus:"ÿßŸÑÿ®ŸàŸÜÿµ",
    redeem:"ÿ™ÿ®ÿØŸäŸÑ",
    redeemHelp:"ÿßŸÉÿ™ÿ® ÿπÿØÿØ ÿßŸÑÿ®ŸàŸÜÿµ ÿßŸÑŸÑŸä Ÿáÿ™ÿ®ÿØŸëŸÑŸá. ŸÑŸà ÿ£ŸÉÿ®ÿ± ŸÖŸÜ ÿßŸÑŸÑŸä ŸÖÿπÿßŸÉ ŸáŸäÿ±ŸÅÿ∂.",
    yourCoupons:"ŸÉÿ±Ÿàÿ™ ÿßŸÑÿÆÿµŸÖ ÿπŸÜÿØŸÉ",
    couponHint:"ŸÉŸàÿØ ÿÆÿµŸÖ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)",
    apply:"ÿ™ÿ∑ÿ®ŸäŸÇ",
    couponApplied:"ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿÆÿµŸÖ",
    couponInvalid:"ŸÉŸàÿØ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠",
    summary:"1) ŸÖŸÑÿÆÿµ", payment:"2) ÿßŸÑÿØŸÅÿπ",
    confirm:"ÿ™ÿ£ŸÉŸäÿØ",
    payTitle:"ÿ∑ÿ±ŸÇ ÿßŸÑÿØŸÅÿπ",
    payInfo:(total)=>`ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÜŸáÿßÿ¶Ÿä: ${money(total)} ‚Äî ÿßÿÆÿ™ÿßÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ:`,
    payHelp:"ÿßŸÑÿØŸÅÿπ ÿÆÿßÿ±ÿ¨ ÿßŸÑŸÖŸàŸÇÿπ. ÿ®ÿπÿØ ÿßŸÑÿØŸÅÿπ ÿßÿ®ÿπÿ™ ÿ•ÿ´ÿ®ÿßÿ™ ÿπŸÑŸâ Ÿàÿßÿ™ÿ≥ÿßÿ®.",
    post:"ŸÜÿ¥ÿ±",
    writeReview:"ÿßŸÉÿ™ÿ® ÿ±ÿ£ŸäŸÉ ÿπŸÜ ÿßŸÑŸÖŸàŸÇÿπ...",
    reviewsInfo:"ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿßÿ™ ŸáŸÜÿß ÿ®ÿ™ÿ∏Ÿáÿ± ÿπŸÑŸâ ŸÜŸÅÿ≥ ÿßŸÑÿ¨Ÿáÿßÿ≤ (ÿ™ÿ¨ÿ±ÿ®ÿ©).",
    inbox:"ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ",
    inboxEmpty:"ŸÖŸÅŸäÿ¥ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ≠ÿßŸÑŸäÿßŸã.",
    giftInfo:"ÿßŸÉÿ™ÿ® ÿ®ÿ±ŸäÿØ ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖ. ŸÑŸà ÿßŸÑÿ®ÿ±ŸäÿØ ŸÖÿ¥ ŸÖÿ≥ÿ¨ŸÑ ÿπŸÜÿØŸÜÿß ŸáŸäÿ±ŸÅÿ∂.",
    send:"ÿ•ÿ±ÿ≥ÿßŸÑ",
    sent:"ÿ™ŸÖ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ‚úÖ",
    bought:(n)=>`ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ∑ŸÑÿ®ŸÉ. ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ${n} ÿ®ŸàŸÜÿµ.`,
    none:"ÿ®ÿØŸàŸÜ",
    selectCoupon:"ÿßÿÆÿ™ÿßÿ± ŸÉÿßÿ±ÿ™ ÿÆÿµŸÖ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)",
    addToCart:"ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ≥ŸÑÿ©",
    buy:"ÿ¥ÿ±ÿßÿ°",
    editProfile:"ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®"
  },
  en: {
    search:"üîç Search games / programs / accounts",
    top:"Top", offers:"Offers", games:"Games", programs:"Programs", accounts:"Accounts",
    topHint:"Most ordered", offersHint:"Deals",
    menu:"Menu", filter:"Filter", quick:"Quick",
    contact:"Contact", reviews:"Reviews", gift:"Send Gift",
    cart:"Cart", total:"Total", checkout:"Checkout", back:"Back",
    details:"Details",
    auth:"Account",
    account:"Account",
    login:"Login", signup:"Create account",
    needLogin:"Please login first to buy.",
    cartHint:"Add items to cart. Checkout requires login.",
    emptyCart:"Your cart is empty.",
    invalid:"Invalid credentials.",
    exists:"‚ùå Email already registered. Please login.",
    notFound:"‚ùå Account not found. Create a new one.",
    profile:"Profile",
    save:"Save",
    logout:"Logout",
    bonus:"Bonus",
    redeem:"Redeem",
    redeemHelp:"Type bonus to redeem. If more than you have, it will be rejected.",
    yourCoupons:"Your discount cards",
    couponHint:"Coupon (optional)",
    apply:"Apply",
    couponApplied:"Discount applied",
    couponInvalid:"Invalid coupon",
    summary:"1) Summary", payment:"2) Payment",
    confirm:"Confirm",
    payTitle:"Payment Methods",
    payInfo:(total)=>`Final total: ${money(total)} ‚Äî Choose payment method:`,
    payHelp:"Payments happen outside the site. After paying, send proof on WhatsApp.",
    post:"Post",
    writeReview:"Write your review...",
    reviewsInfo:"Reviews are stored locally on this device (demo).",
    inbox:"Inbox",
    inboxEmpty:"No messages yet.",
    giftInfo:"Enter receiver email. If not registered, it will be rejected.",
    send:"Send",
    sent:"Sent ‚úÖ",
    bought:(n)=>`Thanks! Added ${n} bonus.`,
    none:"None",
    selectCoupon:"Select a discount card (optional)",
    addToCart:"Add to cart",
    buy:"Buy",
    editProfile:"Edit profile"
  }
};
const L = isArabic ? T.ar : T.en;

/* =========================
   Utils
========================= */
function money(x){ return `EGP ${Math.max(0, Math.round(x))}`; }
function nowIso(){ return new Date().toISOString(); }
function rand(n=6){
  const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let s=""; for(let i=0;i<n;i++) s += chars[Math.floor(Math.random()*chars.length)];
  return s;
}
async function sha256(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
async function fileToDataURL(file){
  return new Promise((res, rej)=>{
    const reader = new FileReader();
    reader.onload = ()=>res(String(reader.result||""));
    reader.onerror = rej;
    reader.readAsDataURL(file);
  });
}

/* =========================
   Storage keys
========================= */
const LS_USERS   = "mgs_users_v2";
const LS_SESSION = "mgs_session_v2";
const LS_GCART   = "mgs_guest_cart_v2";
const LS_REVIEWS = "mgs_reviews_v2";
const LS_USED_COUPONS = "mgs_used_global_coupons_v2";

/* =========================
   Users + session
========================= */
function loadUsers(){
  try{ return JSON.parse(localStorage.getItem(LS_USERS)||"{}"); }catch{ return {}; }
}
function saveUsers(u){ localStorage.setItem(LS_USERS, JSON.stringify(u)); }
function getSessionEmail(){ return localStorage.getItem(LS_SESSION) || ""; }
function setSessionEmail(email){ localStorage.setItem(LS_SESSION, email); }
function clearSession(){ localStorage.removeItem(LS_SESSION); }

function currentUser(){
  const users = loadUsers();
  const email = getSessionEmail();
  return email && users[email] ? users[email] : null;
}
function updateUser(email, patch){
  const users = loadUsers();
  if(!users[email]) return null;
  users[email] = {...users[email], ...patch};
  saveUsers(users);
  return users[email];
}
function updateCurrentUser(patch){
  const email = getSessionEmail();
  if(!email) return null;
  return updateUser(email, patch);
}
function requireLogin(){ return !!currentUser(); }

/* =========================
   Inbox messages
========================= */
function pushMessage(email, text){
  const users = loadUsers();
  if(!users[email]) return;
  users[email].messages = users[email].messages || [];
  users[email].messages.unshift({ id: rand(10), at: nowIso(), text, read:false });
  saveUsers(users);
}
function markAllRead(email){
  const users = loadUsers();
  if(!users[email]) return;
  (users[email].messages||[]).forEach(m=>m.read=true);
  saveUsers(users);
}

/* =========================
   Coupons global
========================= */
function buildCoupons(){
  const map = {};
  const groups = [
    ["MG",10],["MZ",20],["MK",30],["MC",40],["MA",50],
    ["MB",60],["ME",70],["MX",80],["MR",90],["MI",100]
  ];
  for(const [prefix, pct] of groups){
    for(let i=1;i<=10;i++) map[`${prefix}${i}`] = pct;
  }
  return map;
}
const GLOBAL_COUPONS = buildCoupons();

function loadUsedGlobalCoupons(){
  try{ return JSON.parse(localStorage.getItem(LS_USED_COUPONS)||"{}"); }catch{ return {}; }
}
function saveUsedGlobalCoupons(x){ localStorage.setItem(LS_USED_COUPONS, JSON.stringify(x)); }

/* =========================
   Cart
========================= */
function loadGuestCart(){
  try{ return JSON.parse(localStorage.getItem(LS_GCART)||"[]"); }catch{ return []; }
}
function saveGuestCart(items){ localStorage.setItem(LS_GCART, JSON.stringify(items)); }

function loadCart(){
  const u = currentUser();
  if(!u) return loadGuestCart();
  return u.cart || [];
}
function saveCart(items){
  const u = currentUser();
  if(!u){ saveGuestCart(items); return; }
  updateCurrentUser({ cart: items });
}
function cartCount(items){
  return items.reduce((s,x)=>s+(x.qty||0),0);
}

/* =========================
   Products
========================= */
const products = [
  { id: 1, type:"games", name:"Game #1", desc: isArabic ? "ŸàÿµŸÅ ÿ®ÿ≥Ÿäÿ∑ ŸÑŸÑÿπÿ®ÿ©" : "Short game description", price:250, top:true, images:["1A","1B","1C"] },
  { id: 2, type:"games", name:"Game #2", desc: isArabic ? "ŸàÿµŸÅ ÿ®ÿ≥Ÿäÿ∑ ŸÑŸÑÿπÿ®ÿ©" : "Short game description", price:180, offer:true, images:["2A","2B","2C"] },
  { id: 3, type:"games", name:"Game #3", desc: isArabic ? "ŸàÿµŸÅ ÿ®ÿ≥Ÿäÿ∑ ŸÑŸÑÿπÿ®ÿ©" : "Short game description", price:300, images:["3A","3B","3C"] },
  { id: 4, type:"games", name:"Game #4", desc: isArabic ? "ŸàÿµŸÅ ÿ®ÿ≥Ÿäÿ∑ ŸÑŸÑÿπÿ®ÿ©" : "Short game description", price:120, offer:true, images:["4A","4B","4C"] },

  { id: 11, type:"programs", name:"Program #1", desc: isArabic ? "ŸàÿµŸÅ ÿ®ÿ≥Ÿäÿ∑ ŸÑŸÑÿ®ÿ±ŸÜÿßŸÖÿ¨" : "Short program description", price:150, top:true, images:["11A","11B","11C"] },
  { id: 12, type:"programs", name:"Program #2", desc: isArabic ? "ŸàÿµŸÅ ÿ®ÿ≥Ÿäÿ∑ ŸÑŸÑÿ®ÿ±ŸÜÿßŸÖÿ¨" : "Short program description", price:90, images:["12A","12B","12C"] },
  { id: 13, type:"programs", name:"Program #3", desc: isArabic ? "ŸàÿµŸÅ ÿ®ÿ≥Ÿäÿ∑ ŸÑŸÑÿ®ÿ±ŸÜÿßŸÖÿ¨" : "Short program description", price:220, offer:true, images:["13A","13B","13C"] },
  { id: 14, type:"programs", name:"Program #4", desc: isArabic ? "ŸàÿµŸÅ ÿ®ÿ≥Ÿäÿ∑ ŸÑŸÑÿ®ÿ±ŸÜÿßŸÖÿ¨" : "Short program description", price:60, images:["14A","14B","14C"] },

  { id: 21, type:"accounts", name:"Account #1", desc: isArabic ? "ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÉŸàŸÜÿ™ (ÿ™ŸÇÿØÿ± ÿ™ÿ∑ŸàŸëŸÑŸáÿß)" : "Account details (expand later)", price:700, top:true, images:["21A","21B","21C","21D"] },
  { id: 22, type:"accounts", name:"Account #2", desc: isArabic ? "ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÉŸàŸÜÿ™ (ÿ™ŸÇÿØÿ± ÿ™ÿ∑ŸàŸëŸÑŸáÿß)" : "Account details (expand later)", price:350, offer:true, images:["22A","22B","22C"] },
  { id: 23, type:"accounts", name:"Account #3", desc: isArabic ? "ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÉŸàŸÜÿ™ (ÿ™ŸÇÿØÿ± ÿ™ÿ∑ŸàŸëŸÑŸáÿß)" : "Account details (expand later)", price:200, images:["23A","23B","23C"] },
  { id: 24, type:"accounts", name:"Account #4", desc: isArabic ? "ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ£ŸÉŸàŸÜÿ™ (ÿ™ŸÇÿØÿ± ÿ™ÿ∑ŸàŸëŸÑŸáÿß)" : "Account details (expand later)", price:450, images:["24A","24B","24C"] },
];

const productMap = new Map(products.map(p=>[p.id,p]));

function typeLabel(t){
  if(t==="games") return L.games;
  if(t==="programs") return L.programs;
  return L.accounts;
}

/* =========================
   Bonus system
========================= */
function userBonus(){
  const u = currentUser(); return u ? (u.bonus||0) : 0;
}
function setUserBonus(n){
  const u = currentUser(); if(!u) return;
  updateCurrentUser({ bonus: Math.max(0, Math.floor(n)) });
}
function userCoupons(){
  const u = currentUser(); return u ? (u.coupons||[]) : [];
}
function setUserCoupons(coupons){
  const u = currentUser(); if(!u) return;
  updateCurrentUser({ coupons });
}
function couponPctFromBonus(b){
  if(b >= 60) return 40;
  if(b >= 40) return 30;
  if(b >= 25) return 20;
  if(b >= 15) return 15;
  if(b >= 8)  return 10;
  return 5;
}

/* =========================
   Reviews
========================= */
function loadReviews(){
  try{ return JSON.parse(localStorage.getItem(LS_REVIEWS)||"[]"); }catch{ return []; }
}
function saveReviews(r){ localStorage.setItem(LS_REVIEWS, JSON.stringify(r)); }

/* =========================
   DOM
========================= */
const $ = (id)=>document.getElementById(id);
const overlay = $("overlay");

const gridTop = $("gridTop");
const gridOffers = $("gridOffers");
const gridGames = $("gridGames");
const gridPrograms = $("gridPrograms");
const gridAccounts = $("gridAccounts");
const searchEl = $("search");

const menuDrawer = $("menuDrawer");
const filterDrawer = $("filterDrawer");

const authBtn = $("authBtn");
const authText = $("authText");
const userChip = $("userChip");
const userNameText = $("userNameText");
const avatarSmall = $("avatarSmall");

const cartCountEl = $("cartCount");
const inboxCountEl = $("inboxCount");
const gemsCountEl  = $("gemsCount");

const cartModal = $("cartModal");
const cartItemsEl = $("cartItems");
const totalValueEl = $("totalValue");

const checkoutModal = $("checkoutModal");
const paymentModal = $("paymentModal");
const detailsModal = $("detailsModal");

const inboxModal = $("inboxModal");
const gemsModal  = $("gemsModal");
const contactModal = $("contactModal");
const reviewsModal = $("reviewsModal");
const giftModal = $("giftModal");

/* =========================
   Text apply
========================= */
function applyLanguage(){
  $("brandText").textContent = "Medo Gaming Store";
  searchEl.placeholder = L.search;

  $("topTitle").childNodes[0].textContent = `üî• ${T.ar.top && isArabic ? "Top" : "Top"} `;
  $("topHint").textContent = L.topHint;
  $("offersTitle").childNodes[0].textContent = `üéÅ ${T.ar.offers && isArabic ? "Offers" : "Offers"} `;
  $("offersHint").textContent = L.offersHint;

  $("gamesTitle").textContent = `üéÆ ${L.games}`;
  $("programsTitle").textContent = `üíª ${L.programs}`;
  $("accountsTitle").textContent = `üßæ ${L.accounts}`;

  $("menuTitle").textContent = L.menu;
  $("drawerQuick").textContent = L.quick;

  $("goTopText").textContent = isArabic ? "Top" : "Top";
  $("goOffersText").textContent = isArabic ? "Offers" : "Offers";
  $("goGamesText").textContent = isArabic ? "Games" : "Games";
  $("goProgramsText").textContent = isArabic ? "Programs" : "Programs";
  $("goAccountsText").textContent = isArabic ? "Accounts" : "Accounts";
  $("contactText").textContent = "Contact";
  $("reviewsText").textContent = "Reviews";
  $("giftText").textContent = "Send Gift";

  $("filterTitle").textContent = L.filter;
  $("applyFilterBtn").textContent = isArabic ? "ÿ™ÿ∑ÿ®ŸäŸÇ" : "Apply";
  $("filterNote").textContent = isArabic
    ? "ÿßÿÆÿ™ÿßÿ± ÿßŸÑŸÇÿ≥ŸÖ ŸàÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ŸàÿßŸÑÿ≥ÿπÿ± Ÿàÿ®ÿπÿØŸäŸÜ ÿ™ÿ∑ÿ®ŸäŸÇ."
    : "Pick category + sort + price, then Apply.";

  $("authText").textContent = L.auth;

  $("cartTitle").textContent = L.cart;
  $("totalLabel").textContent = L.total;
  $("cartCheckoutBtn").textContent = L.checkout;
  $("cartNote").textContent = L.cartHint;

  $("authModalTitle").textContent = L.account;
  $("authHelp").textContent = isArabic
    ? "ÿßÿÆÿ™ÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ŸÑŸà ÿπŸÜÿØŸÉ ÿ≠ÿ≥ÿßÿ®ÿå ÿ£Ÿà ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ."
    : "Choose Login if you have an account, or Create a new one.";
  $("goLoginBtn").textContent = L.login;
  $("goSignupBtn").textContent = L.signup;

  $("loginTitle").textContent = L.login;
  $("loginSubmit").textContent = isArabic ? "ŸÖÿ™ÿßÿ®ÿπÿ©" : "Continue";
  $("loginHint").textContent = isArabic ? "ŸÑŸà ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸÖÿ¥ ŸÖŸàÿ¨ŸàÿØ: ÿßÿπŸÖŸÑ ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ." : "If account doesn't exist, create one.";

  $("signupTitle").textContent = L.signup;
  $("signupSubmit").textContent = isArabic ? "ÿ•ŸÜÿ¥ÿßÿ°" : "Create";
  $("avatarHint").textContent = isArabic
    ? "ÿµŸàÿ±ÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿßÿÆÿ™Ÿäÿßÿ±Ÿäÿ© (ÿ™ÿ∏Ÿáÿ± ÿØÿßŸäÿ±ÿ© ÿ¨ŸÜÿ® ÿßÿ≥ŸÖŸÉ)."
    : "Avatar is optional (shows next to your name).";
  $("signupHint").textContent = isArabic ? "ÿßŸÑÿ®ÿ±ŸäÿØ ŸÑÿßÿ≤ŸÖ ŸäŸÉŸàŸÜ ÿ¨ÿØŸäÿØ." : "Email must be unique.";

  $("profileTitle").textContent = L.profile;
  $("profileSave").textContent = L.save;
  $("profileNote").textContent = isArabic ? "ŸáŸÜÿß ÿ™ŸÇÿØÿ± ÿ™ÿ∫ŸäŸëÿ± ÿßÿ≥ŸÖŸÉ/ÿµŸàÿ±ÿ™ŸÉ/ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±." : "Edit your name/avatar/password here.";
  $("profileAvatarNote").textContent = isArabic ? "ŸÑŸà Ÿáÿ™ÿ∫ŸäŸëÿ± ÿßŸÑÿµŸàÿ±ÿ© ÿßÿÆÿ™ÿßÿ± ŸÖŸÑŸÅ ÿ¨ÿØŸäÿØ." : "Pick a new image to update avatar.";

  $("inboxTitle").textContent = L.inbox;

  $("gemsTitle").textContent = L.bonus;
  $("redeemBonusBtn").textContent = L.redeem;
  $("redeemHelp").textContent = L.redeemHelp;
  $("couponListTitle").textContent = L.yourCoupons;

  $("contactTitle").textContent = "Contact";
  $("reviewsTitle").textContent = "Reviews";
  $("reviewsInfo").textContent = L.reviewsInfo;
  $("addReviewBtn").textContent = L.post;
  $("reviewText").placeholder = L.writeReview;

  $("giftTitle").textContent = "Send Gift";
  $("giftInfo").textContent = L.giftInfo;
  $("sendGiftBtn").textContent = L.send;

  $("checkoutTitle").textContent = L.checkout;
  $("pill1").textContent = L.summary;
  $("pill2").textContent = L.payment;
  $("couponNote").textContent = L.couponHint;
  $("applyCouponBtn").textContent = L.apply;
  $("bonusCouponNote").textContent = L.selectCoupon;
  $("confirmCheckoutBtn").textContent = L.confirm;
  $("backToCartBtn").textContent = L.back;

  $("paymentTitle").textContent = L.payTitle;

  $("detailsTitle").textContent = L.details;

  // Drawer side by language:
  if(isArabic){
    menuDrawer.style.insetInlineEnd="0"; menuDrawer.style.insetInlineStart="auto";
    filterDrawer.style.insetInlineStart="0"; filterDrawer.style.insetInlineEnd="auto";
  }else{
    menuDrawer.style.insetInlineStart="0"; menuDrawer.style.insetInlineEnd="auto";
    filterDrawer.style.insetInlineEnd="0"; filterDrawer.style.insetInlineStart="auto";
  }
}
applyLanguage();

/* =========================
   Overlay open/close
========================= */
function openOverlay(){ overlay.classList.add("show"); }
function closeOverlay(){ overlay.classList.remove("show"); }

function closeAll(){
  closeOverlay();
  menuDrawer.classList.remove("show");
  filterDrawer.classList.remove("show");
  [
    $("authModal"), $("loginModal"), $("signupModal"), $("profileModal"),
    inboxModal, gemsModal, contactModal, reviewsModal, giftModal,
    cartModal, checkoutModal, paymentModal, detailsModal
  ].forEach(m=>m.classList.remove("show"));
}
overlay.addEventListener("click", closeAll);

function openDrawer(drawer){
  openOverlay();
  drawer.classList.add("show");
}
function openModal(modal){
  openOverlay();
  modal.classList.add("show");
}

/* =========================
   Render cards
   ‚úÖ FIX: Removed any Top/Offers/Programs labels from inside product cards.
========================= */
function cardHTML(p){
  return `
    <div class="card">
      <div class="thumb">${p.type.toUpperCase()}</div>
      <div class="content">
        <p class="name">${p.name}</p>
        <p class="meta">${p.desc || ""}</p>
        <div class="priceRow">
          <p class="price">${money(p.price)}</p>
          <span class="sectionHint">#${p.id}</span>
        </div>
        <div class="actions">
          <button class="btn" data-details="${p.id}">‚ÑπÔ∏è ${L.details}</button>
          <button class="btn" data-add="${p.id}">üõí ${L.addToCart}</button>
          <button class="btn btnRed" data-buy="${p.id}">‚ö° ${L.buy}</button>
        </div>
      </div>
    </div>
  `;
}

function applyFilters(list){
  const q = (searchEl.value||"").toLowerCase().trim();
  const cat = $("filterCategory").value;
  const sort = $("filterSort").value;
  const pm = $("priceMode").value;
  const pv = Number($("priceValue").value);

  let out = [...list];
  if(q) out = out.filter(p => (p.name + " " + (p.desc||"")).toLowerCase().includes(q));
  if(cat !== "all") out = out.filter(p => p.type === cat);

  if(pm !== "off" && !Number.isNaN(pv)){
    if(pm === "eq") out = out.filter(p=>p.price === pv);
    if(pm === "lte") out = out.filter(p=>p.price <= pv);
    if(pm === "gte") out = out.filter(p=>p.price >= pv);
  }

  if(sort === "new") out.sort((a,b)=> b.id - a.id);
  if(sort === "old") out.sort((a,b)=> a.id - b.id);
  if(sort === "low") out.sort((a,b)=> a.price - b.price);
  if(sort === "high") out.sort((a,b)=> b.price - a.price);

  return out;
}

function bindCardButtons(){
  document.querySelectorAll("[data-add]").forEach(btn=>{
    btn.onclick = ()=> addToCart(Number(btn.dataset.add));
  });
  document.querySelectorAll("[data-buy]").forEach(btn=>{
    btn.onclick = ()=> buyNow(Number(btn.dataset.buy));
  });
  document.querySelectorAll("[data-details]").forEach(btn=>{
    btn.onclick = ()=> openDetails(Number(btn.dataset.details));
  });
}

function renderAll(){
  const filtered = applyFilters(products);
  const tops = filtered.filter(p=>p.top);
  const offers = filtered.filter(p=>p.offer);

  gridTop.innerHTML = tops.length ? tops.map(cardHTML).join("") : `<div class="note">${isArabic?"ŸÖŸÅŸäÿ¥ ÿ™Ÿàÿ® ÿ≠ÿßŸÑŸäÿßŸã.":"No top items."}</div>`;
  gridOffers.innerHTML = offers.length ? offers.map(cardHTML).join("") : `<div class="note">${isArabic?"ŸÖŸÅŸäÿ¥ ÿπÿ±Ÿàÿ∂ ÿ≠ÿßŸÑŸäÿßŸã.":"No offers."}</div>`;

  gridGames.innerHTML = filtered.filter(p=>p.type==="games").map(cardHTML).join("");
  gridPrograms.innerHTML = filtered.filter(p=>p.type==="programs").map(cardHTML).join("");
  gridAccounts.innerHTML = filtered.filter(p=>p.type==="accounts").map(cardHTML).join("");

  bindCardButtons();
}
renderAll();
searchEl.addEventListener("input", renderAll);

/* =========================
   Menu scroll
========================= */
function scrollToId(id){
  const el = document.getElementById(id);
  if(!el) return;
  closeAll();
  window.scrollTo({ top: el.getBoundingClientRect().top + window.scrollY - 80, behavior:"smooth" });
}
document.querySelectorAll("[data-scroll]").forEach(x=>{
  x.addEventListener("click", ()=> scrollToId(x.dataset.scroll));
});

/* =========================
   Buttons open/close
========================= */
$("menuBtn").onclick = ()=>{ refreshUserUI(); openDrawer(menuDrawer); };
$("menuClose").onclick = closeAll;

$("filterBtn").onclick = ()=> openDrawer(filterDrawer);
$("filterClose").onclick = closeAll;
$("applyFilterBtn").onclick = ()=>{ closeAll(); renderAll(); };

$("authClose").onclick = closeAll;
$("goLoginBtn").onclick = ()=>{ closeAll(); openModal($("loginModal")); };
$("goSignupBtn").onclick = ()=>{ closeAll(); openModal($("signupModal")); };

$("loginClose").onclick = closeAll;
$("signupClose").onclick = closeAll;
$("profileClose").onclick = closeAll;

$("cartBtn").onclick = ()=>{ renderCart(); openModal(cartModal); };
$("cartClose").onclick = closeAll;

$("checkoutClose").onclick = closeAll;
$("paymentClose").onclick = closeAll;

$("detailsClose").onclick = closeAll;

$("openContactRow").onclick = ()=>{ closeAll(); openModal(contactModal); };
$("contactClose").onclick = closeAll;

$("openReviewsRow").onclick = ()=>{ closeAll(); renderReviews(); openModal(reviewsModal); };
$("reviewsClose").onclick = closeAll;

$("openGiftRow").onclick = ()=>{ closeAll(); openGift(); };
$("giftClose").onclick = closeAll;

$("inboxBtn").onclick = ()=> openInbox();
$("inboxClose").onclick = closeAll;

$("gemsBtn").onclick = ()=> openGems();
$("gemsClose").onclick = closeAll;

/* =========================
   Auth UI
========================= */
function setAuthUILoggedOut(){
  userChip.style.display="none";
  authBtn.style.display="inline-flex";
}
function setAuthUILoggedIn(u){
  authBtn.style.display="none";
  userChip.style.display="inline-flex";
  userNameText.textContent = u.name || (u.email||"").split("@")[0] || "User";
  if(u.avatar){
    avatarSmall.innerHTML = `<img alt="avatar" src="${u.avatar}">`;
  }else{
    avatarSmall.textContent = (userNameText.textContent||"U").slice(0,1).toUpperCase();
  }
}

function refreshUserUI(){
  const u = currentUser();
  if(!u){
    setAuthUILoggedOut();
    $("drawerUserBox").style.display="none";
    refreshBadges();
    return;
  }
  setAuthUILoggedIn(u);
  $("drawerUserBox").style.display="block";
  $("drawerUserNote").textContent = isArabic
    ? `ŸÖÿ≥ÿ¨ŸÑ ÿ®ÿßÿ≥ŸÖ: ${u.name} ‚Ä¢ Bonus: ${u.bonus||0}`
    : `Logged in: ${u.name} ‚Ä¢ Bonus: ${u.bonus||0}`;
  $("editProfileBtn").textContent = L.editProfile;
  $("logoutBtn").textContent = L.logout;

  $("editProfileBtn").onclick = ()=>{ closeAll(); openProfile(); };
  $("logoutBtn").onclick = ()=>{
    clearSession();
    refreshUserUI();
    closeAll();
  };

  refreshBadges();
}
refreshUserUI();

userChip.onclick = ()=>{ refreshUserUI(); openDrawer(menuDrawer); };

/* ‚úÖ auth button: opens auth modal if not logged, otherwise opens profile */
authBtn.onclick = ()=>{
  if(currentUser()) openProfile();
  else openModal($("authModal"));
};

/* =========================
   Signup / Login
   ‚úÖ FIX: Signup MUST reject existing email (no more merging accounts)
========================= */
$("loginSubmit").onclick = async ()=>{
  const email = ($("loginEmail").value||"").trim().toLowerCase();
  const pass  = ($("loginPass").value||"").trim();
  const err = $("loginErr");
  err.style.display="none";

  const users = loadUsers();
  if(!users[email]){
    err.style.display="block";
    err.textContent = L.notFound;
    return;
  }
  const ph = await sha256(pass);
  if(users[email].passHash !== ph){
    err.style.display="block";
    err.textContent = L.invalid;
    return;
  }

  setSessionEmail(email);

  // merge guest cart into user cart
  const guest = loadGuestCart();
  if(guest.length){
    const u = users[email];
    const cart = u.cart || [];
    for(const it of guest){
      const idx = cart.findIndex(x=>x.id===it.id);
      if(idx>=0) cart[idx].qty += it.qty;
      else cart.push({id:it.id, qty:it.qty});
    }
    u.cart = cart;
    saveUsers(users);
    saveGuestCart([]);
  }

  pushMessage(email, isArabic ? "‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠." : "‚úÖ Logged in successfully.");
  closeAll();
  refreshUserUI();
};

$("signupSubmit").onclick = async ()=>{
  const name = ($("signupName").value||"").trim();
  const age  = Number(($("signupAge").value||"").trim());
  const email= ($("signupEmail").value||"").trim().toLowerCase();
  const pass = ($("signupPass").value||"").trim();

  const err  = $("signupErr");
  err.style.display="none";

  if(!name || !email || !pass || !age || age<1){
    err.style.display="block";
    err.textContent = isArabic ? "ÿßŸÖŸÑÿ£ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ." : "Please fill all fields.";
    return;
  }

  const users = loadUsers();

  /* ‚úÖ HARD BLOCK if email exists */
  if(users[email]){
    err.style.display="block";
    err.textContent = L.exists;
    return;
  }

  const ph = await sha256(pass);

  const file = $("signupAvatar").files && $("signupAvatar").files[0];
  let avatarData = "";
  if(file) avatarData = await fileToDataURL(file);

  users[email] = {
    email, name, age,
    passHash: ph,
    avatar: avatarData,
    bonus: 0,
    coupons: [],
    messages: [],
    cart: []
  };
  saveUsers(users);

  setSessionEmail(email);
  pushMessage(email, isArabic ? "üéâ ÿ£ŸáŸÑÿßŸã ÿ®ŸäŸÉ! ÿ≠ÿ≥ÿßÿ®ŸÉ ÿßÿ™ÿπŸÖŸÑ." : "üéâ Welcome! Your account was created.");
  closeAll();
  refreshUserUI();
};

/* =========================
   Profile
========================= */
function openProfile(){
  const u = currentUser();
  if(!u){ openModal($("authModal")); return; }
  $("profileName").value = u.name || "";
  $("profileNewPass").value = "";
  $("profileOk").style.display="none";
  $("profileErr").style.display="none";
  openModal($("profileModal"));
}
$("profileSave").onclick = async ()=>{
  const u = currentUser();
  if(!u) return;

  $("profileOk").style.display="none";
  $("profileErr").style.display="none";

  const newName = ($("profileName").value||"").trim();
  const newPass = ($("profileNewPass").value||"").trim();
  const file = $("profileAvatar").files && $("profileAvatar").files[0];

  const patch = {};
  if(newName) patch.name = newName;
  if(newPass) patch.passHash = await sha256(newPass);
  if(file) patch.avatar = await fileToDataURL(file);

  updateCurrentUser(patch);
  $("profileOk").style.display="block";
  $("profileOk").textContent = isArabic ? "‚úÖ ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏." : "‚úÖ Saved.";
  refreshUserUI();
};

/* =========================
   Cart actions
========================= */
function addToCart(id){
  const p = productMap.get(id); if(!p) return;
  const cart = loadCart();
  const idx = cart.findIndex(x=>x.id===id);
  if(idx>=0) cart[idx].qty += 1;
  else cart.push({id, qty:1});
  saveCart(cart);
  refreshBadges();
}

function cartItemsDetailed(){
  return loadCart()
    .map(ci => ({...ci, p: productMap.get(ci.id)}))
    .filter(x=>x.p);
}
function cartSubtotal(items){
  return items.reduce((sum,x)=> sum + x.p.price * x.qty, 0);
}
function setQty(id, qty){
  const cart = loadCart();
  const idx = cart.findIndex(x=>x.id===id);
  if(idx<0) return;
  cart[idx].qty = Math.max(1, qty);
  saveCart(cart);
  renderCart();
  refreshBadges();
}
function removeFromCart(id){
  const cart = loadCart().filter(x=>x.id!==id);
  saveCart(cart);
  renderCart();
  refreshBadges();
}

function renderCart(){
  const items = cartItemsDetailed();
  if(!items.length){
    cartItemsEl.innerHTML = `<div class="note">${L.emptyCart}</div>`;
    totalValueEl.textContent = money(0);
    return;
  }
  cartItemsEl.innerHTML = items.map(({id, qty, p})=>`
    <div class="cartItem">
      <div class="cartLeft">
        <div class="cartThumb">${p.type.toUpperCase()}</div>
        <div style="flex:1">
          <p class="cartName">${p.name}</p>
          <p class="cartMeta">${typeLabel(p.type)} ‚Ä¢ ${money(p.price)}</p>
          <div class="qtyRow">
            <button class="qtyBtn" data-dec="${id}">‚àí</button>
            <div class="qtyNum">${qty}</div>
            <button class="qtyBtn" data-inc="${id}">+</button>
            <button class="detailsBtn" data-cdetails="${id}">‚ÑπÔ∏è ${L.details}</button>
            <button class="removeBtn" data-rem="${id}">${isArabic?"ÿ≠ÿ∞ŸÅ":"Remove"}</button>
          </div>
        </div>
      </div>
      <div style="text-align:end;white-space:nowrap;font-weight:900">${money(p.price * qty)}</div>
    </div>
  `).join("");

  totalValueEl.textContent = money(cartSubtotal(items));

  cartItemsEl.querySelectorAll("[data-inc]").forEach(b=>{
    b.onclick = ()=>{
      const id = Number(b.dataset.inc);
      const cur = loadCart().find(x=>x.id===id)?.qty || 1;
      setQty(id, cur + 1);
    };
  });
  cartItemsEl.querySelectorAll("[data-dec]").forEach(b=>{
    b.onclick = ()=>{
      const id = Number(b.dataset.dec);
      const cur = loadCart().find(x=>x.id===id)?.qty || 1;
      setQty(id, cur - 1);
    };
  });
  cartItemsEl.querySelectorAll("[data-rem]").forEach(b=>{
    b.onclick = ()=> removeFromCart(Number(b.dataset.rem));
  });
  cartItemsEl.querySelectorAll("[data-cdetails]").forEach(b=>{
    b.onclick = ()=> openDetails(Number(b.dataset.cdetails));
  });
}

$("totalBar").onclick = ()=> $("cartCheckoutBtn").click();

$("cartCheckoutBtn").onclick = ()=>{
  const items = cartItemsDetailed();
  if(!items.length){ renderCart(); return; }
  startCheckout({ mode:"cart" });
};

/* =========================
   Inbox (Bell) ‚úÖ FIX: shows messages
========================= */
function openInbox(){
  const u = currentUser();
  const list = $("inboxList");
  list.innerHTML = "";

  if(!u){
    list.innerHTML = `<div class="note err">${L.needLogin}</div>`;
    openModal(inboxModal);
    return;
  }
  const msgs = (u.messages||[]);
  if(!msgs.length){
    list.innerHTML = `<div class="note">${L.inboxEmpty}</div>`;
  }else{
    for(const m of msgs){
      const time = new Date(m.at).toLocaleString();
      const item = document.createElement("div");
      item.className = "note" + (m.read ? "" : " ok");
      item.textContent = `${m.text} ‚Äî ${time}`;
      list.appendChild(item);
    }
  }
  markAllRead(u.email);
  refreshBadges();
  openModal(inboxModal);
}

/* =========================
   Bonus
========================= */
function openGems(){
  const u = currentUser();
  $("redeemBonusInput").value = "";
  $("couponList").innerHTML = "";

  if(!u){
    $("gemsInfo").className = "note err";
    $("gemsInfo").textContent = L.needLogin;
  }else{
    $("gemsInfo").className = "note";
    $("gemsInfo").textContent = isArabic ? `üíé ÿßŸÑÿ®ŸàŸÜÿµ ÿßŸÑÿ≠ÿßŸÑŸä: ${u.bonus||0}` : `üíé Current bonus: ${u.bonus||0}`;
    renderMyCoupons();
  }
  openModal(gemsModal);
}

function renderMyCoupons(){
  const u = currentUser(); if(!u) return;
  const list = $("couponList");
  const coupons = userCoupons();

  if(!coupons.length){
    list.innerHTML = `<div class="note">${isArabic?"ŸÖŸÅŸäÿ¥ ŸÉÿ±Ÿàÿ™ ÿÆÿµŸÖ ŸÑÿ≥Ÿá.":"No discount cards yet."}</div>`;
    return;
  }
  list.innerHTML = coupons.map(c=>`
    <div class="note ${c.used ? "" : "ok"}">
      <strong>${c.code}</strong> ‚Äî ${c.pct}% ${c.used ? (isArabic?"(ŸÖÿ≥ÿ™ÿπŸÖŸÑ)":"(used)") : (isArabic?"(ÿ¨ÿßŸáÿ≤)":"(ready)")}
    </div>
  `).join("");
}

$("redeemBonusBtn").onclick = ()=>{
  const u = currentUser();
  if(!u) return;

  const want = Number(($("redeemBonusInput").value||"").trim());
  if(!want || want <= 0) return;

  const cur = u.bonus || 0;
  if(want > cur){
    $("gemsInfo").className = "note err";
    $("gemsInfo").textContent = isArabic ? "‚ùå ÿßŸÑÿ®ŸàŸÜÿµ ÿßŸÑŸÑŸä ŸÉÿ™ÿ®ÿ™Ÿá ÿ£ŸÉÿ®ÿ± ŸÖŸÜ ÿßŸÑŸÑŸä ŸÖÿπÿßŸÉ." : "‚ùå You entered more bonus than you have.";
    return;
  }

  const pct = couponPctFromBonus(want);
  const code = "BONUS-" + rand(8);

  const coupons = userCoupons();
  coupons.unshift({ code, pct, used:false, createdAt: nowIso() });
  setUserCoupons(coupons);
  setUserBonus(cur - want);

  pushMessage(u.email, isArabic ? `üé´ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÉÿßÿ±ÿ™ ÿÆÿµŸÖ ${pct}% (${code})` : `üé´ Created a ${pct}% discount card (${code})`);
  refreshUserUI();

  $("gemsInfo").className = "note ok";
  $("gemsInfo").textContent = isArabic ? `‚úÖ ÿ™ŸÖ ÿßŸÑÿ™ÿ®ÿØŸäŸÑ. ÿßŸÑŸÖÿ™ÿ®ŸÇŸä: ${userBonus()}` : `‚úÖ Redeemed. Remaining: ${userBonus()}`;
  renderMyCoupons();
};

/* =========================
   Gift
========================= */
function openGift(){
  $("giftErr").style.display="none";
  $("giftOk").style.display="none";
  $("giftToEmail").value = "";
  $("giftType").value = "bonus";
  $("giftAmount").value = "";
  openModal(giftModal);
}

$("sendGiftBtn").onclick = ()=>{
  const from = currentUser();
  const err = $("giftErr");
  const ok  = $("giftOk");
  err.style.display="none"; ok.style.display="none";

  if(!from){
    err.style.display="block"; err.textContent = L.needLogin; return;
  }
  const toEmail = ($("giftToEmail").value||"").trim().toLowerCase();
  const type = $("giftType").value;
  const amount = Number(($("giftAmount").value||"").trim());

  const users = loadUsers();
  if(!users[toEmail]){
    err.style.display="block";
    err.textContent = isArabic ? "‚ùå ÿßŸÑÿ®ÿ±ŸäÿØ ÿØŸá ŸÖÿ¥ ŸÖÿ≥ÿ¨ŸÑ ÿπŸÜÿØŸÜÿß." : "‚ùå This email is not registered.";
    return;
  }
  if(toEmail === from.email){
    err.style.display="block";
    err.textContent = isArabic ? "‚ùå ŸÖŸäŸÜŸÅÿπÿ¥ ÿ™ÿ®ÿπÿ™ ŸÑŸÜŸÅÿ≥ŸÉ." : "‚ùå You can't send to yourself.";
    return;
  }

  if(type === "bonus"){
    if(!amount || amount <= 0){
      err.style.display="block";
      err.textContent = isArabic ? "ÿßŸÉÿ™ÿ® ŸÉŸÖŸäÿ© ÿ®ŸàŸÜÿµ ÿµÿ≠Ÿäÿ≠ÿ©." : "Enter a valid bonus amount.";
      return;
    }
    const cur = from.bonus || 0;
    if(amount > cur){
      err.style.display="block";
      err.textContent = isArabic ? "‚ùå ÿßŸÑÿ®ŸàŸÜÿµ ŸÖÿ¥ ŸÉŸÅÿßŸäÿ©." : "‚ùå Not enough bonus.";
      return;
    }
    users[from.email].bonus = cur - amount;
    users[toEmail].bonus = (users[toEmail].bonus||0) + amount;
    saveUsers(users);

    pushMessage(from.email, `${isArabic?"ÿ£ÿ±ÿ≥ŸÑÿ™ ÿ®ŸàŸÜÿµ ÿ•ŸÑŸâ":"Sent bonus to"}: ${toEmail} ‚Ä¢ ${amount}`);
    pushMessage(toEmail, `${isArabic?"ŸàÿµŸÑŸÉ ÿ®ŸàŸÜÿµ ŸÖŸÜ":"You received bonus from"}: ${from.name||from.email} ‚Ä¢ ${amount}`);

    ok.style.display="block"; ok.textContent = L.sent;
    refreshUserUI();
    return;
  }

  // product gift message only
  if(!amount || amount <= 0){
    err.style.display="block";
    err.textContent = isArabic ? "ÿßŸÉÿ™ÿ® ID ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿµÿ≠Ÿäÿ≠." : "Enter a valid product ID.";
    return;
  }
  const p = productMap.get(amount);
  if(!p){
    err.style.display="block";
    err.textContent = isArabic ? "ID ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ." : "Product ID not found.";
    return;
  }
  pushMessage(from.email, `${isArabic?"ÿ£ÿ±ÿ≥ŸÑÿ™ ŸáÿØŸäÿ© ÿ•ŸÑŸâ":"Gift sent to"}: ${toEmail} ‚Ä¢ ${p.name} (#${p.id})`);
  pushMessage(toEmail, `${isArabic?"ŸàÿµŸÑŸÉ ŸáÿØŸäÿ© ŸÖŸÜ":"You received gift from"}: ${from.name||from.email} ‚Ä¢ ${p.name} (#${p.id})`);

  ok.style.display="block"; ok.textContent = L.sent;
  refreshUserUI();
};

/* =========================
   Reviews
========================= */
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
function renderReviews(){
  const list = $("reviewsList");
  const reviews = loadReviews();
  if(!reviews.length){
    list.innerHTML = `<div class="note">${isArabic?"ŸÖŸÅŸäÿ¥ ŸÖÿ±ÿßÿ¨ÿπÿßÿ™ ŸÑÿ≥Ÿá.":"No reviews yet."}</div>`;
    return;
  }
  list.innerHTML = reviews.map(r=>{
    const time = new Date(r.at).toLocaleString();
    return `<div class="note"><strong>${r.by}</strong> ‚Äî ${time}<br>${escapeHtml(r.text)}</div>`;
  }).join("");
}
$("addReviewBtn").onclick = ()=>{
  const text = ($("reviewText").value||"").trim();
  if(!text) return;
  const u = currentUser();
  const by = u ? (u.name || u.email) : (isArabic ? "ÿ≤ÿßÿ¶ÿ±" : "Guest");
  const reviews = loadReviews();
  reviews.unshift({ id: rand(10), at: nowIso(), by, text });
  saveReviews(reviews);
  $("reviewText").value = "";
  renderReviews();
};

/* =========================
   Checkout
========================= */
let checkoutState = { mode:"cart", singleId:null };
let appliedPct = 0;
let appliedCode = "";
let appliedSource = ""; // global | bonus

function checkoutItemsFromState(){
  if(checkoutState.mode==="single"){
    const p = productMap.get(checkoutState.singleId);
    return p ? [{id:p.id, qty:1, p}] : [];
  }
  return cartItemsDetailed();
}

function populateMyCoupons(){
  const sel = $("myCouponsSelect");
  sel.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = L.none;
  sel.appendChild(opt0);

  const u = currentUser();
  if(!u) return;

  const coupons = (u.coupons||[]).filter(c=>!c.used);
  for(const c of coupons){
    const o = document.createElement("option");
    o.value = c.code;
    o.textContent = `${c.code} ‚Äî ${c.pct}%`;
    sel.appendChild(o);
  }
}

function buyNow(id){
  if(!requireLogin()){
    openModal($("authModal"));
    alert(L.needLogin);
    return;
  }
  startCheckout({ mode:"single", singleId:id });
}

function startCheckout(state){
  if(!requireLogin()){
    openModal($("authModal"));
    alert(L.needLogin);
    return;
  }
  checkoutState = state;
  appliedPct = 0; appliedCode=""; appliedSource="";
  $("couponInput").value = "";
  populateMyCoupons();
  renderCheckoutStep1();
  openModal(checkoutModal);
}

function renderCheckoutStep1(){
  $("pill1").classList.add("active");
  $("pill2").classList.remove("active");

  const items = checkoutItemsFromState();
  const box = $("checkoutItems");
  box.innerHTML = items.map(x=>`
    <div class="cartItem">
      <div class="cartLeft">
        <div class="cartThumb">${x.p.type.toUpperCase()}</div>
        <div style="flex:1">
          <p class="cartName">${x.p.name}</p>
          <p class="cartMeta">${typeLabel(x.p.type)} ‚Ä¢ ${money(x.p.price)} √ó ${x.qty}</p>
        </div>
      </div>
      <div style="text-align:end;white-space:nowrap;font-weight:900">${money(x.p.price * x.qty)}</div>
    </div>
  `).join("");

  const subtotal = cartSubtotal(items);
  const discount = Math.round(subtotal * (appliedPct/100));
  const total = Math.max(0, subtotal - discount);

  $("checkoutTotals").textContent = isArabic
    ? `ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™: ${money(subtotal)} ‚Ä¢ ÿßŸÑÿÆÿµŸÖ: ${appliedPct}% (${money(discount)}) ‚Ä¢ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: ${money(total)}`
    : `Items: ${money(subtotal)} ‚Ä¢ Discount: ${appliedPct}% (${money(discount)}) ‚Ä¢ Total: ${money(total)}`;

  $("confirmCheckoutBtn").onclick = ()=> openPayment(total);

  $("backToCartBtn").onclick = ()=>{
    closeAll();
    renderCart();
    openModal(cartModal);
  };
}

$("applyCouponBtn").onclick = ()=>{
  const chosen = ($("myCouponsSelect").value||"").trim();
  if(chosen){
    const u = currentUser();
    const coupons = u ? (u.coupons||[]) : [];
    const c = coupons.find(x=>x.code===chosen && !x.used);
    if(c){
      appliedPct = c.pct;
      appliedCode = c.code;
      appliedSource = "bonus";
      $("couponNote").className = "note ok";
      $("couponNote").textContent = `${L.couponApplied}: ${c.code} = ${c.pct}%`;
      renderCheckoutStep1();
      return;
    }
  }

  const code = ($("couponInput").value||"").trim().toUpperCase();
  if(!code){
    appliedPct=0; appliedCode=""; appliedSource="";
    $("couponNote").className = "note";
    $("couponNote").textContent = L.couponHint;
    renderCheckoutStep1();
    return;
  }

  const used = loadUsedGlobalCoupons();
  if(used[code]){
    appliedPct=0; appliedCode=""; appliedSource="";
    $("couponNote").className = "note err";
    $("couponNote").textContent = isArabic ? "ÿßŸÑŸÉŸàÿØ ÿßÿ™ÿ≥ÿ™ÿÆÿØŸÖ ŸÇÿ®ŸÑ ŸÉÿØŸá ÿπŸÑŸâ ŸÜŸÅÿ≥ ÿßŸÑÿ¨Ÿáÿßÿ≤." : "Code already used on this device.";
    renderCheckoutStep1();
    return;
  }

  const pct = GLOBAL_COUPONS[code] || 0;
  if(!pct){
    appliedPct=0; appliedCode=""; appliedSource="";
    $("couponNote").className = "note err";
    $("couponNote").textContent = `${L.couponInvalid}: ${code}`;
    renderCheckoutStep1();
    return;
  }

  appliedPct = pct;
  appliedCode = code;
  appliedSource = "global";
  $("couponNote").className = "note ok";
  $("couponNote").textContent = `${L.couponApplied}: ${code} = ${pct}%`;
  renderCheckoutStep1();
};

function openPayment(finalTotal){
  $("pill1").classList.remove("active");
  $("pill2").classList.add("active");

  $("paymentInfo").textContent = L.payInfo(finalTotal);

  const SELLER_PHONE = "201006760663";
  const waMsg = encodeURIComponent(
    isArabic
      ? `ÿ∑ŸÑÿ® ÿ¨ÿØŸäÿØ:\nÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: ${money(finalTotal)}\nŸÉŸàÿ®ŸàŸÜ: ${appliedCode || "‚Äî"}\n`
      : `New order:\nTotal: ${money(finalTotal)}\nCoupon: ${appliedCode || "‚Äî"}\n`
  );
  const waLink = `https://wa.me/${SELLER_PHONE}?text=${waMsg}`;

  const methods = [
    { key:"vodafone", title:"Vodafone Cash", icon:"VC", url: waLink },
    { key:"orange", title:"Orange Cash", icon:"OC", url: waLink },
    { key:"etisalat", title:"Etisalat Cash", icon:"EC", url: waLink },
    { key:"we", title:"WE Pay", icon:"WE", url: waLink },
    { key:"instapay", title:"InstaPay", icon:"IP", url:"https://www.instapay.eg/" },
    { key:"visa", title:"Visa / Card", icon:"V", url:"https://www.visa.com/" },
    { key:"billpay", title:"Bill Pay", icon:"BP", url: waLink },
    { key:"telda", title:"Telda", icon:"T", url:"https://telda.app/" },
  ];

  $("payList").innerHTML = methods.map(m=>`
    <button class="payBtn" data-pay="${m.key}">
      <span class="payLeft"><span class="payIcon">${m.icon}</span><span>${m.title}</span></span>
      <span class="mini">‚Üí</span>
    </button>
  `).join("");

  document.querySelectorAll("[data-pay]").forEach(btn=>{
    btn.onclick = ()=>{
      const m = methods.find(x=>x.key===btn.dataset.pay);
      if(m) window.open(m.url, "_blank");

      finalizeOrder(finalTotal);
      closeAll();
    };
  });

  $("payHelp").textContent = L.payHelp;
  openModal(paymentModal);
}

function finalizeOrder(finalTotal){
  const u = currentUser();
  if(!u) return;

  if(appliedCode){
    if(appliedSource === "global"){
      const used = loadUsedGlobalCoupons();
      used[appliedCode] = true;
      saveUsedGlobalCoupons(used);
    }
    if(appliedSource === "bonus"){
      const coupons = userCoupons();
      const idx = coupons.findIndex(c=>c.code===appliedCode);
      if(idx>=0){
        coupons[idx].used = true;
        setUserCoupons(coupons);
      }
    }
  }

  const bonusAdd = Math.max(1, Math.floor(finalTotal / 200));
  setUserBonus((u.bonus||0) + bonusAdd);

  if(checkoutState.mode==="cart"){
    saveCart([]);
  }

  pushMessage(u.email, L.bought(bonusAdd));
  refreshUserUI();
  refreshBadges();
}

/* =========================
   Details ‚úÖ FIX: now always opens
========================= */
let currentDetailsId = null;
function openDetails(id){
  const p = productMap.get(id);
  if(!p) return;

  currentDetailsId = id;
  $("detailsTitle").textContent = `${L.details} ‚Ä¢ ${p.name}`;
  $("detailsHero").textContent = p.name;
  $("detailsDesc").textContent = p.desc || "";
  $("detailsGalleryTitle").textContent = isArabic ? "ÿµŸàÿ± ÿ•ÿ∂ÿßŸÅŸäÿ©" : "More images";

  const g = $("detailsGallery");
  const imgs = p.images || [];
  g.innerHTML = imgs.map((x,i)=> `<div class="gThumb" data-g="${i}">${x}</div>`).join("");

  g.querySelectorAll("[data-g]").forEach(el=>{
    el.onclick = ()=> {
      $("detailsHero").textContent = `${p.name} ‚Ä¢ ${imgs[Number(el.dataset.g)]}`;
    };
  });

  $("detailsAddCartBtn").onclick = ()=> addToCart(id);
  $("detailsBuyBtn").onclick = ()=> buyNow(id);

  openModal(detailsModal);
}

/* =========================
   Badges
========================= */
function refreshBadges(){
  cartCountEl.textContent = String(cartCount(loadCart()));

  const u = currentUser();
  if(!u){
    inboxCountEl.textContent = "0";
    gemsCountEl.textContent = "0";
    return;
  }
  const unread = (u.messages||[]).filter(m=>!m.read).length;
  inboxCountEl.textContent = String(unread);
  gemsCountEl.textContent  = String(u.bonus||0);
}

/* =========================
   Init
========================= */
$("year").textContent = new Date().getFullYear();
$("filterCategory").value = "all";
$("filterSort").value = "new";
$("priceMode").value = "off";

refreshBadges();
</script>
</body>
</html>
